#!/bin/bash
# Created by Sovankiry Rim
# Date: 01 January 2015
# All Right Reserved Morakot Technology

echo ""
echo "Welcome to Morakot Technology"
echo ""
#args not set
if [ -z "$1" ]; then

        echo -n "Please enter the database name : "
        read db_name
        echo -n "Please enter the file name : "
        read db_file_name
else
        db_name=$1
        db_file_name=$2
fi

echo "Database connection close ....."
echo ""

# kill all connections to the postgres server
where="where pg_stat_activity.datname = '$db_name'"
cat <<-EOF | psql postgres 
SELECT pg_terminate_backend(pg_stat_activity.pid)
FROM pg_stat_activity
${where}
EOF

#for backup postgres
#service postgresql restart
echo ""
echo "Start database restore ....."
dropdb $db_name
createdb $db_name
pg_restore -d $db_name -v -O /var/dbbackup/SOD/$db_file_name

# Catch error
if [ $? -ne 0 -o ${PIPESTATUS[0]} -ne 0 ]; then
	echo "False"
	echo ""	
	echo "Restore failed."
	echo "Please try again."
	echo ""
	#exit 1
else
	echo "True"
	echo ""
	echo "Restore for SOD was successfully. Thanks You!"
	echo ""
fi
