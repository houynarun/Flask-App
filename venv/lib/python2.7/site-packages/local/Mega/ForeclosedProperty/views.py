from app.mktcore.imports 	import *
from .forms 				import *
from .transfer 				import *
from .sale 					import *
from .revalue 				import *

registerCRUD(admin, '/ForeclosedProperty', 'ForeclosedProperty', FRM_FORECLOSED_PROPERTY, [MKT_FORECLOSED_PROPERTY])
registerCRUD(admin, '/TransferForeclosedProperty', 'TransferForeclosedProperty', FRM_FORECLOSED_PROPERTY_TRANSFER, [MKT_FORECLOSED_PROPERTY])
registerCRUD(admin, '/SaleForeclosedProperty', 'SaleForeclosedProperty', FRM_FORECLOSED_PROPERTY_SALE, [MKT_FORECLOSED_PROPERTY])
registerCRUD(admin, '/RevalueForeclosedProperty', 'RevalueForeclosedProperty', FRM_FORECLOSED_PROPERTY_REVALUE, [MKT_FORECLOSED_PROPERTY])

@app.route("/Morakot/getGainLossByForeclosedValue", methods=['GET'])
@app.route("/Morakot/getGainLossBySaleValue", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def GetGainLoss():
	GainLoss 		= 0
	SaleValue 		= 0 
	ForeclosedValue = 0
	SaleValue 		= request.args.get('SaleValue')
	ForeclosedValue = request.args.get('ForeclosedValue')
	Currency 		= request.args.get("Currency")
	CurrencyObj 	= MKT_CURRENCY.query.get(Currency)

	SaleValueAmount 		= globalfunction.wordAmount(SaleValue)
	ForeclosedValueAmount 	= globalfunction.wordAmount(ForeclosedValue)
	if SaleValueAmount or ForeclosedValueAmount:
		ForeclosedValue = ForeclosedValueAmount
		SaleValue 		= SaleValueAmount
	else:
		SaleValue = 0
		ForeclosedValue = 0

	SaleValue = mktmoney.toMoney(float(SaleValue), CurrencyObj)
	ForeclosedValue = mktmoney.toMoney(float(ForeclosedValue), CurrencyObj)

	GainLoss = float(str(SaleValue).replace(',',"")) - float(str(ForeclosedValue).replace(',',""))

	return jsonify(GainLoss = float(GainLoss))

@app.route("/Morakot/getGainLossByValuationPrice", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def GetGainLossByValuationPrice():
	GainLoss 		= 0
	ValuationPrice 	= 0 
	ForeclosedValue = 0
	ValuationPrice 		= request.args.get('ValuationPrice')
	ForeclosedValue = request.args.get('ForeclosedValue')
	Currency 		= request.args.get("Currency")
	CurrencyObj 	= MKT_CURRENCY.query.get(Currency)

	ValuationPriceAmount 	= globalfunction.wordAmount(ValuationPrice)
	ForeclosedValueAmount 	= globalfunction.wordAmount(ForeclosedValue)
	if ValuationPriceAmount or ForeclosedValueAmount:
		ForeclosedValue = ForeclosedValueAmount
		ValuationPrice 	= ValuationPriceAmount
	else:
		ValuationPrice  = 0
		ForeclosedValue = 0

	ValuationPrice = mktmoney.toMoney(float(ValuationPrice), CurrencyObj)
	ForeclosedValue = mktmoney.toMoney(float(ForeclosedValue), CurrencyObj)

	GainLoss = float(str(ValuationPrice).replace(',',"")) - float(str(ForeclosedValue).replace(',',""))

	return jsonify(GainLoss = float(GainLoss))

@app.route("/Morakot/getAllCollateralInfoByForeClosedID", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getAllCollateralInfoByForeClosedID():
	CollateralTypeDic 	 = {}
	CurrencyDic 	  	 = {}
	ProvinceDic 	  	 = {}
	DistrictDic 	  	 = {}
	CommuneDic 		  	 = {}
	VillageDic 		  	 = {}
	OwnershipTypeDic  	 = {}
	RelationIndicatorDic = {}
	PurchasedPrice 	  = 0
	ValuationPrice 	  = 0
	ForeclosedValue   = 0
	IssuedDate        = ""
	IssuedPlace   	  = ""
	IssuedBy 		  = ""
	CollateralNumber  = ""
	ReceivedDate	  = ""
	ReceivedBy		  = ""
	WithdrawalDate    = ""
	WithdrawalBy  	  = ""
	Description 	  = ""
	OwnerName 		  = ""
	OwnerSpouseName   = ""
	Valuer 			  = ""

	ProvinceDic.update({"ID":"","Value":"--Choose Province--"})
	DistrictDic.update({"ID":"","Value":"--Choose District--"})
	CommuneDic.update({"ID":"","Value":"--Choose Commune--"})
	VillageDic.update({"ID":"","Value":"--Choose Village--"})

	ForeclosedPropertyID = request.args.get('ForeclosedTransferID')
	ForeclosedPropertyObj = MKT_FORECLOSED_PROPERTY.query.get(ForeclosedPropertyID)
	if ForeclosedPropertyObj:
		CollateralTypeObj = MKT_COLLATERAL_TYPE.query.get(ForeclosedPropertyObj.CollateralType)
		if CollateralTypeObj:
			CollateralTypeDic.update({"ID":CollateralTypeObj.ID,
									  "Value":CollateralTypeObj.Description})
		CurrencyObj = MKT_CURRENCY.query.get(ForeclosedPropertyObj.Currency)
		if CurrencyObj:
			CurrencyDic.update({"ID":CurrencyObj.ID,
								"Value":CurrencyObj.ID})
		ProvinceObj = MKT_PROVINCE.query.get(ForeclosedPropertyObj.Province)
		if ProvinceObj:
			ProvinceDic.update({"ID":ProvinceObj.ID,
								"Value":ProvinceObj.Description})
		DistrictObj = MKT_DISTRICT.query.get(ForeclosedPropertyObj.District)
		if DistrictObj:
			DistrictDic.update({"ID":DistrictObj.ID,
								"Value":DistrictObj.Description})
		CommuneObj = MKT_COMMUNE.query.get(ForeclosedPropertyObj.Commune)
		if CommuneObj:
			CommuneDic.update({"ID":CommuneObj.ID,
							   "Value":CommuneObj.Description})
		VillageObj = MKT_VILLAGE.query.get(ForeclosedPropertyObj.Village)
		if VillageObj:
			VillageDic.update({"ID":VillageObj.ID,
							   "Value":VillageObj.Description})
		CollateralID = ForeclosedPropertyObj.CollateralID
		
		LoanCollateralObj = db.session.query(MKT_LOAN_COLLATERAL_HIST.ID).filter(MKT_LOAN_COLLATERAL_HIST.Collateral == CollateralID).\
									  order_by(MKT_LOAN_COLLATERAL_HIST.ID.desc()).first()	
		# Select record in history take before last 
		if LoanCollateralObj:
			LoanID = LoanCollateralObj.ID.split('@')[0]
			LCObj = db.session.query(MKT_LOAN_CONTRACT_HIST.OutstandingAmount).filter(MKT_LOAN_CONTRACT_HIST.ID.like(LoanID+"%")).\
									  order_by(MKT_LOAN_CONTRACT_HIST.ID.desc()).limit(2).all()
			if LCObj:
				ForeclosedValue = list(reversed(LCObj))[0].OutstandingAmount
		else:
			LoanColObj = MKT_LOAN_COLLATERAL.query.filter_by(Collateral=CollateralID).first()
			if LoanColObj:
				LCObj  = MKT_LOAN_CONTRACT.query.get(LoanColObj.ID)
				if LCObj:
					ForeclosedValue = LCObj.OutstandingAmount

		if ForeclosedPropertyObj.RelationIndicator:
			RelationIndicatorObj = MKT_RELATION_INDICATORS.query.get(ForeclosedPropertyObj.RelationIndicator)
			if RelationIndicatorObj:
				RelationIndicatorDic.update({"ID":RelationIndicatorObj.ID,
											 "Value":RelationIndicatorObj.Description})
			else:
				RelationIndicatorDic.update({"ID":"","Value":"--None--"})
		else:
			RelationIndicatorDic.update({"ID":"","Value":"--None--"})

		if ForeclosedPropertyObj.OwnershipType =="1":
			OwnershipTypeDic.update({"ID":"1","Value":"Owned By Customer"})
		elif ForeclosedPropertyObj.OwnershipType =="2":
			OwnershipTypeDic.update({"ID":"2","Value":"Owned By Other"})
		else:
			OwnershipTypeDic.update({"ID":"1","Value":"Owned By Customer"})

		PurchasedPrice 		= ForeclosedPropertyObj.PurchasePrice
		ValuationPrice 		= ForeclosedPropertyObj.ValuationPrice
		IssuedDate     		= ForeclosedPropertyObj.IssuedDate
		IssuedPlace    		= ForeclosedPropertyObj.IssuedPlace
		IssuedBy  	   		= ForeclosedPropertyObj.IssuedBy
		CollateralNumber	= ForeclosedPropertyObj.CollateralNumber
		ReceivedDate   		= ForeclosedPropertyObj.ReceivedDate
		ReceivedBy 	   		= ForeclosedPropertyObj.ReceivedBy
		WithdrawalDate 		= ForeclosedPropertyObj.WithdrawalDate
		WithdrawalBy   		= ForeclosedPropertyObj.WithdrawalBy
		Description    		= ForeclosedPropertyObj.Description
		OwnerName 	   		= ForeclosedPropertyObj.OwnerName
		OwnerSpouseName		= ForeclosedPropertyObj.OwnerSpouseName
		Valuer 		   		= ForeclosedPropertyObj.Valuer
	return jsonify(CollateralType 	= CollateralTypeDic,
				   Currency 		= CurrencyDic,
				   PurchasedPrice	= float(PurchasedPrice),
				   ValuationPrice 	= float(ValuationPrice),
				   IssuedDate  		= IssuedDate,
				   IssuedPlace 		= IssuedPlace,
				   IssuedBy 		= IssuedBy,
				   CollateralNumber = CollateralNumber,
				   ReceivedDate   	= ReceivedDate,
				   ReceivedBy 	   	= ReceivedBy,
				   WithdrawalDate 	= WithdrawalDate,
				   WithdrawalBy   	= WithdrawalBy,
				   Description    	= Description,
				   Province 		= ProvinceDic,
				   District 		= DistrictDic,
				   Commune 			= CommuneDic,
				   Village 			= VillageDic,
				   OwnerName 		= OwnerName,
				   OwnerSpouseName  = OwnerSpouseName,
				   OwnershipType    = OwnershipTypeDic,
				   RelationIndicator= RelationIndicatorDic,
				   Valuer 			= Valuer,
				   ForeclosedValue  = float(ForeclosedValue))


@app.route("/Morakot/getAllCollateralInfoByID", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getAllCollateralInfoByID():
	CollateralTypeDic 	 = {}
	CurrencyDic 	  	 = {}
	ProvinceDic 	  	 = {}
	DistrictDic 	  	 = {}
	CommuneDic 		  	 = {}
	VillageDic 		  	 = {}
	OwnershipTypeDic  	 = {}
	RelationIndicatorDic = {}
	PurchasedPrice 	  = 0
	ValuationPrice 	  = 0
	ForeclosedValue   = 0
	IssuedDate        = ""
	IssuedPlace   	  = ""
	IssuedBy 		  = ""
	CollateralNumber  = ""
	ReceivedDate	  = ""
	ReceivedBy		  = ""
	WithdrawalDate    = ""
	WithdrawalBy  	  = ""
	Description 	  = ""
	OwnerName 		  = ""
	OwnerSpouseName   = ""
	Valuer 			  = ""
	CollateralID 	  = ""

	ProvinceDic.update({"ID":"","Value":"--Choose Province--"})
	DistrictDic.update({"ID":"","Value":"--Choose District--"})
	CommuneDic.update({"ID":"","Value":"--Choose Commune--"})
	VillageDic.update({"ID":"","Value":"--Choose Village--"})

	CollateralDetailID = request.args.get('CollateralDetailID')
	CollateralID 	   = request.args.get('CollateralID')

	CollateralDetailObj = MKT_COLLATERAL_DE.query.get(CollateralDetailID)
	if CollateralDetailObj:
		CollateralTypeObj = MKT_COLLATERAL_TYPE.query.get(CollateralDetailObj.CollateralType)
		if CollateralTypeObj:
			CollateralTypeDic.update({"ID":CollateralTypeObj.ID,
									  "Value":CollateralTypeObj.Description})
		CurrencyObj = MKT_CURRENCY.query.get(CollateralDetailObj.Currency)
		if CurrencyObj:
			CurrencyDic.update({"ID":CurrencyObj.ID,
								"Value":CurrencyObj.ID})
		ProvinceObj = MKT_PROVINCE.query.get(CollateralDetailObj.Province)
		if ProvinceObj:
			ProvinceDic.update({"ID":ProvinceObj.ID,
								"Value":ProvinceObj.Description})
		DistrictObj = MKT_DISTRICT.query.get(CollateralDetailObj.District)
		if DistrictObj:
			DistrictDic.update({"ID":DistrictObj.ID,
								"Value":DistrictObj.Description})
		CommuneObj = MKT_COMMUNE.query.get(CollateralDetailObj.Commune)
		if CommuneObj:
			CommuneDic.update({"ID":CommuneObj.ID,
							   "Value":CommuneObj.Description})
		VillageObj = MKT_VILLAGE.query.get(CollateralDetailObj.Village)
		if VillageObj:
			VillageDic.update({"ID":VillageObj.ID,
							   "Value":VillageObj.Description})

		LoanCollateralObj = db.session.query(MKT_LOAN_COLLATERAL_HIST.ID).filter(MKT_LOAN_COLLATERAL_HIST.Collateral == CollateralID).\
									  order_by(MKT_LOAN_COLLATERAL_HIST.ID.desc()).first()	
		# Select record in history take before last 
		if LoanCollateralObj:
			LoanID = LoanCollateralObj.ID.split('@')[0]
			LCObj = db.session.query(MKT_LOAN_CONTRACT_HIST.OutstandingAmount).filter(MKT_LOAN_CONTRACT_HIST.ID.like(LoanID+"%")).\
									  order_by(MKT_LOAN_CONTRACT_HIST.ID.desc()).limit(2).all()
			if LCObj:
				ForeclosedValue = list(reversed(LCObj))[0].OutstandingAmount
		else:
			LoanColObj = MKT_LOAN_COLLATERAL.query.filter_by(Collateral=CollateralID).first()
			if LoanColObj:
				LOCObj = MKT_LOAN_CONTRACT.query.get(LoanColObj.ID)
				if LOCObj:
					ForeclosedValue = LOCObj.OutstandingAmount

		if CollateralDetailObj.RelationIndicator:
			RelationIndicatorObj = MKT_RELATION_INDICATORS.query.get(CollateralDetailObj.RelationIndicator)
			if RelationIndicatorObj:
				RelationIndicatorDic.update({"ID":RelationIndicatorObj.ID,
											 "Value":RelationIndicatorObj.Description})
			else:
				RelationIndicatorDic.update({"ID":"","Value":"--None--"})
		else:
			RelationIndicatorDic.update({"ID":"","Value":"--None--"})

		if CollateralDetailObj.OwnershipType =="1":
			OwnershipTypeDic.update({"ID":"1","Value":"Owned By Customer"})
		elif CollateralDetailObj.OwnershipType =="2":
			OwnershipTypeDic.update({"ID":"2","Value":"Owned By Other"})
		else:
			OwnershipTypeDic.update({"ID":"1","Value":"Owned By Customer"})

		PurchasedPrice 		= CollateralDetailObj.PurchasePrice
		ValuationPrice 		= CollateralDetailObj.ValuationPrice
		IssuedDate     		= CollateralDetailObj.IssuedDate
		IssuedPlace    		= CollateralDetailObj.IssuedPlace
		IssuedBy  	   		= CollateralDetailObj.IssuedBy
		CollateralNumber	= CollateralDetailObj.CollateralNumber
		ReceivedDate   		= CollateralDetailObj.ReceivedDate
		ReceivedBy 	   		= CollateralDetailObj.ReceivedBy
		WithdrawalDate 		= CollateralDetailObj.WithdrawalDate
		WithdrawalBy   		= CollateralDetailObj.WithdrawalBy
		Description    		= CollateralDetailObj.Description
		OwnerName 	   		= CollateralDetailObj.OwnerName
		OwnerSpouseName		= CollateralDetailObj.OwnerSpouseName
		Valuer 		   		= CollateralDetailObj.Valuer

	return jsonify(CollateralType 	= CollateralTypeDic,
				   Currency 		= CurrencyDic,
				   PurchasedPrice	= float(PurchasedPrice),
				   ValuationPrice 	= float(ValuationPrice),
				   IssuedDate  		= IssuedDate,
				   IssuedPlace 		= IssuedPlace,
				   IssuedBy 		= IssuedBy,
				   CollateralNumber = CollateralNumber,
				   ReceivedDate   	= ReceivedDate,
				   ReceivedBy 	   	= ReceivedBy,
				   WithdrawalDate 	= WithdrawalDate,
				   WithdrawalBy   	= WithdrawalBy,
				   Description    	= Description,
				   Province 		= ProvinceDic,
				   District 		= DistrictDic,
				   Commune 			= CommuneDic,
				   Village 			= VillageDic,
				   OwnerName 		= OwnerName,
				   OwnerSpouseName  = OwnerSpouseName,
				   OwnershipType    = OwnershipTypeDic,
				   RelationIndicator= RelationIndicatorDic,
				   Valuer 			= Valuer,
				   ForeclosedValue  = float(ForeclosedValue))

@app.route("/Morakot/getForeclosedValue", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getForeclosedValue():
	ForeclosedValue = 0
	CollateralID = request.args.get('CollateralID')
	LoanCollateralObj = MKT_LOAN_COLLATERAL.query.filter(MKT_LOAN_COLLATERAL.Collateral == CollateralID).first()
	if LoanCollateralObj:
		LCObj = MKT_LOAN_CONTRACT.query.get(LoanCollateralObj.ID)
		if LCObj: 
			ForeclosedValue = LCObj.OutstandingAmount
	return jsonify(ForeclosedValue = float(ForeclosedValue))

@app.route("/Morakot/getCollateralByCustomer", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getCollateralByCustomer():
	CollateralOwner = request.args.get('CustomerID')
	dic = {}
	result = MKT_COLLATERAL.query.filter(MKT_COLLATERAL.CustomerID == CollateralOwner).all()
	for row in  result:
		dic[row.ID] = row.ID+"-"+row.Description

	return jsonify(results=dic)

@app.route("/Morakot/getCollateralDetail", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getCollateralDetail():
	dic = {}
	CollateralID = request.args.get('CollateralID')
	result = MKT_COLLATERAL_DE.query.filter_by(CollateralID=CollateralID).all()
	for row in  result:
		dic[row.ID] = row.ID+"-"+row.CollateralType

	return jsonify(results=dic)

@app.route("/Morakot/ForeclosedOwnership", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getForeclosedOwnership():
	RelationIndicator 	= 	request.args.get('RelationIndicator')
	OwnerSpouseName 	= 	request.args.get('OwnerSpouseName')
	OwnershipType 		= 	request.args.get('OwnershipType')
	OwnerName 			= 	request.args.get('OwnerName')
	Bool 				= 	False
	
	if OwnershipType == '1':
		RelationIndicator 	= 	''
		OwnerSpouseName 	= 	''
		OwnerName 			= 	''
		Bool 				= 	True

	return jsonify(
			RelationIndicator 	= RelationIndicator,
			OwnerSpouseName 	= OwnerSpouseName,
			OwnershipType 		= OwnershipType,
			OwnerName 			= OwnerName,
			Bool 				= Bool
		)

