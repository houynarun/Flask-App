from app.LoanContract.models import MKT_LOAN_CONTRACT_INAU,MKT_LOAN_CONTRACT
from app 					import db
from app.Tax.models 	import MKT_TAX
from app.Account.models import MKT_ACCOUNT
import app.tools.mktsetting     as mktsetting
import app.tools.mktdate	 	as mktdate
import app.tools.mktaccounting 	as mktaccounting
import app.tools.mktmoney 		as mktmoney
from decimal 					import *

class LocalLoanEx:
	@staticmethod
	def VATPosting(LCID=None, Resource=None):
		SecurityDeposit		= 0
		VATOutputCategory 	= ""
		VATInputCategory 	= ""
		Note 				= ""
		ID 			   		= LCID
		LcObj 				= ""
		BankDate 			= str(mktdate.getBankDate())
		if Resource and Resource == "INAU":
			LcObj = MKT_LOAN_CONTRACT_INAU.query.filter(MKT_LOAN_CONTRACT_INAU.DisbursedStat == 'Y').first()
		else:
			LcObj = MKT_LOAN_CONTRACT.query.filter(MKT_LOAN_CONTRACT.DisbursedStat=='Y',MKT_LOAN_CONTRACT.ValueDate==BankDate,MKT_LOAN_CONTRACT.BookVAT=='N').first()
		if LcObj:
			Inputter 	= LcObj.Inputter
			Createdon 	= LcObj.Createdon
			Authorizer 	= LcObj.Authorizer
			Authorizeon = LcObj.Authorizeon
			Account    	= LcObj.Account
			Category 	= ''
			Currency 	= LcObj.Currency
			VATOutput  	= LcObj.VATOutput
			VATInput  	= LcObj.VATInput
			TransVATOut	= mktsetting.getAppSetting('MEGA_VAT_OUTPUT_TRANS')
			TransVATIn	= mktsetting.getAppSetting('MEGA_VAT_INPUT_TRANS')
			TransSecDepo= mktsetting.getAppSetting('MEGA_SECDEPO_TRANS')
			
			TranDate 	= LcObj.ValueDate
			Branch   	= LcObj.Branch

			# get VAT categorypostVAT=FRM_LOAN_CONTRACT_EX.postVAT
			TaxID  = mktsetting.getAppSetting('VAT')
			TaxObj = MKT_TAX.query.get(TaxID)
			if TaxObj:
				if TaxObj.Rate !=None:
					VATOutputCategory = TaxObj.Category
					VATInputCategory 	= TaxObj.InputCategory

			AccCat = MKT_ACCOUNT.query.get(Account).AccCategory

			# POST ACCOUNTING VAT
			if float(VATOutput) != 0 or float(VATInput) !=0:
				for i in range(0, 2):
					if i == 0:
						DrCr = "Dr"
						Mode = "Direct"
						Category = VATInputCategory
						Note = "VAT Input"
						GL_KEYS = mktaccounting.getConsolKey(Category, Currency, "", "LC", "", "", "", "", "", "", "", "", "")
					else:
						DrCr = "Cr"
						Mode = ""
						Category = AccCat
						Note = "VAT Input"
						GL_KEYS = mktaccounting.getConsolKey(Category, Currency, "", "LC","", "", "", "", "", "", "", "", "")
						
					mktaccounting.postAccounting(
						"AUTH", 				# Status
						"0", 					# Curr
						Inputter,			# Inputter
						Createdon, 			# Createdon
						Authorizer,			# Authorizer
						Authorizeon,		# Authorizeon
						"", 					# AEID
						Account,				# Account
						Category,			# Category
						Currency,			# Currency
						DrCr,					# DrCr
						VATInput, 				# Amount
						"LC",					# Module
						TransVATIn, 		# Transaction
						TranDate, 			# TransactionDate
						ID, 					# Reference
						Note, 				# Note
						"", 					# JNID
						Branch,				# Branch
						GL_KEYS,				# GL_KEYS
						Mode 					# Mode check to insert Journal for category
					)
				for i in range(0, 2):
					if i == 0:
						DrCr = "Dr"
						Mode = ""
						Category = AccCat
						Note = "VAT Output"
						GL_KEYS = mktaccounting.getConsolKey(Category, Currency, "", "LC", "", "", "", "", "", "", "", "", "")
					else:
						DrCr = "Cr"
						Mode = "Direct"
						Category = VATOutputCategory
						Note = "VAT Output"
						GL_KEYS = mktaccounting.getConsolKey(Category, Currency, "", "LC","", "", "", "", "", "", "", "", "")
						
					mktaccounting.postAccounting(
						"AUTH", 				# Status
						"0", 					# Curr
						Inputter,			# Inputter
						Createdon, 			# Createdon
						Authorizer,			# Authorizer
						Authorizeon,		# Authorizeon
						"", 					# AEID
						Account,				# Account
						Category,			# Category
						Currency,			# Currency
						DrCr,					# DrCr
						VATOutput, 			# Amount
						"LC",					# Module
						TransVATOut, 		# Transaction
						TranDate, 			# TransactionDate
						ID, 					# Reference
						Note, 				# Note
						"", 					# JNID
						Branch,				# Branch
						GL_KEYS,				# GL_KEYS
						Mode 					# Mode check to insert Journal for category
					)
				
			else:
				print "VAT is disable"
			# END POSTING
			# POSTING SECURITY DEPOSIT
			if LcObj.SecurityDeposit > 0:
				SecurityDepoCate 	= mktsetting.getAppSetting('MEGA_SECDEPO_CATE')
				SecurityDeposit     = Decimal(LcObj.SecurityDeposit)
				Amount 	= Decimal(SecurityDeposit)
				for i in range(0, 2):
					if i == 0:
						DrCr = "Dr"
						Mode = ""
						Category = AccCat
						Acc  = Account
						Note = "Security Deposit"
						GL_KEYS = mktaccounting.getConsolKey(Category, Currency, "", "LC", "", "", "", "", "", "", "", "", "")
					else:
						DrCr = "Cr"
						Mode = "Direct"
						Category = SecurityDepoCate
						Acc  = ""
						Note = "Security Deposit"
						GL_KEYS = mktaccounting.getConsolKey(Category, Currency, "", "LC","", "", "", "", "", "", "", "", "")

					mktaccounting.postAccounting(
						"AUTH", 				# Status
						"0", 					# Curr
						Inputter,				# Inputter
						Createdon, 				# Createdon
						Authorizer,				# Authorizer
						Authorizeon,			# Authorizeon
						"", 					# AEID
						Acc,				# Account
						Category,				# Category
						Currency,				# Currency
						DrCr,					# DrCr
						Amount, 				# Amount
						"LC",					# Module
						TransSecDepo, 			# Transaction
						TranDate, 				# TransactionDate
						ID, 					# Reference
						Note, 					# Note
						"", 					# JNID
						Branch,					# Branch
						GL_KEYS,				# GL_KEYS
						Mode 					# Mode check to insert Journal for category
					)
			# END POSTING
			# Update BookVAT =='Y'
			LcObj.BookVAT ='Y'
			db.session.commit()
			db.session.flush()
		