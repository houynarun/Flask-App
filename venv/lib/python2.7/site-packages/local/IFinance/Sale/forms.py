from app.mktcore.wtfimports import *
from .models import *
import time

import collections
from flask import flash


from app.Position.models 		import *


import app.tools.user as mktuser
import app.tools.mktofficer as mktofficer
import app.tools.mktdate as mktdate

#function 
def loadPositon():  #define function 
	return MKT_POSITION.query.filter(MKT_POSITION.PositionType.in_(['I','B'])) # tablename.query


#class SALE form
class FRM_SALE(exform):

	FirstNameEN	=	TextField(requiredlabel("First Name (English)","*"),[validators.Required()])
	LastNameEN 	=	TextField(requiredlabel("Last Name (English)","*"),[validators.Required()])
	FirstNameKH	=	TextField("First Name (Khmer)",[validators.Optional()])
	LastNameKH 	=	TextField("Last Name (Khmer)",[validators.Optional()])
	Gender 		= 	SelectField(requiredlabel('Gender',"*"),
						choices=[('Male','Male'),('Female','Female'),('Other','Other')],
						coerce=str,
						validators=[validators.Required()]
					)

	Phone 		=	TextField(requiredlabel("Phone Number", "*"), [validators.Required()])
	StartDate 	= 	DateField(requiredlabel("Start Date", "*"), [validators.Required()],default=mktdate.getDateISO)
	Position 	=	QuerySelectField(requiredlabel('Position','*'),query_factory=loadPositon, 
						get_label='Description',#Field Name
						allow_blank=True,
						blank_text='--None--',
						validators=[validators.Required()]
					)
	Phone 		=	TextField("ID Card", [validators.Optional()])

	def validate_UserID(form, field):

		ID 		= request.form['ID']
		UserID 	= request.form['UserID']
		checkID = MKT_OFFICER.query.get(ID)

		if not checkID:
			user 	= 	MKT_OFFICER.query.\
						filter(MKT_OFFICER.UserID == UserID).\
						first()
		else:
			user 	= 	MKT_OFFICER.query.\
						filter(MKT_OFFICER.UserID == UserID).\
						filter(MKT_OFFICER.UserID != checkID.UserID).\
						all()

		if user:
			raise ValidationError("The user is already exists.")

	@staticmethod
	def setWidth():
		control_list = [("Gender", len1),
						("StartDate", len3),
						("Active", len1)]
		return control_list
