from app.mktcore.wtfimports 		import *
from app.LoanContract.forms 		import *
from app.Customer.models 			import *
from app.LoanApplication.models 	import *

@app.route("/Morakot/GurantorType", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getGurantorType():
	try:
		ID 	= request.args.get("Guarantor")
		TypeDesc = ''
		Type = ''

		CustomerObj = MKT_CUSTOMER.query.filter(MKT_CUSTOMER.ID == ID).first()
		if CustomerObj:
			if CustomerObj.AsGurantor == 'Y':
				Type = 'G'
				TypeDesc = "Guarantor"
			elif CustomerObj.AsReferrer == 'Y':
				Type = 'R'
				TypeDesc = "Referrer"
			elif CustomerObj.AsSuccessor == 'Y':
				Type = 'S'
				TypeDesc = "Successor"
			else:
				Type = 'C'
				TypeDesc = "Collateral Owner"

		return jsonify( Type = Type, TypeDesc = TypeDesc )

	except:
		raise

def loadGuarantor():
	Branch 			= 	mktuser.getCurrentBranch()
	RestrictedObj 	= 	MKT_RESTRICT_BRANCH.query.filter(MKT_RESTRICT_BRANCH.Model == "MKT_CUSTOMER").first()
	AsGurantor 		=	MKT_CUSTOMER.query.\
						filter(MKT_CUSTOMER.Block == 'N').\
						order_by(MKT_CUSTOMER.ID.asc())
	if RestrictedObj:
		AsGurantor 	=	AsGurantor.filter(MKT_CUSTOMER.Branch == Branch)

	return AsGurantor

class FRM_LOAN_CONTRACT_EX(FRM_LOAN_CONTRACT):

	LoanPurpose 	= 	QuerySelectField(getLanguage("Loan Purpose"),
							query_factory=laodLoanPurpose,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None")
						)
	MaximaPurpose 		= SelectField(requiredlabel('Maxima Purpose','*'),
									choices=[('', '--None--'),('1', 'Agriculture'),('2', 'Trade'),('3', 'Service'),('4','Transportation'),('5','Construction'),
											 ('6','Household Business'),('7','Consumption'),('8','Education'),('9','Solar'),('10','Other')],
									coerce=str,
									validators=[validators.Required()])
	ContractVB 		= 	RemoteTextField(getLanguage("Village Bank"))
	VBCyle 				= TextField("Village Bank Cycle")
	Group 			= 	TextField(getLanguage("Group"), [validators.Optional()])

	SourceOfFund 	= 	QuerySelectField(getLanguage("Source of Fund"),
							query_factory=loadSourceOfFund,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None")
						)
	SourceOfFundID 		= TextField("Source Of Fund ID")

	LoanType 		= 	SelectField(requiredlabel(getLanguage('Loan Type'), '*'),
							choices=[('N', '%s' %getLanguage("Normal")),
									 ('R', '%s' %getLanguage("Restructured"))],
							coerce=str,
							default='N'
						)
	
	AssetClass 		= 	TextField(requiredlabel(getLanguage("Asset Class"), "*"), [validators.Required()], default=loadAssetClass)

	MoreThanOneYear = 	TextField(requiredlabel(getLanguage("More Than One Year"), "*"), [validators.Required()], default='N')

	TotalInterest 	= 	DecimalField(getLanguage("Total Interest"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	IntIncEarned 	= 	DecimalField(getLanguage("Interest Income Earned"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrIntPerDay 	= 	DecimalField(getLanguage("Accrued Interest Per Day"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrInterest 	= 	DecimalField(getLanguage("Accrued Interest Receivable"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrCurrentInt 	= 	DecimalField(getLanguage("Accr Current Installment"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrIntCurrMonth = 	DecimalField(getLanguage("Accr Int Current Month"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrIntPreMonth = 	DecimalField(getLanguage("Accr Int Previous Month"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	Suspend 		= 	TextField(getLanguage("Suspend"), default='N', description="1-%s" %getLanguage("Interest"))
	DisbursedStat 	= 	TextField(requiredlabel(getLanguage("Disbursed Status"), "*"), [validators.Required()], default='N')

	ContractOfficerID 	= 	QuerySelectField(requiredlabel(getLanguage('Officer'),'*'),
							query_factory=loadOfficer,
							get_label=lambda a: a.ID + " - " + a.LastName + " " +a.FirstName,
							allow_blank=True,
							blank_text=u'--None--',
							validators=[validators.Required()]
						)

	ChargeKey 	= 	QuerySelectField(getLanguage("Charge Key"),
						query_factory=loadCharge,
						get_label=u'Description',
						allow_blank=True,
						blank_text=u'--None--',
						description=u'2-%s' %getLanguage("Loan Charge")
					)

	RateFixed 			= 	TextField(getLanguage("Rate") + "/" + getLanguage("Fixed"), description=u'2-%s' %getLanguage("Loan Charge"))
	Charge 				= 	TextField(getLanguage("Charge"),
								validators=[custom_Charge], 
								default=0,
								description=u'2-%s' %getLanguage("Loan Charge"))

	ChargePerInstallment= 	TextField("Charge Per Installment", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargePerDay		=   TextField("Charge Per Day", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargeLastBooked	=   TextField("Charge Last Booked", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	
	ChargeEarned 		= 	TextField("Charge Earned", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargeUnearned 		= 	TextField("Charge Unearn", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	# AccrCurrent 		= 	TextField("Accr Current Installment", default=0, description=u'2-%s' %getLanguage("Loan Charge"))

	Guarantor 			= QuerySelectField(getLanguage("Guarantor"),
							query_factory=loadGuarantor,
							get_label=lambda a: a.ID + " - " + a.LastNameEn + " " +a.FirstNameEn,
							allow_blank=True,
							blank_text=u'--None--',
							description="3-%s" %getLanguage("Guarantor")
						)
	GTRelationIndicator = SelectField("Relation Indicator",
								choices=[('', '--None--'), ('1', 'Son/Daughter'), ('2', 'Relative'), ('3', 'Parents'), ('4', 'Friend')],
								coerce=str,
								default='',
								description="3-%s" %getLanguage("Guarantor")
							)
	Type 				= SelectField("Type",
								choices=[('G', 'Guarantor'), ('R', 'Referrer'), ('S', 'Successor'),('C', 'Collateral Owner')],
								coerce=str,
								default='G',
								description="3-%s" %getLanguage("Guarantor")
							)

	LegacyID 		= TextField("MXM Loan Number")
	DeputyContractVB 	= TextField("Deputy Village Bank")
	PaymentPlace 		= SelectField('Payment Place',
									choices=[('None', '--None--'),('C', 'Customer door'),('O', 'Office'),('W', 'Wing')],
									coerce=str,
									default='None')
	WingNumber 			= TextField("Wing Number")
	ChargeKey 			= QuerySelectField(getLanguage("Charge Key"),
									query_factory=loadCharge,
									get_label=u'Description',
									allow_blank=True,
									blank_text=u'--None--',
									description=u'2-%s' %getLanguage("Loan Charge"))

	RateFixed 			= TextField(getLanguage("Rate") + "/" + getLanguage("Fixed"), description=u'2-%s' %getLanguage("Loan Charge"))
	Charge 				= TextField(getLanguage("Charge"),
								validators=[custom_Charge], 
								default=0,
								description=u'2-%s' %getLanguage("Loan Charge"))

	ChargePerInstallment= TextField("Charge Per Installment", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargePerDay		= TextField("Charge Per Day", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargeLastBooked	= TextField("Charge Last Booked", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargeEarned 		= TextField("Charge Earned", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargeUnearned 		= TextField("Charge Unearn", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	CoBorrowerID 		= QuerySelectField(getLanguage("Co-Borrower"),
							query_factory=loadCoBorrower,
							get_label=lambda a: a.ID + " - " + a.LastNameEn + " " +a.FirstNameEn,
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							description="5-%s" %getLanguage("Co-Borrower")
						)

	RelationIndicator 	= SelectField("Relation Indicator",
							choices=[('__None', '--None--'), ('1', 'Spouse'), ('2', 'Son/Daughter'), ('3', 'Relative'), ('4', 'Parent'), ('5', 'Friend')],
							coerce=str,
							default='__None',
							description="5-%s" %getLanguage("Co-Borrower")
						)
	InterviewDate 		= DateField('Interview Date', [validators.Optional()])
	LoanContractDate 	= DateField('Loan Contract Date', [validators.Optional()])
	LoanCycleType 		= SelectField("Loan Cycle Type",
							choices=[('__None', '--None--'), ('0', 'Next Cycle'), ('1', 'New Cycle'), ('2', 'Add Up'), ('3', 'Add Loan')],
							coerce=str,
							default='__None'
						)
	Refinance 			= SelectField("Refinance",
							choices=[('N', 'No'), ('Y', 'Yes')],
							coerce=str,
							default='N'
						)
	LoanUse 			= TextAreaField('Loan Use')

	@staticmethod
	def hotField():
		hotfield = []

		base 			= 		super(FRM_LOAN_CONTRACT_EX,FRM_LOAN_CONTRACT_EX).hotField()

		fielddisplay 	= ("$('#Type').select2('data',{'id':data.Type,'text':data.TypeDesc})")
		varname 		= "Guarantor:$('#Guarantor').val()"
		fun 			= ["Guarantor", varname, fielddisplay, "/Morakot/GurantorType", "change"]
		hotfield.append(fun)

		base.extend(hotfield)
		return base