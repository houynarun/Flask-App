from wtforms 							import SelectMultipleField
from app.mktcore.wtfimports 			import *
from app.mktcore.imports 				import *

from app.Collateral.models				import MKT_COLLATERAL
from app.Collateral.detail				import FRM_COLLATERAL_DE

from app.tools.mktloan 					import *


def loadLocation():
	LocationList 	= [('','--Choose Location--')]

	RawLocationList	= mktsetting.getAppSetting('TrackingLocation').split("\n")

	for RawLocation in RawLocationList:
		Location 	= RawLocation.split('*')
		LocationList.append((Location[0],Location[1]))

	return LocationList
	
def loadYear():
	Year = [('','--Choose Year--')]
	CurrentYear = mktdate.formatDate(str(mktdate.getBankDate()),"YYYY")
	for i in range(1995,int(CurrentYear)+5):
		Year.append((str(i),str(i)))
	return Year

class FRM_COLLATERAL_TRACKING(FRM_COLLATERAL_DE):

	TrackingStatus		=	SelectField(requiredlabel('Tracking Status','*'),
								choices=([('Open','Open'),
										('Close','Close')]),
								coerce=str)
	TrackingLocation	= 	SelectField(requiredlabel('Location','*'),
								coerce=str,
								validators=[validators.Required()]
							)
	TrackingDate		= 	DateField(requiredlabel("Processing Date","*"),
								format='%Y-%m-%d',
								validators=[validators.Required()]
							)
	TrackingTargetDate	=	DateField("Target Date",
								format='%Y-%m-%d',
								validators=[validators.Optional()]
							)
	TrackingDescription	=	TextAreaField('Description',
								[validators.Optional(),validators.Length(max=255)]
							)

	OwnershipType 		=	SelectField('Ownership Type', 
								choices=[('1', 'Owned By Customer'),('2', 'Owned By Other')],
								coerce=str)

	OwnerName 			= 	TextField('Owner Name')
	OwnerSpouseName 	= 	TextField('Owner Spouse Name')
	RelationIndicator 	= 	QuerySelectField("Relation Indicator",
								query_factory=loadRelationIndicators,
								get_label=u'Description',
								allow_blank=True,
								blank_text=u'--%s--' %getLanguage("None")
							)
	#For Leasing 
	if mktsetting.getAppSetting("LEASING_TYPE_SETTING") == "Y":
		PlateNumber		=	TextField('Plate Number')
		FrameNo			= 	TextField('Frame No')
		EngineNo		= 	TextField('Engine No')
		Color 			=	TextField('Color')
		Brand			=	TextField('Brand')
		Model 			=	TextField('Model')
		HorsePower		=	TextField('Horse Power')
		Year			=	SelectField('Year',
								coerce=str)

	def __init__(self, *args, **kwargs):
		
		super(FRM_COLLATERAL_TRACKING, self).__init__(*args, **kwargs)

		self.TrackingLocation.choices=loadLocation()
		
		if mktsetting.getAppSetting("LEASING_TYPE_SETTING") == "Y":
			self.Year.choices = loadYear()

	@staticmethod
	def setVisible():
		controls_list = ['CollateralID','CollateralType','Currency','PurchasePrice','ValuationPrice','Valuer',
						'IssuedDate','IssuedPlace','IssuedBy','CollateralNumber','Province','District',
						'Commune','Village','ReceivedDate','ReceivedBy','WithdrawalDate','WithdrawalBy',
						'Description','OwnershipType','OwnerName','OwnerSpouseName','RelationIndicator']
		if mktsetting.getAppSetting("LEASING_TYPE_SETTING") == "Y":
			controls_list += ['PlateNumber','FrameNo','EngineNo','Color','Brand','Model'
									,'HorsePower','Year']

		return controls_list

	@staticmethod
	def beforeNewID():

		return True, 'This module does not allowed to create new record. Please use Collateral Detail ID for Tracking Module.'

	@staticmethod
	def hotField():
		hotfield=[]

		fielddisplay =  "$('input[name=TrackingDate]').val(data.TrackingDate);"
		fielddisplay += "$('input[name=TrackingTargetDate]').val('');"

		varname  = ""

		fun = ["TrackingLocation", varname, fielddisplay, "/Morakot/ChangeTrackingLocation", "change"]
		hotfield.append(fun)

		return hotfield

	@staticmethod
	def listField():
		Fields = ["ID", "TrackingStatus","TrackingLocation", "TrackingDate", "TrackingTargetDate", "TrackingDescription"]

		return Fields