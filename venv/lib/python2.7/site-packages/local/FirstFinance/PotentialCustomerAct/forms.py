from app.PotentialCustomerAct.forms import *

def loadPotentialCust(ID=''):
	
	Branch 			= mktuser.getCurrentBranch()	
	UserID 			= mktuser.getUser().ID	
	POStatusList = [NewID.ID for NewID in MKT_PO_CUSTOMER_STATUS.query.filter(MKT_PO_CUSTOMER_STATUS.Closed=='No').all()]
	QueryString = MKT_PO_CUSTOMER.query.filter(MKT_PO_CUSTOMER.POStatus.in_(POStatusList)).\
						filter(MKT_PO_CUSTOMER.AssignTo==UserID).\
						filter(MKT_PO_CUSTOMER.AssignBranch==Branch).\
						order_by(MKT_PO_CUSTOMER.ID.asc())
	if ID:
		QueryString = QueryString.filter(MKT_PO_CUSTOMER.ID==ID).first()
	else:
		QueryString = QueryString

	return QueryString

class FRM_PO_CUSTOMER_ACT_EX(FRM_PO_CUSTOMER_ACT):
	PotentialCustomer 	= 	QuerySelectField(requiredlabel('Potential Customer','*'),
							query_factory=loadPotentialCust,
							get_label=lambda a: a.ID + " - " + a.LastNameEn + " " +a.FirstNameEn,
							allow_blank=True,
							validators=[validators.Required()],
							default=lambda:loadPotentialCust(request.args.get("POID") if 'POID' in request.args else ""),
							blank_text=u'--None--')

	ActivityType 		=	QuerySelectField(requiredlabel('Activity Type','*'),
							query_factory=loadActivityType,
							get_label=lambda a: a.ID + " - " + a.Description,
							allow_blank=True,
							validators=[validators.Required()],
							blank_text=u'--None--')

	DateOfActivity		=	DateField("Date Of Activity",
							format='%Y-%m-%d',
							default=mktdate.getDateISO(),
							validators=[custom_DateOfActivity])

	TimeOfActivity 		=	DateTimeField("Time Of Activity",
							validators=[custom_DateOfActivity])
	
	POStatus 			=	QuerySelectField('Potential Status',
							query_factory=loadPotentialStatus,
							get_label=lambda a: a.ID + " - " + a.Description,
							allow_blank=True,
							blank_text=u'--None--')

	ActivityBy			=	QuerySelectField('ActivityBy',
							query_factory=pocustomer.loadUser,
							get_label=lambda a: a.DisplayName,
							allow_blank=True,
							blank_text=u'--None--')
	ActivityDesc 		=	TextAreaField(requiredlabel('Activity Description','*'),
							 validators=[validators.Required()])

	NextFollowDate 		=	DateField("Next Follow up Date",
							format='%Y-%m-%d',
							validators=[custom_NextFollowDate])
	NextAction 		=	TextAreaField('Next Action')
