# -*- coding: utf-8 -*-

'''
Report Name : Example Report

'''

from app.mktcore.imports 					import *
from app.PotentialCustomer.models 			import *
from app.LoanApplication.models 			import *
from app.Customer.models 					import *
from app.Branch.models						import *
import app.tools.mktmessage 				as mktmessage
import app.tools.mktdate					as mktdate
from decimal 								import Decimal
from app.tools.mktcustomreport   			import *
import app.tools.mktmoney 					as mktmoney

class FRM_CUSTOM_REPORT_SEARCH_EX(FRM_CUSTOM_REPORT_SEARCH):
	ReportedDate 		=	DateTextField("Reported Date")

@app.route('/Morakot/Report/FF/POConversionRate', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getPOConversionRate():
	""" Route to view each report """
	try:		
		ErrorMsg    = []
		DefualtUrl 	= CUSTOM_REPORT.getDefaultReportUrl(CurrentUrl=url_for(request.endpoint))
		getCheck    = checkAccess(DefualtUrl,"Search")
		if getCheck != True: 
			ErrorMsg.append(msg_error+msg_permission)
			return render_template("permission.html",ErrorMsg=ErrorMsg)

		''' Setup parameters '''
		Branch 			=	request.args.get("Branch") if "Branch" in request.args and request.args.get("Branch") else "ALL"
		ReportedDate 	= 	request.args.get("ReportedDate") if "ReportedDate" in request.args else ""
		Result 			=	getReport01(Branch=Branch,ReportedDate=str(ReportedDate))
		Parameters 		= 	{"Branch": Branch,"ReportedDate": str(ReportedDate)}
		FilterOption 	=	""

		# html = CUSTOM_REPORT.getCustomReportTemplate()
		SearchForm 		= 	FRM_CUSTOM_REPORT_SEARCH_EX()
		return CUSTOM_REPORT.getCustomReportTemplate(Parameters		=	Parameters,
													Result 			=	Result,
													FilterOption 	=	FilterOption,
													SearchForm 		=	SearchForm)	
	except:
		raise

@app.route('/Morakot/Report/FF/POConversionRate/Excel', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getPOConversionRateExport():
	""" Route to view each report """
	try:
		Branch 			=	request.args.get("Branch") if "Branch" in request.args and request.args.get("Branch") else "ALL"
		ReportedDate 	= 	request.args.get("ReportedDate") if "ReportedDate" in request.args else ""

		Result 			=	getReport01(Branch=Branch,ReportedDate=str(ReportedDate))
		response 		= 	CUSTOM_REPORT.exportExcel(Result=Result,FileName="ConversionRateReport")

		return response

	except Exception as e:
		raise

def getReport01(**kwargs):
	try:
		Branch 			= 	kwargs.get("Branch")
		ReportedDate 	=	kwargs.get("ReportedDate")
		
		ReportHeader 	=	CUSTOM_REPORT.getReportHeader()
		ReportHeader.update({"ReportTitle": "Conversion Rate Report"})
		ReportHeader.update({"Parameters": kwargs})

		Data 		= []
		TableHeader = {}

		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'No', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="A")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'Branch', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="B")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'# Inquiry', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="C")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'# LAF Signed', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="D")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'# LA Created', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="E")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'# LA Approved', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="F")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'% LAF Signed', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="G")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'% Signed to Created', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="H")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'% LA Created to LA Approved', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="I")
		TableHeader = CUSTOM_REPORT.setTableHeader(Text=u'% Inquiry to LA Approved', 
                                            Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center",ExcelCol="J")

		Data = getRecordRow(**kwargs)

		Result = {'ReportHeader': ReportHeader, 'TableHeader': TableHeader, 'Data':Data }

		return Result
	except:
		raise


def getRecordRow(**kwargs):
	Branch 			= 	kwargs.get("Branch")
	ReportedDate 	=	kwargs.get("ReportedDate")
	AllPOObj 			= 	getPOObj(**kwargs)
	POObj 				=	AllPOObj[0]
	POStatusObj 		=	AllPOObj[1]
	LAFSignStatus 	= 	mktsetting.getAppSetting('PO_CUS_LAF_SIGN_STATUS')
	LACreatedStatus = 	mktsetting.getAppSetting('PO_CUS_LA_CREATED_STATUS')
	RecordRow = []
	Index = 1
	BranchObj		= 	MKT_BRANCH.query.order_by(MKT_BRANCH.ID)
	for Row in BranchObj:
		BranchID			=	Row.ID
		if BranchID in Branch or "ALL" in Branch:
			Inquery 		=	POStatusObj.filter(MKT_PO_CUSTOMER.Branch==BranchID).count()
			LACreated		= 	getNumPOStatus(str(LACreatedStatus),BranchID,AllPOObj[1])
			LAFSign 		= 	getNumPOStatus(str(LAFSignStatus),BranchID,POStatusObj)
			LAFSign 		= 	int(LAFSign) +int(LACreated)

			NumLAApproved 	 	=	getNumLAByStatus('3',BranchID,POObj) # Get loan approved
			RateLAFSign 		= 	(float(LAFSign)/float(Inquery))*100 if LAFSign and Inquery else 0
			RateLACreated 		= 	(float(LACreated)/float(LAFSign))*100 if LACreated and Inquery else 0
			RateLACreatedApp 	=	(float(NumLAApproved)/float(LACreated))*100 if NumLAApproved and LACreated else 0
			RateInaquryApp 		=	(float(NumLAApproved)/float(Inquery))*100 if Inquery and NumLAApproved else 0

			DictRow 	= { 1:{"Value":Index,"Class":"text-center"},
							2:{"Value":BranchID,"Class":"text-center"},
							3:{"Value"	:Inquery},
							4:{"Value":LAFSign},
							5:{"Value":LACreated},
							6:{"Value":NumLAApproved},
							7:{"Value":mktmoney.formatNumber(RateLAFSign)},
							8:{"Value":mktmoney.formatNumber(RateLACreated)},
							9:{"Value":mktmoney.formatNumber(RateLACreatedApp)},
							10:{"Value":mktmoney.formatNumber(RateInaquryApp)}
						  }
			RecordRow.append((DictRow,
						  {"Class":"text-right"}))

			Index +=1
	return RecordRow

def getPOObj(**kwargs):
	"""
	Args:
		Date: could be filter by ALL, Between and Specific date.By default by system date
		Branch: could be filter by ALL, Multiple, Specific branch. By default is current user branch.
	Return:
		PO customer's query obj
	"""
	ReportedDate 		=	kwargs.get("ReportedDate")
	Branch 	 			= 	kwargs.get("Branch")
	#---------------------:
	ReportedDate 		=	str(ReportedDate)
	ReportedDate 		=	ReportedDate.split() if ReportedDate else []
	Branch 				=	Branch.split() if Branch else []

	POObj 				= 	db.session.query(MKT_PO_CUSTOMER.Branch).\
										join(MKT_CUSTOMER,MKT_CUSTOMER.PotentialCustomer==MKT_PO_CUSTOMER.ID).\
						    			join(MKT_LOAN_APPLICATION,MKT_LOAN_APPLICATION.LNCustomerID==MKT_CUSTOMER.ID)

	POStatusObj 		= 	MKT_PO_CUSTOMER.query
	# filter branch:
	if "ALL" not in Branch and Branch:
		# if ALL haven't in branch and branch not null
		POObj	=	POObj.filter(MKT_PO_CUSTOMER.Branch.in_(Branch))
		POStatusObj =POStatusObj.filter(MKT_PO_CUSTOMER.Branch.in_(Branch))
	# filter date:
	if ReportedDate:
		if len(ReportedDate)==2:
			# filter between date
			POObj 		=	POObj.filter(MKT_PO_CUSTOMER.DateOfContact>=ReportedDate[0],
									MKT_PO_CUSTOMER.DateOfContact<=ReportedDate[1])
			POStatusObj =	POStatusObj.filter(MKT_PO_CUSTOMER.DateOfContact>=ReportedDate[0],
									MKT_PO_CUSTOMER.DateOfContact<=ReportedDate[1])
		else:
			# filter specific date
			POObj 		= 	POObj.filter(MKT_PO_CUSTOMER.DateOfContact.in_(ReportedDate))
			POStatusObj = 	POStatusObj.filter(MKT_PO_CUSTOMER.DateOfContact.in_(ReportedDate))
			
	return (POObj,POStatusObj)

def getNumLAByStatus(LAStatus,Branch,POOObj):
	Obj  	=	POOObj.filter(MKT_LOAN_APPLICATION.AppStatus==LAStatus,
							  MKT_PO_CUSTOMER.Branch==Branch)
	return Obj.count()
def getNumPOStatus(POStatus,Branch,POStatusObj):
	Obj 	= 	POStatusObj.filter(MKT_PO_CUSTOMER.POStatus==POStatus,
							  MKT_PO_CUSTOMER.Branch==Branch)
	return Obj.count()
