{% extends "layout.html" %}

{% block css %}
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheets/jquery.datatables.css') }}">
    <style>
        h3.header-3{
            color: #888 !important;
		    font-size: 16px;
		    font-weight: bold;
		    margin: 5px 0 10px;
		    padding: 10px 18px 0;
        }

		.se-pre-con1 {
			position: fixed;
			left: 0px;
			top: 0px;
			width: 100%;
			height: 100%;
			z-index: 9999;
			background: #FFF url("{{ url_for('static',filename='images/loading.gif') }}") center no-repeat;
			opacity: 0.4;
			display: none;
		}

		.form-label{
			padding-top: 7px;
		}

		table.borderless td, .borderless th {
		    border: none !important;
		}
		.form-control
		{
			width: 100% !important;
		}
		
		.center-div
		{
		  margin-top: 20px;
		  width: 700px;
		  height: 300px;
		  border-radius: 3px;
		}
		.par {
			min-height: 452px;
		}

		<style>
		@media (max-width: 786px) { /* use the max to specify at each container level */
		    .panel, .panel-body {    
		        width:360px;  /* adjust to desired wrapping */
		        display:table;
		        white-space: pre-wrap; /* css-3 */
		        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
		        white-space: -pre-wrap; /* Opera 4-6 */
		        white-space: -o-pre-wrap; /* Opera 7 */
		        word-wrap: break-word; /* Internet Explorer 5.5+ */
		        overflow: scroll;
		    }
		}
    </style>
{% endblock %}

{# Create Review Form #}
{% macro ReviewForm(Type) -%}
	{%set ReviewObj2 = ReviewObj.filter(FollowupObj.ReviewType==Type) %}
	{% set reviewType = { '1':'Follow Up Survey','2':'Follow Up Review','3':'PAR Follow Up','4':'Request Amendment','5':'Other' } %}
	{% set route = { '1':'FollowUpSurvey','2':'FollowUpReview','3':'FollowUpPar','4':'FollowUpCard','5':'FollowUpCard' } %}

		{%if ReviewObj %}
			<div class="col-xs-12">
				<div class="panel panel-info {% if Type == '3' %} par {% endif %}" id="ReivewDetail">
					<div class="panel-heading">
						<span class="panel-title"><i class="fa fa-edit"></i> {{ reviewType[Type] }}</span>
{# Refresh Button
						<div class="panel-heading-controls">
							<div class="panel-heading-icon" style="padding-top:0px;">
								<a title="Refresh" class="link"><i id="Refresh" class="fa fa-refresh {{ Type }}" data-review="{{ Type }}"></i></a>
							</div>
						</div> 
#}
					</div>
					<div class="panel-body">
						{# <div> #}
							<div class="table-responsive">
								<table id="mktlist" class="display table" cellspacing="0" width="100%">
									<thead>
										<tr>
											<th>ID</th>
											<th style="padding-right: 35px;">Date</th>
											<th style="padding-right: 35px;">Type</th>
											<th style="padding-right: 35px;">Act.Plan</th>
											<th style="padding-right: 35px;">Officer</th>
											<th style="padding-right: 35px;">Link</th>
										</tr>
									</thead>
									<tbody>
										{% for Review in ReviewObj2 %}
											<tr>
											<td>{{ Review.ID }}</td>
											<td>{{ Review.ReviewDate }}</td>
											<td>{{ reviewType[Review.ReviewType] }}</td>
											<td>{{ Review.Description}}</td>
											<td>{{ OfficerObj.LastName }} {{ OfficerObj.FirstName }}</td>
											<td><a href="javascript:void(0)" onclick="CustomClickView('{{ reviewType[Review.ReviewType] }}','{{route[Review.ReviewType]}}/Edit/{{Review.ID}}')">View Detail</a></td>
											<td></td>
											</tr>
										{% endfor %}
									</tbody>
									<tfoot>
										<tr>
											<td><b>Total Review: </b></td>
											<td><b>{{ReviewObj2.all() | length }}</b></td>
										</tr>
									</tfoot>
								</table>
							</div>
						{# </div> #}
					</div> <!-- panel-body -->
				</div> <!-- panel panel-info : Review Detail-->
			</div>
		{%else%}
			
		{%endif%}
{%- endmacro %}

{% macro CustomerForm(CustomerID) -%}
 	<div class="col-xs-12">
 		<div class="panel panel-info" id="CustomerDetail">
 			<div class="panel-heading">
 				<span class="panel-title"><i class="fa fa-user"></i> Customer Detail</span>
 			</div>
 			<div class="panel-body">
 				<div>
 					<div class="table-responsive">
 						<table  class="table" cellspacing="0" width="100%">
 							<tr>
 								<td>Cust.ID</td>
 								<td id="CustomerID"><a href="javascript:void(0)" onclick="CustomClickView('{{ CustomerDetailObj.ID }}','CustomerCentre?Search={{CustomerDetailObj.ID}}')">{{ CustomerDetailObj.ID }}</a></td>
 								<td></td>
 							</tr>
 							<tr>
 								<td>Cust.Name</td>
 								<td>{{ CustomerDetailObj.LastNameEn }} {{CustomerDetailObj.FirstNameEn}} / {{ CustomerDetailObj.LastNameKh }} {{ CustomerDetailObj.FirstNameKh }}</td>
 							</tr>
 							<tr>
 								<td>Gender</td>
 								<td>{{ CustomerDetailObj.Gender }}</td>
 							</tr>
 							<tr>
 								<td>Date of Birth</td>
 								<td>{{ CustomerDetailObj.DateOfBirth }}</td>
 							</tr>
 							<tr>
 								<td>Place of Birth</td>
 								<td>{{ mktaddress.getAddress(CustomerDetailObj.ProvinceOfBirth, CustomerDetailObj.DistrictOfBirth, CustomerDetailObj.CommuneOfBirth, CustomerDetailObj.VillageOfBirth, Locale='kh') }}</td>
 							</tr>
 							<tr>
 								<td>Mobile1</td>
 								<td>{{ CustomerDetailObj.Mobile1 if CustomerDetailObj.Mobile1 else '' }}
 							</tr>
 							<tr>
 								<td>Mobile2</td>
								<td>{{ CustomerDetailObj.Mobile1 if CustomerDetailObj.Mobile2 else '' }}
 							</tr>
 							<tr>
 								<td>Address</td>
 								<td>{{ mktaddress.getAddress(CustomerDetailObj.Province, CustomerDetailObj.District, CustomerDetailObj.Commune, CustomerDetailObj.Village, Locale='kh') }}</td>
 							</tr>
 							<tr>
 								<td>Branch</td>
 								<td>{{ BranchName(CustomerDetailObj.Branch) }}</td>
 							</tr>
 							<tr>
 								<td>Officer</td>
 								<td>{{ OfficerObj.LastName }} {{ OfficerObj.FirstName }}</td>
 							</tr>
 						</table>
 					</div>
 				</div>
 			</div> <!-- panel-body -->
 		</div> <!-- panel panel-info -->
 	</div> <!-- col-xs-6 -->
{%- endmacro %}

{% macro BranchName(BranchID) -%}
	{% set BranchObj = BranchObj.query.filter(BranchObj.ID==BranchID).first() %}
	{{ BranchObj.Description }}
{%- endmacro %}

{% block content %}
    <div class="navbar navbar-default navbar-static-top">
    	<form method="POST" id="frm" name="frm" role="form" action="/Morakot/FollowUpHistory">
			<div class="col-xs-8">
				<div style="margin-top: 8px;">
		    		<div class="col-xs-4" style="padding-left: 0;">		    		
		    		{% from "print.html" import searchCustomer %}
		    		{{searchCustomer('/Morakot/SearchCustomerID','CustomerID',CustomerID,'','Input Customer ID or Name',AllowPutID='Y')}}
{#
 		            <select name="CustomerID" id="CustomerList" class="form-control" style="width: 100%;">
		            	{% for Customer in CustomerObj %}
		            		<option value="{{Customer.ID}}">{{Customer.ID}} - {{Customer.LastNameEn}} {{Customer.FirstNameEn}}</option>
		            	{% endfor %}
		            </select>		             
#}
					</div>
					<label class="col-xs-1" style="padding:0px;">
		    			<button id="btnShow" type="submit" class="btn btn-flat btn-labeled btn-primary" style="padding: 7px 25px;">
	                        Show
	                    </button>
		    		</label>
				</div>
			</div>
		</form>
	</div>
	<div class="clearfix"></div>
{% if msg %}
	<div class="col-xs-12 text-center" style="margin-top: 10%;"><i class="fa fa-check-circle text-success" style="font-size: 70px"></i></div>
	<div class="col-sm-12">
		<h1 class="header-3 text-center text-success"><span style="font-weight: bold;">Customer Card Enquiry</span></h1>
	</div>
	<div class="text-default text-center"><p style="font-size: 18px;">{{ msg }}</p></div>
{% elif ReviewObj %}
	{% set reviewType = { '1':'Follow Up Survey','2':'Follow Up Review','3':'PAR Follow Up','4':'Request Amendment','5':'Other' } %}
	{% set route = { 'Client Survey':'FollowUpSurvey','Client Review':'FollowUpReview','PAR Follow Up':'FollowUpPar','Request Amendment':'FollowUpCard','Other':'FollowUpCard' } %}
<div class="row">
	<div class="col-xs-12">
		<div class="col-xs-6">
			<div class="row">
				{{ CustomerForm(CustomerDetailObj.ID) }}
				{% for Type in [ '2','1' ] %}
					{{ ReviewForm(Type) }}
				{% endfor %}
			</div>
		</div> <!-- col-xs-6 -->
		<div class="col-xs-6">
			{{ ReviewForm('3')}}
		</div>
	</div>
</div>
{% endif %}
{% endblock %}

{% block js %}
	<script>
	$(document).ready(function(){
		$('#CustomerList').select2({
			placeholder: "Input Customer Name or ID *"
		});
/* 
Script Refresh Review

		$('.1').click(function(e){
			updateReview('1');
		})

		$('.2').click(function(e){
			updateReview('2');
		})

		$('.3').click(function(e){
			updateReview('3');
		})


		function updateReview(Type)
		{
			var CustomerID = $('#CustomerID').text();
			var ReviewType = Type;
			alert(ReviewType);
			$.ajax({
				url: '/Morakot/getUpdateReview',
				type: "GET",
				data:{CustomerID:CustomerID,ReviewType:ReviewType},
				beforeSend: function() {
					$('#Refresh').addClass('fa-spin');
				},
				error: function(data){
					alert('error');
				},
				success: function(data){
					$('#Refresh').removeClass('fa-spin');
					$('#ReivewDetail').find('.panel-body').html(data);
				}
			});
		}
*/
	})
	</script>
{% endblock js %}
