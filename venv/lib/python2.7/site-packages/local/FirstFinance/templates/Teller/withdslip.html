{% extends "layout.html" %}

{% block css %}
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheets/jquery.datatables.css') }}">
    <style>
		@page {
		    margin: 0.5cm 0.5cm;
		}
        h3.header-3{
            color: #888 !important;
		    font-size: 16px;
		    font-weight: bold;
		    margin: 5px 0 10px;
		    padding: 10px 18px 0;
        }

		.form-label{
			padding-top: 7px;
		}
		table.borderless td, .borderless th {
		    border: none !important;
		}
		.form-control
		{
			width: 100% !important;
		}
		table.Accinfo tr td {
			padding: 12px;
		}
		.clearfix {
			margin-top: 15px;
		}
		@media print {
			.hideprint {
				display:none;
			}

			.id_table {
				
			}
			body
			{
				margin: 0.5cm -2.5cm;
			}
		}
    </style>
{% endblock %}

{# Defined macro getFeePromo #}
{# for showing charge amount and promotion amount #}
{% macro getFeePromo(ChargeAmount,CurrSign,isDisbAment) -%}
{% for key,value in ChargeAmount.iteritems() %}
	{% set Desc	  = value['Description'] %}
	{% set Charge = value['ChargeAmount'] if value['ChargeAmount'] else 0 %}
	{% set Promo  = value['PromotionAmount'] if value['PromotionAmount'] else 0 %}
	{% if key != '102' %} {# exclude monthly charge #}
		<tr>
			<td>{{ Desc }}</td>
			<td>{{ CurrSign }} ({{ mktmoney.toMoney(float(Charge),CurrencyObj) }})</td>
		</tr>
		<tr>
			<td>&nbsp;&nbsp;&nbsp;Promotion</td>
			<td>{{ mktmoney.toMoney(float(Promo),CurrencyObj,1) }}</td>
		</tr>
	{% endif %}
{% endfor %}
{%- endmacro %}


{% block content %}
<!-- Print Button -->
<div class="navbar navbar-default navbar-static-top">
	<form method="GET" id="frm" name="frm" role="form" action="/Morakot/WithdrawalSlip/">
		<div class="col-xs-12">
			<div class="col-xs-3 col-xs-offset-9 text-right" style="margin-top:8px;">
				<div class="pull-right">				
					<a id="print" onclick="" class="btn btn-flat btn-labeled btn-success" style="margin-left: 3px">
						<span class="btn-label icon fa fa-print"></span> {{ getLanguage('Print') }}
					</a>
	            </div>
			</div>
		</div>
	</form>
</div>
<!-- /Print Button -->

	<div class="clearfix"></div>
	{% include 'error.html' %}
	<div class="container" style="width: 80%;">
	<!-- Form Input ID -->
	<div class="col-xs-12 hideprint" id="navberCriteria">
		{% include 'msg_error.html' %}
		<form action="" method="POST" role="FORM" id="generate_estimate">
			<div class="col-xs-12">
				<div class="panel colourable panel-info panel-dark" style="height: 350px;">
						<div class="panel-heading">
							<span class="panel-title"><i class="fa fa-file-text" aria-hidden="true"></i> Withdrawal Slip</span>
						</div>
						<div class="panel-body">
							<div class="form-group">
							<label class="col-sm-3">Loan Contract <span style="color:#d38e99">*</span></label>
							<div class="col-sm-8">
							   <select class="form-control" id="LoanID" name="LoanID" required="required">
									<option value=""></option>
									{% if LoanObj and LoanContract %}
									 	 {%for row in LoanObj1 %}
									 	 <option value="{{row[0].ID}}" {% if LoanObj.ID == row[0].ID %} selected="selected" {% endif %} > {{row[0].ID}} - {{row[1].LastNameEn }} {{row[1].FirstNameEn}} </option> 
									 	 {%endfor%}
									{% else %}
										{%for row in LoanObj1 %}
										<option value="{{row[0].ID}}" {{'selected' if row[0].ID == LoanID else '' }} > {{row[0].ID}} - {{row[1].LastNameEn }} {{row[1].FirstNameEn}} </option> 
										{%endfor%}
									{% endif %}
								</select>
								<script type="text/javascript">
									init.push(function () {
										// Select Account By Loan Contract ID
										$("#LoanID").select2({
											allowClear: true,
											placeholder: "Loan Contract ID"
										});
									});
								</script>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3">Other Discount <span style="color:#d38e99">*</span></label>
							<div class="col-sm-8">
								<input class="input-sm form-control" type="number" value="{{Promotion if Promotion else 0}}" placeholder="" name="Promotion" id="Promotion" required="required" min="0" step=".01" style="width:214px;">
								<script type="text/javascript">

									init.push(function () {

									});

								</script>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3">Advance - mortgage registration <span style="color:#d38e99">*</span></label>
							<div class="col-sm-8">
								<input class="input-sm form-control" type="number" value="{{AdvanceMortgage if AdvanceMortgage else 0}}" placeholder="" name="AdvanceMortgage" id="AdvanceMortgage" required="required" min="0" step=".01" style="width:214px;">
								<script type="text/javascript">

									init.push(function () {

									});

								</script>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-sm-12 form-group text-center">
							<input type="submit" id="Generate" value="Print Preview" class="btn btn-info">
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
	<!-- /Form Input ID -->
		<div id="Main">
			{% if LoanObj %}
				{% set Min_Height = "430px" %}
				{% set Max_Height = "430px" %}
				{% set Tr_ChargeRecievable = "" %}
				{% set Tr_ChargeRate = "" %}
				{% set Tr_CurrentCharge = "" %}
				{% set CurrentCharge = 0 %}
				{% set ChargeRecievable = 0 %}
				{% set ChargeRate  	 = 0 %}
				
				{% set TranDate = LoanObj.ValueDate %}
				{# {% set Reference = LoanObj.ID %} #}
				{% set CurrSign = '$' if LoanObj.Currency=='USD' else 'áŸ›' %}
				{% set Account = LoanObj.Account %}
				{% set ClientName = lookupTable('MKT_ACCOUNT','ID','AccName',Account) %}
				{% set ApprovalAmount = disbursedAmount %}
				{% set ChargeObj = getFee(ID) %}
				{% set AdvanceMortgage = AdvanceMortgage %}
				{% set Promotion = Promotion %}
				{% set TotalAmount = float(ApprovalAmount) - float(TotalCharge) - float(AdvanceMortgage) + float(TotalPromo) + float(Promotion) %}

				{% if TotalAmount >= 0 %}
					<script>
						init.push(function () {
							$('#LoanInfo .panel-body > div').slimScroll({ height: 365, alwaysVisible: true, color: '#888',allowPageScroll: true });
						})
					</script>
					<div class="col-xs-12" style="padding:0px;">
						<div class="col-xs-3" style="height: 70px;">
							<img style="max-width: 100%; max-height: 95%; margin-top: 20px;" 
								src="{{ url_for('static', filename='company/logo.png') }}">
						</div>
						<div class="col-xs-12">
									<h3 class="text-center text-bold">WITHDRAWAL SLIP</h3>
									<br>
									<br>
									<div class="row">
										<div class="col-xs-12">
											<p class="col-xs-4 col-xs-offset-8 text-bold" style="margin-left:67.666667%;">Transaction Date: {{ TransDate }}</p>
										</div><br><br>
										<div class="col-xs-12">
										<!-- Table Left -->
											<table class="borderless table">
												<tr>
													<td class="text-bold">Client Name</td>
													<td>: {{ ClientName }}</td>
												</tr>
												<tr>
													<td class="text-bold">Drawdown Account</td>
													<td>: {{ Account }}</td>
												</tr>
												<tr>
													<td class="text-bold">Loan ID</td>
													<td>: {{ ID }}</td>
												</tr>
												<tr>
													<td class="text-bold">Withdrawal Purpose</td>
													<td>: Loan Disbursement</td>
												</tr>
												<tr>
													<td class="text-bold" style="width: 22%;">Amount in Figures</td>
													<td>: {{ mktmoney.toMoney(float(TotalAmount),CurrencyObj,1) }}</td>
													<!-- <td>: {{ mktmoney.toMoney(float(ApprovalAmount),CurrencyObj,1) }}</td> -->
												</tr>
												<tr>
													<td class="text-bold">Amount in Word</td>
													<td>: {{ formatNumberToWord(mktmoney.toMoney(float(TotalAmount),CurrencyObj),lang = 'en',currency = LoanObj.Currency) | title }}</td>
													<!-- <td>: {{ formatNumberToWord(mktmoney.toMoney(float(ApprovalAmount),CurrencyObj),lang = 'en',currency = LoanObj.Currency) | title }}</td> -->
												</tr>
											</table>
										</div>
									</div>
								<div class="col-xs-12">
									<p class="text-bold">** Transaction Detail</p>
									<table class="table table-striped bordered">
										<tr>
											<td class="text-bold">Loan ID {{ ID }}</td>
											<td></td>
										</tr>
										<tr>
											<td>Disbursement Amount </td>
											<td><span>{{ mktmoney.toMoney(float(ApprovalAmount),CurrencyObj,1) }}</span></td>
										</tr>
										<!-- Fee and promotion -->
										{{getFeePromo(ChargeAmount,CurrSign,isDisbAment)}}
									<tr>
										<td>Advance - mortgage registration</td>
										<td>{{ CurrSign }} ({{ mktmoney.toMoney(float(AdvanceMortgage),CurrencyObj) }})</td>
									</tr>
									<tr>
										<td>Other Discount</td>
										<td>{{ mktmoney.toMoney(float(Promotion),CurrencyObj,1) }}</td>
									</tr>
									<tr class="text-bold">
										<td>Total:</td>
										<td><span>{{ mktmoney.toMoney(float(TotalAmount),CurrencyObj,1) }}</span></td>
									</tr>
									</table>
								</div>
						</div>
						<div class="clearfix"></div>
						<div class="clearfix"></div>
						<div class="row" style="margin-left: 15px;">
							<div class="col-xs-4">
								<p>Representative from First Finance Plc</p>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<p>..................................................</p>
								<p>Name:.........................</p>
								<p>Date:.........................</p>
							</div>
							<div class="col-xs-4 col-xs-offset-4">
								<p>Customer of First Finance Plc</p>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<div class="clearfix"></div>
								<p>..................................................</p>
								<p>Name:.........................</p>
								<p>Date:.........................</p>
							</div>
						</div>
						<script>
							init.push(function () {
								$('#AccountInfo .panel-body > div').slimScroll({ height: 330, alwaysVisible: true, color: '#888',allowPageScroll: true });
							})
						</script>
					</div>
				<div class="col-xs-12">
				</div>
				{% else %}
					<div class="col-xs-12 text-center"><i class="fa fa-check-circle text-success" style="font-size: 70px"></i></div>
					<div class="col-sm-12">
						<h1 class="header-3 text-center text-success"><span style="font-weight: bold;">Uable to Procceed.</span></h1>
					</div>
					<div class="text-default text-center"><p style="font-size: 18px;">Total Amount to Withdraw is Below 0. <b>{{ mktmoney.toMoney(float(TotalAmount),CurrencyObj,1) }}</b></p></div>
				{% endif %}	

			{% endif %}
		</div>
	</div>
{% endblock %}

{% block js %}
    <script src="{{ url_for('static',filename='javascripts/jquery.datatables.min.js') }}"></script>

{#     {% from "print.html" import exportIncludeJS %}
    {{exportIncludeJS()}} #}

    <script type="text/javascript">
        $(document).ready(function() {

            $('#mktlist').dataTable({
               "lengthMenu": [[12, 36, 48, 60,120, -1], [12, 36, 48, 60,120, "All"]],
               "bSort": false,
               // "pageLength": 12
            });

            // $('table.datatables').dataTable();

            // {% from "print.html" import exportDataTable %}
            // {{exportDataTable('#mktlist','Repayment Schedule')}}

        });

  		function fn_fadeIn(){
			var $getParentEle = window.parent.$("#animated")
			$getParentEle.fadeIn("slow");
		}
		$('#generate_estimate').on("submit",function(event) 
		{
			fn_fadeIn();
		}); 
    </script>

{% endblock %}
