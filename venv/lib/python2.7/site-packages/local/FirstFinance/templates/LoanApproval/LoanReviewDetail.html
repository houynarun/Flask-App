{% extends "layout.html" %}

{% block css %}
<style type="text/css">
	/*tr{
		height:35px;
	}*/
	.panel-group{
		margin-bottom: 5px !important;
	}
	.accordion-toggle::after {
		right: auto;
	}
	.colunm-padding {
		padding: 9px 5px 9px 10px;
	}
	.colunm-padding-first {
		padding: 9px 5px 9px 50px;
	}
	.uninstall-padding{

		display: inline-block;
		padding-left: 25px;
		padding-top: 4px;
		vertical-align: top;
	}
}
.table-borderless td,
.table-borderless th
{
	border: 0 !important;
	padding-top: 3px !important;
}

.modal-lg {
	width: 95%;
}
iframe{
	border: 0px
}

@media all and (max-width: 756px) { #ID{margin-top: 10px !important;} }
</style>
{% endblock %}

{# Macro for select product description #}
{% macro getProduct(ProductID) -%}
{%set ProductObj = Product.query.filter(Product.ID==ProductID).first() %}
{%if ProductObj %}
{{ProductObj.Description}}
{%else%}
No Product
{%endif%}
{%- endmacro %}

{# Macro for select collateral ID and description #}
{% macro getCollateral(CustomerID) -%}
{%set CollateralObj = Collateral.query.filter(Collateral.CustomerID==CustomerID).first() %}
{%if CollateralObj%}
{{CollateralObj.ID + ' - ' + CollateralObj.Description}}
{%endif%}
{%- endmacro %}

{# Macro for select customer spouse name #}
{% macro getSpouseName(CustomerID) -%}
{%set SpouseObj = TblCustomer.query.filter(TblCustomer.ID==CustomerID).first() %}
{%if SpouseObj%}
{{SpouseObj.LastNameEn + ' ' + SpouseObj.FirstNameEn}}
{%endif%}
{%- endmacro %}

{# Macro for select loan purpose description #}
{% macro getLoanPurpose(LoanPurposeID) -%}
{%set LoanPurposeObj = TblLoanPurpose.query.filter(TblLoanPurpose.ID==LoanPurposeID).first() %}
{%if LoanPurposeObj%}
{{LoanPurposeObj.Description}}
{%endif%}
{%- endmacro %}

{# Macro for select full name #}
{% macro getUserName(Inputter) -%}
{%set InputterName = User.query.filter(User.ID==Inputter).first() %}
{%if InputterName%}
{{InputterName.DisplayName}}
{%endif%}
{%- endmacro %}

{% block content %}

{# # Defined all needed variables #}
{% if LoanAppObj %}
{%set CustomerName          = CustomerObj.LastNameEn + ' ' + CustomerObj.FirstNameEn %}
{%set Currency              = LoanAppObj.Currency %}
{%set AppliedAmount         = mktmoney.toMoney(LoanAppObj.AppliedAmount|float, mktmoney.getCurrencyObj(Currency)) %}
{%set ApprovedAmount        = mktmoney.toMoney(LoanAppObj.Amount|float, mktmoney.getCurrencyObj(Currency)) %}
{%set InterestRate          = LoanAppObj.InterestRate%}
{%set LoanProduct           = LoanAppObj.LoanProduct%}
{%set Term                  = LoanAppObj.Term%}
{%set MonthlyRepToNDI       = LoanAppObj.MonthlyRepToNDI %}
{%set LVR                   = LoanAppObj.LVR %}
{%set ID                    = LoanAppObj.ID %}
{%set PreparedBy            = LoanAppObj.PreparedBy %}
{%set PreparedDate          = LoanAppObj.PreparedDate %}
{%set MainBorrower          = LoanAppObj.LNCustomerID + ' - ' + CustomerName %}
{%set CustomerID            = LoanAppObj.LNCustomerID %}
{%set SpouseID              = LoanAppObj.SpouseID %}
{%set Cycle                 = LoanAppObj.Cycle %}
{%set LoanPurposeID         = LoanAppObj.LoanPurpose%}
{%set Category              = LoanAppObj.Category%}
{%set RepaymentMode         = LoanAppObj.RepaymentMode %}
{%set FrequencyType         = LoanAppObj.FreqType%}
{%set Frequency             = LoanAppObj.Frequency%}
{%set Installment           = LoanAppObj.Installment%}

{% else %}
{# No data yet #}
{% endif %}

{# Modal reject #}
<div class="modal" id="modal_reject">
	<div class="modal-dialog modal-lg" style="width: 90%;">
		<div class="modal-content" style="background: #fff">

			{%set LoanID = ID %}

			<div class="modal-body" style="background: none;">
				<button type="button" class="close close-modal" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				
				{# ========== Load Form ============= #}
				<div class="navbar navbar-default navbar-static-top" role="navigation">
					<ul class="nav navbar-nav">
						<li>
							<a href="javascript:void(0);" id="Save"><i class="fa fa-pencil-square-o"></i>&nbsp;Save</a>
						</li>
						<li>
							<a href="javascript:void(0);" class="close-modal" data-dismiss="modal" aria-label="Close"><i class="fa fa-undo"></i>&nbsp;Cancel</a>
						</li>
						<li>
							<div class="navbar-form navbar-left">
								<div class="form-group">
									<input type="text" class="form-control" name="ID" id="ID" placeholder="Record ID" value="{{ID}}" readonly="" data-original-title="" title="">
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div class="col-sm-12" id="div-warning" style="display: none;">  
					<div class="alert alert-danger">
						<button type="button" class="close" data-dismiss="alert">Ã—</button>
						<div id="warning-msg"></div>
					</div>
				</div>
			<div class="form-horizontal">
			   <form method="POST" id="frm-rejected" name="frm" role="form" class="" action="/Morakot/LoanReviewDetail/?ID={{ID}}">
			   <input type="hidden" name="Action" id="Action-Rejected" value="3">
			   <input type="hidden" name="LoanAppID" id="LoanAppID-Rejected" value="{{ID}}">
			   <input type="hidden" name="Comment" id="Comment-Rejected">
				<div class="form-group">
					<label for="RejectBy" class="col-sm-2 control-label"><label for="RejectedBy">RejectedBy <span style="color:#d38e99">*</span></label></label>
					<div class="col-sm-10">
						<select name="RejectedBy" id="RejectedBy" class="form-control" required="">
							<option value="2">Company</option>
							<option value="1">Client</option>
						</select>
					</div>
				</div>            
				<div class="form-group">
					<label for="Reason" class="col-sm-2 control-label"><label for="Reason">Reason <span style="color:#d38e99">*</span></label></label>
					<div class="col-sm-10">
						<textarea name="RejectedReason" id="RejectedReason" cols="30" rows="10" class="form-control"></textarea>
					</div>
				</div>
				<div class="form-group">
					<label for="RejectBy" class="col-sm-2 control-label"><label for="Block">Block </label></label>
					<div class="col-sm-10">
						<select name="Block" id="Block" class="form-control">
							<option value="N">No</option>
							<option value="Y">Yes</option>
						</select>
					</div>
				</div>
				<div class="form-group">
					<label for="BlockReason" class="col-sm-2 control-label"><label for="BlockReason">Block Reason </label></label>
					<div class="col-sm-10">
						<textarea name="BlockReason" id="BlockReason" cols="30" rows="10" class="form-control"></textarea>
					</div>
				</div>
				<!-- Javascript -->
				<script>
					$(document).ready(function() {
						init.push(function () {
							$('ul.bs-tabdrop-example').tabdrop();
						});
						
							//set up date picker after adding new control
							$('#BlockDate').datepicker({
								format:"yyyy-mm-dd"
							 });//end of format.
							$('select').select2();
						})
					</script>
					<!-- / Javascript -->
				</form>
			</div>
			{# ========= /Load Form ==============#}
		</div>
	</div>

	</div>
</div>
{# /Modal reject #}

{# Modal More Detail #}
<div class="modal" id="modal_more_detail">
	<div class="modal-dialog modal-lg" style="width: 90%;">
		<div class="modal-content" style="background: #fff">
			<div class="modal-body" style="background: none;">
				<button type="button" class="close close-modal" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" >&times;</span></button>
				<iframe id="loanApp" src="/Morakot/LoanApplicationEx/Edit/{{ID}}" style="width: 100%;" frameborder="0"></iframe>
			</div>
		</div>
	</div>
</div>
{# /Modal More Detail #}

{# Horizontal Form #}
<form method="POST" id="frm" name="frm" role="form" class="">
<div class="navbar navbar-default navbar-static-top" role="navigation">
	<ul class="nav navbar-nav opt">
	{% if AccessRightDict.get('Reviewed')[0] == True and AccessRightDict.get('Comment')[0] == False %}
	<li>
		<a href="javascript:void();" id="Review"><i class="fa fa-pencil-square-o"></i>&nbsp;Review</a>
	</li>
	{% endif %}

	{% if AccessRightDict.get('Approved')[0] == True and AccessRightDict.get('Comment')[0] == False %}
	<li>
		<a href="javascript:void();" id="Approve"><i class="fa fa-pencil-square-o"></i>&nbsp;Approve</a>
	</li>
	{% endif %}

	{% if AccessRightDict.get('Rejected')[0] == True and AccessRightDict.get('Comment')[0] == False %}
	<li>
		<a href="/Morakot/GetLoanReviewBeforeReject/{{ID}}" data-toggle="modal" data-target="#modal_reject" id="Reject"><i class="fa fa-undo"></i>&nbsp;Reject</a>
	</li>
	{% endif %}
	{% if AccessRightDict.get('Comment')[0] == True %}
	<li>
		<a href="javascript:void(0);" id="BtnComment"><i class="fa fa-comment"></i>&nbsp;Comment</a>
	</li>
	{% endif %}
	{% if AccessRightDict.get('Reset')[0] == True %}
	<li>
		<a href="javascript:void(0);" id="BtnReset"><i class="fa fa-eraser"></i>&nbsp;Reset</a>
	</li>
	{% endif %}
	<li>
		<div class="navbar-form navbar-left">
			<div class="form-group">
				<input type="text" class="form-control" name="LoanAppID" id="ID" placeholder="Record ID" value="{{ID}}" readonly="" data-original-title="" title="">
				<input type="hidden" name="Action" id="Action">
			</div>
		</div>
	</li>
</ul>

</div>
{# /Horizontal Form #}

{# ===================  Form  ========================= #}

{% include 'msg_error.html' %}

<div class="form-horizontal">
	
		<div class="form-group">
			<label for="Comment" class="col-sm-2 control-label"><label for="Comment">Comment </label></label>
			<div class="col-sm-10">
				<textarea class="form-control" id="Comment" name="Comment"></textarea>
			</div>
		</div>
		<!-- Javascript -->
		<script>
		$(document).ready(function(){
			  init.push(function () {
				$('ul.bs-tabdrop-example').tabdrop();
			});
		})
	</script>
	<!-- / Javascript -->
	<div id="container_tab" class="tab-content">
		<ul class="nav nav-tabs bs-tabdrop-example" role="tablist">
			<li class="dropdown pull-right tabdrop hide"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><i class="fa fa-bars"></i> <b class="caret"></b></a><ul class="dropdown-menu"></ul>
			</li>
			<li class="active"><a data-toggle="tab" href="#1-Summary">Summary</a></li>
			<li><a data-toggle="tab" href="#2-Signature">Signatory</a></li>
			<li><a data-toggle="tab" href="#3-QuickLink">Quick Link</a></li>
		</ul>
		<div id="1-Summary" class="tab-pane fade in active "><br>
			<div id="1-Summary_1" class="mspan">
				<div class="form-group">
					<label for="MainBorrower" class="col-sm-2 control-label"><label for="MainBorrower">Main Borrower</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="MainBorrower" readonly="readonly" name="MainBorrower" type="text" value="{{MainBorrower}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="MainBorrowerSpouse" class="col-sm-2 control-label"><label for="MainBorrowerSpouse">Main Borrower Spouse</label></label>
					<div class="col-sm-10">
					{%if SpouseID %}
						<input class="form-control" id="MainBorrowerSpouse" readonly="readonly" name="MainBorrowerSpouse" type="text" value="{{SpouseID}} - {{getSpouseName(SpouseID)}}" data-original-title="" title="">
					{%else%}
						<input class="form-control" id="MainBorrowerSpouse" readonly="readonly" name="MainBorrowerSpouse" type="text" value="" data-original-title="" title="">
					{%endif%}
					</div>
				</div>
				<div class="form-group">
					<label for="Collateral" class="col-sm-2 control-label"><label for="Collateral">Collateral</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="Collateral" readonly="readonly" name="Collateral" type="text" value="{{getCollateral(CustomerID)}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="Currency" class="col-sm-2 control-label"><label for="Currency">Currency</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="Currency" readonly="readonly" name="Currency" type="text" value="{{Currency}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="AppliedAmount" class="col-sm-2 control-label"><label for="AppliedAmount">Applied Amount</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="AppliedAmount" readonly="readonly" name="AppliedAmount" type="text" value="{{AppliedAmount}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="ApprovedAmount" class="col-sm-2 control-label"><label for="ApprovedAmount">Approved Amount</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="ApprovedAmount" readonly="readonly" name="ApprovedAmount" type="text" value="{{ApprovedAmount}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="MonthlyRepToNDI" class="col-sm-2 control-label"><label for="MonthlyRepToNDI">Monthly Repayment to NDI (Main) (%)</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="MonthlyRepToNDI" readonly="readonly" name="MonthlyRepToNDI" type="text" value="{{MonthlyRepToNDI}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="LVR" class="col-sm-2 control-label"><label for="LVR">Loan to Value Ratio</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="LVR" readonly="readonly" name="LVR" type="text" value="{{LVR}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="Product" class="col-sm-2 control-label"><label for="Product">Loan Product</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="Product" readonly="readonly" name="Product" type="text" value="{{getProduct(LoanProduct)}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="LoanPurpose" class="col-sm-2 control-label"><label for="LoanPurpose">Loan Purpose</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="LoanPurpose" readonly="readonly" name="LoanPurpose" type="text" value="{{getLoanPurpose(LoanPurposeID)}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="InterestRate" class="col-sm-2 control-label"><label for="InterestRate">Interest Rate</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="InterestRate" readonly="readonly" name="InterestRate" type="text" value="{{InterestRate}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="RepaymentMode" class="col-sm-2 control-label"><label for="RepaymentMode">Repayment Mode</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="RepaymentMode" readonly="readonly" name="RepaymentMode" type="text" value="{{RepaymentMode}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="FrequencyType" class="col-sm-2 control-label"><label for="Frequency">Frequency Type</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="FrequencyType" readonly="readonly" name="FrequencyType" type="text" value="{{FrequencyType}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="Frequency" class="col-sm-2 control-label"><label for="Frequency">Frequency</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="Frequency" readonly="readonly" name="Frequency" type="text" value="{{Frequency}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="Term" class="col-sm-2 control-label"><label for="Term">Term (Month)</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="Term" readonly="readonly" name="Term" type="text" value="{{Term}}" data-original-title="" title="">
					</div>
				</div>
				<div class="form-group">
					<label for="Installment" class="col-sm-2 control-label"><label for="Installment">Installment</label></label>
					<div class="col-sm-10">
						<input class="form-control" id="Installment" readonly="readonly" name="Installment" type="text" value="{{Installment}}" data-original-title="" title="">
					</div>
				</div>
				<div class="col-sm-3 col-sm-offset-3">
					<a href="/Morakot/GetLoanReviewDetail/{{ID}}" id="detail" data-toggle="modal" data-target="#myModal" >More Detail</a>
				</div>

			</div>
		</div>
		{# Tab Signature panel #}
		<div id="2-Signature" class="tab-pane fade in"><br>
			{#{% from "LoanApproval/macro.html" import FullSignature %}
			{{ FullSignature(ApprovalObj,LoanAppObj,Action=['1','2','3','4']) }}#}
			<iframe width="100%" height="3000px" id="Iframe" frameborder="0" src="/Morakot/Signature/?ID={{ID}}&Resource=AUTH"></iframe>

		</div>
		<div id="3-QuickLink" class="tab-pane fade in"><br>
			<iframe src="/Morakot/QuickLink/?ID={{ID}}" width="100%" height="1000px"></iframe>
		</div>

	</div>
</form>
</div>

<div class="clearfix">&nbsp;</div>


{% endblock %}



{% block js %}

<script type="text/javascript">
	$(document).ready(function() {
		function fn_fadeOut(){
			var $getParentEle = window.parent.$("#animated")
			$getParentEle.fadeOut("slow");
		}
		function fn_fadeIn(){
			var $getParentEle = window.parent.$("#animated")
			$getParentEle.fadeIn("slow");
		}

		$('a#detail[data-toggle="modal"]').on("click", function(e) {
			e.preventDefault();
			var url = $(this).attr('href');
			if (url.indexOf('#') == 0) {
				return false;
			} else {
				$.get(url, function(data) {
					fn_fadeIn();
					var iFrameDetection = (window === window.parent) ? false : true;
					window.parent.$( ".is-iframe" ).remove();
					window.parent.$('<div class="modal is-iframe" data-is-iframe='+iFrameDetection+' style="overflow-y:hidden;overflow-x:hidden;">' + data + '</div>').modal();
				})
				.success(function(data) {
					fn_fadeOut();
					$('input:text:visible:first').focus();
					$('#myModal').on('hidden.bs.modal',function() {
						$('body').find('div.modal-backdrop').remove(); // Removed modal in case it does not disappear already close modal
					} )
				});
			}
		});
		// Confirm before submit
		$('a#Review').click(function(e){
			e.preventDefault();            
			bootbox.confirm({
				message: "<b>Are you sure you want to submit your review</b> ?",
				callback: function(result) {
					if(result==true){
						fn_fadeIn();
						$("#Action").val("1")
						$('#frm').submit()
					}                    
				},
				className: "bootbox-sm"
			});
		})

		$('a#Approve').click(function(e){
			e.preventDefault();            
			bootbox.confirm({
				message: "<b>Are you sure you want to submit your approve</b> ?",
				callback: function(result) {
					if(result==true){
						fn_fadeIn();
						$("#Action").val("2")
						$('#frm').submit()
					}                    
				},
				className: "bootbox-sm"
			});
		})

		$('a#BtnComment').click(function(e){
			e.preventDefault();            
			bootbox.confirm({
				message: "<b>Are you sure you want to submit your comment</b> ?",
				callback: function(result) {
					if(result==true){
						fn_fadeIn();
						$("#Action").val("4")
						$('#frm').submit()
					}                    
				},
				className: "bootbox-sm"
			});
		})

		$('a#BtnReset').click(function(e){
			e.preventDefault();            
			bootbox.confirm({
				message: "<b>Are you sure you want to reset approval</b> ?<br> It will clear all previous approval.",
				callback: function(result) {
					if(result==true){
						fn_fadeIn();
						$("#Action").val("5")
						$('#frm').submit()
					}                    
				},
				className: "bootbox-sm"
			});
		})

		// JS script for Modal
		var height = window.innerHeight;
		$('iframe#loanApp').css('height',height);

		$("#Save").on("click",function(e){
			// var ACTION_REJECTED = "3"
			// $("#Action-Rejected").val(ACTION_REJECTED);
			// $("#LoanAppID-Rejected").val($("#LoanAppID").val());
			$("#Comment-Rejected").val($("#Comment").val());

			var Reason = $("#RejectedReason").val()
			var Block  = $("#Block").val()
			var BlockReason = $("#BlockReason").val()
			
			if (Reason == ""){
				$('#div-warning').css('display','block')
				$('#warning-msg').html('<a href="#RejectedReason" class="error_pointer"><label for="RejectedReason">Reason <span style="color:#d38e99">*</span></label></a> : This field is required.')
			}
			else if (Block == "Y" && BlockReason == ""){
				$('#div-warning').css('display','block')
				$('#warning-msg').html('<a href="#BlockReason" class="error_pointer"><label for="BlockReason">Block Reason <span style="color:#d38e99">*</span></label></a> : This field is required.')
			}else{
				$("#frm-rejected").submit(); 
			}
				
		});

	});

</script>

{% endblock %}