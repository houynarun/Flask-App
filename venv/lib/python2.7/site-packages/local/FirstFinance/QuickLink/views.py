from app.mktcore.imports import *

from app.LoanApplication.models 	import *
from app.LoanContract.models 		import *
from app.LoanAmendment.models 		import *
from app.Collateral.models 			import *
from app.CBC.models					import *

@app.route('/Morakot/QuickLink/',methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getQuickLink():
	ID 	= 	request.args.get('ID') if 'ID' in request.args else '' #ID = LoanApplicationID

	CoBorrowerObj = None
	GuarantorObj  = None
	CollateralObj = None
	CollateralDetailObj = None
	ContractObj 		= None

	# find loan application ID in loan contract
	if "LC" in ID:
		LoanContract = MKT_LOAN_CONTRACT.query.get(ID)
		if not LoanContract:
			LoanContract = MKT_LOAN_CONTRACT_INAU.query.get(ID)
		if LoanContract:
			ID = LoanContract.LoanApplicationID
			ContractObj = LoanContract

	# find loan application ID in loan amendment
	if "LN" in ID:
		LoanAmendment = MKT_LOAN_AMENDMENT.query.get(ID)
		if not LoanAmendment:
			LoanAmendment = MKT_LOAN_AMENDMENT_INAU.query.get(ID)
		if LoanAmendment:
			LoanContractID = LoanAmendment.LoanID
			LoanContract = MKT_LOAN_CONTRACT.query.get(LoanContractID)
			if LoanContract:
				ID = LoanContract.LoanApplicationID
				ContractObj = LoanContract

	# if ID get from CBC
	if "CBC" in ID:
		CBC = MKT_CBC.query.get(ID)
		if CBC:
			ID = CBC.LoanAppID

	LoanObj = MKT_LOAN_APPLICATION.query.get(ID)

	if LoanObj:
		CoBorrowerObj = MKT_LOAN_CO_BORROWER.query.filter(MKT_LOAN_CO_BORROWER.ID==ID)
		GuarantorObj  = MKT_GUARANTOR.query.filter(MKT_GUARANTOR.ID==ID)
		LoanCollateralObj = MKT_LOAN_COLLATERAL.query.filter(MKT_LOAN_COLLATERAL.ID==ID).first()
		if LoanCollateralObj:
			CollateralID = LoanCollateralObj.Collateral
			CollateralObj = MKT_COLLATERAL.query.filter(MKT_COLLATERAL.ID==CollateralID)
			CollateralDetailObj = MKT_COLLATERAL_DE.query.filter(MKT_COLLATERAL_DE.CollateralID==CollateralID)

	return render_template('QuickLink/quicklink.html',
							ID=ID,
							LoanObj=LoanObj,
							CoBorrowerObj=CoBorrowerObj,
							GuarantorObj=GuarantorObj,
							CollateralObj=CollateralObj,
							CollateralDetailObj=CollateralDetailObj,
							ContractObj=ContractObj)