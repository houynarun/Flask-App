from app.mktcore.imports 			import *
from app.LoanApplication.models 	import *
from app.CheckList.models 			import *

from .forms 		import *
# from .checklist 	import *
import math

registerCRUD(admin, '/LoanContractEx', 'LoanContractEx', FRM_LOAN_CONTRACT_EX, [MKT_LOAN_CONTRACT, MKT_LOAN_CHARGE, MKT_GUARANTOR, MKT_LOAN_COLLATERAL, MKT_LOAN_CO_BORROWER,MKT_APP_STATUS])
# registerCRUD(admin, '/DisbursementCheckList', 'DisbursementCheckList', FRM_CHECKLSIT, [MKT_LOAN_CONTRACT,MKT_APP_STATUS])

@app.route('/Morakot/checklistDisb/<ID>', methods=['GET','POST'])
@app.route('/Morakot/checklistDisb', methods=['GET','POST'])
@checkLogOutSession
@checkLogOutTime
def getCheckList(ID=''):
	CheckListObj 	 =''
	if ID:
		CheckListObj = getAppStatusObj(ID)
		for row in CheckListObj:
			checklistDesc = row[1]
		percentage   = getPercentage(ID)

		return render_template('LoanContract/getCheckList.html',
								CheckListObj=CheckListObj,
								percentage=percentage)
	else:
		return render_template('LoanContract/getCheckList.html',
								lookupTable=lookupTable)

def getAppStatusObj(ID):
	CheckListObj = ''
	CheckListObj = db.session.query(MKT_APP_STATUS,MKT_CHECKLIST).join(MKT_CHECKLIST,MKT_CHECKLIST.ID==MKT_APP_STATUS.CheckList).filter(MKT_APP_STATUS.ID==ID).order_by(MKT_CHECKLIST.ID.asc()).all()
	if not CheckListObj:
		CheckListObj = db.session.query(MKT_APP_STATUS_INAU,MKT_CHECKLIST).join(MKT_CHECKLIST,MKT_CHECKLIST.ID==MKT_APP_STATUS_INAU.CheckList).filter(MKT_APP_STATUS_INAU.ID==ID).order_by(MKT_CHECKLIST.ID.asc()).all()
	return CheckListObj

def getPercentage(ID):
	percentage = 0;
	CheckListObj = ''
	checkNum = 0
	listsNum = 0

	CheckListObj = MKT_APP_STATUS.query.filter(MKT_APP_STATUS.ID==ID).all()

	if not CheckListObj:		
		checkNum = MKT_APP_STATUS_INAU.query.filter(MKT_APP_STATUS_INAU.ID==ID).count()
	else:
		checkNum = MKT_APP_STATUS.query.filter(MKT_APP_STATUS.ID==ID).count()

	listsNum = MKT_CHECKLIST.query.count()
	percentage =  math.ceil(float(checkNum * 100)/float(listsNum))

	return percentage


@app.route('/Morakot/disbchecklist',methods=['GET','POST'])
@checkLogOutSession
@checkLogOutTime
def DisbursementCheckList():

	return render_template('LoanContract/disbursementchecklist.html')
