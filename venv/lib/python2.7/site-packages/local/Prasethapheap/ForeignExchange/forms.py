from app.ForeignExchange.forms import *
from app.mktcore.imports 		import *


@checkLogOutSession
@checkLogOutTime
@app.route("/Morakot/FindExchangeRate", methods=["GET"])
def calculateExchangeRate():	
	ExchangeRate = request.args.get('Rate')	
	Rate = round(1/float(ExchangeRate))
	
	return jsonify(Rate=Rate)


@checkLogOutSession
@checkLogOutTime
@app.route("/Morakot/LoadExchangeRate", methods=["GET"])
def loadExchangeRate():
	Currency = request.args.get('DrCurrency')
	Form = request.args.get('Form')
	Rate = None

	if Currency:
		CurrencyObj = MKT_CURRENCY.query.get(Currency)
		if CurrencyObj:			
			if Form == "Buy":
				Rate = round(1/float(CurrencyObj.BuyRate))
			elif Form == "Sell":
				Rate = round(1/float(CurrencyObj.SellRate))
	
	return jsonify(Rate=Rate)


class FRM_SELL_FOREIGN_EX(FRM_SELL_FOREIGN):	
	DrAccount 		= 	TextField(requiredlabel("Dr Account", "*"))
	DrCategory 		= 	TextField(requiredlabel("Dr Category", "*"))
	DrCurrency 		= 	TextField(requiredlabel("Dr Currency", "*"))
	CrAccount 		= 	TextField(requiredlabel("Cr Account", "*"))
	CrCategory 		= 	TextField(requiredlabel("Cr Category", "*"))

	CrCurrency 		= 	QuerySelectField(requiredlabel(getLanguage("Currency"), "*"),
	                        query_factory=loadCurrency,
	                        get_label=u'ID',
	                        allow_blank=loadDefaultCurrency(),
	                        blank_text=u'--None--',
	                        validators=[validators.Required()]
                        )
	Amount 			= 	DecimalField(requiredlabel(getLanguage("Amount"), "*"), [validators.Required()], default=0)
	ExchangeRate 	= 	TextField(requiredlabel("Exchange Rate", "*"))
	FrnCurrExchangeRate = TextField("Foreign Currency Exchange Rate")
	ExchangeAmount 	= 	TextField(requiredlabel("Exchange Amount", "*"))
	Transaction 	= 	TextField(requiredlabel("Transaction", "*"))
	TranDate 		= 	DateField(requiredlabel(getLanguage("Transaction Date"), "*"), [validators.Required()], default=loadCurrentDate)
	Reference 		= 	TextField(getLanguage("Reference"))
	Note 			= 	TextAreaField(requiredlabel(getLanguage("Note"),"*"),[validators.Required()])

	
	@staticmethod
	def hotField():
		hotfield 		= []
		SuperHotField 	= super(FRM_SELL_FOREIGN_EX, FRM_SELL_FOREIGN_EX).hotField()

		fielddisplay 	= "$('#FrnCurrExchangeRate').val(data.Rate)"
		varname 		= "DrCurrency:$('#CrCurrency').val(), Form:'Sell'"
		fun 			= ['CrCurrency', varname, fielddisplay, "/Morakot/LoadExchangeRate", 'click']
		hotfield.append(fun)

		fielddisplay 	= "$('#FrnCurrExchangeRate').val(data.Rate)"
		varname 		= "Rate:$('#ExchangeRate').val()"
		fun 			= ['Amount', varname, fielddisplay, "/Morakot/FindExchangeRate", 'blur']
		hotfield.append(fun)

		fielddisplay 	= "$('#FrnCurrExchangeRate').val(data.Rate)"
		varname 		= "Rate:$('#ExchangeRate').val()"
		fun 			= ['ExchangeRate', varname, fielddisplay, "/Morakot/FindExchangeRate", 'blur']
		hotfield.append(fun)

		fielddisplay 	= "$('#FrnCurrExchangeRate').val(data.Rate)"
		varname 		= "Rate:$('#ExchangeRate').val()"
		fun 			= ['Amount', varname, fielddisplay, "/Morakot/FindExchangeRate", 'focus']
		hotfield.append(fun)

		SuperHotField.extend(hotfield)
		return SuperHotField


	@staticmethod
	def setDisable():
		SuperFields = super(FRM_SELL_FOREIGN_EX, FRM_SELL_FOREIGN_EX).setDisable()
		Fields = ['FrnCurrExchangeRate']

		SuperFields.extend(Fields)
		return SuperFields



class FRM_BUY_FOREIGN_EX(FRM_BUY_FOREIGN):
	DrAccount 		= 	TextField(requiredlabel("Dr Account", "*"))
	DrCategory 		= 	TextField(requiredlabel("Dr Category", "*"))
	DrCurrency 		= 	QuerySelectField(requiredlabel(getLanguage("Currency"), "*"),
	                        query_factory=loadCurrency,
	                        get_label=u'ID',
	                        allow_blank=loadDefaultCurrency(),
	                        blank_text=u'--None--',
	                        validators=[validators.Required()]
                        )
	CrAccount 		= 	TextField(requiredlabel("Cr Account", "*"))
	CrCategory 		= 	TextField(requiredlabel("Cr Category", "*"))
	CrCurrency 		= 	TextField(requiredlabel("Cr Currency", "*"))
	Amount 			= 	DecimalField(requiredlabel(getLanguage("Amount"), "*"), [validators.Required()], default=0)
	ExchangeRate 	= 	TextField(requiredlabel("Exchange Rate", "*"))
	FrnCurrExchangeRate = TextField("Foreign Currency Exchange Rate")
	ExchangeAmount 	= 	TextField(requiredlabel("Exchange Amount", "*"))
	Transaction 	= 	TextField(requiredlabel("Transaction", "*"))
	TranDate 		= 	DateField(requiredlabel(getLanguage("Transaction Date"), "*"), [validators.Required()], default=loadCurrentDate)
	Reference 		= 	TextField(getLanguage("Reference"))
	Note 			= 	TextAreaField(requiredlabel(getLanguage("Note"),"*"),[validators.Required()])


	@staticmethod
	def hotField():
		hotfield 		= []

		SuperHotField 	= super(FRM_BUY_FOREIGN_EX, FRM_BUY_FOREIGN_EX).hotField()

		fielddisplay 	= "$('#FrnCurrExchangeRate').val(data.Rate)"
		varname 		= "DrCurrency:$('#DrCurrency').val(), Form:'Buy'"
		fun 			= ['DrCurrency', varname, fielddisplay, "/Morakot/LoadExchangeRate", 'click']
		hotfield.append(fun)

		fielddisplay 	= "$('#FrnCurrExchangeRate').val(data.Rate)"
		varname 		= "Rate:$('#ExchangeRate').val()"
		fun 			= ['Amount', varname, fielddisplay, "/Morakot/FindExchangeRate", 'blur']
		hotfield.append(fun)

		fielddisplay 	= "$('#FrnCurrExchangeRate').val(data.Rate)"
		varname 		= "Rate:$('#ExchangeRate').val()"
		fun 			= ['ExchangeRate', varname, fielddisplay, "/Morakot/FindExchangeRate", 'blur']
		hotfield.append(fun)

		fielddisplay 	= "$('#FrnCurrExchangeRate').val(data.Rate)"
		varname 		= "Rate:$('#ExchangeRate').val()"
		fun 			= ['Amount', varname, fielddisplay, "/Morakot/FindExchangeRate", 'focus']
		hotfield.append(fun)

		SuperHotField.extend(hotfield)
		return SuperHotField


	@staticmethod
	def setDisable():
		SuperFields = super(FRM_BUY_FOREIGN_EX, FRM_BUY_FOREIGN_EX).setDisable()
		Fields = ['FrnCurrExchangeRate']

		SuperFields.extend(Fields)
		return SuperFields
