from app.LoanContract.forms 		import *
from app.LoanContract.models 		import *
from app.mktcore.wtfimports 		import *
from app.LoanApplication.models 	import *
from ..SourceIncome.models 			import *


@app.route("/Morakot/LoanApplicationInfoEx", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getLoanApplicationInfoEx():
	PFPurposeID = "__None"
	PFPurposeDesc = "--Choose PF Purpose--"
	ClientID = "0"
	ClientDesc = "New"
	ClientZoneID = "__None"
	ClientZoneDesc = "--Choose Client Zone--"
	ClientList = [('0','New'),('1','Existing')]
	ClientZoneList = [('0','Urban'),('1','Semi Urban'),('2','Rural Areas'),('3','Remote Areas')]
	try:
		LoanAppID 		= request.args.get('LoanAppID')		
		query = MKT_LOAN_APPLICATION.query.get(LoanAppID)
		if query:
			PFPurposeID = str(query.PFPurpose)
			PFPurpose = MKT_SOURCE_INCOME.query.get(PFPurposeID)		
			PFPurposeDesc = PFPurposeID + " - " +PFPurpose.LocalDescription if PFPurpose else PFPurposeDesc
			ClientID = query.Client if query.Client != '' else ClientID
			ClientDesc = ClientList[int(ClientID)][1] if ClientID !="" else ClientDesc
			ClientZoneID = query.ClientZone
			ClientZoneDesc = ClientZoneList[int(ClientZoneID)][1] if ClientZoneID != "" else ClientZoneDesc

		return jsonify(
						PFPurposeID = PFPurposeID,
						PFPurposeDesc = PFPurposeDesc,
						ClientID  = str(ClientID),
						ClientDesc = ClientDesc,
						ClientZoneID = ClientZoneID,
						ClientZoneDesc = ClientZoneDesc
					   )
	except Exception, e:
		raise


class FRM_LOAN_CONTRACT_EX(FRM_LOAN_CONTRACT):
	LoanStatus 		= 	SelectField(requiredlabel("Loan Status","*"),
							choices=[('SMT', 'Submitted'), ('APV', 'Approved'), ('DSB', 'Disbursed'), ('TPU', 'Topped-up'), ('DDT', 'Deducted'), ('TMN', 'Paid-off'), ('WOF', 'Written-off'), ('MRT', 'Matured')],
							coerce=str,
							default='SMT',
							validators=[validators.Required()]
						)
	LoanApplicationID 	= 	RemoteTextField(getLanguage("Loan Application"))
	ContractCustomerID 	= 	RemoteTextField(requiredlabel(getLanguage("Customer"), "*"), [validators.Required()])
	Account 			= 	QuerySelectField(requiredlabel(getLanguage("Drawdown Account"), "*"),
								query_factory=loadAccount,
								get_label=u'ID',
								allow_blank=False,
								blank_text=u'--None--',
								validators=[validators.Required()]
							)

	Currency 		= 	TextField(requiredlabel(getLanguage("Currency"), "*"))
	ApprovedAmount	= 	DecimalField("Approved Amount", default=0)
	Disbursed 		= 	DecimalField(requiredlabel(getLanguage("Disbursed"), "*"), [validators.Required()])
	Amount 			= 	TextField(requiredlabel(getLanguage("Loan Balance"), "*"), [validators.Required()], default=0)
	OutstandingAmount 	=	TextField(requiredlabel(getLanguage("Loan Outstanding"), "*"), [validators.Required()], default=0)
	ValueDate 		= 	DateField(requiredlabel(getLanguage("Value Date"), "*"), [validators.Required()], default=loanBankDate)
	FirstCollectionDate =	DateField("First Collection Date", [custom_FirstCollectionDate])
	Cycle 			= 	IntegerField(requiredlabel(getLanguage("Cycle"), "*"), [validators.Required()], default=1)
	MaturityDate 	= 	DateField(getLanguage("Maturity Date"), [validators.Optional()])

	LoanProduct 	= 	QuerySelectField(requiredlabel(getLanguage("Loan Product"), "*"),
							query_factory=loadLoanProduct,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							validators=[validators.Required()]
						)

	Category 		= 	TextField(requiredlabel(getLanguage("Category"), "*"), [validators.Required()])
	InterestRate 	= 	TextField(requiredlabel(getLanguage("Interest Rate"), "*"), [validators.Required()])
	IRR 			= 	TextField("IRR")
	FreqType 		= 	SelectField(requiredlabel(getLanguage("Frequency Type"), "*"),
							choices=[('1', '1. %s' %getLanguage('Monthly')), 
									 ('2', '2. %s' %getLanguage("Weekly")),
									 ('3', '3. %s' % "Daily")],
							coerce=str,
							validators=[validators.Required()]
						)

	Frequency 		= 	IntegerField(requiredlabel(getLanguage("Frequency"), "*"), [validators.Required()], default=1)
	Term 			= 	IntegerField(requiredlabel("%s (%s)" %(getLanguage("Term"), getLanguage("Month")), "*"), [validators.Required()])
	Installment 	= 	IntegerField(requiredlabel(getLanguage("Installment"), "*"), [validators.Required()])

	DeliqMode 		= 	SelectField(requiredlabel(getLanguage('Deliquency Mode'), '*'),
							choices=[('3', '3. %s' %getLanguage("Semi-Automatic")),
									 ('2', '2. %s' %getLanguage("Automatic")),
									 ('1', '1. %s' %getLanguage("Manual"))],
							coerce=str,
							validators=[validators.Required()]
						)

	LoanPurpose 	= 	QuerySelectField(requiredlabel("CBC Purpose","*"),
							query_factory=laodLoanPurpose,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							validators=[validators.Required()]
						)

	ContractVB 		= 	RemoteTextField(getLanguage("Village Bank"))
	Group 			= 	TextField(getLanguage("Group"), [validators.Optional()])

	SourceOfFund 	= 	QuerySelectField(getLanguage("Source of Fund"),
							query_factory=loadSourceOfFund,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None")
						)

	LoanType 		= 	SelectField(requiredlabel(getLanguage('Loan Type'), '*'),
							choices=[('N', '%s' %getLanguage("Normal")),
									 ('R', '%s' %getLanguage("Restructured"))],
							coerce=str,
							default='N'
						)
	
	AssetClass 		= 	TextField(requiredlabel(getLanguage("Asset Class"), "*"), [validators.Required()], default=loadAssetClass)

	MoreThanOneYear = 	TextField(requiredlabel(getLanguage("More Than One Year"), "*"), [validators.Required()], default='N')

	TotalInterest 	= 	DecimalField(getLanguage("Total Interest"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	IntIncEarned 	= 	DecimalField(getLanguage("Interest Income Earned"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrIntPerDay 	= 	DecimalField(getLanguage("Accrued Interest Per Day"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrInterest 	= 	DecimalField(getLanguage("Accrued Interest Receivable"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrCurrentInt 	= 	DecimalField(getLanguage("Accr Current Installment"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrIntCurrMonth = 	DecimalField(getLanguage("Accr Int Current Month"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	AccrIntPreMonth = 	DecimalField(getLanguage("Accr Int Previous Month"), [validators.Optional()], default=0, description="1-%s" %getLanguage("Interest"))
	Suspend 		= 	TextField(getLanguage("Suspend"), default='N', description="1-%s" %getLanguage("Interest"))
	DisbursedStat 	= 	TextField(requiredlabel(getLanguage("Disbursed Status"), "*"), [validators.Required()], default='N')

	ContractOfficerID 	= 	QuerySelectField(requiredlabel(getLanguage('Officer'),'*'),
							query_factory=loadOfficer,
							get_label=lambda a: a.ID + " - " + a.LastName + " " +a.FirstName,
							allow_blank=True,
							blank_text=u'--None--',
							validators=[validators.Required()]
						)

	ChargeKey 	= 	QuerySelectField(getLanguage("Charge Key"),
						query_factory=loadCharge,
						get_label=u'Description',
						allow_blank=True,
						blank_text=u'--None--',
						description=u'2-%s' %getLanguage("Loan Charge")
					)

	RateFixed 			= 	TextField(getLanguage("Rate") + "/" + getLanguage("Fixed"), description=u'2-%s' %getLanguage("Loan Charge"))
	Charge 				= 	TextField(getLanguage("Charge"),
								validators=[custom_Charge], 
								default=0,
								description=u'2-%s' %getLanguage("Loan Charge"))

	ChargePerInstallment= 	TextField("Charge Per Installment", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargePerDay		=   TextField("Charge Per Day", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargeLastBooked	=   TextField("Charge Last Booked", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	
	ChargeEarned 		= 	TextField("Charge Earned", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	ChargeUnearned 		= 	TextField("Charge Unearn", default=0, description=u'2-%s' %getLanguage("Loan Charge"))
	# AccrCurrent 		= 	TextField("Accr Current Installment", default=0, description=u'2-%s' %getLanguage("Loan Charge"))

	Guarantor 		= 	QuerySelectField(getLanguage("Guarantor"),
							query_factory=loadGuarantor,
							get_label=lambda a: a.ID + " - " + a.LastNameEn + " " +a.FirstNameEn,
							allow_blank=True,
							blank_text=u'--None--',
							description="3-%s" %getLanguage("Guarantor")
						)
	GTRelationIndicator = 	QuerySelectField("Relation Indicator",
							query_factory=loadRelationIndicators,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--None--',
							description="3-%s" %getLanguage("Guarantor")
						)
	Type 				= SelectField("Type",
								choices=[('G', 'Guarantor'), ('R', 'Referrer'), ('S', 'Successor')],
								coerce=str,
								default='G',
								description="3-%s" %getLanguage("Guarantor")
							)

	Penalty 		=	TextField(getLanguage("Penalty"), default='Y')

	Collateral 		= 	QuerySelectField(getLanguage("Collateral"),
							query_factory=loadCollateral,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							description="4-%s" %getLanguage("Collateral")
						)

	CoBorrowerID 	= 	QuerySelectField(getLanguage("Co-Borrower"),
							query_factory=loadCoBorrower,
							get_label=lambda a: a.ID + " - " + a.LastNameEn + " " +a.FirstNameEn,
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							description="5-%s" %getLanguage("Co-Borrower")
						)
	RelationIndicator = 	QuerySelectField("Relation Indicator",
							query_factory=loadRelationIndicators,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--None--',
							description="5-%s" %getLanguage("Co-Borrower")
						)
	Sector 			= 	QuerySelectField(requiredlabel("Sector", "*"),
							query_factory=loadSector,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							validators=[validators.Required()],
							description="6-%s" %"NBC"
						)
	Industry 		=	QuerySelectField(requiredlabel(getLanguage('Industry'),'*'),
							 query_factory=loadIndustry, 
							 get_label=lambda a: a.ID + " - " + a.Description,
							 allow_blank=True,
							 blank_text='--None--',
							 validators=[validators.Required()],
							description="6-%s" %"NBC"
					)
	Ownership 			= 	QuerySelectField(requiredlabel("Ownership", "*"),
							query_factory=loadOwnership,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							validators=[validators.Required()],
							description="6-%s" %"NBC"
					)

	@staticmethod
	def hotField():
		hotfield = []

		fielddisplay 	= "$('#ContractCustomerID').select2('data', {'id':data.LNCustomerID,'text':data.CustomerName}),$('#Amount').val(data.Amount),$('#Disbursed').val(data.Amount),$('#OutstandingAmount').val(data.Amount),$('#Installment').val(data.Installment),$('#Term').val(data.Term),$('#Frequency').val(data.Frequency)"
		fielddisplay 	+= ",$('#LoanProduct').select2('data', {'id':data.LoanProduct,'text':data.ProDesc}),$('#Category').val(data.Category),$('#InterestRate').val(data.InterestRate),$('#ContractVB').select2('data', {'id':data.VBID,'text':data.VB_Desc})"
		fielddisplay 	+= ",$('#FreqType').select2('data', {'id':data.FreqType,'text':data.FreqDesc})"
		fielddisplay 	+= ",$('#LoanPurpose').select2('data', {'id':data.LoanPurpose,'text':data.PurDesc})"		
		fielddisplay 	+= ",$('#SourceOfFund').select2('data', {'id':data.SourceOfFund,'text':data.SouDesc})"
		fielddisplay 	+= ",$('#ContractOfficerID').select2('data', {'id':data.ContractOfficerID,'text':data.OfficerName})"
		fielddisplay 	+= ",$('#Currency').val(data.Currency),$('#Group').val(data.Group),$('#ApprovedAmount').val(data.Amount)"
		fielddisplay 	+= ",$('a[href=#3-Guarantor]').attr('style', data.OnOff),$('div#3-Guarantor').attr('style', data.OnOff)"
		fielddisplay 	+= ",$('a[href=#4-Collateral]').attr('style', data.OnOff1),$('div#4-Collateral').attr('style', data.OnOff1)"
		fielddisplay 	+= ",$('#MoreThanOneYear').val(data.MoreThanOneYear)"
		# fielddisplay 	+= ",$('#Account').select2('data', {'id':data.Account,'text':data.AccountName})"
		varname 		= "LoanAppID:$('#LoanApplicationID').val()"
		fun 			= ["LoanApplicationID", varname, fielddisplay, "/Morakot/LoanApplicationInfo", "change", "ContractCustomerID" ]
		# hotfield.append(fun)
		# varname 		= "CustomerID:$('#ContractCustomerID').val()"
		# fun 			= ["LoanApplicationID", varname, fielddisplay, "/Morakot/LoanApplicationAccountInfo", "change", "ContractCustomerID" ]
		hotfield.append(fun)

		fielddisplay 	= "$('#Currency').val(data.Currency), $('#InterestRate').val(data.InterestRate)"
		varname 		= "AccountID:$('#Account').val(), LoanProduct:$('#LoanProduct').val(), LoanAppID:$('#LoanApplicationID').val()"
		fun 			= ["Account", varname, fielddisplay, "/Morakot/ContractCurrencyInfo", "change"]
		hotfield.append(fun)

		fielddisplay 	= "$('#Category').val(data.Category)"
		varname 		= "LoanProduct:$('#LoanProduct').val(), Currency:$('#Currency').val(), LoanAppID:$('#LoanApplicationID').val()"
		fun 			= ["LoanProduct", varname, fielddisplay, "/Morakot/LoanProductInfo", "change"]
		hotfield.append(fun)

		fielddisplay 	= "$('#RateFixed').val(data.RateFixed); $('#Charge').val(data.Charge)"
		fielddisplay 	+=";$('#ChargePerInstallment').val(data.ChargePerInstallment)"
		fielddisplay 	+=";$('#ChargePerDay').val(data.ChargePerDay)"
		fielddisplay 	+=";$('#ChargeEarned').val(data.ChargeEarned)"
		fielddisplay 	+=";$('#ChargeUnearned').val(data.ChargeUnearned)"
		fielddisplay 	+=";$('#ChargeLastBooked').val(data.ChargeLastBooked)"
		varname 		= "ChargeKeyID:$('#ChargeKey').val(), Currency:$('#Currency').val()"
		fun 			= ["ChargeKey", varname, fielddisplay, "/Morakot/ChargeKeyInfo", "change"]
		hotfield.append(fun)

		fielddisplay_string = "$('#Amount').val(data.Amount);"

		# if not mktloanapp.isMigrationMode():
		fielddisplay_string += "$('#OutstandingAmount').val(data.Amount);"

		fielddisplay 	= (fielddisplay_string)
		varname 		= ("Disbursed:$('#Disbursed').val(), Currency:$('#Currency').val()")
		fun 			= ["Disbursed", varname, fielddisplay, "/Morakot/SetOutStandingAmount", "blur"]
		hotfield.append(fun)

		fielddisplay_string = "$('#Disbursed').val(data.Amount);$('#Amount').val(data.Amount);"

		# if not mktloanapp.isMigrationMode():
		fielddisplay_string += "$('#OutstandingAmount').val(data.Amount);"

		fielddisplay 	= (fielddisplay_string)
		varname 		= ("Disbursed:$('#ApprovedAmount').val(), Currency:$('#Currency').val()")
		fun 			= ["ApprovedAmount", varname, fielddisplay, "/Morakot/SetOutStandingAmount", "blur"]
		hotfield.append(fun)

		fielddisplay 	= ("$('#OutstandingAmount').val(data.Amount);")
		varname 		= ("Disbursed:$('#Amount').val(), Currency:$('#Currency').val()")
		fun 			= ["Amount", varname, fielddisplay, "/Morakot/SetOutStandingAmount", "blur"]
		hotfield.append(fun)

		fielddisplay 	= ("$('#MoreThanOneYear').val(data.MoreThanOneYear)")
		varname 		= ("Term:$('#Term').val()")
		fun 			= ["Term", varname, fielddisplay, "/Morakot/CheckMoreThanOneYear", "blur"]
		hotfield.append(fun)

		fielddisplay 	= "$('#Installment').val(data.Installment);"
		varname 		= "Term:$('#Term').val(),ValueDate:$('#ValueDate').val(),FreqType:$('#FreqType').val(),Frequency:$('#Frequency').val()"
		fun 			= ["Term", varname, fielddisplay, "/Morakot/CalculateInstallment", "blur"]
		hotfield.append(fun)

		fielddisplay 	= "$('#Installment').val(data.Installment)"
		varname 		= "Term:$('#Term').val(),ValueDate:$('#ValueDate').val(),FreqType:$('#FreqType').val(),Frequency:$('#Frequency').val()"
		fun 			= ["Frequency", varname, fielddisplay, "/Morakot/CalculateInstallment", "blur"]
		hotfield.append(fun)

		# $('FreqType').val()=='3' ? $('#Installment').prop('disabled',false): $('#Installment').prop('disabled',true)
		fielddisplay 	= "$('#Installment').val(data.Installment);"
		fielddisplay 	+="$('#FreqType').val()==='3' ? $('#Installment').prop('readonly',false) : $('#Installment').prop('readonly',true);"
		varname 		= "Term:$('#Term').val(),ValueDate:$('#ValueDate').val(),FreqType:$('#FreqType').val(),Frequency:$('#Frequency').val()"
		fun 			= ["FreqType", varname, fielddisplay, "/Morakot/CalculateInstallment", "change"]
		hotfield.append(fun)

		fielddisplay 	= "$('#CoBorrowerName').val(data.CustomerName);$('#CoBorrowerID').val(data.Customer)"
		varname 		= "CoBorrowerID:$('#CoBorrowerID').val()"
		fun 			= ["CoBorrowerID", varname, fielddisplay, "/Morakot/CustomerFullNameByID", "blur"]
		hotfield.append(fun)

		fielddisplay 	= "$('#PFPurpose').select2('data', {'id':data.PFPurposeID,'text':data.PFPurposeDesc});"
		fielddisplay 	+= "$('#Client').select2('data', {'id':data.ClientID,'text':data.ClientDesc});"
		fielddisplay 	+= "$('#ClientZone').select2('data', {'id':data.ClientZoneID,'text':data.ClientZoneDesc});"

		varname 		= "LoanAppID:$('#LoanApplicationID').val()"
		fun 			= ["LoanApplicationID", varname, fielddisplay, "/Morakot/LoanApplicationInfoEx", "change"]
		hotfield.append(fun)

		return hotfield


	@staticmethod
	def isMultiValue():
		controls_list=["2-Loan Charge", "3-Guarantor", "5-Co-Borrower"]
		return controls_list
		

	@staticmethod
	def setDisable():
		field = [('FreqType')]
		SuperField = super(FRM_LOAN_CONTRACT_EX, FRM_LOAN_CONTRACT_EX).setDisable()
		SuperField.extend(field)

		return SuperField
