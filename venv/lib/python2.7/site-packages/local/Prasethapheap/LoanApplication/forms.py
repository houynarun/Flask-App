from app.LoanApplication.forms import *


class FRM_LOAN_APPLICATION_EX(FRM_LOAN_APPLICATION):
	
	LNCustomerID 	= RemoteTextField(requiredlabel(getLanguage("Customer"),"*"), [validators.Required()])
	AppDate 		= DateField(requiredlabel(getLanguage("Application Date"), "*"), [validators.Required()], default=loadCurrentDate)

	Currency 		= QuerySelectField(requiredlabel(getLanguage("Currency"), "*"),
						query_factory=loadCurrency,
						get_label=u'ID',
						allow_blank=loadDefaultCurrency(),
						blank_text=u'--%s--' %getLanguage("Currency"),
						validators=[validators.Required()]
					)

	AppliedAmount 	= TextField(requiredlabel("Applied Amount", "*"), [validators.Required()])
	Amount 			= TextField(requiredlabel("Approved Amount", "*"), [validators.Required()])
	Cycle 			= IntegerField(requiredlabel(getLanguage("Cycle"), "*"), [validators.Required()], default=1)
	LoanProduct 	= QuerySelectField(requiredlabel(getLanguage("Loan Product"), "*"),
						query_factory=loadLoanProduct,
						get_label=u'Description',
						allow_blank=True,
						blank_text=u'--%s--' %getLanguage("Choose Loan Product"),
						validators=[validators.Required()]
					)

	Category 		= TextField(requiredlabel(getLanguage("Category"), "*"), [validators.Required()])
	InterestRate 	= TextField(requiredlabel(getLanguage("Interest Rate"), "*"), [validators.Required()], default=0)

	FreqType 		= SelectField(requiredlabel(getLanguage("Frequency Type"), "*"),
						choices=[('', '--%s--' %getLanguage("None")),
								 ('1', '1. %s' %getLanguage("Monthly")), 
								 ('2', '2. %s' %getLanguage("Weekly")),
								 ('3', '3. %s' % "Daily")],
						coerce=str,
						validators=[validators.Required()],
						default='1'
					)

	Frequency 		= IntegerField(requiredlabel(getLanguage("Frequency"), "*"), [validators.Required()], default=1)
	Term 			= TextField("%s (%s)" %(getLanguage("Term"), getLanguage("Month")))
	Installment 	= TextField(getLanguage("Installment"))

	LoanPurpose 	= QuerySelectField(getLanguage("Loan Purpose"),
						query_factory=loadLoanPurpose,
						get_label=u'Description',
						allow_blank=True,
						blank_text=u'--%s--' %getLanguage("Choose Loan Purpose")
					)

	VBID 			= RemoteTextField(getLanguage("Village Bank"))
	Group 			= IntegerField(getLanguage("Group"), [validators.Optional()])

	SourceOfFund 	= QuerySelectField(getLanguage("Source of Fund"),
						query_factory=loadSourceOfFund,
						get_label=u'Description',
						allow_blank=True,
						blank_text=u'--%s--' %getLanguage("Choose Source of Fund")
					)

	AppStatus 		= SelectField(getLanguage("Status"),
						choices=[('1', '1. %s' %"Applied"), ('2', '2. %s' %"Reviewed"), ('3', '3. %s' %"Approved"), ('4', '4. %s' %"Rejected"), ('5', '5. %s' %"Cancelled"), ('6', '6. %s' %"Closed")], 
						default='1',
						coerce=str
					)


	PreparedBy 		= TextField(getLanguage("Prepared By"), default=loadUserID, description="5-%s" %getLanguage("Signatory"))
	PreparedDate 	= DateField(getLanguage("Prepared Date"), [validators.Optional()], default=loadCurrentDate, description="5-%s" %getLanguage("Signatory"))
	ReviewedBy 		= TextField(getLanguage("Reviewed By"), description="5-%s" %getLanguage("Signatory"))
	ReviewedDate 	= DateField(getLanguage("Reviewed Date"), [validators.Optional()], description="5-%s" %getLanguage("Signatory"))
	ApprovedBy 		= TextField(getLanguage("Approved By"), description="5-%s" %getLanguage("Signatory"))
	ApprovedDate 	= DateField(getLanguage("Approved Date"), [validators.Optional()], description="5-%s" %getLanguage("Signatory"))
	RejectedBy 		= TextField(getLanguage("Rejected By"), description="5-%s" %getLanguage("Signatory"))
	RejectedDate 	= DateField(getLanguage("Rejected Date"), [validators.Optional()], description="5-%s" %getLanguage("Signatory"))

	# AppStatusID = TextField(requiredlabel("ID", "*"), [validators.Required()], description="1-Check List Items")
	CheckList = QuerySelectField(getLanguage("Check List Item"),
					query_factory=loadCheckList,
					get_label=u'Description',
					allow_blank=True,
					blank_text=u'--%s--' %getLanguage("Choose Check List"),
					description="1-%s" %getLanguage("Check List Items")
				)

	YesNo = SelectField("%s/%s" %(getLanguage("Yes"), getLanguage("No")),
					choices=[('N', getLanguage('No')), ('Y', getLanguage('Yes'))],
					coerce=str,
					description="1-%s" %getLanguage("Check List Items")
				)
	YesDate = DateField(getLanguage("Yes Date"), [validators.Optional()], description="1-%s" %getLanguage("Check List Items"))

	Guarantor 		= 	QuerySelectField(getLanguage("Guarantor"),
							query_factory=loadGuarantor,
							get_label=lambda a: a.ID + " - " + a.LastNameEn + " " +a.FirstNameEn,
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							description="3-%s" %getLanguage("Guarantor")
						)
	GTRelationIndicator 		= 	QuerySelectField("Relation Indicator",
							query_factory=loadRelationIndicators,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							description="3-%s" %getLanguage("Guarantor")
						)
	Type 				= SelectField("Type",
								choices=[('G', 'Guarantor'), ('R', 'Referrer'), ('S', 'Successor')],
								coerce=str,
								default='G',
								description="3-%s" %getLanguage("Guarantor")
							)

	Collateral 		= 	QuerySelectField(getLanguage("Collateral"),
							query_factory=loadCollateral,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							description="4-%s" %getLanguage("Collateral")
						)
	
	CoBorrowerID 		= 	QuerySelectField(getLanguage("Co-Borrower"),
							query_factory=loadCoBorrower,
							get_label=lambda a: a.ID + " - " + a.LastNameEn + " " +a.FirstNameEn,
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							description="2-%s" %getLanguage("Co-Borrower")
						)
	# CoBorrowerName 		= 	TextField("Co-Borrower Name", description="2-%s" %getLanguage("Co-Borrower"))

	RelationIndicator 		= 	QuerySelectField("Relation Indicator",
							query_factory=loadRelationIndicators,
							get_label=u'Description',
							allow_blank=True,
							blank_text=u'--%s--' %getLanguage("None"),
							description="2-%s" %getLanguage("Co-Borrower")
						)


	@staticmethod
	def hotField():
		hotfield = []

		fielddisplay 	= "$('#Category').val(data.Category);"
		varname 		= "LoanProduct:$('#LoanProduct').val(),Currency:$('#Currency').val()"
		fun 			= ["LoanProduct", varname, fielddisplay, "/Morakot/LoanProductID", "change"]
		hotfield.append(fun)

		fielddisplay 	= "$('#Category').val(data.Category);"
		varname 		= "LoanProduct:$('#LoanProduct').val(),Currency:$('#Currency').val()"
		fun 			= ["Currency", varname, fielddisplay, "/Morakot/LoanProductID", "change"]
		hotfield.append(fun)

		fielddisplay 	= "$('#YesDate').val(data.YesDate)"
		varname 		= "YesNo:$('#YesNo').val()"
		fun 			= ["YesNo", varname, fielddisplay, "/Morakot/YesNo", "change"]
		hotfield.append(fun)

		fielddisplay 	= "$('#ReviewedBy').val(data.ReviewedBy),$('#ReviewedDate').val(data.ReviewedDate)"
		fielddisplay 	+= ",$('#ApprovedBy').val(data.ApprovedBy),$('#ApprovedDate').val(data.ApprovedDate)"
		fielddisplay 	+= ",$('#RejectedBy').val(data.RejectedBy),$('#RejectedDate').val(data.RejectedDate)"
		varname 		= "AppStatus:$('#AppStatus').val()"
		fun 			= ["AppStatus", varname, fielddisplay, "/Morakot/LoanAppStatus", "change"]
		hotfield.append(fun)

		fielddisplay 	= "$('#Installment').val(data.Installment)"
		varname 		= "Term:$('#Term').val(),AppDate:$('#AppDate').val(),FreqType:$('#FreqType').val(),Frequency:$('#Frequency').val()"
		fun 			= ["Term", varname, fielddisplay, "/Morakot/CalculateInstallment", "blur"]
		hotfield.append(fun)

		fielddisplay 	= ("$('#Amount').val(data.Amount);$('#Amount').focus();$('#Cycle').focus();")
		varname 		= ("Amount:$('#AppliedAmount').val()")
		fun 			= ["AppliedAmount", varname, fielddisplay, "/Morakot/LoanApprovedAmount", "blur"]
		hotfield.append(fun)

		fielddisplay 	= "$('#Installment').val(data.Installment)"
		varname 		= "Term:$('#Term').val(),AppDate:$('#AppDate').val(),FreqType:$('#FreqType').val(),Frequency:$('#Frequency').val()"
		fun 			= ["Frequency", varname, fielddisplay, "/Morakot/CalculateInstallment", "blur"]
		hotfield.append(fun)

		fielddisplay 	= "$('#Installment').val(data.Installment);"
		fielddisplay 	+= "$('#FreqType').val()==='3' ? $('#Installment').prop('readonly',false) : $('#Installment').prop('readonly',true);"
		varname 		= "Term:$('#Term').val(),AppDate:$('#AppDate').val(),FreqType:$('#FreqType').val(),Frequency:$('#Frequency').val()"
		fun 			= ["FreqType", varname, fielddisplay, "/Morakot/CalculateInstallment", "change"]
		hotfield.append(fun)

		fielddisplay 	= "$('#CoBorrowerName').val(data.CustomerName);$('#CoBorrowerID').val(data.Customer)"
		varname 		= "CoBorrowerID:$('#CoBorrowerID').val()"
		fun 			= ["CoBorrowerID", varname, fielddisplay, "/Morakot/CustomerFullNameByID", "blur"]
		hotfield.append(fun)

		return hotfield


	@staticmethod
	def setDisable():
		field = [('FreqType')]
		SuperField = super(FRM_LOAN_APPLICATION_EX, FRM_LOAN_APPLICATION_EX).setDisable()
		SuperField.extend(field)

		return SuperField

	@staticmethod
	def isMultiValue():
		controls_list=["1-Check List Items", "2-Co-Borrower", "3-Guarantor"]
		return controls_list
