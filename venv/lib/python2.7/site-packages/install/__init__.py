from flask import Flask
from flask.ext.sqlalchemy 	import SQLAlchemy
from app.config 			import *
from datetime 				import datetime, date, timedelta
import time

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = CONF.CONNECTION_STRING
db = SQLAlchemy(app)

d 			= 	datetime.now()
now 		= 	'%s-%s-%s'% (d.year, d.month, d.day)
ISODate 	= 	str(datetime.strptime(str(now), "%Y-%m-%d").date())

try:

	import create_models
	def isInstallExisting():
		from app.User.models 	import MKT_USER
		UserObj = MKT_USER.query.get('ADMIN.S')
		if UserObj:
			return True
		else:
			return False
	def createDefaultData():
		# Set Default Data
		print "[--VB--]: VB installation default configuration..."
		print "[--VB--]: Installing default bank date..."
		from app.Dates.models 	import MKT_DATES
		db_date = MKT_DATES(
						Status 			=	'AUTH',
						Curr 			=	'0',
						Inputter 		=	'System',
						Createdon 		=	ISODate,
						Authorizer		=	'System',
						Authorizeon 	=	ISODate,
						ID				=	'SYSTEM',
						Branch 			= 	'HO',
						SystemDate 		= 	ISODate)

		db.session.add(db_date)

		from app.Branch.models 	import MKT_BRANCH

		BranchEntry = MKT_BRANCH(
					Status 			=	'AUTH',
					Curr 			=	'0',
					Inputter		=	'System',
					Createdon 		=	ISODate,
					Authorizer		=	'System',
					Authorizeon		=	ISODate,
					Branch 			= 	'HO',
					ID 				=	'HO',
					Description 	=	'Head Office',
					RegisteredDate 	= 	ISODate
				 )

		db.session.add(BranchEntry)
		print "[--VB--]: Installing branch..."

		from app.Module.models 	import MKT_MODULE
		from app.Module.models 	import MKT_FORM

		ModuleEntry = MKT_MODULE(
					Status 		=	'AUTH',
					Curr 		=	'0',
					Inputter	=	'System',
					Createdon 	=	ISODate,
					Authorizer	=	'System',
					Authorizeon	=	ISODate,
					Branch 		= 	'HO',
					ID 			=	'INS',
					Description =	'Installation'
				 )

		db.session.add(ModuleEntry)
		print "[--VB--]: Installing module..."

		FormEntry = MKT_FORM(
					Status 		=	'AUTH',
					Curr 		=	'0',
					Inputter	=	'System',
					Createdon 	=	ISODate,
					Authorizer	=	'System',
					Authorizeon	=	ISODate,
					Branch 		= 	'HO',
					ID 			=	'INS',
					FormID 		=	'INS01',
					FormDesc 	=	'Restore',
					URL 		=	'Restore'
				 )

		db.session.add(FormEntry)
		print "[--VB--]: Installing form..."

		from app.Role.models 	import MKT_ROLE
		from app.Role.models 	import MKT_ACCESS

		RoleEntry = MKT_ROLE(
					Status 		=	'AUTH',
					Curr 		=	'0',
					Inputter	=	'System',
					Createdon 	=	ISODate,
					Authorizer	=	'System',
					Authorizeon	=	ISODate,
					Branch 		= 	'HO',
					ID 			=	'99',
					Description	=	'Super Admin'
				 )

		db.session.add(RoleEntry)
		print "[--VB--]: Installing role..."

		AccessEntry = MKT_ACCESS(
					Status 		=	'AUTH',
					Curr 		=	'0',
					Inputter	=	'System',
					Createdon 	=	ISODate,
					Authorizer	=	'System',
					Authorizeon	=	ISODate,
					ID 			=	'99',
					Branch 		= 	'HO',
					AccessID	=	'9901',
					Module 		=	'INS',
					Form 		=	'INS01',
					AccessRight =	'ALL'
				 )

		db.session.add(AccessEntry)
		print "[--VB--]: Installing access right..."

		from app.Menu.models 	import MKT_MENU
		from app.Menu.models 	import MKT_MENU_ITEM

		MenuEntry = MKT_MENU(
					Status 		=	'AUTH',
					Curr 		=	'0',
					Inputter	=	'System',
					Createdon 	=	ISODate,
					Authorizer	=	'System',
					Authorizeon	=	ISODate,
					Branch 		= 	'HO',
					ID 			=	'99',
					Description	=	'Administration'
				 )

		db.session.add(MenuEntry)
		print "[--VB--]: Installing menu..."

		MenuItemEntry = MKT_MENU_ITEM(
					Status 		=	'AUTH',
					Curr 		=	'0',
					Inputter	=	'System',
					Createdon 	=	ISODate,
					Authorizer	=	'System',
					Authorizeon	=	ISODate,
					Branch 		= 	'HO',
					ID 			=	'99',
					ItemID		=	'9901',
					ItemDesc 	=	'Administration',
					Icon 		=	'fa fa-gear',
					Form 		=	'INS:INS01',
					Parents 	=	'',
					Active 		=	'Y'
				 )

		db.session.add(MenuItemEntry)
		print "[--VB--]: Installing menu item..."

		from app.User.models 	import MKT_USER

		UserEntry = MKT_USER(
					Status 			=	'AUTH',
					Curr 			=	'0',
					Inputter		=	'System',
					Createdon 		=	ISODate,
					Authorizer		=	'System',
					Authorizeon		=	ISODate,
					ID 				=	'ADMIN.S',
					LogInName 		=	'ADMIN.S',
					DisplayName 	=	'Super Admin',
					StartDate 		=	ISODate,
					ExpiryDate 		=	'2025-07-03',
					PassValidity 	=	'20250703 M0730',
					Attempts 		=	'6',
					Role 			=	'99',
					Branch 			=	'HO',
					Active 			=	'Yes',
					Menu 			=	'99',
					AccessBranch 	=	'HO ALL',
					RestrictBranch 	=	'ALL',
					Notification 	=	'',
					CashAccount 	=	'')


		db.session.add(UserEntry)
		print "[--VB--]: Installing user..."

		from app.Setting.models import MKT_SETTING

		SettingEntry = MKT_SETTING(
					Status 			=	'AUTH',
					Curr 			=	'0',
					Inputter		=	'System',
					Createdon 		=	ISODate,
					Authorizer		=	'System',
					Authorizeon		=	ISODate,
					Branch 			= 	'HO',
					ID 				=	'SYSTEM',
					ATTEMPS 		=	'6',
					TIME_OUT 		=	'15',
					PASSWORD_LENGTH =	'6',
					PASSWORD_CAP 	=	'0',
					PASSWORD_NUM 	=	'0',
					PASSWORD_LOW 	=	'0',
					Notification 	=	'TRUE',
					NotificationInterval 	=	'2',
					MCODE 			= '',
					NUSER 			= '',
					EXPIRY 			= '',
			)

		db.session.add(SettingEntry)
		print "[--VB--]: Installing setting..."

		db.session.commit()
		print '[--VB--]: Configuration successfully...'
	
	if not isInstallExisting():
		createDefaultData()
	else:
		print "[--VB--]: You have already installation Morakot VB..."

except Exception, e:
	db.session.rollback()
	print e
	raise
