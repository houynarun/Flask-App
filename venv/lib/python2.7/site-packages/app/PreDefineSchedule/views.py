import json
import datetime

from app.mktcore.imports 	import *
from .forms 				import *

import app.tools.loantools.rescheduletools 		as mktschedule
import app.tools.mktdate 						as mktdate

registerCRUD(admin, '/PreDefineSchedule', 'PreDefineSchedule', FRM_PRE_DEFINE_SCHEDULE, [MKT_PRE_DEFINE_SCHEDULE],"/predefineschedule/define.html")

@app.route("/Morakot/viewGenerateSchedule", methods = ['GET','POST'])
@checkLogOutSession
@checkLogOutTime
def viewGenerateSchedule():
	RepaymentMode 			= request.args.get('RepMode',1)
	FwdBwdKey 				= request.args.get('FwdBwdKey',1)
	ValueDate 				= request.args.get('ValueDate')
	FirstInstallmentDate 	= request.args.get('FirstInstallmentDate')
	BaseDateKey 			= request.args.get('BaseDateKey',1)
	FreqType 				= request.args.get('FreqType',0)
	Frequency 				= request.args.get('Frequency',0)
	PrincipalFreq 			= request.args.get('PrincipalFreq',1)
	InterestFreq			= request.args.get('InterestFreq',1)
	WeekDay					= request.args.get('WeekDay','')
	NumOfWeek				= request.args.get('NumOfWeek','')
	ValueDate 				= ValueDate
	IRRMode 				= False if RepaymentMode != '4' else True
	DisburseAmount 			= float(1000)
	Rate 					= float(1)
	Term 					= int(12)
	InterestDayBasis 		= 2
	HolidayOption 			= 1
	Currency 				= 'USD'
	PaymentHoliday 			= 0
	NumOfHolidayInstallment = 0
	OptWaiveInterest 		= ""
	ParamCharge 			= {}
	Schedule 				= ''

	if RepaymentMode in ['1','3','4']:
		Schedule 	=	mktschedule.getScheduleDeclining(DisburseAmount,ValueDate,Rate,int(FreqType),
						int(Frequency),Term,InterestDayBasis,FwdBwdKey,
						HolidayOption,Currency,int(BaseDateKey),
						float(PrincipalFreq),float(InterestFreq),RepaymentMode,None,FirstInstallmentDate,IRRMode,PaymentHoliday,
						NumOfHolidayInstallment,OptWaiveInterest,WeekDay,NumOfWeek,ParamCharge=ParamCharge)
	elif RepaymentMode == '2':
		Schedule 	= 	mktschedule.getScheduleAnnuity(DisburseAmount,
						ValueDate,Rate,int(FreqType),
						int(Frequency),Term,Currency,Locale='KH',ParamCharge=ParamCharge)
	for item in Schedule:
		if not RepaymentMode == '2':
			item['FormatCollectionDate'] 	= mktdate.toDateShort(item['FormatCollectionDate'],'EN')
		item['CollectionDate'] 				= mktdate.toDateShort(item['CollectionDate'],'EN')

	Year 	= ''
	Month 	= ''
	Day 	= ''
	Dates 	= ValueDate

	if FirstInstallmentDate:
		Dates = FirstInstallmentDate

	Year, Month, Day 	= (int(x) for x in str(Dates).split('-'))
	WeekDays 			= mktschedule.getWeekDay(Year,Month,Day)
	NumOfWeek 			= mktschedule.getWeekofMonth(Year, Month, Day)

	return jsonify(result = Schedule,WeekDays = WeekDays, NumOfWeek = NumOfWeek)
