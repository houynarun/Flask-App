from app.mktcore.imports 	import *
from .forms 				import *
from .transfer 				import *
from .sale 					import *
from .revalue 				import *

registerCRUD(admin, '/ForeclosedProperty', 'ForeclosedProperty', FRM_FORECLOSED_PROPERTY, [MKT_FORECLOSED_PROPERTY])
registerCRUD(admin, '/TransferForeclosedProperty', 'TransferForeclosedProperty', FRM_FORECLOSED_PROPERTY_TRANSFER, [MKT_FORECLOSED_PROPERTY])
registerCRUD(admin, '/SaleForeclosedProperty', 'SaleForeclosedProperty', FRM_FORECLOSED_PROPERTY_SALE, [MKT_FORECLOSED_PROPERTY])
registerCRUD(admin, '/RevalueForeclosedProperty', 'RevalueForeclosedProperty', FRM_FORECLOSED_PROPERTY_REVALUE, [MKT_FORECLOSED_PROPERTY])
@app.route("/Morakot/getGainLossByForeclosedValue", methods=['GET'])
@app.route("/Morakot/getGainLossBySaleValue", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def GetGainLoss():
	GainLoss 		= 0
	SaleValue 		= 0 
	ForeclosedValue = 0
	SaleValue 		= request.args.get('SaleValue')
	ForeclosedValue = request.args.get('ForeclosedValue')
	Currency 		= request.args.get("Currency")
	CurrencyObj 	= MKT_CURRENCY.query.get(Currency)
	SaleValueAmount 		= globalfunction.wordAmount(SaleValue)
	ForeclosedValueAmount 	= globalfunction.wordAmount(ForeclosedValue)
	if SaleValueAmount or ForeclosedValueAmount:
		ForeclosedValue = ForeclosedValueAmount
		SaleValue 		= SaleValueAmount
	else:
		SaleValue = 0
		ForeclosedValue = 0

	GainLoss = float(SaleValue) - float(ForeclosedValue)
	GainLoss = mktmoney.toMoney(float(GainLoss), CurrencyObj)
	GainLoss = float(str(GainLoss).replace(",",""))
	return jsonify(GainLoss = GainLoss)

@app.route("/Morakot/getGainLossByPawnPrice", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def GetGainLossByPawnPrice():
	GainLoss 	= 0
	PawnPrice 	= 0 
	ForeclosedValue = 0
	PawnPrice 	= request.args.get('PawnPrice')
	ForeclosedValue = request.args.get('ForeclosedValue')
	Currency 		= request.args.get("Currency")
	CurrencyObj 	= MKT_CURRENCY.query.get(Currency)

	PawnPriceAmount 		= globalfunction.wordAmount(PawnPrice)
	ForeclosedValueAmount 	= globalfunction.wordAmount(ForeclosedValue)
	if PawnPriceAmount or ForeclosedValueAmount:
		ForeclosedValue = ForeclosedValueAmount
		PawnPrice 		= PawnPriceAmount
	else:
		PawnPrice 	    = 0
		ForeclosedValue = 0

	PawnPrice = mktmoney.toMoney(float(PawnPrice), CurrencyObj)
	ForeclosedValue = mktmoney.toMoney(float(ForeclosedValue), CurrencyObj)
	GainLoss = float(str(PawnPrice).replace(',',"")) - float(str(ForeclosedValue).replace(',',""))

	return jsonify(GainLoss = float(GainLoss))


@app.route("/Morakot/getAllCollateralInfoByID", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getAllCollateralInfoByID():
	# CollateralItemDic 	 = {}
	CurrencyDic 	  	 = {}
	ProvinceDic 	  	 = {}
	DistrictDic 	  	 = {}
	CommuneDic 		  	 = {}
	VillageDic 		  	 = {}
	OwnershipTypeDic  	 = {}
	RelationIndicatorDic = {}
	# PercentageBaseDic    =  {}
	PurchasedPrice 	  = 0
	ValuationPrice 	  = 0
	ForeclosedValue   = 0
	# MarketPrice 	  = 0
	# HotPrice 		  = 0
	# PawnPrice 		  = 0
	# PawnPercentage 	  = 0
	IssuedDate        = ""
	IssuedPlace   	  = ""
	IssuedBy 		  = ""
	CollateralNumber  = ""
	ReceivedDate	  = ""
	ReceivedBy		  = ""
	Description 	  = ""
	OwnerName 		  = ""
	OwnerSpouseName   = ""
	Valuer 			  = ""
	# ValuerInfo		  = ""
	CollateralID 	  = ""
	# OwnerPhone 		  = ""
	Status 			  = ""
	CollateralType 	  = ""

	ProvinceDic.update({"ID":"__None","Value":"--Choose Province--"})
	DistrictDic.update({"ID":"__None","Value":"--Choose District--"})
	CommuneDic.update({"ID":"__None","Value":"--Choose Commune--"})
	VillageDic.update({"ID":"__None","Value":"--Choose Village--"})

	CollateralDetailID   = request.args.get('CollateralDetailID')
	CollateralID 	   	 = request.args.get('CollateralID')
	ForeclosedPropertyID = request.args.get('ForeclosedTransferID')

	CollateralDetailObj = ""
	if ForeclosedPropertyID:
		Status 	= "Sale"
		CollateralDetailObj =  MKT_FORECLOSED_PROPERTY.query.get(ForeclosedPropertyID)
		if CollateralDetailObj:
			CollateralID = CollateralDetailObj.CollateralID
	else:
		Status 	= "Transfer"
		CollateralDetailObj = MKT_COLLATERAL_DE.query.get(CollateralDetailID)

	if CollateralDetailObj:
		# CollateralItemObj = MKT_COLLATERAL_ITEM.query.get(CollateralDetailObj.CollateralItemID)
		# if CollateralItemObj:
		# 	CollateralItemDic.update({"ID":CollateralItemObj.ID,
		# 							  "Value":CollateralItemObj.Description})
		CurrencyObj = MKT_CURRENCY.query.get(CollateralDetailObj.Currency)
		if CurrencyObj:
			CurrencyDic.update({"ID":CurrencyObj.ID,
								"Value":CurrencyObj.ID})
		if CollateralDetailObj.Province != None:
			ProvinceObj = MKT_PROVINCE.query.get(CollateralDetailObj.Province)
			if ProvinceObj:
				ProvinceDic.update({"ID":ProvinceObj.ID,
									"Value":ProvinceObj.Description})
		if CollateralDetailObj.District!=None:
			DistrictObj = MKT_DISTRICT.query.get(CollateralDetailObj.District)
			if DistrictObj:
				DistrictDic.update({"ID":DistrictObj.ID,
									"Value":DistrictObj.Description})
		if CollateralDetailObj.Commune!=None:
			CommuneObj = MKT_COMMUNE.query.get(CollateralDetailObj.Commune)
			if CommuneObj:
				CommuneDic.update({"ID":CommuneObj.ID,
								   "Value":CommuneObj.Description})
		if CollateralDetailObj.Village!=None:
			VillageObj = MKT_VILLAGE.query.get(CollateralDetailObj.Village)
			if VillageObj:
				VillageDic.update({"ID":VillageObj.ID,
								   "Value":VillageObj.Description})
		if Status == "Transfer":
			LoanCollateralObj = db.session.query(MKT_LOAN_COLLATERAL_HIST.ID).filter(MKT_LOAN_COLLATERAL_HIST.Collateral == CollateralID).\
										  order_by(MKT_LOAN_COLLATERAL_HIST.ID.desc()).first()	
			# Select record in history take before last 
			if LoanCollateralObj:
				LoanID = LoanCollateralObj.ID.split('@')[0]
				LCObj = db.session.query(MKT_LOAN_CONTRACT_HIST.OutstandingAmount).filter(MKT_LOAN_CONTRACT_HIST.ID.like(LoanID+"%")).\
										  order_by(MKT_LOAN_CONTRACT_HIST.ID.desc()).limit(2).all()
				if LCObj:
					ForeclosedValue = list(reversed(LCObj))[0].OutstandingAmount
			else:
				LoanColObj = MKT_LOAN_COLLATERAL.query.filter_by(Collateral=CollateralID).first()
				if LoanColObj:
					LOCObj = MKT_LOAN_CONTRACT.query.get(LoanColObj.ID)
					if LOCObj:
						ForeclosedValue = LOCObj.OutstandingAmount
		elif Status=="Sale":
			ForeclosedValue = CollateralDetailObj.ForeclosedValue

		if CollateralDetailObj.RelationIndicator:
			RelationIndicatorObj = MKT_RELATION_INDICATORS.query.get(CollateralDetailObj.RelationIndicator)
			if RelationIndicatorObj:
				RelationIndicatorDic.update({"ID":RelationIndicatorObj.ID,
											 "Value":RelationIndicatorObj.Description})
			else:
				RelationIndicatorDic.update({"ID":"","Value":"--None--"})
		else:
			RelationIndicatorDic.update({"ID":"","Value":"--None--"})

		if CollateralDetailObj.OwnershipType =="1":
			OwnershipTypeDic.update({"ID":"1","Value":"Owned By Customer"})
		elif CollateralDetailObj.OwnershipType =="2":
			OwnershipTypeDic.update({"ID":"2","Value":"Owned By Other"})
		else:
			OwnershipTypeDic.update({"ID":"1","Value":"Owned By Customer"})
		# [('1', '1-Hot price'),('2', '2-Purchase price'),('3', '3-Market price'),('4', '4-Valuation price')]
		# percent = str(CollateralDetailObj.PercentageBase)
		# if percent =='1':
		# 	PercentageBaseDic.update({"ID":percent,"Value":"Hot price"})
		# elif percent =='2':
		# 	PercentageBaseDic.update({"ID":percent,"Value":"Perchase price"})
		# elif percent =='3':
		# 	PercentageBaseDic.update({"ID":percent,"Value":"Market price"})
		# elif percent =='4':
		# 	PercentageBaseDic.update({"ID":percent,"Value":"Valuation price"})
		# else:
		# 	PercentageBaseDic.update({"ID":percent,"Value":"Hot price"})

		PurchasedPrice 		= CollateralDetailObj.PurchasePrice
		ValuationPrice 		= CollateralDetailObj.ValuationPrice
		# MarketPrice 		= CollateralDetailObj.MarketPrice
		# HotPrice 			= CollateralDetailObj.HotPrice
		# PawnPrice 			= CollateralDetailObj.PawnPrice
		# PawnPercentage 		= CollateralDetailObj.PawnPercentage
		IssuedDate     		= CollateralDetailObj.IssuedDate
		IssuedPlace    		= CollateralDetailObj.IssuedPlace
		IssuedBy  	   		= CollateralDetailObj.IssuedBy
		CollateralNumber	= CollateralDetailObj.CollateralNumber
		ReceivedDate   		= CollateralDetailObj.ReceivedDate
		ReceivedBy 	   		= CollateralDetailObj.ReceivedBy
		Description    		= CollateralDetailObj.Description
		OwnerName 	   		= CollateralDetailObj.OwnerName
		OwnerSpouseName		= CollateralDetailObj.OwnerSpouseName
		# OwnerPhone 			= CollateralDetailObj.OwnerPhone
		Valuer 		   		= CollateralDetailObj.Valuer
		# ValuerInfo			= CollateralDetailObj.ValuerDetail
		CollateralType 		= CollateralDetailObj.CollateralType

	return jsonify(#CollateralItem 	= CollateralItemDic,
				   Currency 		= CurrencyDic,
				   PurchasedPrice	= float(PurchasedPrice),
				   ValuationPrice 	= float(ValuationPrice),
				   # MarketPrice 		= float(MarketPrice),
				   # HotPrice 		= float(HotPrice),
				   # PawnPrice 		= float(PawnPrice),
				   # PawnPercentage 	= float(PawnPercentage),
				   IssuedDate  		= IssuedDate,
				   IssuedPlace 		= IssuedPlace,
				   IssuedBy 		= IssuedBy,
				   CollateralNumber = CollateralNumber,
				   ReceivedDate   	= ReceivedDate,
				   ReceivedBy 	   	= ReceivedBy,
				   Description    	= Description,
				   Province 		= ProvinceDic,
				   District 		= DistrictDic,
				   Commune 			= CommuneDic,
				   Village 			= VillageDic,
				   OwnerName 		= OwnerName,
				   # OwnerPhone 		= OwnerPhone,
				   OwnerSpouseName  = OwnerSpouseName,
				   OwnershipType    = OwnershipTypeDic,
				   RelationIndicator= RelationIndicatorDic,
				   Valuer 			= Valuer,
				   # ValuerInfo 		= ValuerInfo,
				   ForeclosedValue  = float(ForeclosedValue),
				   # PercentageBase   = PercentageBaseDic,
				   CollateralType   = CollateralType)

@app.route("/Morakot/getForeclosedValue", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getForeclosedValue():
	ForeclosedValue = 0
	CollateralID = request.args.get('CollateralID')
	LoanCollateralObj = MKT_LOAN_COLLATERAL.query.filter(MKT_LOAN_COLLATERAL.Collateral == CollateralID).first()
	if LoanCollateralObj:
		LCObj = MKT_LOAN_CONTRACT.query.get(LoanCollateralObj.ID)
		if LCObj: 
			ForeclosedValue = LCObj.OutstandingAmount
	return jsonify(ForeclosedValue = float(ForeclosedValue))

@app.route("/Morakot/getCollateralByCustomer", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getCollateralByCustomer():
	CollateralOwner = request.args.get('CustomerID')
	dic = {}
	result = MKT_COLLATERAL.query.filter(MKT_COLLATERAL.CustomerID == CollateralOwner).all()
	for row in  result:
		dic[row.ID] = row.ID+"-"+row.Description

	return jsonify(results=dic)

@app.route("/Morakot/getCollateralDetail", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getCollateralDetail():
	dic = {}
	CollateralID = request.args.get('CollateralID')
	result = MKT_COLLATERAL_DE.query.filter_by(CollateralID=CollateralID).all()
	for row in  result:
		# CollateralItemObj = MKT_COLLATERAL_ITEM.query.get(row.CollateralItemID)
		# if CollateralItemObj:
			# dic[row.ID] = row.ID+"-"+CollateralItemObj.Description
		dic[row.ID] = row.ID+"-"+row.CollateralType

	return jsonify(results=dic)

@app.route("/Morakot/ForeclosedOwnership", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getForeclosedOwnership():
	RelationIndicator 	= 	request.args.get('RelationIndicator')
	OwnerSpouseName 	= 	request.args.get('OwnerSpouseName')
	OwnershipType 		= 	request.args.get('OwnershipType')
	OwnerName 			= 	request.args.get('OwnerName')
	Bool 				= 	False
	
	if OwnershipType == '1':
		RelationIndicator 	= 	''
		OwnerSpouseName 	= 	''
		OwnerName 			= 	''
		Bool 				= 	True

	return jsonify(
			RelationIndicator 	= RelationIndicator,
			OwnerSpouseName 	= OwnerSpouseName,
			OwnershipType 		= OwnershipType,
			OwnerName 			= OwnerName,
			Bool 				= Bool
		)

