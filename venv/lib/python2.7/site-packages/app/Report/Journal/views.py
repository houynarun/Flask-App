from app.mktcore.imports 			import *
from app.Journal.models 			import MKT_JOURNAL
from app.Category.models 			import MKT_CATEGORY
from app.Transaction.models 		import MKT_TRANSACTION

import app.tools.mktdate 			as mktdate
import app.tools.mktmoney 			as mktmoney
import app.tools.mktreport			as mktreport

@app.route("/Morakot/Report/Journal/", methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getReportJournal():
	try:
		
		CriteriaRequired=	request.args.get('CriteriaRequired') if 'CriteriaRequired' in request.args else "Y"
		Branch			=	request.args.get('Branch') if 'Branch' in request.args else session.get('ChangeBranch')

		DicCondition 	=	{'Branch':'MKT_JOURNAL', 'TransactionDate':'MKT_JOURNAL', 'CategoryID':'MKT_JOURNAL', 'Reference':'MKT_JOURNAL', 'GL_KEYS':'MKT_JOURNAL', 'Module':'MKT_JOURNAL'}
		ListCondition 	=	['Branch', 'TransactionDate', 'CategoryID', 'Reference', 'GL_KEYS', 'Module']
		urlRequest 		=	request
		RecordObj 		=	None
		Oprs 			=	None
		kwargs 			=	{'Branch':Branch}

		# Custom Journal Report by Dr/Cr
		if CriteriaRequired == 'Y':
			QueryObj	=	None
		else:
			QueryObj 	=	db.session.query(
								MKT_JOURNAL.ID,
								MKT_JOURNAL.Description,
								MKT_JOURNAL.TransactionDate,
								MKT_JOURNAL.CategoryID,
								MKT_JOURNAL.DebitCredit,
								MKT_JOURNAL.Amount,
								MKT_JOURNAL.Currency,
								MKT_JOURNAL.Reference,
								MKT_JOURNAL.GL_KEYS,
								MKT_JOURNAL.CustomerID,
								MKT_CATEGORY.Description.label('Category'),
								MKT_TRANSACTION.Description.label('Transaction')
							).\
							join(
								MKT_CATEGORY,
								MKT_CATEGORY.ID == MKT_JOURNAL.CategoryID
							).\
							join(
								MKT_TRANSACTION,
								MKT_TRANSACTION.ID == MKT_JOURNAL.Transaction
							)

			ResultObj 		=	mktreport.getObjectReport(QueryObj, DicCondition, ListCondition, urlRequest)
			RecordObj 		=	ResultObj[1]
			Oprs 			=	ResultObj[2]
			kwargs 				=	mktreport.getValueOfCriteria(ListCondition, urlRequest)

		return render_template('report/journal/journal_seperated_by_dr_cr.html',
								RecordObj 		=	RecordObj,
								ListCondition 	=	ListCondition,
								kwargs 			=	kwargs,
								Oprs 			=	Oprs,
								float 			=	float,
								toMoney 		=	mktmoney.toMoney,
								getCurrencyObj 	=	mktmoney.getCurrencyObj,
								urlRequest 		=	urlRequest,
								CriteriaRequired=	CriteriaRequired
							)

	except Exception, e:
		raise