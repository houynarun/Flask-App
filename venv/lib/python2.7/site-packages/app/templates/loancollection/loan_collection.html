{% extends "layout.html" %}

{% block css %}
<style type="text/css">
	.header-color-collect{
		background-color: rgb(217, 237, 247);
	}
	.header-color-pd{
		background-color: rgb(249, 198, 203);
	}
	.td-disable{
		display: none;
	}
</style>
{% endblock %}

{% block content %}

{%if ErrorMsg %}
	<div class="col-sm-12" style="padding-top:5px;">
		<div class="alert alert-danger">
		<button type="button" class="close" data-dismiss="alert">&times;</button>
		{%for message in ErrorMsg %}
			{{ message }}
		{%endfor%}
		</div>
	</div>
{%else%}
	
	<div class="col-sm-12 navbar navbar-default navbar-static-top" role="navigation">
		<ul class="col-sm-7 nav navbar-nav">
			{% for items in li_html %}
				<li  {{items[1]|safe}} >
					{% if items[0]=="Save" %}
						<a href="javascript:void(0)" {{items[1]|safe}} id="{{items[0]}}"><i class='fa fa-floppy-o'></i>&nbsp;{{ getLanguage('Save') }}</a>
					{% elif items[0]=="Edit" %}
						<a href="javascript:void(0)" {{items[1]|safe}} id="{{items[0]}}"><i class='fa fa-pencil-square-o'></i>&nbsp;{{ getLanguage('Edit') }}</a>
					{% elif items[0]=="Delete" %}
						<a href="javascript:void(0)" id="Delete" {{items[1]|safe}}><i class='fa fa-trash-o'></i>&nbsp;{{ getLanguage('Delete') }}</a>
					{% elif items[0]=="Authorize" %}
						<a href="javascript:void(0)" id="Authorize" {{items[1]|safe}} ><i class='fa fa-check'></i>&nbsp;{{ getLanguage('Authorize') }}</a>
					{% elif items[0]=="Cancel" %}
						<a href="javascript:void(0)" id="Cancel" {{items[1]|safe}} ><i class='fa fa-undo'></i>&nbsp;{{ getLanguage('Cancel') }}</a>
					{% elif items[0]=="Verify" %}
						<a href="javascript:void(0)" id="Verify" {{items[1]|safe}}><i class='fa fa-pencil-square-o'></i>&nbsp;{{ getLanguage('Verify') }}</a>
					{% else %}
						<a href="javascript:void(0)" id="New" {{items[1]|safe}}><i class='fa fa-file-text-o'></i>&nbsp;{{ getLanguage('New') }}</a>
					{% endif %}
				</li>
			{% endfor %}
			<li>
				<div class="navbar-form navbar-left">
					<div class="form-group">
					<input type="text" class="form-control" name="ID" ID="ID" placeholder="Record ID"  value="{{g_id}}" {{ g_readonly }} >
					
					</div>
				</div>
			</li>
			<li>
				<div class="btn-group" style="padding: 9px 0px 0px 0px; margin-left: 15px;">
					<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">{{ getLanguage('More Action') }}</button>
					<button type="button" class="btn btn-primary" data-toggle="dropdown">
							<i class="fa fa-caret-down"></i>
					</button>
					<ul class="dropdown-menu">
							<li><a href="javascript:void(0)" onclick="copy('frm')"><i class='fa fa-files-o'></i>&nbsp;{{ getLanguage('Copy Record') }}</a></li>
							<li><a href="javascript:void(0)" onclick="paste('frm')"><i class='fa fa-clipboard'></i>&nbsp;{{ getLanguage('Paste Record') }}</a></li>
							<!-- <li><a href="javascript:void(0)" id="Reverse"><i class='fa fa-reply'></i>&nbsp;{{ getLanguage('Reverse Record') }}</a></li> -->
							<li class="divider"></li>
							<li><a href="javascript:void(0)" id="listLive" ><i class='fa fa-list'></i>&nbsp;{{ getLanguage('List Live Record') }}</a></li>
							<li><a href="javascript:void(0)" id="listAuth"><i class='fa fa-list'></i>&nbsp;{{ getLanguage('List Un-authorize Record') }}</a></li>
							<li><a href="javascript:void(0)" id="listHist"><i class='fa fa-list'></i>&nbsp;{{ getLanguage('List History Record') }}</a></li>
							
							<li class="divider"></li>

							<li><a href="javascript:void(0)" id="csv"> <i class='fa fa-files-o'></i> {{ getLanguage('Export CSV') }} </a></li> 
							<li><a href="javascript:void(0)" id="excel"> <i class='fa fa-file-excel-o'></i> {{ getLanguage('Export Excel') }} </a></li>
							<li><a href="javascript:void(0)" id="print"><i class='fa fa-print'></i>&nbsp;{{ getLanguage('Print') }}</a></li>
					</ul>
				</div>
			</li>
		</ul>
		</ul>
		{%if Form %}
		<div class="col-sm-5 nav navbar-nav">
			<ul class="nav navbar-nav" style="float: right;">
				<li class="pull-right">
					<div class="navbar-form navbar-left" style="padding:0px 10px;">
						<button type="button" id="AddMoreLoan" data-toggle="modal" {{disabled}} data-target="#modal-sizes-2" class="btn btn-flat btn-labeled btn-success" 
						id="Auto">
							<span class="btn-label icon fa fa-plus"></span>Add More Loan Contract
						</button>
					</div>
				</li>
			</ul>
		</div>
		{%endif%}
	</div>
	

	<!--  message  -->

	<div class="col-sm-12">
		{% for message in get_flashed_messages() %}
			{% if contain(message, "Error") %}
				<div class="clearfix">&nbsp;</div>
				<div class="alert alert-danger">
					<button type="button" class="close" data-dismiss="alert">&times;</button>
					{{ message }}
				</div>
			{% elif contain(message,"Warning") %}
				<div class="alert alert-warning">
				<button type="button" class="close" data-dismiss="alert">&times;</button>
					{{ message }}
				</div>
			{% else %}
				<div class="clearfix">&nbsp;</div>
				<div class="alert alert-info">
					<button type="button" class="close" data-dismiss="alert">&times;</button>
					{{ message }}
				</div>
			{% endif %}
		{% endfor %}
	</div>
	<!-- Javascript -->
	<script>

		function setCloneform(FrmFrom, FrmTo) {
			$(':input[name]', FrmFrom ).each(function() {
				Name 	= $(this).attr('name')
				ID 		= $(this).attr('id')
				Value 	= $(this).val()
				$('<input>').attr({
					type: 'hidden',
					id: ID,
					name: Name,
					value:Value
				}).appendTo(FrmTo);
				// $('[name=' + $(this).attr('name') +']', formB).val($(this).val())
			})
			$('<input>').attr({
					type: 'hidden',
					id: "ID",
					name: "ID",
					value:$("#ID").val()
				}).appendTo(FrmTo);
		}
		function fn_fadeOut(){
			var $getParentEle = window.parent.$("#animated")
			$getParentEle.fadeOut("slow");
		}
		function fn_fadeIn(){
			var $getParentEle = window.parent.$("#animated")
			$getParentEle.fadeIn("slow");
		}
		function toolbar(url){
			$("#Cancel").on("click",function(e){
				value_id=$('#ID').val()
				//$("#animated").addClass ('se-pre-con')
				fn_fadeIn();
				//$(".se-pre-con").fadeOut("slow");
				if (value_id==""){
					window.location.href=url+"/Cancel/Operation/"
				return 0;
				}
					window.location.href=url+"/Cancel/"+ value_id +"/";
				return 0;

			});
			$("#New").on("click",function(e){
				value_id=$('#ID').val()
				fn_fadeIn();
				if (value_id==""){
					window.location.href=url+"/New/Operation/"
				return 0;
				}
					window.location.href=url+"/New/"+ value_id +"/";
				return 0;
			});
			//save button
			$("#Save").on("click",function(e){
				value_id=$('#ID').val()
				fn_fadeIn();
				if (isModified()) {

				window.location.href=url+"/Cancel/"+ value_id +"/";
				return 0;
				}
				$(':focus').blur();
				// removeComma();
				setCloneform($("#frmGenerate"),$("#frm"))
				document.forms["frm"].action=url+"/";
				$('#mktlist').DataTable().destroy()
				document.forms["frm"].submit(); 
				//return false; 
			});
			//edit button
			$("#Edit").on("click",function(e){
				value_id=$('#ID').val()
				if (value_id==""){
					alert("No record to edit"); 
					return 0
				}
				fn_fadeIn();
				window.location.href=url+"/Edit/"+value_id+"/";
				//return false; 
			});
			//disable enter key from submit
			$("#ID").on("keypress", function(e) {
				$("#frm").attr("method", "post");
				$("#frm").attr("method", "get");
				if (e.keyCode == 13){
				value_id=$('#ID').val()
				if (value_id==""){
				value_id="Operation"
				}
				fn_fadeIn();
				window.location.href=url+"/?ID="+value_id;
				return false;

				}
			});
			$("#Generate").on("click", function(e) {
				// $("#frm").attr("method", "post");
				// $("#frm").attr("method", "get");
				value_id=$('#ID').val()
				if (value_id==""){
					value_id="Operation"
				}
				fn_fadeIn();
				document.forms['frmGenerate'].action=url+"/Generate/"+value_id+"/";
				document.forms['frmGenerate'].submit();
				//obj_loaded(); 
				return false;
				
			});
			
			//add link to authorize
			//Add link to delete button
			$('#Authorize').on("click",function(e){
				value_id=$('#ID').val()
				if (value_id==""){
					value_id="Operation"
				}
					fn_fadeIn();
					window.location.href=url+"/Authorize/"+value_id+"/";
			});

			//Add link to delete button
			$('#Delete').on("click",function(e){
				value_id=$('#ID').val()
				bootbox.confirm({
					message: "Are you sure to delete " +value_id+"?",
					callback: function(result) {
					if (result==true){                    
						if (value_id==""){
							value_id="Operation"
						}
							fn_fadeIn()
							window.location.href=url+"/Delete/"+value_id+"/";
						}
					},
					className: "bootbox-sm"
				});
			});
			//Add link to delete button
			$('#listLive').on("click",function(e){
				fn_fadeIn();
				window.location.href=url+"/ListLive/Operation/";
			});
			//Add link to delete button
			$('#listAuth').on("click",function(e){
				fn_fadeIn();
				window.location.href=url+"/ListAuth/Operation/";
			});
			//Add link to delete button
			$('#listHist').on("click",function(e){
				fn_fadeIn();
				window.location.href=url+"/ListHist/Operation/";
			});

			//remove delete and authorize button when record is in AUTH
			var Status = $('#Status').val()
			var searchID = $('#ID').val()

			if ( Status == "AUTH"){
				$("#Delete").remove();
				$("#Authorize").remove();
			}else if (Status =="INAU" || Status =="RNAU"){
				$("#Reverse").remove();  
			}
			//check history record
			if (searchID.indexOf("@") >0)
			{
				$("#Save").remove();
				$("#Delete").remove();
				$("#Authorize").remove();
				$("#Edit").remove();
				$("#Reverse").remove();
				$('#frm input').attr('readonly', 'readonly');
				$('#frm select').attr('disabled', 'disabled');
			}
			$('#Status').css('width','60px')
			$('#Curr').css('width','50px')
			$('#Inputter').css('width','150px')
			$('#Createdon').css('width','150px')
			$('#Authorizer').css('width','150px')
			$('#Authorizeon').css('width','150px')
			$('#Branch').css('width','150px')
		}
		function MoneyField(ID,Money,Currency){
			// code here
			$.ajax({
					url: "/Morakot/toMktmoney",
					data:{Currency:Currency,Money:Money},
					type: "GET",
					success: function(data){
						ID.text(data['value']);
						ID.val(data['value']);
					} 
				});
		}
		function isDuplicateLoanID(ID){

			if($('.LoanID_'+ID).length > 1) {
			 	//object exists
			 	return true
			}
			else {
				//object does not exists
			 	return false
			}
		}

		function setSerializeAmount(ID){

			var ObjectData = $(".totalamount").serializeArray();
			// console.log($(".moneyfield").serializeArray());
			len = ObjectData.length,
			dataObj = {};
			SumTAmount = 0
			tSumAmount = 0
			SumSAmount = 0
			sSumAmount = 0
			// for (i=0; i<len; i++) {
			// 	// dataObj[ObjectData[i].name] = ObjectData[i].value;
			// 	var value = ObjectData[i].value;
			// 	if (value!=""){
			// 		var Amount = parseFloat(value.replace(/\,/g, ""));
			// 		SumAmount+=Amount;
			// 	}
			// }

			var rows = $("#mktlist").dataTable().fnGetNodes();
			$.each(rows,function(index, row) {
				var tvalue = $(row).find('.totalamount').val();
				var svalue = $(row).find('.savingamount').val();
				if (tvalue!=""){
					try {
						var Amount = parseFloat(tvalue.replace(/\,/g, ""));
					}
					catch(err) {
						var Amount = 0
					}
					SumTAmount+=Amount;
				}
				if (svalue!=""){
					try {
						var Amount = parseFloat(svalue.replace(/\,/g, ""));
					}
					catch(err) {
						var Amount = 0
					}
					SumSAmount+=Amount;
				}

				var RepID   = $(row).find('input[class=RepID]').val();
				// var tValue = row.children[0].textContent.trim();
				var input   = 'input[id="TotalAmount_'+RepID+'"]'
				var tValue  = $(row).find(input).val();
				
				if (!tValue) {
					var tValue  = $(input).val();
				} 

				if (tValue){
					var tAmount = parseFloat(tValue.replace(/\,/g, ""));
					tSumAmount+=tAmount;
				}

			})

			var Currency = $('#Currency').val();
			var TotalAmounts = SumTAmount + SumSAmount

			MoneyField($('#TotalActualAmount'),SumTAmount,Currency);
			MoneyField($('#SumLoanIDLC'),SumTAmount,Currency);
			MoneyField($('#TotalCollection'),tSumAmount,Currency);
			MoneyField($('#SumSaving'),SumSAmount,Currency);
			MoneyField($('#TotalSaving'),SumSAmount,Currency);
			MoneyField($('#TotalAmounts'),TotalAmounts,Currency);

			$('#CountLoanID').text(len);
		}

		function setDeleteRow(ID,Title){

			oTable = $('#mktlist').dataTable();
			var aPos = oTable.fnGetPosition( $("#row_"+ID)[0] );
			bootbox.confirm({
				message: "Are you sure you want to delete "+Title+"?",
				callback: function(result) {
					if(result==true){
						
						var Currency = $('#Currency').val();
						// var Amount 		= 	parseFloat($('#Amount_'+ID).val().replace(/\,/g, ""));
						oTable.fnDeleteRow(aPos[0],null,true);
						$('#RepID_'+ID).remove();
						$('#LoanID_'+ID).remove();
						$('#Customer_'+ID).remove();
						$('#Account_'+ID).remove();
						$('#Collection_'+ID).remove();
						$('#Principal_'+ID).remove();
						$('#Interest_'+ID).remove();
						$('#Charge_'+ID).remove();
						$('#TotalAmount_'+ID).remove();
						$('#Account_'+ID).remove();
						var AmountID = $('#Amount_'+ID);
						setSerializeAmount(AmountID);
						ListRepID = ""
						$(".RepID").each(function() {
							ListRepID+=$(this).val()+" ";
						});
						$.ajax({
							url: "/Morakot/LoanCollection/Officer/",
							type: "GET",
							data:{Currency 	:$('#Currency').val(),
								Officer 	:$('#AddOfficer').val(),
								StartDate 	:$('#CollectionDateStart').val(),
								EndDate 	:$('#CollectionDateEnd').val(),
								ContractVB 	:$('#ContractVB').val(),
								VBGroup 	:$('#VBGroup').val(),
								ListRepID 	:ListRepID
							},
							success: function(data){
								$('#loadAddOfficer').html(data);
								$('#mktofficer').dataTable({
								"lengthMenu": [[100,200,300,500, -1], [100,200,300,500, "All"]],
								"bSort" : false
								});
							}
						});
					}
				},
				className: "bootbox-sm"
			});	
		}
		
		function insertRowDataTable(data){

			// var data = [
			// 	"1000010101",
			// 	"Rim sovankiry",
			// 	"DD101",
			// 	"KHR",
			// 	"2015-01-11",
			// 	"10,100",
			// 	""
			// 	];

			oTable = $('#mktlist').dataTable();
			var newRow = oTable.fnAddData(data);
			var nTr = oTable.fnSettings().aoData[ newRow[0] ].nTr;
			nTr.className = "DeleteRow"; //add class to tr
			$('td', nTr)[0].setAttribute( 'id', 'row_'+data[16] ); //add ID to td
			$('td', nTr)[0].setAttribute( "onclick", "setDeleteRow('"+data[16]+"','"+data[16]+"')" ); //add Class to td
			$('td', nTr)[5].setAttribute( "class", "td-disable" ); //add Class to td
			$('td', nTr)[6].setAttribute( "class", "td-disable" ); //add Class to td
			$('td', nTr)[7].setAttribute( "class", "td-disable" ); //add Class to td
		}
		function setAddRow(ID,isVisibleMsg, row){
			if (row) {
				var LoanID 			= $(row).find('#LoanID_'+ID).val();
			} else {
				var LoanID 			= $('#LoanID_'+ID).val();
			}

			if (isDuplicateLoanID(ID) == true){
				//already exist
				$.growl.warning({ message: LoanID+" already exists." });

			}else{

				if (row) {
					var Customer 		= $(row).find('#Customer_'+ID).val();
					var CustomerID 		= $(row).find('#CustomerID_'+ID).val();
					var Village			= $(row).find('#Village_'+ID).val();
					var Account 		= $(row).find('#Account_'+ID).val();
					var CollectionDate 	= $(row).find('#CollectionDate_'+ID).val();
					var Principal 		= $(row).find('#Principal_'+ID).val();
					var Interest 		= $(row).find('#Interest_'+ID).val();
					var Charge 			= $(row).find('#Charge_'+ID).val();
					var PDPrincipal 	= $(row).find('#PDPrincipal_'+ID).val();
					var PDInterest 		= $(row).find('#PDInterest_'+ID).val();
					var PDCharge 		= $(row).find('#PDCharge_'+ID).val();
					var Penalty 		= $(row).find('#Penalty_'+ID).val();
					var TotalAmount 	= $(row).find('#TotalAmount_'+ID).val();
					var SavingAmount 	= $(row).find('#SavingAmount_'+ID).val();
				} else {
					var Customer 		= $('#Customer_'+ID).val();
					var CustomerID 		= $('#CustomerID_'+ID).val();
					var Village			= $('#Village_'+ID).val();
					var Account 		= $('#Account_'+ID).val();
					var CollectionDate 	= $('#CollectionDate_'+ID).val();
					var Principal 		= $('#Principal_'+ID).val();
					var Interest 		= $('#Interest_'+ID).val();
					var Charge 			= $('#Charge_'+ID).val();
					var PDPrincipal 	= $('#PDPrincipal_'+ID).val();
					var PDInterest 		= $('#PDInterest_'+ID).val();
					var PDCharge 		= $('#PDCharge_'+ID).val();
					var Penalty 		= $('#Penalty_'+ID).val();
					var TotalAmount 	= $('#TotalAmount_'+ID).val();
					var SavingAmount 	= $('#SavingAmount_'+ID).val();
				}


				var TitleLoan 		= "'Loan&nbspCentre'"
				var LoanUrlLoan 	= "'{{g_getUrlExtend(Module='LoanCentre')}}/?ID="+LoanID+"'"
				
				var TitleAcc 		= "'Account Statement'"
				var LoanUrlAcc 		= "'{{g_getUrlExtend(Module='AccountStatement')}}/?ID="+Account+"'"

				var TitleCustomer 	= "'Customer'"
				var LoanUrlCus 		= "'{{g_getUrlExtend(Module='Customer')}}/?ID="+CustomerID+"'"

				var linkLoanID 		= 	'<a href="javascript:void(0)" onclick="CustomClickView('+TitleLoan+','+LoanUrlLoan+')">'+LoanID+'</a>'
				var linkAccID 		= 	'<a href="javascript:void(0)" onclick="CustomClickView('+TitleAcc+','+LoanUrlAcc+')">'+Account+'</a>'
				var linkCusID 		= 	'<a href="javascript:void(0)" onclick="CustomClickView('+TitleCustomer+','+LoanUrlCus+')">'+Customer+'</a>'

				var Action 			= 	"<a class='link'><span class='label label-danger'>Delete</span></a>"
				var ActualAmount 	= "<input type='text' data-loan='"+LoanID+"' class='form-control moneyfield totalamount' id='Amount_"+ID+"' name='Amount_"+ID+"' value='"+TotalAmount+"' {{disabled}} style=' width: 120px;'>";
				var SavingAmount 	= "<input type='text' data-loan='"+LoanID+"' class='form-control moneyfield savingamount' id='SavingAmount_"+ID+"' name='SavingAmount_"+ID+"' value='"+SavingAmount+"' {{disabled}} style='width: 120px;'>";

				$('<input>').attr({
								type: 	'hidden',
								id: 	'RepID_'+ID,
								class: 	'RepID',
								value:ID
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'LoanID_'+ID,
								name: 	'LoanID_'+ID,
								class: 	'LoanID_'+ID,
								value:LoanID
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'Customer_'+ID,
								name: 	'Customer_'+ID,
								value:Customer
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'Village_'+ID,
								name: 	'Village_'+ID,
								value:Village
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'Account_'+ID,
								name: 	'Account_'+ID,
								value:Account
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'CollectionDate_'+ID,
								name: 	'CollectionDate_'+ID,
								value:CollectionDate
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'Principal_'+ID,
								name: 	'Principal_'+ID,
								value:Principal
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'Interest_'+ID,
								name: 	'Interest_'+ID,
								value:Interest
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'Charge_'+ID,
								name: 	'Charge_'+ID,
								value:Charge
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'PDPrincipal_'+ID,
								name: 	'PDPrincipal_'+ID,
								value:PDPrincipal
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'PDInterest_'+ID,
								name: 	'PDInterest_'+ID,
								value:PDInterest
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'PDCharge_'+ID,
								name: 	'PDCharge_'+ID,
								value:PDCharge
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'Penalty_'+ID,
								name: 	'Penalty_'+ID,
								value:Penalty
								}).appendTo('#frm');
				$('<input>').attr({
								type: 	'hidden',
								id: 	'TotalAmount_'+ID,
								name: 	'TotalAmount_'+ID,
								value:TotalAmount
								}).appendTo('#frm');

				insertRowDataTable([
						Action,
						linkLoanID + ' - ' + linkAccID + ' - ' + linkCusID + ' <input class="RepID" type="hidden" value="'+ID+'">',
						CollectionDate,
						SavingAmount,
						ActualAmount,
						TotalAmount,
						Customer,
						Village,
						Account,
						Principal,
						Interest,
						Charge,
						PDPrincipal,
						PDInterest,
						PDCharge,
						Penalty,
						LoanID
					])
				
				
				if (isVisibleMsg=='True'){
					$( ".moneyfield").unbind( "blur" );
					$('.moneyfield').bind('blur', function() {
						var ID = $(this);
						var Currency = $('#Currency').val();
						Value = ID.val();
						MoneyField(ID,Value,Currency);
						setSerializeAmount(ID);
					});
					var AmountID = $('#Amount_'+ID);
					setSerializeAmount(AmountID);
					//Remove row that add
					oTable = $('#mktofficer').dataTable();
					var aPos = oTable.fnGetPosition( $("#row_"+ID)[0] );
					oTable.fnDeleteRow(aPos[0],null,true);
					$.growl.notice({ title: "Loan", message:LoanID+" was add successfully.", size: 'small' });
				}
			}

		}
		function assignValue(){
			//When generate
			if (getParameterByName){ 
				$('#Officer').val(getParameterByName("Officer"));
				$('#Currency').val(getParameterByName("Currency"));
				$('#OfficerAccount').val(getParameterByName("OfficerAccount"));
				$('#OfficerCategory').val(getParameterByName("OfficerCategory"));
				$('#CollectionDateStart').val(getParameterByName("CollectionDateStart"));
				$('#CollectionDateEnd').val(getParameterByName("CollectionDateEnd"));
				$('#ContractVB').val(getParameterByName("ContractVB"));
				$('#VBGroup').val(getParameterByName("VBGroup"));
				
			}
			//When View record
			{%if kwargs%}
				$('#Officer').val("{{kwargs['Officer']}}");
				$('#Currency').val("{{kwargs['Currency']}}");
				$('#OfficerAccount').val("{{kwargs['OfficerAccount']}}");
				$('#OfficerCategory').val("{{kwargs['OfficerCategory']}}");
				$('#CollectionDateStart').val("{{kwargs['CollectionDateStart']}}");
				$('#CollectionDateEnd').val("{{kwargs['CollectionDateEnd']}}");
				$('#ContractVB').val("{{kwargs['ContractVB']}}");
				$('#VBGroup').val("{{kwargs['VBGroup']}}");
				$('#TotalCollection').val("{{kwargs['TotalCollection']}}");
				$('#TotalActualAmount').val("{{kwargs['TotalActualAmount']}}");
				
			{%endif%}
		}
		init.push(function () {
			Action = "{{Action}}";
			ActionNoEndingSlash = Action.substring(0, Action.length - 1);
			toolbar(ActionNoEndingSlash);
			assignValue();
			$(function() {
				$('#mktlist').on('blur','.moneyfield', function() {
					var ID = $(this);
					var Currency = $('#Currency').val();
					Value = ID.val();
					MoneyField(ID,Value,Currency);
					setSerializeAmount(ID);
				});
			});
			$("#ContractVB").select2({
				placeholder:'Search ContractVB',
				minimumInputLength: 3,
				triggerChange: true,
				allowClear: true,
				ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
					url: "/Morakot/FilterVB/",
					dataType: 'json',
					data: function (term, page) {
						return {
							q: term, // search term
							Officer:$('#Officer').val(),							
							apikey: "ju6z9mjyajq2djue3gbvv26t" // please do not use so this example keeps working
						};
					},
					results: function (data, page) { // parse the results into the format expected by Select2.
						// since we are using custom formatting functions we do not need to alter remote JSON data
						return {results: data.items};
					}
				},
				initSelection: function(element, callback) {
					// the input tag has a value attribute preloaded that points to a preselected movie's id
					// this function resolves that id attribute to an object that select2 can render
					// using its formatResult renderer - that way the movie name is shown preselected
					var id=$(element).val();
					var Officer = $('#Officer').val();
					if (id!=="") {
						$.ajax("/Morakot/FilterVB/?Officer="+ Officer +"&q="+id, {
							data: {
								apikey: "ju6z9mjyajq2djue3gbvv26t"
							},
							dataType: "json"
						}).done(function(data) { callback({id: id, text: data.items[0].text}); });
					}
				}
			});
			$("#VBGroup").select2({
				placeholder:'Search Group',
				minimumInputLength: 3,
				triggerChange: true,
				allowClear: true,
				ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
					url: "/Morakot/FilterGroup/",
					dataType: 'json',
					data: function (term, page) {
						return {
							q: term, // search term
							VBID:$('#ContractVB').val(),							
							apikey: "ju6z9mjyajq2djue3gbvv26t" // please do not use so this example keeps working
						};
					},
					results: function (data, page) { // parse the results into the format expected by Select2.
						// since we are using custom formatting functions we do not need to alter remote JSON data
						return {results: data.items};
					}
				},
				initSelection: function(element, callback) {
					// the input tag has a value attribute preloaded that points to a preselected movie's id
					// this function resolves that id attribute to an object that select2 can render
					// using its formatResult renderer - that way the movie name is shown preselected
					var id=$(element).val();
					var VBID = $('#ContractVB').val();
					if (id!=="") {
						$.ajax("/Morakot/FilterGroup/?view=yes&VBID="+ VBID +"&q="+id, {
							data: {
								apikey: "ju6z9mjyajq2djue3gbvv26t"
							},
							dataType: "json"
						}).done(function(data) { callback({id: id, text: data.items[0].text}); });
					}
				}
			});

			$(function() {

				$('#AddAll').bind('click', function() {
					fn_fadeIn();
					setTimeout(function () {
						ID=""

						// $(".AddRepID").each(function() {
						// 	ID = $(this).val();
						// 	setAddRow(ID,'False');
						// });

						var rows = $("#mktofficer").dataTable().fnGetNodes();
						$.each(rows,function(index, row) {
							var ID = $(row).find('.AddRepID').val();
							setAddRow(ID,'False', row);
						});
							
						$.growl.notice({ title: "Loan", message:"All loan contract was add successfully.", size: 'small' });
						$( ".moneyfield").unbind( "blur" );
						$('.moneyfield').bind('blur', function() {
							var ID = $(this);
							var Currency = $('#Currency').val();
							Value = ID.val();
							MoneyField(ID,Value,Currency);
							setSerializeAmount(ID);
						});
						var AmountID = $('#Amount_'+ID);
						setSerializeAmount(AmountID);
						//Remove row that add
						var table = $('#mktofficer').DataTable();
						table.clear().draw();
						
					}, 1000); // 1000 ==> 1 second
					fn_fadeOut();
				});
			});
			// $(function() {
			// 	$('.moneyfield').bind('click', function() {
			// 		alert("click moneyfield")
			// 		$( ".moneyfield").unbind( "blur" );
			// 		$(function() {
			// 			$('.moneyfield').bind('blur', function() {
			// 				var ID = $(this);
			// 				var Currency = $('#Currency').val();
			// 				Value = ID.val();
			// 				MoneyField(ID,Value,Currency);
			// 				setSerializeAmount(ID);
			// 			});
			// 		});
			// 	});
			// });
			
		});	
	</script>
	<!-- / Javascript -->
	{%if Form%}

		<!-- Large modal loan ccollection -->
		<div id="modal-sizes-2" class="modal fade" tabindex="-1" role="dialog" style="display: none;">
			<div class="modal-dialog modal-lg" style="width:90%;">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
						<h4 class="modal-title">Add More Loan Contract</h4>
					</div>
					<div class="modal-body" >

						<div class="form-group">
							<label for="AddOfficer" class="col-sm-2 control-label">Add Officer</label>
							<div class="col-sm-10">
								<div class="col-sm-6">
									<select id="AddOfficer" class="form-control" name="AddOfficer" {{disabled}} >
										<option value="">--{{ getLanguage('None') }}--</option>
										{%for row in OfficerObj%}
											<option value="{{row.ID}}" >{{row.ID}} - {{row.LastName}} {{row.FirstName}}</option>
										{%endfor%}
									</select>
								</div>
								<div class="col-sm-6 text-right">
									<button type="button" id="AddAll" {{disabled}}  class="btn btn-flat btn-labeled btn-success" disabled="disabled" 
									id="Auto">
										<span class="btn-label icon fa fa-plus"></span>Add All
									</button>
									
								</div>
								<script type="text/javascript">
									init.push(function () {
										// Single select
										$("#AddOfficer").select2({
											allowClear: true,
											placeholder: "AddOfficer"
										});
										$(function() {
											$('#AddOfficer').bind('change', function() {
												ListRepID = ""
												$(".RepID").each(function() {
													ListRepID+=$(this).val()+" ";
												});
												$.ajax({
													url: "/Morakot/LoanCollection/Officer/",
													type: "GET",
													data:{Currency 	:$('#Currency').val(),
														Officer 	:$('#AddOfficer').val(),
														StartDate 	:$('#CollectionDateStart').val(),
														EndDate 	:$('#CollectionDateEnd').val(),
														ContractVB 	:$('#ContractVB').val(),
														VBGroup 	:$('#VBGroup').val(),
														ListRepID 	:ListRepID
													},
													beforeSend: function() {
														fn_fadeIn();
													},
													success: function(data){
														fn_fadeOut();
														$('#loadAddOfficer').html(data);
														$('#mktofficer').dataTable({
														// "lengthMenu": [[25,50,100,200, -1], [25,50,100,200, "All"]],
														"lengthMenu": [[100,200,300,500, -1], [100,200,300,500, "All"]],
														"bSort" : false
														});
													}
												});

											});
										});
									});
								</script>
							</div>
						</div> <!-- / .form-group -->
						
						<div class="form-group">
							<div id="loadAddOfficer" class="table-responsive">
								<table id="mktofficer"  class="table table-striped table" cellspacing="0" width="100%">
								<thead>
									<tr>
										<th></th>
										<th></th>
										<th></th>
										<th></th>
										<th></th>
										<th style="display: none;"></th>
										<th style="display: none;"></th>
										<th style="display: none;"></th>
										<th style="display: none;"></th>
										<th colspan="3" class="text-center header-color-collect">Loan Collection</th>
										<th colspan="4" class="text-center header-color-pd">Past Due</th>
									</tr>
									<tr>
										{#{%if VisibleReference %}
										<th>{{ getLanguage('Reference') }}</th>
										{%endif%}
										{%if not disabled%}#}
										<th class="ActionFotter">{{ getLanguage('Action') }}</th>
										{#{%endif%}#}
										<th>Loan ID - Account - Customer</th>
										<th>Collection Date</th>
										<th style="display: none;">ContractCustomerID</th>
										<th style="display: none;">Account</th>
										<th style="display: none;">Village</th>
										<th style="display: none;">Saving Amount</th>
										<th>Actual Amount</th>
										<th>Total Amount</th>

										<th class="header-color-collect">Principal</th>
										<th class="header-color-collect">Interest</th>
										<th class="header-color-collect">Charge</th>

										<th class="header-color-pd">PD Principal</th>
										<th class="header-color-pd">PD Interest</th>
										<th class="header-color-pd">PD Charge</th>
										<th class="header-color-pd">Penalty</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
								<tfoot>
								</tfoot>
							</table>
							</div>
						</div> <!-- / .form-group -->
						
					</div>
				</div> <!-- / .modal-content -->
			</div> <!-- / .modal-dialog -->
		</div> <!-- / .modal -->
		<!-- / Large modal -->

		<div class="col-sm-12">
		<!-- <h3 class="header-3 text-center" style="padding-bottom:40px;">Generate Disbursement Sheet for {{ g_id }} </h3> -->
		{% if FieldRequired %}
		<div class="alert alert-danger" id="alert-danger">
			<button type="button" class="close" data-dismiss="alert">&times;</button>
			<ol>
				{% for message in FieldRequired %}
				<li id="lblTableName">
					<a class="error_pointer">
						<label for="TableName">
							{{message[0]}} <span style="color:#d38e99">*:</span>
						</label>

					</a> {{message[1]}}
				</li>		
				{% endfor %}
			</ol>
		</div>
		{% endif %}

		<form action="{{Action}}" id="frmGenerate"  method="GET">
		<!-- <div class="col-sm-1"></div> -->
		<div class="col-sm-6 row" style="padding-top:10px;">
				<div class="row form-group">
					<label class="col-sm-3 control-label">
						<label for="ValueDate">

							{{ getLanguage('Officer') }}
							<span style="color:#d38e99">*</span>
						</label>
					</label>
					<div class="col-sm-9">
						<select id="Officer" class="form-control" name="Officer" {{disabled}} >
							<option value="">--{{ getLanguage('None') }}--</option>
							{%for row in OfficerObj%}
								<option value="{{row.ID}}" >{{row.ID}} - {{row.LastName}} {{row.FirstName}}</option>
							{%endfor%}
						</select>
						<script type="text/javascript">
							init.push(function () {
								// Single select
								$("#Officer").select2({
									allowClear: true,
									placeholder: "Officer"
								});
							});
						</script>
					</div>
				</div>
				<div class="row form-group">
					<label class="col-sm-3 control-label">
						<label for="ValueDate">
							{{ getLanguage('Currency') }}
							<span style="color:#d38e99">*</span>
						</label>
					</label>
					<p style="display: none;" id='DefaultCurrency'>{{DefaultCurrency}}</p>
					<div class="col-sm-9">
						<select id="Currency" class="form-control" name="Currency" {{disabled}} style="width: 220px;">
							<option  value="">--{{ getLanguage('None') }}--</option>
							{%for row in CurrencyObj%}
								<option value="{{row.ID}}">{{row.ID}}</option>
							{%endfor%}
						</select>
						<script type="text/javascript">
							init.push(function () {
								// Single select
								var DCurrency = $('#DefaultCurrency').text()
								$('#Currency').val(DCurrency).trigger('change')
								$("#Currency").select2({
									allowClear: true,
									placeholder: "--None--"
								});
							});
						</script>
					</div>
				</div>

				<div class="row form-group">
					<label class="col-sm-3 control-label" for="OfficerAccount">{{ getLanguage('Officer Account') }}</label>
					<div class="col-sm-8" >
						<input type="text" class="form-control" id="OfficerAccount" value="" name="OfficerAccount" readonly="readonly" style="width: 220px;"> 
					</div>
				</div>

				<div class="row form-group">
					<label class="col-sm-3 control-label">
						<label for="CollectionDate">
							{{ 'Collection Date' }}
							<span style="color:#d38e99">*</span>
						</label>
					</label>
					<div class="col-sm-9">
						<div class="input-daterange input-group" style="width: 68%;" id="bs-datepicker-range">
							<input type="text" id="CollectionDateStart" {{disabled}} class="input-sm form-control" name="CollectionDateStart" value="{{BankDate}}" placeholder="{{ getLanguage('Start Date') }}">
							<span class="input-group-addon">{{ getLanguage('to') }}</span>
							<input type="text" id="CollectionDateEnd" {{disabled}} class="input-sm form-control" name="CollectionDateEnd" placeholder="{{ getLanguage('End Date') }}">
						</div>

						<!-- <input id="ValueDate" class="form-control" type="text" value="2015-08-03" name="ValueDate" style="width: 214px;"> -->
						<script type="text/javascript">
                            $(document).ready(function() {
                                $($(".input-sm").click(function(evt){
                                    $(this).attr("id");
                                })).datepicker({
                                        format:"yyyy-mm-dd"
                                }).on("change", function(){
                                    var date = $(this).val().split(/[.,\/\\ -]/g);
                                    if(date[0].length <= 2){
                                        date = date.reverse()
                                    }
                                    for (i=1; i<=2; i++){
                                        if (parseInt(date[i]) < 11 && date[i].length == 1){
                                            date[i] = "0"+ date[i];
                                        }  
                                    }
                                    $(this).val(date.join("-"));

                                });
                                
                            });
						</script>
					</div>
				</div>		
				<div class="row form-group">
					<label class="col-sm-3 control-label">
					<label for="VillageBank">
							{{' Village Bank/Centre'}}
						</label>
					</label>
					<div class="col-sm-9">
						<input type="text" id="ContractVB" name="ContractVB" value="{{VBID}}" class="form-control" {{disabled}} style="width:260px !importance ">
					</div>
				</div>
				<div class="row form-group">
					<label class="col-sm-3 control-label">
						<label for="VillageBank">
							{{ getLanguage('Group') }}
						</label>
					</label>
					<div class="col-sm-9">
						<!-- <input type="text" id="VBGroup" class="form-control" style="width:260px !importance"> -->
						<input type="text" id="VBGroup" name="VBGroup" value="{{Group}}" class="form-control" {{disabled}} style="width:260px !importance" >
					</div>
				</div>
		</div>
		<div class="col-sm-6 row " style="padding-top:10px;">
				<div class=" form-group">
					<label class="col-sm-4 control-label" for="OfficerCategory">{{ getLanguage('Officer Category') }}</label>
					<div class="col-sm-6" >
						<input id="OfficerCategory" class="form-control" type="text" value="" name="OfficerCategory" readonly="readonly" style="width: 180px;"> 
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-4 control-label" for="TotalCollection">{{ getLanguage('Total Collection') }}</label>
					<div class="col-sm-6">
						<input id="TotalCollection" name="TotalCollection" class="form-control" type="text" value="{{TotalCollection}}" readonly="readonly" >
					</div>
				</div>

				<div class=" form-group">
					<label class="col-sm-4 control-label" for="TotalActualAmount">{{ getLanguage('Total Actual Amount') }}</label>
					<div class="col-sm-6" >
						<input id="TotalActualAmount" name="TotalActualAmount" class="form-control" type="text" value="{{TotalActualAmount}}" readonly="readonly">
					</div>
				</div>

				<div class=" form-group">
					<label class="col-sm-4 control-label" for="TotalSaving">{{ 'Total Saving' }}</label>
					<div class="col-sm-6" >
						<input id="TotalSaving" name="TotalSaving" class="form-control" type="text" value="{{TotalSaving}}" readonly="readonly"> 
					</div>
				</div>

				<div class=" form-group">
					<label class="col-sm-4 control-label" for="TotalAmounts">{{ 'Total Amount' }}</label>
					<div class="col-sm-6" >
						<input id="TotalAmounts" name="TotalAmounts" class="form-control" type="text" value="{{TotalAmounts if TotalAmounts != 0 else TotalCollection}}" readonly="readonly">
					</div>
				</div>

				<div class=" form-group">
					<label class="col-sm-4 control-label"></label>
					<div class="col-sm-8" >
						<button type="submit" id="Generate" {{disabled}} class="btn btn-flat btn-labeled btn-primary ActionFotter" style="margin-right: -36px;">
						<span class="btn-label icon fa fa-th"></span> {{ getLanguage('Generate Collection') }}
					</button>
					</div>
				</div>

		</div>
		<!-- <div class="col-sm-1"></div> -->
		</form>
		<div class="clearfix"></div>

		<div class="row">
			<form action="{{Action}}" id="frm"  method="POST">
			<div class="col-sm-12" style="padding:0px;">
				<!-- Javascript -->
				<script>
					init.push(function () {
						$('ul.bs-tabdrop-example').tabdrop();
					});
				</script>
				<!-- / Javascript -->
				<!-- Tabs -->
				<ul class="nav nav-tabs bs-tabdrop-example">
					<li class="active"><a href="#bs-tabdrop-tab1" data-toggle="tab">1-Loan Collection</a></li>
					<li><a href="#bs-tabdrop-tab2" data-toggle="tab">{{ getLanguage('Audit') }}</a></li>
				</ul>
				<div class="tab-content tab-content-bordered" >
					<div class="tab-pane active" id="bs-tabdrop-tab1" style="padding-top:10px;">
						<table id="mktlist"  class="table table-striped table" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th style="display: none;"></th>
									<th></th>
									<th class="td-disable"></th>
									<th class="td-disable"></th>
									<th class="td-disable"></th>
									<th></th>
									<th></th>
									<th></th>
									<th></th>
									<th colspan="3" class="text-center header-color-collect">Loan Collection</th>
									<th colspan="4" class="text-center header-color-pd">Past Due</th>
								</tr>
								<tr>
									{%if VisibleReference %}
										<th>{{ getLanguage('Reference') }}</th>
									{%endif%}
									{%if not disabled%}
										<th class="ActionFotter">{{ getLanguage('Action') }}</th>
									{%endif%}
									<th>Loan ID - Account - Customer</th>
									<th>Collection Date</th>
									<th class="td-disable">ContractCustomerID</th>
									<th class="td-disable">Account</th>
									<th class="td-disable">Village</th>
									<th style="display: none;">Saving Amount</th>
									<th>Actual Amount</th>
									<th>Total Amount</th>

									<th class="header-color-collect">Principal</th>
									<th class="header-color-collect">Interest</th>
									<th class="header-color-collect">Charge</th>

									<th class="header-color-pd">PD Principal</th>
									<th class="header-color-pd">PD Interest</th>
									<th class="header-color-pd">PD Charge</th>
									<th class="header-color-pd">Penalty</th>
								</tr>
							</thead>
							<tbody>
								{%if QueryObj and kwargs == [] %}
									{%for row in QueryObj%}
										{%set TotalAmount = row.Principal+row.Interest+row.Charge %}
										{%set TotalPDAmount = float(PDObj[row.LoanID]['PDPrincipal'])+float(PDObj[row.LoanID]['PDInterest'])+float(PDObj[row.LoanID]['PDCharge'])+float(PDObj[row.LoanID]['Penalty']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0 %}
										{%set TotalAmount = toMoney(float(TotalAmount) + float(TotalPDAmount),getCurrencyObj(row.Currency))%}
										<tr>
											{%if not disabled%}
											<td class="ActionFotter"
											 onclick="setDeleteRow('{{row['ID']}}','{{row.LoanID}}','LC')"
											 id="row_{{row['ID']}}">
											 	{{TotalPDAmount}}
												<a class="link"> 
													<span class="label label-danger">{{ getLanguage('Delete') }}</span> 
												</a>
											</td>
											{%endif%}

											<td>
												<a href="javascript:void(0)" onclick="CustomClickView('Loan&nbspCentre','{{g_getUrlExtend(Module="LoanCentre")}}/?ID={{row.LoanID}}')">{{row.LoanID}}</a> -
												<a href="javascript:void(0)" onclick="ClickView('Account Statement','{{g_getUrlExtend(Module="AccountStatement")}}','{{row.Account}}')">{{row.Account}}</a> -
												<a href="javascript:void(0)" onclick="ClickView('Customer','{{g_getUrlExtend(Module="Customer")}}','{{row.ContractCustomerID}}')">{{row.LastNameEn}} {{row.FirstNameEn}}</a>

												<input type="hidden" class="RepID" value="{{row.ID}}">
												<input type="hidden" name="LoanID_{{row.ID}}" id="LoanID_{{row.ID}}" class="LoanID_{{row.ID}}" value="{{row.LoanID}}">
											</td>
											<td>
												<input type="hidden" name="CollectionDate_{{row.ID}}" id="CollectionDate_{{row.ID}}" value="{{row.CollectionDate}}">
												{{row.CollectionDate}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Customer_{{row.ID}}" id="Customer_{{row.ID}}" value="{{row.ContractCustomerID}}">
												{{row.ContractCustomerID}}-{{row.LastNameEn}} {{row.FirstNameEn}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Account_{{row.ID}}" id="Account_{{row.ID}}" value="{{row.Account}}">
												{{row.Account}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Village_{{row.ID}}" id="Village_{{row.ID}}" value="{{row.Village}}">
												{{row.Village}}
											</td>
											<td style="display: none;">
												<input type="text" data-loan="SavingAmount_{{row.LoanID}}" class="form-control moneyfield savingamount" id="SavingAmount_{{row.ID}}" name="SavingAmount_{{row.ID}}" value="0" {{disabled}} style=" width: 120px;">
											</td>
											<td>
												<input type="text" data-loan="{{row.LoanID}}" class="form-control moneyfield countrowlc totalamount" id="Amount_{{row.ID}}" name="Amount_{{row.ID}}" value="{{TotalAmount}}" {{disabled}} style=" width: 120px;">
											</td>
											<td>
												<input type="hidden" name="TotalAmount_{{row.ID}}" id="TotalAmount_{{row.ID}}" value="{{TotalAmount}}">
												{{TotalAmount}}
											</td>

											<td>
												<input type="hidden" name="Principal_{{row.ID}}" id="Principal_{{row.ID}}" value="{{toMoney(float(row.Principal),getCurrencyObj(row.Currency))}}">
												{{toMoney(float(row.Principal),getCurrencyObj(row.Currency))}}
											</td>
											<td>
												<input type="hidden" name="Interest_{{row.ID}}" id="Interest_{{row.ID}}" value="{{toMoney(float(row.Interest),getCurrencyObj(row.Currency))}}">
												{{toMoney(float(row.Interest),getCurrencyObj(row.Currency))}}
											</td>
											<td>
												<input type="hidden" name="Charge_{{row.ID}}" id="Charge_{{row.ID}}" value="{{toMoney(float(row.Charge),getCurrencyObj(row.Currency))}}">
												{{toMoney(float(row.Charge),getCurrencyObj(row.Currency))}}
											</td>
											<td>
												<input type="hidden" name="PDPrincipal_{{row.ID}}" id="PDPrincipal_{{row.ID}}" value="{{toMoney(float(PDObj[row.LoanID]['PDPrincipal']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0 ,getCurrencyObj(row.Currency))}}">
												{{toMoney(float(PDObj[row.LoanID]['PDPrincipal']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0,getCurrencyObj(row.Currency))}}
											</td>
											<td>
												<input type="hidden" name="PDInterest_{{row.ID}}" id="PDInterest_{{row.ID}}" value="{{toMoney(float(PDObj[row.LoanID]['PDInterest']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0 ,getCurrencyObj(row.Currency))}}">
												{{toMoney(float(PDObj[row.LoanID]['PDInterest']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0,getCurrencyObj(row.Currency))}}
											</td>
											
											<td>
												<input type="hidden" name="PDCharge_{{row.ID}}" id="PDCharge_{{row.ID}}" value="{{toMoney(float(PDObj[row.LoanID]['PDCharge']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0 ,getCurrencyObj(row.Currency))}}">
												{{toMoney(float(PDObj[row.LoanID]['PDCharge']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0,getCurrencyObj(row.Currency))}}
											</td>
											<td>
												<input type="hidden" name="Penalty_{{row.ID}}" id="Penalty_{{row.ID}}" value="{{toMoney(float(PDObj[row.LoanID]['Penalty']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0 ,getCurrencyObj(row.Currency))}}">
												{{toMoney(float(PDObj[row.LoanID]['Penalty']) if row.LoanID in PDObj.keys() and PDObj[row.LoanID]['WITHLC'] != 'D' else 0,getCurrencyObj(row.Currency))}}
											</td>

										</tr>
										{%if row.LoanID in  PDObj.keys()%}
											{% set a = PDObj[row.LoanID].update({'WITHLC': 'D'})%}
											{% if a %}{%endif%}
										{%endif%}
									{%endfor%}

									{%for key, row in PDObj.items() if row['WITHLC'] == 'N'%}

										{%set TotalAmount = row['PDPrincipal']+row['PDInterest']+row['PDCharge'] %}
										{%set TotalAmount = toMoney(float(TotalAmount),getCurrencyObj(row.Currency))%}
										<tr>
											{%if not disabled%}
											<td class="ActionFotter"
											 onclick="setDeleteRow('{{row['ID']}}','{{row.LoanID}}','LC')"
											 id="row_{{row['ID']}}">
												<a class="link"> 
													<span class="label label-danger">{{ getLanguage('Delete') }}</span> 
												</a>
											</td>
											{%endif%}

											<td>
												<a href="javascript:void(0)" {{key}} id="LoanID" onclick="CustomClickView('Loan&nbspCentre','{{g_getUrlExtend(Module="LoanCentre")}}/?ID={{key}}')">{{key}}</a> -
												<a href="javascript:void(0)" {{row['Account']}} onclick="ClickView('Account Statement','{{g_getUrlExtend(Module="AccountStatement")}}','{{row['Account']}}')">{{row['Account']}}</a> -
												<a href="javascript:void(0)" {{row['ContractCustomerID']}} onclick="ClickView('Customer','{{g_getUrlExtend(Module="Customer")}}','{{row['ContractCustomerID']}}')">{{row['LastNameEn']}} {{row['FirstNameEn']}}</a>
												<input type="hidden" class="RepID" value="{{row.ID}}">
												<input type="hidden" name="LoanID_{{row.ID}}" id="LoanID_{{row.ID}}" class="LoanID_{{row.ID}}" value="{{key}}">
											</td>
											<td>
												<input type="hidden" name="CollectionDate_{{row.ID}}" id="CollectionDate_{{row.ID}}" value="{{row['DueDate']}}">
												{{row['DueDate']}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Customer_{{row.ID}}" id="Customer_{{row.ID}}" value="{{row['ContractCustomerID']}}">
												{{row['ContractCustomerID']}}-{{row['LastNameEn']}} {{row['FirstNameEn']}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Account_{{row.ID}}" id="Account_{{row.ID}}" value="{{row['Account']}}">
												{{row['Account']}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Village_{{row.ID}}" id="Village_{{row.ID}}" value="{{row['Village']}}">
												{{row['Village']}}
											</td>
											<td style="display: none;">
												<input type="text" data-loan="SavingAmount_{{row.LoanID}}" class="form-control moneyfield savingamount" id="SavingAmount_{{row.ID}}" name="SavingAmount_{{row.ID}}" value="0" {{disabled}} style=" width: 120px;">
											</td>
											<td>
												<input type="text" data-loan="{{row.LoanID}}" class="form-control moneyfield countrowlc totalamount" id="Amount_{{row.ID}}" name="Amount_{{row.ID}}" value="{{TotalAmount}}" {{disabled}} style=" width: 120px;">
											</td>
											<td>
												<input type="hidden" name="TotalAmount_{{row.ID}}" id="TotalAmount_{{row.ID}}" value="{{TotalAmount}}">
												{{TotalAmount}}
											</td>

											<td>
												<input type="hidden" name="Principal_{{row.ID}}" id="Principal_{{row.ID}}" value="{{toMoney(float(0),getCurrencyObj(row['Currency']))}}">
												{{toMoney(float(0),getCurrencyObj(row['Currency']))}}
											</td>
											<td>
												<input type="hidden" name="Interest_{{row.ID}}" id="Interest_{{row.ID}}" value="{{toMoney(float(0),getCurrencyObj(row['Currency']))}}">
												{{toMoney(float(0),getCurrencyObj(row['Currency']))}}
											</td>
											<td>
												<input type="hidden" name="Charge_{{row.ID}}" id="Charge_{{row.ID}}" value="{{toMoney(float(0),getCurrencyObj(row['Currency']))}}">
												{{toMoney(float(0),getCurrencyObj(row['Currency']))}}
											</td>
											<td>
												<input type="hidden" name="PDPrincipal_{{row.ID}}" id="PDPrincipal_{{row.ID}}" value="{{toMoney(float(row['PDPrincipal']),getCurrencyObj(row['Currency']))}}">
												{{toMoney(float(row['PDPrincipal']),getCurrencyObj(row['Currency']))}}
											</td>
											<td>
												<input type="hidden" name="PDInterest_{{row.ID}}" id="PDInterest_{{row.ID}}" value="{{toMoney(float(row['PDInterest']),getCurrencyObj(row['Currency']))}}">
												{{toMoney(float(row['PDInterest']),getCurrencyObj(row['Currency']))}}
											</td>
											
											<td>
												<input type="hidden" name="PDCharge_{{row.ID}}" id="PDCharge_{{row.ID}}" value="{{toMoney(float(row['PDCharge']),getCurrencyObj(row['Currency']))}}">
												{{toMoney(float(row['PDCharge']),getCurrencyObj(row['Currency']))}}
											</td>
											<td>
												<input type="hidden" name="Penalty_{{row.ID}}" id="CPenalty_{{row.ID}}" value="{{toMoney(float(row['Penalty']),getCurrencyObj(row['Currency']))}}">
												{{toMoney(float(row['Penalty']),getCurrencyObj(row['Currency']))}}
											</td>

										</tr>
									{%endfor%}
								{%elif kwargs%}
									{%for row in ListRepID%}
										<tr>
											{%if VisibleReference %}
												<td> <a href="javascript:void(0)" onClick="ClickView('Fund Deposit','FundDeposit','{{kwargs['Reference_'+row]}}')">{{kwargs['Reference_'+row]}}</a> </td>
											{%endif%}
										 	{%if not disabled%}
												<td class="ActionFotter" onclick="setDeleteRow('{{row}}','{{kwargs['LoanID_'+row]}}','LC')" id="row_{{row}}">
													<a class="link"><span class="label label-danger">{{ getLanguage('Delete') }}</span></a>
												</td>
											{%endif%}
											<td>
												<a href="javascript:void(0)" onclick="CustomClickView('Loan&nbspCentre','{{g_getUrlExtend(Module="LoanCentre")}}/?ID={{kwargs['LoanID_'+row]}}')">{{kwargs['LoanID_'+row]}}</a> -
												<a href="javascript:void(0)" onclick="ClickView('Account Statement','{{g_getUrlExtend(Module="AccountStatement")}}','{{kwargs['Account_'+row]}}')">{{kwargs['Account_'+row]}}</a> -
												<a href="javascript:void(0)" onclick="ClickView('Customer','{{g_getUrlExtend(Module="Customer")}}','{{kwargs['CustomerID_'+row]}}')">{{kwargs['Customer_'+row]}}</a>

												<input type="hidden" class="RepID" value="{{row}}">
												<input type="hidden" name="LoanID_{{row}}" id="LoanID_{{row}}" class="LoanID_{{row}}" value="{{kwargs['LoanID_'+row]}}"> 
											</td>
											<td>
												<input type="hidden" name="CollectionDate_{{row}}" id="CollectionDate_{{row}}" value="{{kwargs['CollectionDate_'+row]}}">
												{{kwargs['CollectionDate_'+row]}}
											</td>
											<td style="display: none;">
												<input type="text" data-loan="{{row}}" class="form-control moneyfield savingamount" id="SavingAmount_{{row}}" name="SavingAmount_{{row}}" value="{{kwargs['SavingAmount_'+row]}}" {{disabled}} style=" width: 120px;">
											</td>
											<td>
												<input type="text" data-loan="{{row}}" class="form-control moneyfield totalamount countrowlc" id="Amount_{{row}}" name="Amount_{{row}}" value="{{kwargs['Amount_'+row]}}" {{disabled}} style=" width: 120px;">
											</td>
											<td>
												<input type="hidden" name="TotalAmount_{{row}}" id="TotalAmount_{{row}}" value="{{kwargs['TotalAmount_'+row]}}">
												{{kwargs['TotalAmount_'+row]}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Customer_{{row}}" id="Customer_{{row}}" value="{{kwargs['Customer_'+row]}}">
												{{kwargs['Customer_'+row]}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Village_{{row}}" id="Village_{{row}}" value="{{kwargs['Village_'+row]}}">
												{{kwargs['Village_'+row]}}
											</td>
											<td class="td-disable">
												<input type="hidden" name="Account_{{row}}" id="Account_{{row}}" value="{{kwargs['Account_'+row]}}">
												{{kwargs['Account_'+row]}}
											</td>
											<td>
												<input type="hidden" name="Principal_{{row}}" id="Principal_{{row}}" value="{{kwargs['Principal_'+row]}}">
												{{kwargs['Principal_'+row]}}
											</td>
											<td>
												<input type="hidden" name="Interest_{{row}}" id="Interest_{{row}}" value="{{kwargs['Interest_'+row]}}">
												{{kwargs['Interest_'+row]}}
											</td>
											<td>
												<input type="hidden" name="Charge_{{row}}" id="Charge_{{row}}" value="{{kwargs['Charge_'+row]}}">
												{{kwargs['Charge_'+row]}}
											</td>
											<td>
												<input type="hidden" name="PDPrincipal_{{row}}" id="PDPrincipal_{{row}}" value="{{kwargs['PDPrincipal_'+row]}}">
												{{kwargs['PDPrincipal_'+row]}}
											</td>
											<td>
												<input type="hidden" name="PDInterest_{{row}}" id="PDInterest_{{row}}" value="{{kwargs['PDInterest_'+row]}}">
												{{kwargs['PDInterest_'+row]}}
											</td>
											<td>
												<input type="hidden" name="PDCharge_{{row}}" id="PDCharge_{{row}}" value="{{kwargs['PDCharge_'+row]}}">
												{{kwargs['PDCharge_'+row]}}
											</td>
											<td>
												<input type="hidden" name="Penalty_{{row}}" id="Penalty_{{row}}" value="{{kwargs['Penalty_'+row]}}">
												{{kwargs['Penalty_'+row]}}
											</td>
										</tr>
									{%endfor%}
								{%endif%}
							</tbody>
							<tfoot>
								<tr>
									<th><b>{{ getLanguage('Total') }}</b></th>
									<th><b><label id="CountLoanID">
									{%if kwargs %}
										{{kwargs['CountRow']}}
									{%elif QueryObj and kwargs == [] %}
										{{QueryObj.count()}}
									{%endif%}
									</label></b></th>
									<th></th>
									<th id="SumSaving">
									{%if kwargs%}
											{{kwargs['TotalSaving']}}
										{%else%}
											{{TotalSaving}}
										{%endif%}
									</th>
									<th><b><label id="SumLoanIDLC">
										{%if kwargs%}
											{{kwargs['TotalActualAmount']}}
										{%else%}
											{{TotalActualAmount}}
										{%endif%}
									</label></b>
									<th></th>
									<th></th>
									<th></th>
									<th></th>
									<th></th>
									<th></th>
									<th></th>
									</th>
									{%if VisibleReference %}
										<th></th>
									{%endif%}
									{%if not disabled%}
										<th class="ActionFotter"></th>
									{%endif%}
								</tr>
							</tfoot>
						</table>
					</div> <!-- End tab 1-DETAIL -->

					<div class="tab-pane" id="bs-tabdrop-tab2">

						{# call audit tab form #}
						{%set AuditObj = AuditObj %}
						<div  style="padding-top:10px;">
							<div class="form-group">
								<label for="Status" class="col-sm-2 control-label"><label for="Status">{{ getLanguage('Status') }}</label></label>
								<div class="col-sm-10">
								<input class="form-control" id="Status" name="Status" readonly type="text" value="{{AuditObj.Status}}">
								</div>
							</div>
							<div class="form-group">
								<label for="Curr" class="col-sm-2 control-label"><label for="Curr">{{ getLanguage('Curr.No') }}</label></label>
								<div class="col-sm-10">
								<input class="form-control" id="Curr" name="Curr" readonly type="text" value="{{AuditObj.Curr}}">
								</div>
							</div>
							<div class="form-group">
								<label for="Inputter" class="col-sm-2 control-label"><label for="Inputter">{{ getLanguage('Inputter') }}</label></label>
								<div class="col-sm-10">
								<input class="form-control" id="Inputter" name="Inputter" readonly type="text" value="{{AuditObj.Inputter}}">
								</div>
							</div>
							<div class="form-group">
								<label for="Createdon" class="col-sm-2 control-label"><label for="Createdon">{{ getLanguage('Input DateTime') }}</label></label>
								<div class="col-sm-10">
								<input class="form-control" id="Createdon" name="Createdon" readonly type="text" value="{{AuditObj.Createdon}}">
								</div>
							</div>
							<div class="form-group">
								<label for="Authorizer" class="col-sm-2 control-label"><label for="Authorizer">{{ getLanguage('Authorizer') }}</label></label>
								<div class="col-sm-10">
								<input class="form-control" id="Authorizer" name="Authorizer" readonly type="text" value="{{AuditObj.Authorizer}}">
								</div>
							</div>
							<div class="form-group">
								<label for="Authorizeon" class="col-sm-2 control-label"><label for="Authorizeon">{{ getLanguage('Authorize DateTime') }}</label></label>
								<div class="col-sm-10">
								<input class="form-control" id="Authorizeon" name="Authorizeon" readonly type="text" value="{{AuditObj.Authorizeon}}">
								</div>
							</div>
							<div class="form-group">
								<label for="Branch" class="col-sm-2 control-label"><label for="Branch">{{ getLanguage('Branch') }}</label></label>
								<div class="col-sm-10">
								<input class="form-control" id="Branch" name="Branch" readonly type="text" value="{{AuditObj.Branch}}">
								</div>
							</div>
						</div>
					</div> <!-- End tab 3-Audit -->

				</div> <!-- end tab-content-bordered -->
			</div>
			</form>
		</div>
	{%endif%}
{%endif%}

{% endblock %}

{% block js %}
{% from "print.html" import exportIncludeJS %}
{{exportIncludeJS()}}

<script type="text/javascript">
	$(document).ready(function() {
		
		var oTable = $('#mktlist').dataTable({
			// "lengthMenu": [[25,50,100,200, -1], [25,50,100,200, "All"]],
			"lengthMenu": [[100,200,300,500, -1], [100,200,300,500, "All"]],
			"bSort" : false,
			// "bLengthChange" :false,
		});
		
		// $('.table-header').hide()
		// $('#users-url').addClass('active');
		$('#ModalBox').hide();
  		{% from "print.html" import exportDataTable %}
        {{exportDataTable('#mktlist',"Disbursement Sheet")}}
        // Hot Field
		$(function() {
			$('#Currency').bind('change', function() {
			$.getJSON('/Morakot/GenerateDisbursementAccount', {
			Currency:$('#Currency').val(),Officer:$('#Officer').val()
			}, function(data) {
			$('#OfficerAccount').val(data.OfficerAccount);$('#OfficerCategory').val(data.OfficerCategory);$('#Transaction').val(data.Transaction);
			/// fix for loan application only
		
			});
			return false;
			});
		});

		$(function() {
			$('#Officer').bind('change', function() {
				$.getJSON('/Morakot/GenerateDisbursementAccount', {
					Currency:$('#Currency').val(),Officer:$('#Officer').val()
					}, function(data) {
					$('#OfficerAccount').val(data.OfficerAccount);$('#OfficerCategory').val(data.OfficerCategory);$('#Transaction').val(data.Transaction);
					/// fix for loan application only

					});
				return false;
			});
		}); 
	});

	$(function() {
		$('#ContractVB').bind('change', function() {
		$.getJSON('/Morakot/GroupFilter', {
			ContractVB:$('#ContractVB').val()
			}, function(data) {
				var Data = data.data;
				$('#VBGroup').empty();
				$("#VBGroup").append(`<option value=""> --None-- </option>`);
				for(key in Data) {
					Value = Data[key].value;
					Label = Data[key].label;
					$("#VBGroup").append(`<option value=${Value}> ${Value} - ${Label}</option>`);
				}
			});
			return false;
		});
	});
</script>
{% endblock %}