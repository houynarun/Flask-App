{% extends "layout.html" %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheets/jquery.datatables.css') }}">
    <style>
        h3.header-3{
            color: #888 !important;
            font-size: 16px;
            font-weight: bold;
            margin: 5px 0 10px;
            padding: 10px 18px 0;
        }

        h4.header-4{
            color: #888 !important;
            font-size: 14px;
            font-weight: normal;
            margin: 5px 0 10px;
            padding: 0px 18px 0;
        }

        .form-label{
            padding-top: 7px;
        }

        .input-sm {

            width: 214px !important;
        }

        .modal-dialog{

            width: 428px !important;

        }

        .form-label{
            padding-top: 7px;
        }

        .modal-body {
            z-index: 99999 !important;
        }
        table.dataTable tfoot th, table.dataTable tfoot td {
            border-top: 1px solid #111111;
            padding: 10px 10px 6px;
        }
        #Main {
          width: 1px;
          min-width: 100%;
          *width: 100%;
        }
        .panel {
          width: 100%;
        }
    </style>

{% endblock %}

{% block content %}
<div id="Main">
    <div class="navbar navbar-default navbar-static-top">
        <div class="col-sm-6" style="margin-top: 15px;">
            <!-- Button Export -->
            {% from "print.html" import exportButtonLink %}
            {{exportButtonLink()}}
        </div>
        <div class="col-sm-6" style="margin-top: 8px;">
            <button type="button" class="btn btn-flat btn-labeled btn-success pull-right" data-toggle="modal" data-target="#getCustomRange">
                <span class="btn-label icon fa fa-gear"></span> {{ getTextMsg('400002') }}
            </button>
        </div>
    </div>
    <div class="clearfix"></div>
    {% include 'msg_error.html' %}
    
    {% if ConsolBal and Currency %}
        <div class="clearfix"></div>
        <div class="col-sm-12">
            <h3 class="header-3 text-center">{{Company.CompanyName}}</h3>
            <h4 class="header-4 text-center">Consolidated Balance</h4>
            <h4 class="header-4 text-center"><strong>As of: </strong> {{ AsOf }}</h4>
            <h4 class="header-4 text-center"><strong>Branch: </strong> {{ Branch }}</h4>
        </div>
   
        <div class="clearfix">&nbsp;</div>
        <table id="mktlist" class="display" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Description</th>
                    <th>Branch</th>
                    <th>Currency</th>
                    <th>Dr/Cr</th>
                    <th class="text-right">FCYBalance</th>
                    {% if ShowFCYBalance == "Yes" %}
                        <th class="text-right">FCYCurrent Month</th>
                        <th class="text-right">FCYCurrent Prev Month</th>
                        <th class="text-right">FCYPrev Month</th>
                        <th class="text-right">FCYYTD</th>
                        <th class="text-right">FCYPrev Year</th>
                    {% endif %}
                    <th class="text-right">LCYBalance</th>
                    <th class="text-right">LCYCurrent Month</th>
                    <th class="text-right">LCYCurrent Prev Month</th>
                    <th class="text-right">LCYPrev Month</th>
                    <th class="text-right">LCYYTD</th>
                    <th class="text-right">LCYPrev Year</th>
                </tr>
            </thead>
            <tbody>
                {% set TotalAmount = {"TotalBal":0, "PreMonthBal":0, "PreYearBal":0, "YearToDate":0, "CurMonth":0, "CurPrevMonth":0, "CurPrevYear":0} %}
                {% for row in ConsolBal %}

                    {{ getConsolBal(TotalAmount, Decimal(row.LCYBalance), row.LCYPrevMonthBal, row.LCYPrevYearBal, row.LCYYTDBal, row.LCYCurrentMonthBal, row.LCYCurrentPrevMonthBal, row.LCYCurrentPrevYearBal, getAccBalanceType(str(row.ID).split(".")[0])) }}

                    {%set CurrencyObj = getCurrencyObj(row.Currency) %}
                    <tr>
                        <td>{{ row.ID }}</td>
                        <td>
                            {{ VLOOKUP(['MKT_CATEGORY', 'ID', str(str(row.ID).split('.')[0]), 'Description']) }}
                        </td>
                        <td>{{ row.Branch }}</td>
                        <td>{{ row.Currency }}</td>
                        <td>{{ getAccBalanceType(str(row.ID).split(".")[0]) }}</td>

                        <td class="text-right">{{ formatBalance(row.Balance,CurrencyObj,Rounding) }}</td>

                        {% if ShowFCYBalance == "Yes" %}
                            <td class="text-right">{{ formatBalance(row.CurrentMonthBal,CurrencyObj,Rounding) }}</td>
                            <td class="text-right">{{ formatBalance(row.CurrentPrevMonthBal,CurrencyObj,Rounding) }}</td>
                            <td class="text-right">{{ formatBalance(row.PrevMonthBal,CurrencyObj,Rounding) }}</td>
                            <td class="text-right">{{ formatBalance(row.YTDBal,CurrencyObj,Rounding) }}</td>
                            <td class="text-right">{{ formatBalance(row.PrevYearBal,CurrencyObj,Rounding) }}</td>
                        {% endif %}
                        <td class="text-right">{{ formatBalance(row.LCYBalance,BaseCurrencyObj,Rounding)}}</td>
                        <td class="text-right">{{ formatBalance(row.LCYCurrentMonthBal,BaseCurrencyObj,Rounding) }}</td>
                        <td class="text-right">{{ formatBalance(row.LCYCurrentPrevMonthBal,BaseCurrencyObj,Rounding) }}</td>
                        <td class="text-right">{{ formatBalance(row.LCYPrevMonthBal,BaseCurrencyObj,Rounding) }}</td>
                        <td class="text-right">{{ formatBalance(row.LCYYTDBal,BaseCurrencyObj,Rounding) }}</td>
                        <td class="text-right">{{ formatBalance(row.LCYPrevYearBal,BaseCurrencyObj,Rounding) }}</td>
                    </tr>
                    {% if loop.last %}

                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td class="text-right"><strong>Total Balance:</strong></td>
                            <td class="text-right"><strong></strong></td>
                            {% if ShowFCYBalance == "Yes" %}
                                <td class="text-right"><strong></strong></td>
                                <td class="text-right"><strong></strong></td>
                                <td class="text-right"><strong></strong></td>
                                <td class="text-right"><strong></strong></td>
                                <td class="text-right"><strong></strong></td>
                            {% endif %}
                            <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.TotalBal) }}</strong></td>
                            <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.CurMonth) }}</strong></td>
                            <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.CurPrevMonth) }}</strong></td>
                            <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.PreMonthBal) }}</strong></td>
                            <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.YearToDate) }}</strong></td>
                            <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.PreYearBal) }}</strong></td>
                        </tr>

                    {% endif %}
                {% endfor %}
                <tfoot>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="text-right"><strong>Total Balance:</strong></td>
                        <td class="text-right"><strong></strong></td>
                        {% if ShowFCYBalance == "Yes" %}
                            <td class="text-right"><strong></strong></td>
                            <td class="text-right"><strong></strong></td>
                            <td class="text-right"><strong></strong></td>
                            <td class="text-right"><strong></strong></td>
                            <td class="text-right"><strong></strong></td>
                        {% endif %}
                        <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.TotalBal) }}</strong></td>
                        <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.CurMonth) }}</strong></td>
                        <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.CurPrevMonth) }}</strong></td>
                        <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.PreMonthBal) }}</strong></td>
                        <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.YearToDate) }}</strong></td>
                        <td class="text-right"><strong>{{ formatTotalConsole(TotalAmount.PreYearBal) }}</strong></td>
                    </tr>
                </tfoot>
            </tbody>
        </table>
        {% if ShowPrintBy == 'Yes' %}
            {{PrintByAndDate()|safe}}   
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block js %}
    <!-- <script src="{{ url_for('static',filename='javascripts/jquery.datatables.min.js') }}"></script> -->
    <script type="text/javascript">

        $(function(){
            $('[data-toggle="modal"]').on("click", function(e) {
                e.preventDefault();
                var url = $(this).attr('href');
                if (url.indexOf('#') == 0) {
                    // $(url).modal('open');
                    return false;
                } else {
                    $.get(url, function(data) {
                        $('<div class="modal">' + data + '</div>').modal();
                    }).success(function() {
                        $('input:text:visible:first').focus();
                    });
                }
            });

            $('#mktlist').dataTable({
                "lengthMenu": [[25,50,100,200, -1], [25,50,100,200, "All"]],
                "bSort" : false,
                "scrollX": true
            });

            {% from "print.html" import exportDataTable %}
            {{exportDataTable('#mktlist','Consolidated Balance')}}

        });

    </script>

    <!-- Call in Block Js -->

    {% from "print.html" import exportIncludeJS %}
    {{exportIncludeJS()}}

    <div class="modal fade" id="getCustomRange" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form class="form-horizontal" action="/Morakot/ConsolBalance/" method="GET">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Custom</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="ID" class="col-sm-4 control-label">Branch:</label>
                            <div class="col-sm-8">
                                <input name="ID" value="{{ Branch }}" class="input-sm form-control" style="width: 100%;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="Currency" class="col-sm-4 control-label">Currency:</label>
                            <div class="col-sm-8">
                                <input name="Currency" value="{{ Currency }}" class="input-sm form-control" style="width: 100%;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ShowPrintBy" class="col-sm-4 control-label">Show Print By & Date:</label>
                            <div class="col-sm-8">
                                <select class="form-control input-sm" name="ShowPrintBy" style="width: 100%;" id="ShowPrintBy">
                                    {% if ShowPrintBy == 'Yes' %}
                                        <option value="Yes" selected>Yes</option>
                                        <option value="No" >No</option>
                                    {% else %}
                                        <option value="Yes">Yes</option>
                                        <option value="No" selected>No</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ShowFCYBalance" class="col-sm-4 control-label">Show FCY Balance</label>
                            <div class="col-sm-8">
                                <select class="form-control input-sm" name="ShowFCYBalance" style="width: 100%;" id="ShowFCYBalance">
                                    <option value="Yes" {% if ShowFCYBalance == "Yes" %} selected='selected' {% endif %}>Yes</option>
                                    <option value="No" {% if ShowFCYBalance == "No" %} selected='selected' {% endif %}>No</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="Rounding" class="col-sm-4 control-label">Rounding:</label>
                            <div class="col-sm-8">
                                <select id="Rounding" name="Rounding" class="input-sm form-control" style="width: 100%;">
                                    {% if Rounding == "Y" %}
                                        <option value="Y" selected>Yes</option>
                                        <option value="N">No</option>
                                    {% else %}
                                        <option value="Y" >Yes</option>
                                        <option value="N" selected>No</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">{{ getTextMsg('400003') }}</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">{{ getTextMsg('400004') }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% macro getConsolBal(TotalAmount, CurrentAmount, PreMonth, PreYear, YearToDate, CurMonth, CurPrevMonth, CurPrevYear, DrCr) %}
    {% if DrCr == 'Dr' %}
        {% if TotalAmount.update({ 

        "TotalBal":TotalAmount["TotalBal"] + CurrentAmount,
        "PreMonthBal":TotalAmount["PreMonthBal"] + PreMonth,
        "PreYearBal":TotalAmount["PreYearBal"] + PreYear,
        "YearToDate":TotalAmount["YearToDate"] + YearToDate,
        "CurMonth":TotalAmount["CurMonth"] + CurMonth,
        "CurPrevMonth":TotalAmount["CurPrevMonth"] + CurPrevMonth,
        "CurPrevYear":TotalAmount["CurPrevYear"] + CurPrevYear

        }) %}{% endif %}
    
    {% else %}
        {% if TotalAmount.update({ 

        "TotalBal":TotalAmount["TotalBal"] - CurrentAmount,
        "PreMonthBal":TotalAmount["PreMonthBal"] - PreMonth,
        "PreYearBal":TotalAmount["PreYearBal"] - PreYear,
        "YearToDate":TotalAmount["YearToDate"] - YearToDate,
        "CurMonth":TotalAmount["CurMonth"] - CurMonth,
        "CurPrevMonth":TotalAmount["CurPrevMonth"] - CurPrevMonth,
        "CurPrevYear":TotalAmount["CurPrevYear"] - CurPrevYear

        }) %}{% endif %}
    
    {% endif %}
{% endmacro %}

{% macro formatTotalConsole(Balance) %}
    {%if Rounding == 'Y'%}
         {{ toMoney(float(Balance), BaseCurrencyObj)}}
    {%else%}
        {{Decimal(Balance)}}
    {%endif%}
{% endmacro%}

{% macro formatBalance(Number,getCurrencyObj,Rounding='Y')%}
    {%if Rounding=="Y"%}
        {{ toMoney(float(Number),getCurrencyObj) }}
    {%else%}
        {{Number}}
    {%endif%}
  
{% endmacro%}
