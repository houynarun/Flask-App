{% extends "layout.html" %}

{% block css%}
   
    <style type="text/css">
        .navbar-inverse{
            background-color: #f8f8f8;
            border-color: #e7e7e7;
            font-family: "Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
            font-size: 14px;
        }
        .navbar-inverse .navbar-nav>li>a:hover{
            color:black;
        }
        .navbar-inverse .navbar-nav>li>a:link{
            color:red;
        }
        .navbar-inverse .navbar-nav>li>a:active{
            color:red;
        }
        a{
            cursor: pointer;
        }
        div .fstMultipleMode .fstControls{
            width: 450px;
            height: 35px;
        }

        div .fstElement{
            font-size: 9px; 
        }

    </style>
{% endblock%}

{% block content%}
<form method="POST" action="/Morakot/Action" id="frm" onsubmit="getJSON()" enctype='application/json' name="frm" class="">
<div class="row">
    <div class="form-horizontal">
   
        <div class="navbar navbar-default navbar-static-top" role="navigation">
            <ul class="nav navbar-nav">

                {% for row in list%}
                <li>
                        <a onclick="passAction('{{row.event}}');" id="{{row.id}}"><i class="fa {{row.id}}"></i>&nbsp;{{row.title}}</a>
                    </li>
                {% endfor %}

                {% if currentRole == preparedUser %}
                    <li>
                        <a onclick="passAction('5');" id="Feedback"><i class="fa fa-refresh"></i>&nbsp;Feedback</a>
                    </li>
                    <li>
                        <a onclick="passAction('6');" id="Cancel"><i class="fa fa-undo"></i>&nbsp;Cancel</a>
                    </li>
                {% elif doneApproved == True or doneReviewed == True or doneRejected == True%}
                    <li>
                        <a onclick="passAction('5');" id="Feedback"><i class="fa fa-refresh"></i>&nbsp;Feedback</a>
                    </li>
                     <li>
                        <a onclick="passAction('6');" id="Cancel"><i class="fa fa-undo"></i>&nbsp;Cancel</a>
                    </li>
                {% else %}
                    {% if isReviewer == True %}                   
                        <li style="padding-left: 15px">
                            <a onclick="passAction('2');" id="Review">
                                <i class="fa fa-eye"></i>&nbsp;Review
                            </a>
                        </li>
                        <!-- status = 4 mean reviewer rejected -->
                         <li>
                            <a onclick="passAction('4');" id="Reject"><i class="fa fa-times"></i>&nbsp;Reject</a>
                        </li>
                    {% elif isApprover == True %}
                        <li>
                            <a onclick="passAction('3');" id="Approve">
                                <i class="fa fa-check-square-o"></i>&nbsp;Approve
                            </a>
                        </li>
                        <li>
                            <!-- status =7 mean approver rejected -->
                            <a onclick="passAction('7');" id="Reject"><i class="fa fa-times"></i>&nbsp;Reject</a>
                        </li>
                    {% endif %}
                    <li>
                        <a onclick="passAction('5');" id="Feedback"><i class="fa fa-refresh"></i>&nbsp;Feedback</a>
                    </li>
                    <li>
                        <a onclick="passAction('6');" id="Cancel"><i class="fa fa-undo"></i>&nbsp;Cancel</a>
                    </li>
                {% endif %}
                <li>
                    <div class="navbar-form navbar-left">
                        <div class="form-group">
                            <input type="text" class="form-control" disabled name="recordID" id="recordID" placeholder="Record ID" value="{{ID}}">
                        </div>
                    </div>
                    
                </li>
            </ul>
        </div>
    </form>
</div>
</div>
<div id="rejectAlert">
    
</div>
<div>
    {% if msgWorkonOtherBranch != ""%}
        <div class="alert alert-info fade in">
            <a href="#" class="close" data-dismiss="alert">&times;</a>
            {{msgWorkonOtherBranch}}
        </div>
    {% endif %}
</div>

<div class="row">
        <div class="form-horizontal">
          <div class="box-body">
            <div class="form-group">
              <label for="inputEmail3" name='comment'  class="col-sm-2 control-label">Comment
                <!-- <span style="color: red"> *</span>  -->
              </label>

              <div class="col-sm-10">
                <textarea class="form-control"  id="comment" rows="4" placeholder="What you want to say..."></textarea>
              </div>
            </div>
            <hr/>
            <div class="form-group">
              <label class="col-sm-2 control-label">
                    <u>Feedback to</u>
              </label>
            </div>
           
            <div class="form-group">
              <label class="col-sm-2 control-label">User</label>

              <div class="col-sm-10 select2-primary">
                <select name="notifyTo" id="notifyTo" class="form-control" multiple='multiple'>
                    {% for user in users %}
                        <option value="{{user.ID}}">{{user.ID}}</option>
                    {% endfor %}
                </select>
               
             </div>
            </div>
          </div>
        </div>
    </div>
</div>
</form>
<hr>
</div>
<div class="row">
    <div id="container_tab" class="tab-content">
        <ul class="nav nav-tabs bs-tabdrop-example" role="tablist">
            <li class="dropdown pull-right tabdrop hide">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i class="fa fa-bars"></i> 
                    <b class="caret"></b>
                </a>
            </li>
            <li class="active"><a data-toggle="tab" href="#FormReview">Form Review/Approve</a></li>
            <li id="CreditScoreTab" class=""><a data-toggle="tab" href="#CreditScore">Credit Score</a></li>
            <li class=""><a data-toggle="tab" href="#CreditSummary">Credit Summary</a></li>
            <li class=""><a data-toggle="tab" href="#Signatory">Signatory</a></li>
            <!-- <li class=""><a data-toggle="tab" href="#CreditBorrow">Credit Borrow</a></li> -->

            <!-- <li class=""><a data-toggle="tab" href="#Audit">Audit</a></li> -->
        </ul>
        <div id="FormReview" class="tab-pane active in">
            <br>
            <div id="FormReview1">    
                <div class="col-sm-12">
                    <h2>
                        {% if currentRole == 'EMP' %}
                             <iframe onload='addToStorage()' id="frameForm" width="100%"  height="9000px" frameborder="0" src="/Morakot/{{formurl}}/Edit/?ID={{ID}}"></iframe>
                        {% else %}
                            {% if editMode == 'True' %}
                                <iframe onload='addToStorage()' id="frameForm" width="100%"  height="9000px" frameborder="0" src="/Morakot/{{formurl}}/Edit/?ID={{ID}}"></iframe>
                            {% else %}
                                <iframe onload='addToStorage()' id="frameForm" width="100%"  height="9000px" frameborder="0" src="/Morakot/{{formurl}}/?ID={{ID}}"></iframe>
                            {% endif %}
                        {% endif %}
                    </h2>
                </div>
            </div>
        </div>
        <div id="Signatory" class="tab-pane">
            <br>
            <div id="Signatory1">
                <div class="form-group">
                    <div class="col-sm-12">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="box">
                                    <div class="box-header">
                                        <h3 class="box-title">User activity</h3>
                                        <br/>
                                    </div>
                                    <!-- /.box-header -->
                                    <div class="box-body table-responsive no-padding">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>RecordID</th>
                                                    <th>User</th>
                                                    <th>Role</th>
                                                    <th>Date</th>
                                                    <th>Activity</th>
                                                    <th>Comment</th>
                                                    <th>NextLevel</th>
                                                    <th>NotifyTo</th>
                                                    
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for s in signatory%}
                                                <tr>
                                                    <td>{{s.ID}}</td>
                                                    <td>{{s.RecordID}}</td>
                                                    <td>{{s.UserID}}</td>
                                                    <td>{{s.RoleID}}</td>
                                                    <td>{{s.Createdon}}</td>
                                                    {% if s.Action == '1' %}
                                                        <td><span class="label label-primary">Prepared</span></td>
                                                    {% elif s.Action == '2' %}
                                                        <td><span class="label label-warning">Reviewed</span></td>
                                                    {% elif s.Action == '3' %}
                                                        <td><span class="label label-success">Approve</span></td>
                                                    {% elif s.Action == '4' %}
                                                        <td><span class="label label-danger">Rev Rejected</span></td>
                                                    {% elif s.Action == '5' %}
                                                        <td><span class="label label-info">Feedback</span></td>
                                                    {% elif s.Action == '7' %}
                                                        <td><span class="label label-danger">Appr Rejected</span></td>
                                                    {% elif s.Action == '8' %}
                                                        <td><span class="label label-default">Edited</span></td>
                                                    {% elif s.Action == '3' %}
                                                    {% else %}
                                                        <td><span class="label label-default">Undefined</span></td>
                                                    {% endif %}
                                                    <td>{{s.Comment}}</td>
                                                    <td>{{s.NextLevel}}</td>
                                                    <td>{{s.NotifyUserID}}</td>
                                                    
                                                </tr>
                                                {% endfor %}
                                                
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- /.box-body -->
                                </div>
                                <!-- /.box -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="CreditSummary" class="tab-pane">
            <br>
            <div class="col-sm-12">
                <iframe width="100%" id="frameForm" height="9000px"  frameborder="0" src="/Morakot/CreditSummary/?ID={{ID}}"></iframe>
            </div>
            
        </div>
         <div id="CreditBorrow" class="tab-pane">
            <br>
            <div class="col-sm-12">
                <iframe width="100%" id="frameForm" height="9000px"  frameborder="0" src="/Morakot/CreditSummary/?ID={{ID}}"></iframe>
            </div>
            
        </div>
        <div id="CreditScore" class="tab-pane">
          
            
        </div>
    </div>
</div>

{% endblock%}

{% block js%}

    <script type="text/javascript">
        $(document).ready(function(){
            $('#CreditScoreTab').click(function(){
                $('#CreditScore').html("\
                     <br>\
                    <div class='col-sm-12'>\
                        <iframe width='100%' id='frameForm' height='9000px'\
                        frameborder='0' src='/Morakot/CreditScoreTemplate?ID={{credit_score}}&OptToolbar=N'></iframe>\
                    </div>\
                ")
            });
        });
    </script>

    <script type="text/javascript">
        init.push(function () {
            // Multiselect
            $("#notifyTo").select2({
                placeholder: "Notify to first user"
            });
        });
        // frame load
        SubClone  = ""
        function addToStorage(){
            SubClone = $('iframe#frameForm').contents().find('form').serialize();
            // console.log("Subclone:",SubClone)
        }

        $(document).ready(function(){
            $('iframe#frameForm').load(function(){ 
                setTimeout(disableButton,10);
                function disableButton(){                    
                    $('iframe#frameForm').contents().find('.navbar').hide();
                    // $('iframe#frameForm').contents().find('a#Save').hide(); 
                }
            });
            $('.multipleSelect').fastselect();
        });
        
        function postData(){
            // alert(data['action'])
            var getAction = data['action'];
            $.ajax({
                url: '/Morakot/Action?action='+getAction,
                data: JSON.stringify(data),
                type: 'POST',
                dataType:'json',
                contentType:'application/json',
                success: function(response) {
                    
                    console.log("respone url:",response.redirect);
                    console.log("message:",response.messageSuccess);
                    var redirectURL = response.redirect;
                    if (redirectURL.includes('?')){
                        window.location.href    =   response.redirect+"&message="+response.messageSuccess+"&type="+response.type;
                        
                    }else{
                        window.location.href    =   response.redirect;
                    }
                },
                error: function(error) {
                    console.log("respone err:",error);
                    // console.log("message:",response.messageFail);
                    // window.location.href = response.redirect+"?message="+response.messageFail+"&type="+response.type;
                },
            })
        }

        function checkEditAndPost(){
            SubForm = $('iframe#frameForm').contents().find('form').serialize();
            if(SubClone == SubForm){
                // alert("Data has no change. Will not submit to server.");
                postData();
                return true;
            }else{
                // alert("Data was edited")
                fn_fadeIn();
                $('iframe#frameForm').contents().find('a#Save')[0].click();
                
                $("iframe#frameForm").load(function(){
                    // alert('Before');
                   var damageMessage = $(this).contents().find("div.alert-danger").text();
                   // alert('After');
                   if(damageMessage == ''){
                        // fn_fadeIn();
                        // console.log("No validate");
                        $("iframe#frameForm").hide();
                        $("#bodyform").hide();
                        postData();
                        return true;
                   }else{
                        console.log('In validation')
                   }
                });  

                fn_fadeOut();            
            }
        }
        function passAction(action){            
            fn_fadeIn();
            var comment     = $('#comment').val();
            var recordID    = '{{ID}}';
            var formID      = '{{formID}}';
            var notifyTos   = $("#notifyTo").val();
            var rejectMsg   = $('#rejectAlert');
            var formurl     = '{{formurl}}';
            
            console.log('notifyTos:',notifyTos);
            if(notifyTos != null){
                notifyTos = $.map($("#notifyTo option:selected"),function(el, i) {
                                 return $(el).text();
                             });
                notifyTos = notifyTos.join(",");
            }
            else{
                notifyTos = '{{preparedUser}}';
            }

            console.log("Users:",notifyTos);
            data = {
                    "action":action,
                    "comment":comment,
                    "recordID":recordID,
                    "notifyTo":notifyTos,
                    "formID":formID,
                    "formurl":formurl
                    }

            if(action=='2' || action=='3' || action=='5' ){
                checkEditAndPost();

            }else if(action == '4' || action == '7'){
                if (confirm('Are you sure you want to reject?')) {
                    if(comment ==""){
                        rejectMsg.html("\
                                <div class='alert alert-danger fade in'>\
                                    <a href='#'' class='close' data-dismiss='alert'>&times;</a>\
                                    <p>Please give the reasons..! </p> \
                                </div>\
                            ")
                        $('#comment').focus();
                        // console.log("work");
                    }else{
                        postData();
                    }
                }
            }else{
                console.log("No action click");
                postData();
            }
            fn_fadeOut();
        }   
    </script>
{% endblock %}
