{% extends "layout.html" %}

{% block css %}
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheets/jquery.datatables.css') }}">
	<style>
		h3.header-3{
			color: #888 !important;
			font-size: 16px;
			font-weight: bold;
			margin: 5px 0 10px;
			padding: 10px 18px 0;
		}

		.form-label{
			padding-top: 7px;
		}
		table.borderless td, .borderless th {
			border: none !important;
		}
		.form-control
		{
			width: 100% !important;
		}

		.style-total{
			padding-right: 35px !important; 
			border-top: 1px solid #000 !important;
		}

		#Main {
			width: 1px;
			min-width: 100%;
			*width: 100%;
		}

		.panel {
			width: 100%;
		}
		.hidden-td {
			display: none;
		}
    </style>
{% endblock %}

{% block content %}

<script src="{{ url_for('static',filename='javascripts/jquery.datatables.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/dataTables.tableTools.js') }}"></script>

<!-- <link rel=stylesheet type=text/css href="{{ url_for('static', filename='stylesheets/jquery.datatables.css') }}">
 -->
 <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.1/css/responsive.bootstrap.min.css">
 <link rel=stylesheet type=text/css href="{{ url_for('static', filename='stylesheets/dataTables.tableTools.css') }}">
 <script src="{{ url_for('static',filename='javascripts/dataTables.responsive.min.js') }}"></script>
 
<script>
	$(document).ready(function(){
		$('[data-toggle="popover"]').popover();
	});
</script>

<div class="navbar navbar-default navbar-static-top">
	<form method="GET" id="frm" name="frm" role="form" action="/Morakot/LoanCentre/">
		<div class="col-xs-12">

			<div class="col-xs-6 col-lg-3 col-sm-3 col-md-3" style="margin-top:8px; padding:0px">

				{% from "print.html" import searchCustomer %}
				{{searchCustomer('/Morakot/SearchLoanCentreID','ID',ID,'','Input Loan ID or Customer Name',AllowPutID='Y')}}
			</div>			 
			<div class="col-xs-3 col-lg-6 col-sm-6 col-md-6" style="margin-top:8px;">
				<label>
					<button type="submit" class="btn btn-flat btn-labeled btn-primary" id="btnShow" style="padding: 7px 25px;">Show</button>
				</label>
			</div>
			
			<div class="col-xs-3 col-lg-3 col-sm-3 col-md-3 text-right" style="margin-top:8px;">
				<div class="pull-right">
					{% from "print.html" import exportButton %}
					{{ exportButton() }}
					</div>
			</div>
		</div>
	</form>
</div>
	<!--  message  -->
	<div class="clearfix"></div>
	{% include 'error.html' %}
	
	<div id="Main">
		{% if Loan %}
			{% set Min_Height = "430px" %}
			{% set Max_Height = "430px" %}
			{% set Tr_ChargeRecievable = "" %}
			{% set Tr_ChargeRate = "" %}
			{% set Tr_CurrentCharge = "" %}
			{% set CurrentCharge = 0 %}
			{% set ChargeRecievable = 0 %}
			{% set ChargeRate  	 = 0 %}

			{% if ACCR_CHARGE_DAILY == "Y" %}
				{% set Min_Height = "470px" %}
				{% set Max_Height = "470px" %}

				{% if ChargeRegularObj: %}
				{% set CurrentCharge 	= ChargeRegularObj[0].AccrCurrent if ChargeRegularObj[0].AccrCurrent else 0 %}
				{% set ChargeRecievable = ChargeRegularObj[0].ChargeUnearned %}
				{% set ChargeRate  	 	= ChargeRegularObj[0].Charge %}
				{% endif %}

				{% set Tr_ChargeRecievable = "<tr><th>Accrued Charged Receivable:</th><td>"+ toMoney(float(ChargeRecievable), getCurrencyObj(Loan.Currency), 1) +"</td></tr>" %}
				{% set Tr_ChargeRate    = "<tr><th>Charge Rate:</th><td>"+str(formatNumber(ChargeRate))+" / Year </td></tr>"   %}
				{% set Tr_CurrentCharge = "<tr><th>Current Installment Charge:</th><td>"+ toMoney(float(CurrentCharge), getCurrencyObj(Loan.Currency), 1) +"</td></tr>" %}

			{%endif%}
			<script>
				init.push(function () {
					$('#LoanInfo .panel-body > div').slimScroll({ height: 365, alwaysVisible: true, color: '#888',allowPageScroll: true });
				})
			</script>
			<div class="col-sm-12" style="padding:0px;">
				<div class="col-sm-6">
					<div class="panel panel-info" id="LoanInfo">
						<div class="panel-heading">
							<span class="panel-title"><i class="fa fa-file-text-o"></i> General - Info</span>
						</div>

						<div class="panel-body" style="min-height: {{Min_Height}}; max-height: {{Max_Height}};"> 
							{% if Loan %}
								<!-- <div> -->
									<table class="table">
										<tr>
											<th>Loan ID:</th>
											<td >
												<a href="javascript:void(0);" id="LinkToLoan" title="View Loan Contract">
													{{ Loan.ID }}
												</a>
												{{ ' - '+Loan.Branch }}
												<script type="text/javascript">
													init.push(function () {
														$("#LinkToLoan").click(function(){
															if ( self !== top ) {
																window.parent.addTab("Loan Contract", "/Morakot/{{g_getUrlExtend(Module='LoanContract')}}/?ID={{ Loan.ID }}");
															}else{
																window.parent.location.href="/Morakot/{{g_getUrlExtend(Module='LoanContract')}}/?ID={{ Loan.ID }}"
															}
														});
													});
												</script>
											</td>
										</tr>
										<tr>
											<th>Customer:</th>
											<td>
												<a href="javascript:void(0);" id="LinkToCustomer" title="View Customer">
													{{ Loan.ContractCustomerID }}
												</a>
												<script type="text/javascript">
													init.push(function () {
														$("#LinkToCustomer").click(function(){
															if ( self !== top ) {
																window.parent.addTab("Customer", "/Morakot/{{g_getUrlExtend(Module='Customer')}}/?ID={{ Loan.ContractCustomerID }}");
															}else{
																window.parent.location.href="/Morakot/{{g_getUrlExtend(Module='Customer')}}/?ID={{ Loan.ContractCustomerID }}"
															}
														});
													});
												</script>
												 - {{ lookupTable('MKT_CUSTOMER', 'ID', 'LastNameEn', Loan.ContractCustomerID) }}
												 {{ lookupTable('MKT_CUSTOMER', 'ID', 'FirstNameEn', Loan.ContractCustomerID) }}
											</td>
										</tr>
										<tr>
											<th>Account:</th>
											<td>
												<a href="javascript:void(0);" id="LinkToAccount" title="View Account">
													{{ Loan.Account }}
												</a>
												<script type="text/javascript">
													init.push(function () {
														$("#LinkToAccount").click(function(){
															if ( self !== top ) {
																window.parent.addTab("Account", "/Morakot/{{g_getUrlExtend(Module='Account_DD')}}/?ID={{ Loan.Account }}");
															}else{
																window.parent.location.href="/Morakot/{{g_getUrlExtend(Module='Account_DD')}}/?ID={{ Loan.Account }}"
															}
														});
													});
												</script>
											</td>
										</tr>
										<tr>
											<th>Value Date:</th>
											<td>{{ Loan.ValueDate }}</td>
										</tr>
										<tr>
											<th>Maturity Date:</th>
											<td>{{ Loan.MaturityDate }}</td>
										</tr>
										<tr>
											<th>Disbursed Amount:</th>
											<td>{{ toMoney(float(Loan.Disbursed), getCurrencyObj(Loan.Currency), 1) }}</td>
										</tr>
										<tr>
											<th>Outstanding Amount:</th>
											<td>{{ toMoney(float(Loan.OutstandingAmount), getCurrencyObj(Loan.Currency), 1) }}</td>
										</tr>
										<tr>
											<th>Interest Rate:</th>
											<td>{{ Loan.InterestRate }}% / Year</td>
										</tr>
										<tr>
											<th>Total Interest Earned:</th>
											<td>{{ toMoney(float(Loan.IntIncEarned), BaseCurrencyObj, 1) }}</td>
										</tr>
										<tr>
											<th>Accrued Interest Receivable Booked:</th>
											<td>{{ toMoney(float(Loan.AccrInterest), getCurrencyObj(Loan.Currency), 1) }}</td>
										</tr>
										
										{{Tr_ChargeRecievable | safe}}
										{{Tr_ChargeRate | safe}}

									</table>
								<!-- </div> -->
							{% endif %}
						</div>
					</div>
				</div>


				<script>
					init.push(function () {
						$('#AccountInfo .panel-body > div').slimScroll({ height: 330, alwaysVisible: true, color: '#888',allowPageScroll: true });
					})
				</script>
				<div class="col-sm-6">
					<div class="panel panel-info" id="AccountInfo">
						<div class="panel-heading">
							<span class="panel-title"><i class="fa fa-money"></i> Outstanding Amount from Customer</span>
							<div class="panel-heading-controls">
								<div class="panel-heading-icon">
									
								</div>
							</div>
						</div>
						<!-- <div class="panel-body" style="min-height: 390px; max-height: 430px;"> -->
						<div class="panel-body osAmt" style="min-height: {{Min_Height}}; max-height: {{Max_Height}};">
							<!-- <div> -->
								<!-- <div class="table-responsive"> -->
									{% if Loan %}
										<table class="table">
											<tr>
												<th>Loan Balance:</th>
												<td>
													{{ toMoney(float(Loan.Amount), getCurrencyObj(Loan.Currency), 1) }}
												</td>
											</tr>
											<tr>
												<th>Current Installment Interest:</th>
												<td>
													{{ toMoney(float(AccrCurrInstallment), getCurrencyObj(Loan.Currency), 1) }}
													{% set AccrCurrInstal = toMoney(float(AccrCurrInstallment), getCurrencyObj(Loan.Currency))%}
												</td>
											</tr>
											{{Tr_CurrentCharge | safe}}
											<tr>
												<th>Pre-Termination Amount:</th>
												<td width="200">
													{{ toMoney(float(PreTermination), getCurrencyObj(Loan.Currency), 1) }}
												</td>
											</tr>
											<tr>
												<th>Past Due:</th>
												<td width="200" ><b>
													<a href="javascript:void(0);" class="link" onclick="
											CustomClickView('Past&nbspDue','PD/?ID=PD{{ID}}')">
													{{ toMoney(float(TotODAmount), getCurrencyObj(Loan.Currency), 1) }}</a></b>
												</td>
											</tr>
											<tr>
												<td colspan="2" style="padding-top: 2px; padding-bottom: 2px;">
													<table class="table borderless pull-right" style="width: 60% !important; margin: 0px;">
														<tbody>
															<tr>
																<td>Principal:</td>
																<td width="240" style="padding-left: 55px;">
																	{{ toMoney(float(TotPrincipalDue), getCurrencyObj(Loan.Currency), 1) }}
																</td>
															</tr>
															<tr>
																<td>Interest:</td>
																<td style="padding-left: 55px;">
																	{{ toMoney(float(TotInterestDue), getCurrencyObj(Loan.Currency), 1) }}
																</td>
															</tr>
															<tr>
																<td>Penalty:</td>
																<td style="padding-left: 55px;">
																	{{ toMoney(float(TotPenaltyDue), getCurrencyObj(Loan.Currency), 1) }}
																</td>
															</tr>
															<tr>
																<td>Charge:</td>
																<td style="padding-left: 55px;">
																	{{ toMoney(float(TotChargeDue), getCurrencyObj(Loan.Currency), 1) }}
																</td>
															</tr>
														</tbody>
													</table>
												</td>
											</tr>
											<tr>
												<th>Total:</th>
												<td>
													<strong>
													
														{{ toMoney(float(Loan.Amount) + float(''.join(AccrCurrInstal.split(',')))  + float(TotODAmount)+ float(PreTermination) + float(CurrentCharge), getCurrencyObj(Loan.Currency), 1) }}
														
													</strong>
												</td>
											</tr>
											<tr>
												<th>Account Balance:</th>
												<td>
													<strong>

														<a href="javascript:void(0);" id="LinkToAccountStatement" title="View Account Statement">
															{% if lookupTable('MKT_ACCOUNT', 'ID', 'AvailableBal', Loan.Account) != '' %}
																{{ toMoney(float(lookupTable('MKT_ACCOUNT', 'ID', 'AvailableBal', Loan.Account)), getCurrencyObj(Loan.Currency), 1) }}
															{% else %}
																{{ toMoney(float(0), getCurrencyObj(Loan.Currency), 1) }}
															{% endif %}
														</a>

														<script type="text/javascript">
															init.push(function () {
																$("#LinkToAccountStatement").click(function(){
																	if ( self !== top ) {
																		window.parent.addTab("Account Statement", "/Morakot/AccountStatement/?ID={{ Loan.Account }}");
																	}else{
																		window.parent.location.href="/Morakot/AccountStatement/?ID={{ Loan.Account }}"
																	}
																});
															});
														</script>

													</strong>
												</td>
											</tr>
											<tr>
												<th>Balance Due From Customer:</th>
												<td>
													<strong>
														{% if lookupTable('MKT_ACCOUNT', 'ID', 'AvailableBal', Loan.Account) != '' %}
															
															{{ toMoney((float(Loan.Amount) + float(''.join(AccrCurrInstal.split(','))) + float(TotODAmount) + float(PreTermination) + float(CurrentCharge)) - float(lookupTable('MKT_ACCOUNT', 'ID', 'AvailableBal', Loan.Account)), getCurrencyObj(Loan.Currency), 1) }}
															
														{% else %}
															
															{{ toMoney((float(Loan.Amount) + float(''.join(AccrCurrInstal.split(','))) + float(TotODAmount) + float(PreTermination) + float(CurrentCharge)), getCurrencyObj(Loan.Currency), 1) }}
															
														{% endif %}
													</strong>
												</td>
											</tr>

										</table>
									{% endif %}
								<!-- </div> Responsive-->
							<!-- </div> -->
						</div>
					</div>
				</div>
			</div>

			<!--Collatoral-Info-->
			{% if CollateralDetailObj %}
				{%include 'schedule/collateraldetail.html' %}
			{%endif%}
			<!--Co_Borrower and Guarantor-->
			{% set Relation			= 	{'': 'N/A', '1': 'Spouse', '2': 'Son/Daughter', '3': 'Relative', '4': 'Parent', '5': 'Friend'} %}
			{%if CoBorrowerObj or GuarantorObj%}
				<div class="col-sm-12">
					<!--Guarantor Info-->
					<div class="panel panel-info">
						<div class="panel-heading">
							<span class="panel-title"><i class="fa fa-file-text-o"></i> 
							Guarantor & CoBorrower Info
							</span>
						</div>
						<div class="panel-body">
							<div class="table-responsive">
								<div class="col-sm-12">
									<div class="row">
										<table id="GuarantorList"  class="table table-striped table-hover" cellspacing="0">
											<thead>
												<tr>
													<th>ID</th>
													<th>Name</th>
													<th>Gender</th>
													<th>Phone Number</th>
													<th>RelationIndicator</th>
													{% if showColumnType=='Yes' %}
														<th>Type</th>
													{% endif %}
													<th>Loan</th>
													<th>Address</th>
												</tr>
											</thead>
											<tbody>
											{%if GuarantorObj%}
												{%for Guarantor in GuarantorObj%}
												<tr>
													<td>
														<a href="javascript:void(0);" class="link" onclick="CustomClickView('Customer','{{g_getUrlExtend(Module="Customer")}}/?ID={{Guarantor.ID}}')">
														{{Guarantor.ID}}
														</a>
													</td>
													<td>{{Guarantor.CustomerName}}</td>
													<td>{{Guarantor.Gender}}</td>
													<td>{{Guarantor.Mobile}}</td>
													<td>{{Relation[Guarantor.RelationIndicator]}}</td>
													{% if showColumnType=="Yes" %}
														<td>{{Guarantor.Type}}</td>
													{%endif%}
													<td>
														<a href="javascript:void(0);" class="link" style="color: blue; font-weight: bold;" data-toggle="popover" title="Loan Contract" data-html="true" data-content="{% for row in Guarantor.LoanID %}{{'ID: '+row[0]}}<br>{% endfor %}">
															{{Guarantor.Loan}}
														</a>
													</td>
													<td>{{Guarantor.Address}}</td>
												</tr>
												{%endfor%}
											{%endif%}
											{%if CoBorrowerObj %}
												{%for CoBorrower in CoBorrowerObj%}
												<tr>
													<td>
													<a href="javascript:void(0);" class="link" onclick="CustomClickView('Customer','{{g_getUrlExtend(Module="Customer")}}/?ID={{CoBorrower.ID}}')">
													{{CoBorrower.ID}}
													</a>
													</td>
													<td>{{CoBorrower.CustomerName}}</td>
													<td>{{CoBorrower.Gender}}</td>
													<td>{{CoBorrower.Mobile}}</td>
													<td>{{Relation[CoBorrower.RelationIndicator]}}</td>
													{% if showColumnType=="Yes" %}
														<td>{{CoBorrower.Type}}</td>
													{% endif %}
													<td >
														<a href="javascript:void(0);" class="link" style="color: blue; font-weight: bold;" data-toggle="popover" title="Loan Contract" data-html="true" data-content="{% for row in CoBorrower.LoanID %}{{'ID: '+row[0]}}<br>{% endfor %}">
															{{CoBorrower.Loan}}
														</a>
													</td>
													<td>{{CoBorrower.Address}}</td>
												</tr>
												{%endfor%}
											{%endif%}
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			{%endif%}

			<div class="col-sm-12">
				<!-- <div class="col-sm-12"> -->
				<div class="panel panel-info">
					<div class="panel-heading">
						<span class="panel-title"><i class="fa fa-history"></i> Payment History</span>
					</div>
					<div class="panel-body">
						<div>
							<div class="table-responsive">
								{% if Loan %}
									{% set TotalAmount = {'TotPrincipal':0, 'TotInterest':0, 'TotPenalty':0, 'TotPaidAmt':0 ,'TotWaivePenalty':0, 'TotWaiveInterest':0} %}
									<table id="mktlist" class="display" cellspacing="0" width="100%">
										<thead>
											<tr>
												<th>ID</th>
												<th>Date</th>
												<th class="text-right" style="padding-right: 35px;">Principal</th>
												<th class="text-right" style="padding-right: 35px;">Interest</th>
												{%if EnableChargeSchedule%}
													<th class="text-right" style="padding-right: 35px;">Charge</th>
												{%endif%}
												<th class="text-right" style="padding-right: 35px;">Penalty</th>
												<th class="text-right" style="padding-right: 35px;">Total</th>
												<th>Status</th>
												<th># of Day Due</th>
												<th class="text-right" style="padding-right: 35px;">Paid Amount</th>
												<th class="text-right" style="padding-right: 35px;">Waive Penalty</th>
												<th class="text-right" style="padding-right: 35px;">Waive Interest</th>
												<th class="text-right" style="padding-right: 35px;">Loan Balance</th>
												<th class="text-right" style="padding-right: 35px;">Number Of Day</th>
											</tr>
										</thead>
										<tbody>
											{% if Schedule %}
												{% set LastCollectionDate = "" %}
												{% set LastAmendDate = "" %}
												{% set TotalCol = 14 %}
												<!-- Loop in Repayment Schedule -->
												{% for row in Schedule %}
													{% set NumDayLateObj = PDDateObj.filter(MKT_PD_DATE.DueDate == str(row.CollectionDate)).first()%}
													{% set NumDayLate = NumDayLateObj.NumDayDue if NumDayLateObj else 0 %}
													{% set PenaltyAmount =  getPenaltyByDate(row.CollectionDate,'PD'+row.LoanID)%}
													{{ AddDataToList(TotalAmount, row.Principal, row.Interest, PenaltyAmount, row.PartPaidAmt, row.WaivePenalty, row.WaiveInterest) }}
													
													<!-- Showing label for loan amendment -->
													{% if DictInfo %}
														{% for key, value in DictInfo.iteritems() %}
															{# This condition will show a row indicate amendment after loan collection if there is loan collect today#}
															{% if LastCollectionDate <= key < row.CollectionDate %}

																<!-- Meaning loan is amended more than one time on the same date -->
																{% if value.ListInfo|length > 1 %}
																	<tr style="background-color: {{value.Color}};">
																		<td colspan="{%if EnableChargeSchedule%} {{TotalCol}} {%else%} {{TotalCol}}-1 {%endif%}">
																			<div class="text-center">
																				<b><i><u>LOAN AMENDMENT</u></i></b>
																				<a id="btnExpand" style="float:right; width:5px; padding-right:10px; color:black;"><i class="fa fa-chevron-right" aria-hidden="true"></i></a>
																			</div>
																			{% set No = 1 %}
																			<div id="Detail" class="text-left" hidden="True">

																				{% for item in value.ListInfo %}
																					<a href="javascript:void(0);" class="link" title="View Loan Amend" onclick="CustomClickView('Loan Amendment','LoanAmendment/?ID={{item[1]}}')"><b><i>{{No}}. {{item[0]}}</i></b></a>
																					<br>
																					{% set No = No + 1 %}
																				{% endfor %}
																			</div>
																		</td>
																{% else %}
																	<tr style="background-color: {{value.Color}}">
																		<td colspan="{%if EnableChargeSchedule %} {{TotalCol}} {%else%} {{TotalCol}}-1 {%endif%}" class="text-center">
																			<a href="javascript:void(0);" class="link" title="View Loan Amend" onclick="CustomClickView('Loan Amendment','LoanAmendment/?ID={{value.ListInfo[0][1]}}')"><b><i>{{value.ListInfo[0][0]}}</i></b></a>
																		</td>
																	</tr>
																{% endif %}
																	<tr>
																		{% for i in range(0,TotalCol) %}
																			<td style="display: none;"></td>
																		{% endfor %}
																	</tr>
															{% endif %}
															{% if LastAmendDate != key %}
																{% set LastAmendDate = key %}
															{% endif %}
														{% endfor %}
													{% endif %}
													<!-- End showing label for loan amendment -->

													<!-- Showing Repayment Schedule data -->
													
													<!-- Set dynamic color -->
													{% set RowColor = ""%}
													{% if row.CollectionDate < str(SystemDate) and int(row.RepStatus) == 1 %}
														{% set RowColor = "text-danger"%}
													{% elif int(str(row.CollectionDate).replace('-', '')) == int(SystemDate.replace('-', '')) %}
														{% set RowColor = "text-info"%}
													{% endif %}
													<!-- End set dynamic color -->

													<tr>
														<td class="{{RowColor}}">{{ row.No }}</td>
														<td class="{{RowColor}}">{{ row.CollectionDate }}</td>
														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(row.Principal), getCurrencyObj(Loan.Currency)) }}</td>

														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(row.Interest), getCurrencyObj(Loan.Currency))}}</td>
														{%if EnableChargeSchedule%}
															<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(row.Charge), getCurrencyObj(Loan.Currency))}}</td>
														{%endif%}

														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(PenaltyAmount), getCurrencyObj(Loan.Currency)) }}</td>
														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(row.Principal) + float(row.Interest) + float(row.Charge) + float(PenaltyAmount), getCurrencyObj(Loan.Currency)) }}</td>
														<td>
															{% if int(row.RepStatus) == 0 %}
																{% if row.CollectionDate < str(SystemDate) and int(row.RepStatus)==1 %}
																	<i class="text-danger">Due Today</i>
																{% elif int(str(row.CollectionDate).replace('-', '')) == int(SystemDate.replace('-', '')) %}
																	<i class="text-info">Due Today</i>
																{% else %}
																	<i class="text-warning">Not Yet Due</i>
																{% endif %}
															{% elif int(row.RepStatus) == 1 %}
																<i class="text-danger">Past Due</i>
															{% elif int(row.RepStatus) == 2 %}
																<i class="text-warning">Partial Paid</i>
															{% elif int(row.RepStatus) == 3 %}
																<i class="text-success">Fully Paid On Time</i>
															{% elif int(row.RepStatus) == 4 %}
																<i class="text-info">Fully Paid But Late</i>
															{% elif int(row.RepStatus) == 5 %}
																<i class="text-success">Capitalize Interest</i>
															{% endif %}
														</td>
														<td class="text-right {{RowColor}}">{{ NumDayLate }}</td>
														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(row.PartPaidAmt), getCurrencyObj(Loan.Currency)) }}</td>
														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(row.WaivePenalty), getCurrencyObj(Loan.Currency), 1) }}</td>
														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(row.WaiveInterest), getCurrencyObj(Loan.Currency), 1) }}</td>
														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ toMoney(float(row.Balance), getCurrencyObj(Loan.Currency)) }}</td>
														<td class="text-right {{RowColor}}" style="padding-right: 35px;">{{ row.NumDay }}</td>
													</tr>
													<!-- End Showing Repayment Schedule data -->
													
													<!-- Showing Loan Reaches Maturity Date -->
													{% if loop.last %}
														<tr style="background-color: #D6D6D6;">
															<td colspan="{%if EnableChargeSchedule%} {{TotalCol}} {%else%} {{TotalCol}}-1 {%endif%}" class="text-center">
																<b><i>LOAN REACHES MATURITY DATE - {{row.CollectionDate}}</i></b>
															</td>
															{% for i in range(0,TotalCol) %}
																<td style="display: none;" class="hidden-td"></td>
															{% endfor %}
														</tr>
														
													{% endif %}

													<!-- End Showing Loan Reaches Maturity Date -->

													<!-- set Last collection date to current collection date if it is different -->
													{% if LastCollectionDate != row.CollectionDate %}
														{% set LastCollectionDate = row.CollectionDate %}
													{% endif %}

												{% endfor %}
												<!-- End Loop in Repayment Schedule -->
											{% endif %}
											<tr>
												<th class="text-right" style="border-top: 1px solid #000">Total</th>
												<th class="text-right style-total"></th>
												<th class="text-right style-total">{{ toMoney(float(TotalAmount['TotPrincipal']),getCurrencyObj(Loan.Currency)) }}</th>

												<th class="text-right style-total">{{ toMoney(float(TotalAmount['TotInterest']),getCurrencyObj(Loan.Currency)) }}</th>
												
												{%if EnableChargeSchedule%}
												<th class="text-right style-total">{{ toMoney(float(Schedule|sum(attribute='Charge')),getCurrencyObj(Loan.Currency)) }}</th>
												{%endif%}
												
												<th class="text-right style-total">{{ toMoney(float(TotalAmount['TotPenalty']),getCurrencyObj(Loan.Currency)) }}</th>
												<th class="text-right style-total">{{ toMoney(float(TotalAmount['TotPrincipal']) + float(TotalAmount['TotInterest']) + 
																					float(Schedule|sum(attribute='Charge'))+ float(TotalAmount['TotPenalty']),getCurrencyObj(Loan.Currency)) }}</th>
												<th class="text-right style-total"></th>
												<th class="text-right style-total"></th>
												<th class="text-right style-total">{{ toMoney(float(TotalAmount['TotPaidAmt']),getCurrencyObj(Loan.Currency), 1) }}</th>
												<th class="text-right style-total">{{ toMoney(float(TotalAmount['TotWaivePenalty']), getCurrencyObj(Loan.Currency), 1) }}</th>
												<th class="text-right style-total">{{ toMoney(float(TotalAmount['TotWaiveInterest']), getCurrencyObj(Loan.Currency), 1) }}</th>
												<th class="text-right style-total"></th>
												<th class="text-right style-total"></th>
											</tr>
										</tbody>
									</table>
								{% endif %}
							</div><!-- Responsive-->
						</div>
					</div>
				</div>
				<!-- </div> -->
			</div>
		{% endif %}
	</div>

{% endblock %}

{% block js %}
    <!-- <script src="{{ url_for('static',filename='javascripts/jquery.datatables.min.js') }}"></script> -->

	{% from "print.html" import exportIncludeJS %}
	{{exportIncludeJS()}}

	<script type="text/javascript">
		$(document).ready(function() {

            $('#mktlist').dataTable({
            	responsive: true,
               "lengthMenu": [[12, 36, 48, 60,120, -1], [12, 36, 48, 60,120, "All"]],
               "bSort": false,
               // "pageLength": 12
            });

			{% from "print.html" import exportDataTable %}
			{{exportDataTable('#mktlist','Repayment Schedule')}}

            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
              if(isMobile==true)
              {
              	$('.osAmt').css('max-height','650px');
              }

        });

		function fn_fadeIn(){
			var $getParentEle = window.parent.$("#animated")
			$getParentEle.fadeIn("slow");
		}
		$('#btnShow').on("click",function(event) 
		{
			fn_fadeIn();
		}); 

		$('#btnExpand').click(function() {
			$("#Detail").slideToggle('slow', 'swing');
			$('#btnExpand i').toggleClass('fa-chevron-down');
		});

	</script>

{% endblock %}

{% macro AddDataToList(TotalAmount, Principal, Interest, Penalty, PaidAmt, WaivePenalty, WaiveInterest) %}
	{% if TotalAmount.update({ 
		"TotPrincipal":float(TotalAmount["TotPrincipal"]) + float(Principal),
		"TotInterest":float(TotalAmount["TotInterest"]) + float(Interest),
		"TotPenalty":float(TotalAmount["TotPenalty"]) + float(Penalty),
		"TotPaidAmt":float(TotalAmount["TotPaidAmt"]) + float(PaidAmt),
		"TotWaivePenalty":float(TotalAmount["TotWaivePenalty"]) + float(WaivePenalty),
		"TotWaiveInterest":float(TotalAmount["TotWaiveInterest"]) + float(WaiveInterest)
		})%}
	{% endif %}

{% endmacro %}
