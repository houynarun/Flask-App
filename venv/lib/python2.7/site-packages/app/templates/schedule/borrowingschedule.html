{% extends "layout.html" %}

{% block css %}
 <style type="text/css">
 	tr{
 		height:35px;
 	}
 #Tableselect::-ms-expand {
            width:12px;
            border:none;
            background:#fff;
        }

  .save-msg{
  			display: none;
  			position: relative;
  			margin: 0;
  }

  .btn-close{
  			border: 0;
  			background: transparent;
  			position: relative;
  			float: right;
  			font-size:19.5px;
  			font-weight: 700;
  			color: #555;
  			opacity: .2;
  			padding: 0px;
  			margin-top: -5px;
  }
  .btn-close:hover{
  			opacity: 1;
  }

  .brr-title{
            font-family: inherit;
            font-size:14pt;
            font-weight: 700;
            color:#777;
        }


 </style>

{% endblock %}

{% block content %}

<div class="col-sm-12 navbar navbar-default navbar-static-top" style="padding: 10px !important; margin: 0px !important;">
			<div class="form-group" style="margin: 0px !important;">
				<input type="hidden" name="ContractID" id="ContractID" value="{{ ContractID }}">
				<input type="hidden" name="Resource" value="{{ Resource }}">
				<input type="hidden" name="FilePath" value="{{ FilePath }}" id="fp">
				<input type="hidden" name="AmtID" id="AmtID" value="{{ AmtID }}">				
				<input type="hidden" name="IsError" id="IsError" value="{{ IsError }}">
				<div class="col-sm-12" style="display: flex;justify-content: space-between;">
					<div style="padding-top: 5px;">
					
						<a href="javascript:void(0)" id="Save"  style="color: #777;">
						<span class="btn-label icon fa fa-floppy-o"></span> Save
						</a> &nbsp;&nbsp;&nbsp;

						<a href="javascript:void(0)" id="Edit" style="color: #777;">
							<span class="btn-label icon fa fa-pencil-square-o"></span>&nbsp; Edit
						</a> &nbsp;&nbsp;&nbsp;

					</div>
					<div style="padding-top: 5px;">
						<a href="javascript:void(0)" id="Download" style="color: #777;">
							<span class="btn-label icon fa fa-download"></span>&nbsp; Download Schedule Template
						</a> &nbsp;&nbsp;&nbsp;
					</div>
				</div>
				
			</div>
			<script type="text/javascript">
				
				ScheduleObj = $('#schedule').val();
				IsError 	= $('#IsError').val();
				ErrMessage 	= $('#save-msg-err');
				Message 	= $('#save-msg');
				function formatDate(date) {
				    var d = new Date(date),
				        month = '' + (d.getMonth() + 1),
				        day = '' + d.getDate(),
				        year = d.getFullYear();

				    if (month.length < 2) month = '0' + month;
				    if (day.length < 2) day = '0' + day;

				    return [year, month, day].join('-');
				}

				const CollectionDate = formatDate(Date.now());
				const rows = [["InstallmentNo", "CollectionDate", "Principal", "Interest", "Charge", "Balance"], [1,CollectionDate, 0, 0, 0, 0]];												

				var csvContent = "data:text/csv;charset=utf-8,";
				rows.forEach(function(rowArray){
				   var row = rowArray.join(",");
				   csvContent += row + "\r\n";
				});
				var encodedUri = encodeURI(csvContent);	
				var link = document.createElement("a");
				link.setAttribute("href", encodedUri);
				link.setAttribute("download", "schedule_template.csv");
				document.body.appendChild(link);				
								
				init.push(function (event) {
					Schedule = $('#schedule').val()
					$('#New').click(function(){
						window.location.href="/Morakot/{{g_getUrlExtend(Module='BorrowingContract')}}/New";
					});
					$('#Download').click(function(){
						link.click();						
					});
					$('#Save').click(async function(e){
						
						// if (IsError!="True"){
						$('#frmData').attr('action', "/Morakot/BorrowingSchedule/{{BorrowingID}}?Resource={{Resource}}&Save=Y&IsError={{IsError}}");
						$('#frmData').submit();
						// window.setTimeout(window.location.href = "/Morakot/{{g_getUrlExtend(Module='BorrowingContract')}}/",5000);
						// } else {
						// 	$('#save-msg-err').css('display','none');
						// 	$('#save-msg-err').fadeIn(200);
						// 	$('#save-msg-err').find('p').text('Please correct all error to save schedule.');
							
						// }
						
					});
					$('#close-err').click(function(){
						$('#save-msg-err').slideUp('slow');
						$('#save-msg-err').find('p').empty();
					})
					$('#Edit').click(function(e){
						window.location.href="/Morakot/{{g_getUrlExtend(Module='BorrowingContract')}}/Edit/{{ BorrowingID }}/";
					});
				});
			</script>
</div>

<div class="clearfix save-msg" id="save-msg-err">
	<div class="col-sm-12">	
		<div class="clearfix">&nbsp;</div>
        <div class="alert alert-danger" style="margin-bottom: 0px">
	        <button type="button" id="close-err" class="btn-close" >&times;</button>
	        <p></p>
        </div>
    </div>
</div>
<!--  message  -->
<div class="col-sm-12" style="margin: 0">
	{% autoescape false %}
    {% for message in get_flashed_messages() %}
        {% if contain(message, "Error") %}
            <div class="clearfix">&nbsp;</div>
            <div class="alert alert-danger">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <p></p>
                {{ message|replace("Error","") }}
            </div>
        {% else %}
            <div class="clearfix">&nbsp;</div>
            <div class="alert alert-info">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                {{ message }}
            </div>
        {% endif %}
    {% endfor %}
    {% endautoescape %}
</div>

<div class="clearfix save-msg" id="save-msg">
	<div class="col-sm-12">
		<div class="clearfix">&nbsp;</div>
		<div class="alert alert-info">
    	<button type="button" class="close" data-dismiss="alert">&times;</button>
    	<p></p>
	</div>
	</div>
</div>

{% if FieldRequired %}
<div class="clearfix"></div>
<div class="col-sm-12">

	<div class="alert alert-danger" id="alert-danger">
		<ol>
			{% for message in FieldRequired %}
			<li id="lblTableName">
				<a class="error_pointer">
					<label for="TableName">
						{{message[0]}} <span style="color:#d38e99">*:</span>
					</label>
				</a> {{message[1]}}
			</li>		
			{% endfor %}
		</ol>
	</div>
</div>
{% endif %}

<div class="col-sm-12">

	<form method="post" enctype="multipart/form-data" id="frmData" name="myform" >
	<table class="col-sm-6">
		
	<tr style="padding-top: 20px">
		<td class="col-sm-4">
			<label for="Uploadfile"> Schedule Upload (csv only) </label> <span style="color:#d38e99">*</span>
		</td>
		<td class="col-sm-5">
			<input type="hidden" name="files" value="{{ScheduleObj}}" id="schedule" />
			<input type="hidden" value="{{IsError}}" id="iserror" />
			<input type="file" name="file" id="fileUpload" style="width:40% !important;" accept="text/csv" />
			<script>
					init.push(function () {
						$('#fileUpload').pixelFileInput({ placeholder: 'No file selected...' });
						$('#fileUpload').change(function(){ 
							$('#frmData').attr('action', "/Morakot/BorrowingSchedule/{{BorrowingID}}?Resource={{Resource}}");
							$('#frmData').submit(); 
						});
					})
			</script>
		</td>
		
	</tr>
	
	</table>	

	</form>
	
	
</div>
{% if ScheduleObj %}
		<div class="row"></div>
		<div class="col-sm-12">
			<div class="container-fluid">
				{% if ScheduleObj %}
					<h3 class="text-center brr-title">Borrowing Schedule for {{BorrowingID}}</h3>
					<table id="mktlist" class="table table-striped table-info table-dark" cellspacing="0" width="100%">
						<thead>
							<tr>
								{% set Header = [] %}
								
								{% if ScheduleObj[0].Charge == 0 or ScheduleObj[0].Charge == "" %}
									<span style="display: none;">{{HeaderTable.remove('Charge')}}</span>
								{% endif %}
							
								{%for item in HeaderTable %}
									<th>{{item}}</th>
								{% endfor %}
								
							</tr>
						</thead>
						<tbody>
							{% set TotalPayment = 0 %}
							{% for row in ScheduleObj %}
								<tr>
									{% set TotalPayment = float(row.Principal) + float(row.Interest) + float(row.Charge) %}
									<td>{{ loop.index }}</td> 
									<td>{{ row.CollectionDate }}</td> 
									<td>{{ toMoney(float(row.Principal), getCurrencyObj(BorrowingObj.Currency), 0) }}</td>
									<td>{{ toMoney(float(row.Interest), getCurrencyObj(BorrowingObj.Currency), 0) }}</td> 
									{% if row.Charge!="" and row.Charge!=0 %}
										<td>{{ toMoney(float(row.Charge), getCurrencyObj(BorrowingObj.Currency), 0) }}</td>
									{% endif %}
									<td>{{ toMoney(float(TotalPayment), getCurrencyObj(BorrowingObj.Currency), 0) }}</td>
									<td>{{ toMoney(float(row.Balance), getCurrencyObj(BorrowingObj.Currency), 0) }}</td>								
								</tr>
							{% endfor %}							
						</tbody>
						
					</table>
				{% endif %}
			</div>
			<div class="col-sm-offset-1"></div>
		</div>
		
{% endif %}

{% endblock %}



{% block js %}

<script type="text/javascript">
$(document).ready(function(event) {


	$('#mktlist').dataTable({
			"lengthMenu": [[25,50,100,200, -1], [25,50,100,200, "All"]],
			"bSort" : false,
			"bScrollCollapse": true
		});		
	
});

</script>
{% endblock %}