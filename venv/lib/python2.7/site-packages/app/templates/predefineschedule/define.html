{% extends "layout.html" %}

{% block content %}
{% from "_formhelper.html" import render_field %}
{% macro render_forms(form, action='', li_html='',g_id='',g_readonly='',disabled='',formReadOnly='', class_='', btn_class='btn btn-default') %}

	<form method="POST" id='frm' name="frm" role="form" class="{{ class_ }}">

	 {# call toolbar form #}
	 {% include "toolbar.html" %}
	 {% if form.errors %}
	 <div class="alert alert-danger">
		<ol>
			{% for field_name, field_errors in form.errors|dictsort if field_errors %}
				{%if field_name == 'csrf_token'%}
					{% for error in field_errors %}
						{%if error in 'failed'%}
							<li ><a href="#" class="error_pointer">Security</a>: Your token key was failed. Please log in again.</li>
						{%elif error in 'expired' %}
							<li ><a href="#" class="error_pointer">Security</a>:
								Your (CSFR) token key was expired. Please try again.
							</li>
						{%elif error in 'missing'%}
							<li ><a href="#" class="error_pointer">Security</a>:
							You have an cross-site request forgery (CSRF) attack. 
							The website you are visiting might contain malicious code. Please close the website immediately.</li>
						{%else%}
							<li ><a href="#" class="error_pointer">Security</a>:{{error}}</li>
						{%endif%}
					{%endfor%}<!--   -->
				{%else%}
					{% for error in field_errors %}
						<li ><a href="#{{field_name}}" class="error_pointer">{{ form[field_name].label }}</a>: {{ error }}</li>
					{% endfor %}
				{%endif%}
			{% endfor %}
		</ol>
	</div>
	{% endif %}
	{# call error form#}
	{% include "error.html" %}
	{% if form %}
		{{ form.hidden_tag() if form.hidden_tag }}
		{% if caller %}
			{{ caller() }}
		{% else %}
				{% for f in form %}
					{% if f.description =='' and f.id !='csrf_token'%}
						{% if f.type == 'BooleanField' %}
							{{ render_checkbox_field(f) }}
						{% elif f.type == 'RadioField' %}
							{{ render_radio_field(f) }}
						{% else %}
							
							  {{ render_field(f,disabled) }}
							
						{% endif %}
					{% endif %}
				{% endfor %}
				<div class="row">
					<div class="col-xs-2"></div>
					<div class="col-sm-8" style="padding-left: 4px;">
						<button type="submit" id="Generate" class="btn btn-flat btn-labeled btn-primary ActionFotter" style="margin-right: -36px;">
							<span class="btn-label icon fa fa-th"></span>Generate Disbursement</button>
					</div>
					<p id="frmGenerate"></p>
				</div>

				<div class="row">
					<div id="container_tab" class="tab-content">
						<ul class="nav nav-tabs bs-tabdrop-example" role="tablist">
							<li class='active'><a data-toggle="tab" href="#1-Schedule">Schedule</a></li>
							<li><a data-toggle="tab" href="#9-Audit">Audit</a></li>
						</ul>
					</div>
					<div class="tab-content">
						<div id="1-Schedule" class="tab-pane fade in active">
							<div class="row">
								<div class="col-sm-10 col-sm-offset-1">
									<h3 class="text-center">Repayment Schedule</h3>
									<table id="mylist" class="table table-striped table-info table-dark" cellspacing="0" width="100%">
										<thead>
											<tr>
												<td>No</td>
												<td>Collection Date</td>
												<td>Principal</td>
												<td>Interest</td>
												<td>Charge</td>
												<td>Total Amount</td>
												<td>Balance</td>
												<td>NumberOfDay</td>
											</tr>
										</thead>
										<tbody id="Schedule"></tbody>
									</table>
								</div>
							</div>
						</div>
						<div id="9-Audit" class="tab-pane fade">
							<div class="row">
								{% set chk=1%}
								{% for tablist in form|groupby('description')%}
									{% if tablist.grouper !="" %}
										<div id="{{tablist.grouper|replace(" ","")}}" class="tab-pane fade {% if chk==1 %} in active {% endif %}"><br/>
											{%set chk=2%}
											{% for f in tablist.list %}
												{% if loop.last %}
													{% set rng= maxValue(tablist.list,"_")|int +1 %}
													{%set i=1%}
													{% for i in range(1,rng) %}
													<div id="{{tablist.grouper|replace(" ","") +"_"+i|string}}" class='mspan'>
														{% for f in tablist.list %}
														  {% if i ==delimiterdic(f.id,"_")|int  %}
																{% if f.type == 'BooleanField' %}
																	{{ render_checkbox_field(f) }}
																{% elif f.type == 'RadioField' %}
																	{{ render_radio_field(f) }}
																{% else %}
																	{{ render_field(f,disabled) }}
																{% endif %}
														  {% endif %}
														{% endfor %}
													</div>
											 		{% endfor %}
												{% endif %}
											{% endfor %}
										</div>
									{% endif %} {#end if of tablist #}
								{% endfor %} {# end for of tablist #}
							</div>
						</div>
					</div>
				</div>
		{% endif %}

{# call form attribute #}
{% include "formattr.html" %}

{% endif %}

<script type="text/javascript">
	init.push(function () {
	toolbar("{{'/'+action.split('/')[1]+'/'+action.split('/')[2]}}")
		$('ul.bs-tabdrop-example').tabdrop();
	});

	$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
	$(document).ready(function() {
		$('#Generate').on('click', function() {
			$.getJSON($SCRIPT_ROOT + '/Morakot/viewGenerateSchedule', {
			RepMode 				: $('#RepMode').val(),
			FwdBwdKey 				: $('#FwdBwdKey').val(),
			ValueDate 				: $('#ValueDate').val(),
			FirstInstallmentDate 	: $('#FirstInstallmentDate').val(),
			BaseDateKey 			: $('#BaseDateKey').val(),
			FreqType 				: $('#FreqType').val(),
			Frequency 				: $('#Frequency').val(),
			PrincipalFreq 			: $('#PrincipalFreq').val(),
			InterestFreq 			: $('#InterestFreq').val(),
			WeekDay 				: $('#WeekDay').val(),
			NumOfWeek 				: $('#NumOfWeek').val()
			}, function(data) {
				var tr = ''
				var WeekDays 	= data.WeekDays
				var NumOfWeek 	= data.NumOfWeek
				for(var i = 0; i < data.result.length; i++) {
				 var obj = data.result[i]
				 tr += "<tr><td>"+(i+1)+"</td>"
				 tr += "<td>"+obj.CollectionDate+"</td>"
				 tr += "<td>"+obj.Principal+"</td>"
				 tr += "<td>"+obj.Interest+"</td>"
				 tr += "<td>"+obj.Charge+"</td>"
				 tr += "<td>"+obj.TotalAmount+"</td>"
				 tr += "<td>"+obj.Balance+"</td>"
				 tr += "<td>"+obj.NumberOfDay+"</td></tr>"
				}
				 // console.log(data.result)
				$('#mylist>#Schedule').html(tr)
			});
			return false;
		});

		// $('#mktlist').dataTable({
		// 	"lengthMenu": [[25,50,100,200, -1], [25,50,100,200, "All"]],
		// 	"bSort" : false,
		// 	"bScrollCollapse": true
		// });
		// {% from "print.html" import exportDataTable %}
		// {{exportDataTable("#mktlist","Daily Cash Collection Reports ")}}
		// if($('#ChargeType').val() == "1"){
		// 	$('#ChargeText').html('Example: 50 per each installment');
		// } else if ($('#ChargeType').val() == "2"){
		// 	$('#ChargeText').html('Example: 1% of Disburse amount per each installment');
		// } else if ($('#ChargeType').val() == "3"){
		// 	$('#ChargeText').html('Example: 1% of Loan Balance per each installment');
		// } else {
		// 	$('#ChargeText').html('Charge value can be fix amount or rate based on charge type');
		// }
	});

</script>
	<!-- end Javascript -->

	{# active csrf token #}
	{{ form.csrf_token }}
	</form>

{%- endmacro %}

	<div class="form-horizontal">
		{{ render_forms(form, action=action,li_html=li_html,g_id=g_id,g_readonly=g_readonly,disabled=disabled,formReadOnly=formReadOnly) }}
	</div>

{% endblock %}
