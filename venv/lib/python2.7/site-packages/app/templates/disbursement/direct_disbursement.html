{% extends "disbursement/disbursement_sheet.html" %}
{% block js%}
	{{super()}}

	<script type="text/javascript">
		
		$(document).ready(function(){

			var IsDisabled = "{{disabled_ex}}";


			Object.size = function(obj) {
			    var size = 0, key;
			    for (key in obj) {
			        if (obj.hasOwnProperty(key)) size++;
			    }
			    return size;
			};
			
			$(function(){

				$('#Officer').unbind("change");
				$('#Currency').unbind('change');
				$('#AddLoanID').unbind('change');
				var AddButton = document.getElementById("Add");
				AddButton.id = "AddEx";
				// $('#Add').unbind("click");

				if ( $.fn.DataTable.isDataTable('#mktlist') ) {
					$('#mktlist').DataTable().destroy();
					$('#mktlist').empty();
					
					var source = '<table id="mktlist"  class="table table-striped table" cellspacing="0" width="100%">\
								<thead>\
									<tr>\
										<th>{{ getLanguage('ID') }}</th>\
										<th>{{ getLanguage('Customer') }}</th>\
										<th>{{ getLanguage('Account') }}</th>\
										<th>{{ getLanguage('Currency') }}</th>\
										<th>Disbursement Date</th>\
										<th>{{ getLanguage('Amount') }}</th>\
										<th>Compulsory Amount</th>\
										{% if ChargeList %}\
											{% for key, val in ChargeList.iteritems() %}\
											<th>{{val}}</th>\
											{% endfor %}\
										{%endif%}\
										<th>{{ getLanguage('Available Balance') }}</th>\
										{%if not disabled_ex%}\
										<th class="ActionFotter">{{ getLanguage('Action') }}</th>\
										{%endif%}\
									</tr>\
								</thead>\
								<tbody>\
								<input style="display: none" id="RObj" name="ResultObj" value="{{ResultObj}}" />\
								<input id="ChargeKeyList" value="{{ChargeKeyList}}" style="display: none"/>\
									{%if ResultObj %}\
										\
										{%for row in ResultObj if row['Amount'] > '0' %}\
											<tr id="TrVal">\
												<td id="TdVal">\
												<input type="hidden" name="LoanID_{{row['ID']}}" 			id="LoanID_{{row['ID']}}" 		value="{{row['ID']}}">\
												<input type="hidden" name="Customer_{{row['ID']}}" 		id="Customer_{{row['ID']}}" 	value="{{row['Customer']}}">\
												<input type="hidden" name="Account_{{row['ID']}}" 		id="Account_{{row['ID']}}" 		value="{{row['Account']}}">\
												<input type="hidden" name="Currency_{{row['ID']}}" 		id="Currency_{{row['ID']}}" 	value="{{row['Currency']}}">\
												<input type="hidden" name="ValueDate_{{row['ID']}}" 	id="ValueDate_{{row['ID']}}" 	value="{{row['ValueDate']}}">\
												<input type="hidden" name="AvailableBal_{{row['ID']}}" 	id="AvailableBal_{{row['ID']}}" value="{{row['AvailableBal']}}">\
												<input type="hidden" name="CompulsoryAmount_{{row['ID']}}" 	id="CompulsoryAmount_{{row['ID']}}" value="{{row['CompulsoryAmount']}}">\
												<input type="hidden" name="Documentation_{{row['ID']}}" 	id="Documentation_{{row['ID']}}" value="{{row['ChargeDict']['Doc'] if row['ChargeDict']['Doc'] else 0}}">\
												<input type="hidden" name="Welfarefund_{{row['ID']}}" 	id="Welfarefund_{{row['ID']}}" value="{{row['ChargeDict']['Wel'] if row['ChargeDict']['Wel'] else 0}}">\
												<input id="ChargeKeyDict" value="{{ChargeList}}" style="display: none"/>\
												<input id="NewChargeKeyDict" style="display: none"/>\
												<input id="LoanChargeDict" style="display: none"/>\
												<input id="AllChargeKeyList" style="display: none"/>\
												{% for Charge in ChargeList %}\
													<input type="hidden" data-loan="{{row.ID}}" class="form-control" id="Fee_{{Charge}}_{{row.ID}}" name="Fee_{{Charge}}_{{row.ID}}" value="{{row['UpFrontCharge'][Charge] or 0}}" {{disabled_ex}} style="width: 120px;">\
												{% endfor %}\
												\
												{{row['ID']}}</td>\
												<td>{{row['Customer']}}</td>\
												<td>{{row['Account']}}</td>\
												<td>{{row['Currency']}}</td>\
												<td>{{row['ValueDate']}}</td>\
												<td>\
													<input type="text" data-loan="{{row.ID}}" class="form-control moneyfield" id="Amount_{{row.ID}}" name="Amount_{{row.ID}}" value="{{row['Amount']}}" {{disabled_ex}} style="width: 120px;">\
												</td>\
												<td>{{toMoney(float(row['CompulsoryAmount']),getCurrencyObj(row['Currency']))}}</td>\
												\
												{% for Charge in ChargeList %}\
													{% if row['UpFrontCharge'][Charge] %}\
														<td>{{toMoney(float(row['UpFrontCharge'][Charge]),getCurrencyObj(row['Currency']))}}</td>\
													{% else %}\
														<td>0</td>\
													{% endif %}\
												{% endfor %}\
												\
												<td>\
													{%if float(row['Amount'].replace(',',''))  > float(row['AvailableBal'].replace(',','')) %}\
														<label id="Balance_{{row['ID']}}" class="text-danger">{{row['AvailableBal']}}\
														</label>\
													{%else%}\
														<label id="Balance_{{row['ID']}}" class="text-success">{{row['AvailableBal']}}\
														</label>\
													{%endif%}\
												</td>\
												{%if not disabled_ex%}\
													<td id="row_{{row['ID']}}" class="ActionFotter" onclick="setDeleteRow(' + "'{{row["ID"]}}'" + ')"' + '>\
														<a class="link">\
															<span class="label label-danger">{{ getLanguage('Delete') }}</span>\
														</a>\
													</td>\
												{%endif%}\
											</tr>\
										{%endfor%}\
									\
									{%endif%}\
									</tbody>\
									<tfoot>\
										<tr>\
											<th><b>{{ getLanguage('Total') }}</b></th>\
											<th>\
												<b><label id="CountLoanID">\
												{%if kwargs%}\
													{%if ListLoanID%}\
														{{ListLoanID|length}}\
													{%endif%}\
												{%else%}\
													{{TotalLoanContract}}\
												{%endif%}\
												</label></b>\
											</th>\
											<th></th>\
											<th></th>\
											<th></th>\
											\
											<th><b><label id="SumLoanID">\
												\
												{{TotalDisbursement}}\
											\
											</label></b></th>\
											{% if disabled_ex == ""%}\
											<th>\
												{##{toMoney(float(TotalCompulsory),getCurrencyObj(CurrencyObj.first().ID))}#}\
											</th>\
											{% endif %}\
											{% for Charge in ChargeList %}\
												<th></th>\
											{% endfor %}\
											<th></th>\
											<th class="ActionFotter"></th>\
										</tr>\
									</tfoot>\
								</table>';
					
					$('#mktlist').replaceWith(source);
					
					// table = $('#mktlist').DataTable({
					//   "destroy": true,
					//   "sort" : false,
					//   "cache": true,
					//   "scrollX": true,
					//   // "dom": 'T<"clear">lfrtip',
					//   "lengthMenu": [[25,100,200,300,500, -1], [25,100,200,300,500, "All"]],
					//   "bSort" : false,
					//   "displayLength": 25,
					//   "order": [ 0, 'asc' ],
					// });
				};
				{% from "print.html" import exportDataTable %}
				{{exportDataTable('#mktlist',"Disbursement Sheet")}}
				
			});
			
			
			$(function(){
				// To make sure that this block run lastly, that's why I use setTimeout.
				if (IsDisabled === ""){
					setTimeout(function(){
						$("#OfficerAccount").val("{{Account}}");
						$("#OfficerCategory").val("{{AccCategory}}");
						$("#OfficerBalance").val("{{AvailableBal}}");
						$('#RObj').css("display", "none");
					}, 100);
				}
			});
			
			$(function(){
				officerAccParent = $("#OfficerAccount").parent();
				officerCatParent = $("#OfficerCategory").parent();
				officerBalParent = $("#OfficerBalance").parent();
				$("#frmGenerate").attr("action", "/Morakot/DirectGroupDisbursement");
				$("#frmGenerate").on("submit", function(){
					$("#OfficerAccount").val("{{Account}}");
					$("#OfficerCategory").val("{{AccCategory}}");
					$("#OfficerBalance").val("{{AvailableBal}}");
				});

				officerAccParent.siblings("label").text("Account");
				officerCatParent.siblings("label").text("Category");
				officerBalParent.siblings("label").text("Balance");
				
				if (IsDisabled === "disabled"){

					$('#frmGenerate :input').prop("disabled", true);
					$('#Auto').prop("disabled", true);
				}
				
				if (IsDisabled === ""){
					$("#Currency").on("change", function(){
						$.getJSON('/Morakot/GenerateDisbursementAccountEx', {
							Currency:$('#Currency').val(),Officer:$('#Officer').val()
							}, function(data) {
								$('#OfficerAccount').val(data.OfficerAccount);
								$('#OfficerCategory').val(data.OfficerCategory);
								$('#OfficerBalance').val(data.AvailableBal);
							});
							
							return false;
					});
				}
			});

			$(function(){

				$('#AddLoanID').bind('change', function() {
					
					$.getJSON('/Morakot/DirectGroupDisbursement/AddLoanContract', {
						LoanID:$('#AddLoanID').val(),
						ChargeKeyList:$('#ChargeKeyList').val(),
						ChargeKeyDict:$('#ChargeKeyDict').val()
					}, function(data) {
						$('#AddCustomer').val(data.Customer);
						$('#AddCurrency').val(data.Currency);
						$('#AddValueData').val(data.ValueDate);
						$('#AddAccount').val(data.Account);
						$('#AddAmount').val(data.Amount);
						$('#AddBalance').val(data.Balance);
						$('#AddCOMAmount').val(data.COMAmount);
						$('#NewChargeKeyDict').val(data.NewChargeKeyDict);
						$('#LoanChargeDict').val(data.LoanChargeDict);
						$('#ChargeKeyDict').val(data.ChargeKey);
						$('#AllChargeKeyList').val(data.AllChargeKeyList);
						// console.log("ChargeKeyDict", $("#NewChargeKeyDict").val());
						// console.log("LoanChargeDict", $('#LoanChargeDict').val());
					});
					return false;
				});

			});

			setTimeout(function(){
			$('#AddEx').on("click",function(e){
				// alert("Fuck Me!");
				fn_fadeOut();
				var LoanID 		= 	$('#AddLoanID').val();
				var Customer 	= 	$('#AddCustomer').val();
				var Account 	= 	$('#AddAccount').val();
				var Currency 	= 	$('#AddCurrency').val();
				var ValueDate 	= 	$('#AddValueData').val();
				var StrBalance 	= 	$('#AddBalance').val();
				var COMSaving 	= 	$('#AddCOMAmount').val();
				
				var ChargeKeyDict  = JSON.parse($('#ChargeKeyDict').val());
				var NewChargeKey   = JSON.parse($("#NewChargeKeyDict").val());
				var LoanChargeDict = JSON.parse($('#LoanChargeDict').val());
				var AllChargeKeyList = JSON.parse($('#AllChargeKeyList').val());

				var StrAmount 	= 	$('#AddAmount').val();
				var Amount 		= 	parseFloat(StrAmount.replace(/\,/g, ""));
				var Balance 	= 	parseFloat(StrBalance.replace(/\,/g, ""));
				var Action 		= 	"<a class='link'><span class='label label-danger'>Delete</span></a>";
				var Message 	= 	""
				var InputAmount = 	"<input type='text' data-loan='"+LoanID+"' class='form-control moneyfield' style='width: 120px' id='Amount_"+LoanID+"' name='Amount_"+LoanID+"' value='"+StrAmount+"'>";
				var AvailableBal= 	"<label id='Balance_"+LoanID+"' class='text-success'>"+StrBalance+"</label>";
				var CompulsoryAmount = "<label id='CompulsoryAmount_"+LoanID+"' data-loan='"+LoanID+"' class='moneyfield'>"+COMSaving+"</label>";

				if (LoanID==""){
					Message = "<span class='text-info'>Loan ID/Customer*</span>:This field is required."
					$('#ModalMessage').html(Message);
					$('#ModalBox').show();
				}else{
					if (Object.size(NewChargeKey) > 0) {
						alert("Allow to add only Loan Contract which has the same charge key.");
					}
					else if (isDuplicateLoanID(LoanID) == false){
					 //it doesn't exist
 						if (Amount <= 0){
							Message = "<span class='text-info'>Amount*:</span> Amount must be more than 0."
							$('#ModalMessage').html(Message);
							$('#ModalBox').show();
						}else{
							if(Amount>Balance){
								
								Message = "<span class='text-info'>Amount*:</span> Amount must be less than available balance."
								$('#ModalMessage').html(Message);
								$('#ModalBox').show();
							}else{
								$('#ModalBox').hide();
								// var inputAmount = document.createElement('input');
								// inputAmount.setAttribute("id", 'LoanID_'+LoanID);
								// inputAmount.setAttribute("name", 'LoanID_'+LoanID);
								// inputAmount.setAttribute("value", LoanID);

								// $('#mktlist tbody tr:last-child').after(inputAmount);
								console.log("loanid", LoanID);
								$('<input>').attr({
										type: 'hidden',
										id: 'LoanID_'+LoanID,
										name: 'LoanID_'+LoanID,
										value: LoanID
									}).appendTo('#mktlist tbody tr:last-child');

								$('<input>').attr({
									type: 'hidden',
									id: 'CompulsoryAmount_'+LoanID,
									name: 'CompulsoryAmount_'+LoanID,
									value: COMSaving
								}).appendTo('#mktlist tbody tr:last-child');

								$('<input>').attr({
									type: 'hidden',
									id: 'Customer_'+LoanID,
									name: 'Customer_'+LoanID,
									value: Customer
								}).appendTo('#mktlist tbody tr:last-child');

								$('<input>').attr({
									type: 'hidden',
									id: 'Account_'+LoanID,
									name: 'Account_'+LoanID,
									value: Account
								}).appendTo('#mktlist tbody tr:last-child');

								$('<input>').attr({
									type: 'hidden',
									id: 'Currency_'+LoanID,
									name: 'Currency_'+LoanID,
									value: Currency
								}).appendTo('#mktlist tbody tr:last-child');

								$('<input>').attr({
									type: 'hidden',
									id: 'ValueDate_'+LoanID,
									name: 'ValueDate_'+LoanID,
									value: ValueDate
								}).appendTo('#mktlist tbody tr:last-child');

								$('<input>').attr({
									type: 'hidden',
									id: 'AvailableBal_'+LoanID,
									name: 'AvailableBal_'+LoanID,
									value: StrBalance
								}).appendTo('#mktlist tbody tr:last-child');

								$('<input>').attr({
									type: 'hidden',
									id: 'Welfarefund_'+LoanID,
									name: 'Welfarefund_'+LoanID,
									value: 0
								}).appendTo('#mktlist tbody tr:last-child');

								$('<input>').attr({
									type: 'hidden',
									id: 'Documentation_'+LoanID,
									name: 'Documentation_'+LoanID,
									value: 0
								}).appendTo('#mktlist tbody tr:last-child');

								
								var Data = [LoanID,
											Customer,
											Account,
											Currency,
											ValueDate,
											InputAmount,
											CompulsoryAmount,
											AvailableBal,
											Action
											];
								
								
								var ExistingChargeKey = Object(ChargeKeyDict).keys();
								
								for(var key of ExistingChargeKey){
									
									$('<input>').attr({
										type: 'hidden',
										id: 'Fee_' + key + '_' + LoanID,
										name: 'Fee_' + key + '_' + LoanID,
										value: Object.size(LoanChargeDict[key]) != 0 ? LoanChargeDict[key][0] : 0
									}).appendTo('#mktlist tbody tr:last-child');

									console.log($("CompulsoryAmount_"+LoanID).val());

									Data.splice(7, 0, Object.size(LoanChargeDict[key]) != 0 ? LoanChargeDict[key][0] : 0);
								}

								insertRowDataTable(Data);
								updateTotalDisbursement("+",Amount,Currency);
								alert(LoanID+" was added successfully.");
								
							}
							
						}
					}else{
						alert(LoanID+" already exists.")
					}//End chkDuplicate

					}
				});}
			,300);
			
			
		});

	</script>
{% endblock %}
