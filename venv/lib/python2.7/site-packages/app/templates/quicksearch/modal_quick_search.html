<!-- Quick Search Modal -->
<div id="modal-quick-search" class="quick-search modal fade bs-example-modal-lg" tabindex="-1" role="dialog"
    aria-labelledby="modal-quick-search-label">
    <div class="modal-dialog modal-md" role="document">
        <div class="quick-search modal-content">
            <!-- Search Bar Content -->
            <div class="quick-search content">
                <div class="input-group input-group-lg">
                    <!-- Button Search -->
                    <div class="input-group-btn">
                        <button class="quick-search btn" type="button">
                            <i class="quick-search fa fa-search"></i>
                        </button>
                    </div>
                    <!-- End Button Search -->

                    <!-- Input Search -->
                    <input id="max-input-quick-search" type="text" class="quick-search form-control"
                        placeholder="Quick Search..." autocomplete="off">
                    <!-- End Input Search -->

                    <!-- Button Setting -->
                    <div class="input-group-btn">
                        <button class="quick-search btn" type="button" onclick="onClickSetting()">
                            <i class="quick-search fa fa-gear"></i>
                        </button>
                    </div>
                    <!-- End Button Setting -->
                </div>
            </div>
            <!-- End Search Bar Content -->

            <!-- Search Result -->
            <div id="quick-search-result" class="quick-search list-group content scrollbar-primary hide"></div>
            <!-- End Search Result -->
        </div>
    </div>
</div>
<!-- End Quick Search Modal -->

<!-- Quick Search Setting Modal -->
<div id="modal-quick-search-setting" class="quick-search modal fade bs-example-modal-lg" tabindex="-1" role="dialog"
    aria-labelledby="modal-quick-search-setting-label">
    <div class="modal-dialog modal-md" role="document">
        <div class="quick-search modal-content">
            <!-- Search Bar Content -->
            <div class="quick-search content" style="padding-bottom: 20px">
                <!-- Content Header -->
                <div class="input-group input-group-lg ">
                    <!-- Button Search -->
                    <div class="input-group-btn">
                        <button class="quick-search btn" type="button" onclick="onClickSetting()">
                            <i class="quick-search fa fa-arrow-left"></i>
                        </button>
                    </div>
                    <!-- End Button Search -->

                    <!-- Input Search -->
                    <div class="quick-search form-control">
                        <span class="quick-search"><b>Settings</b></span>
                    </div>
                    <!-- End Input Search -->

                    <!-- Button Setting -->
                    <div class="input-group-btn">
                        <div class="quick-search btn">
                        </div>
                    </div>
                    <!-- End Button Setting -->
                </div>
                <!-- Devider -->
                <div class="quick-search section devider"></div>
                <!-- End Devider -->
                <!-- End Content Header -->

                <div class="scrollbar-primary">
                    <!-- Theme Setting Item -->
                    <div href="#" class="quick-search setting list-group-item disable-hover">
                        <div>
                            <i class="quick-search menu-icon fa fa-paint-brush"></i>
                            <span class="quick-search item-text"><b>Theme</b></span>
                        </div>
                        <select id="quick-search-select-theme" class="quick-search select right">
                        </select>
                    </div>
                    <!-- Devider -->
                    <div class="quick-search devider"></div>
                    <!-- End Devider -->
                    <!-- End Theme Setting Item -->

                    <!-- Shortcut Setting Item -->
                    <div class="quick-search setting list-group-item disable-hover">
                        <div>
                            <i class="quick-search menu-icon fa fa-share"></i>
                            <span class="quick-search item-text"><b>Shortcut</b></span>
                        </div>
                        <input style="margin-left: 10px" id="quick-search-input-shortcut" type="text" class="quick-search collapse-input right"
                            placeholder="Shortcut key..." autocomplete="off">
                    </div>
                    <!-- Devider -->
                    <div class="quick-search devider"></div>
                    <!-- End Devider -->
                    <!-- End Shortcut Setting Item -->

                    <!-- Aliases Setting Item -->
                    <a href="#collapse-aliases" data-toggle="collapse" aria-expanded="true"
                        aria-controls="collapse-aliases" class="quick-search setting list-group-item collapsed disable-hover">
                        <div>
                            <i class="quick-search menu-icon fa fa-bookmark"></i>
                            <span class="quick-search item-text"><b>Aliases</b></span>
                        </div>
                        <i class="quick-search menu-icon right fa fa-angle-down"></i>
                    </a>
                    <!-- Devider -->
                    <div class="quick-search devider"></div>
                    <!-- End Devider -->
                    <div id="collapse-aliases" class="quick-search collapse">

                        <!-- Alias List -->
                        <div id="aliases-list">
                            <!-- Alias Header -->
                            <div>
                                <div href="#" class="quick-search list-group-item collapse-item disable-hover">
                                    <div class="quick-search button-square delete-alias" style="margin-right:5px;display:none">
                                    </div>
                                    <span class="quick-search collapse-input"><b>Alias:</b></span>
                                    <span class="quick-search collapse-input"><b>Alias Label:</b></span>
                                    <span class="quick-search collapse-input right"><b>Alias Url:</b></span>
                                </div>
                                <!-- End Alias Item -->
                                <!-- Devider -->
                                <div class="quick-search devider"></div>
                                <!-- End Devider -->
                            </div>
                            <!-- End Alias Header -->
                        </div>
                        <!-- End Alias List -->

                        <!-- Alias Control -->
                        <div class="quick-search list-group-item collapse-item disable-hover">
                            <div class="quick-search row" >
                                <button id="quick-search-btn-add-alias" onclick="addAlias()" class="quick-search button-square primary" style="margin-left: 10px">
                                    <i class="fa fa-plus"></i>
                                </button>
                                <button id="quick-search-btn-delete-alias" class="quick-search button-square danger" style="margin-left: 5px"
                                    onclick="showDeleteAlias()">
                                    <i class="fa fa-trash"></i>
                                </button>
                                <button id="quick-search-btn-cancel-delete-alias" class="quick-search button-square" style="margin-left: 10px;display: none;" 
                                    onclick="hideDeleteAlias()">
                                    <i class="fa fa-ban"></i>
                                    <span style="margin-left: 5px"><b>Cancel Delete</b></span>
                                </button>
                            </div>
                        </div>
                        <!-- End Alias Control -->
                        <!-- Devider -->
                        <div class="quick-search devider"></div>
                        <!-- End Devider -->
                    </div>
                    <!-- End Aliases Setting Item -->

                    <!-- Setting Item -->
                    <a href="#collapse-help" data-toggle="collapse" aria-expanded="true" aria-controls="collapse-help"
                        class="quick-search setting list-group-item collapsed disable-hover">
                        <div>
                            <i class="quick-search menu-icon fa fa-info-circle" style="font-size: 16px"></i>
                            <span class="quick-search item-text"><b>Help</b></span>
                        </div>
                        <i class="quick-search menu-icon right fa fa-angle-down"></i>
                    </a>
                    <!-- Devider -->
                    <div class="quick-search devider" style="border-bottom: 1px solid transparent;;"></div>
                    <!-- End Devider -->
                    <!-- Collapse Content -->
                    <div id="collapse-help" class="quick-search collapse well">
                        <!-- Menu Search -->
                        <h4>1. Menu Search</h4>
                        <p>User able to search menu via quick search. While searching, it will populate the suggestion
                            found in current user menu. When user click on the suggestion, it will open the form.</p>
                        <p><b>Example:</b> Input "Cu[stomer]"</p>
                        <p>=> Suggestion: </p>
                        <ul>
                            <li>Customer</li>
                            <li>Customer Center</li>
                            <li>Customer Detail Listing</li>
                            <li>Potential Customer</li>
                            <li>...</li>
                        </ul>
                        <!-- End Menu Search -->

                        <!-- Advanced Search -->
                        <h4>2. Advanced Search</h4>
                        <p>User able to search customer via quick search. While inputting customer name, it will
                            populate suggestion based on 2 criterias:</p>
                        <ul>
                            <li>Customer Name: it will show customer with similar name. This functionality is similar to
                                searching in Customer center and Loan center</li>
                            <li>Module: it will also show modules such as Customer Center, Account Statement, Loan
                                Center, ... </li>
                        </ul>
                        <p><b>Example:</b> Input "@Kimsan"</p>
                        <p>=> Suggestion: </p>
                        <ul>
                            <li>(Kimsan Sok) Customer Center</li>
                            <li>(Kimsan Sok) Account Statement</li>
                            <li>(Kimsan Sok) Loan Center</li>
                            <li>(Kimsan Sat) Customer Center</li>
                        </ul>
                        <p><b>Note:</b></p>
                        <ul>
                            <li>Module can be added later without the change of code. This should be configuration.</li>
                            <li>To recognize that user input is Advanced Search, use symbol '@' </li>
                        </ul>
                        <!-- End Advanced Search -->

                        <!-- Command Search -->
                        <h4>3. Command Search</h4>
                        <p>User able to perform action via quick search such as: New, Search, Authorize, List Live, List
                            Unauthorize, List History, Reverse, ...</p>
                        <ul>
                            <li>Customer Name: it will show customer with similar name. This functionality is similar to
                                searching in Customer center and Loan center</li>
                            <li>Module: it will also show modules such as Customer Center, Account Statement, Loan
                                Center, ... </li>
                        </ul>
                        <p><b>Example:</b> Input "#New Customer"</p>
                        <p>=> Suggestion: </p>
                        <ul>
                            <li>#New Customer</li>
                            <li>#New Customer Center</li>
                            <li>#New Potential Customer</li>
                            <li>...</li>
                        </ul>
                        <p>=> Select on #New Customer to create new customer.</p>
                        <p><b>Note:</b></p>
                        <ul>
                            <li>To recognize that user input is Search Commands, use symbol '#'</li>
                            <li>If record have to input record id manually, just input "#New Province 001" to create new
                                province with record id "001"</li>
                        </ul>
                        <!-- End Command Search -->
                    </div>
                    <!-- End Collapse Content -->
                    <!-- End Setting Item -->
                </div>

                <!-- Devider -->
                <div class="quick-search section devider"></div>
                <!-- End Devider -->
            </div>
            <!-- End Search Bar Content -->
        </div>
    </div>
</div>
<!-- End Quick Search Setting Modal -->

<!-- Quick Search Modal Script -->
<script>

    const MODAL               = ".quick-search.modal"
    const SEARCH_MIN          = "#min-input-quick-search"
    const SEARCH_HINT         = "input.xdsoft_autocomplete_hint"
    const SEARCH_VALUE        = "#max-input-quick-search"
    const SEARCH_RESULT       = "#quick-search-result"
    const SEARCH_RESULT_ITEM  = "#quick-search-result a.quick-search.item"
    const SEARCH_RESULT_SECT  = "#quick-search-result a.quick-search.section"
    const SEARCH_MODAL        = "#modal-quick-search"
    const SEARCH_SETTING_MODAL= "#modal-quick-search-setting"
    const SCROLL_BAR          = ".quick-search div.slimScrollBar"
    const SECLECT_THEME       = "#quick-search-select-theme"
    const ALIASES             = "#aliases-list"
    const BTN_DELETE_ALIAS    = "#quick-search-btn-delete-alias"
    const BTN_CANCEL_DEL_ALIAS= "#quick-search-btn-cancel-delete-alias"
    const BTN_ADD_ALIAS       = "#quick-search-btn-add-alias"
    const BTNS_DELETE_ALIAS   = ".quick-search.delete-alias"
    const SHORTCUT_VALUE      = "#quick-search-input-shortcut"

    let timer;
    let triggerAction;
    let duration     = 250;
    let item_pos     = 0;

    let app_section  = { id: "", text: "Applications", icon: "fa fa-list", url: "", is_section:true };
    let themes       = [{id:"light", text:"Light"}, {id:"dark", text: "Dark"}];
    let shortcuts    = JSON.parse(localStorage.getItem("quick-search-shortcuts")) || {};
    let curr_theme   = localStorage.getItem("quick-search-theme");
    let aliases      = JSON.parse(localStorage.getItem("quick-search-aliases")) || {};
    let prefixs      = {customer: "@", action: "#"};
    let regex_cus    = new RegExp(`^${prefixs.customer}.*`);
    let regex_action = new RegExp(`^${prefixs.action}.*`);

    let second_item  = {{ SecondItemList | safe }}
    let sections     = {{ QuickSearchItems | safe }}
    let access_list  = {{ AccessList | safe }}
    let access_keys  = Object.keys(access_list).map(item=>`${prefixs.action}${item}`)

    init.push(() => {
        $(SEARCH_VALUE).autocomplete({
            titleKey: "text",
            valueKey: "text",
            closeOnBlur: true,
            autoselect: false,
            limit: 0,
            showHint: true,
            minLength: 0,
            appendMethod:'replace',
            source: [manageSearch]
        })

        // Themes Block
        themes.map((item, index)=>{
            const option = `<option ${item.id == curr_theme ? "selected" : ""} value="${item.id}">${item.text}</option>`
            $(SECLECT_THEME).append(option)
        })
        $(SECLECT_THEME).select2({minimumResultsForSearch: -1})
        $(MODAL).addClass(curr_theme)

        // Aliases Block
        Object.keys(aliases).map((key)=>{
            addAlias(key, aliases[key].label, aliases[key].url, init=true)
        })

        // Shortcuts Block
        if(Object.keys(shortcuts).length < 0){
            shortcuts = {shortcut:[["Alt","altKey",true],["Space","keyCode",32]]}
            localStorage.setItem("quick-search-shortcuts", JSON.stringify(shortcuts)) 
        }
        setShortcutInput()
    })

    $(document).on("keydown", (e) => {
        if ($(e.target).is(SEARCH_VALUE)) {
            const value   = getSpaceClearedText($(SEARCH_VALUE).val())
            const hint    = $(SEARCH_HINT).val()
            const r_item  = $(`${SEARCH_RESULT_ITEM}:eq(${item_pos}) span`).text()
            switch(e.keyCode){
                case 27: // ESC Key
                    if(value!=""){
                        $(SEARCH_VALUE).val("")
                        e.preventDefault()
                    }
                    break;
                case 40: // Arrow Key Down
                    if (item_pos !== $(SEARCH_RESULT_ITEM).length - 1) {
                        item_pos++;
                    }
                    hoverResultItem(item_pos)
                    scrollToActiveItem(item_pos)
                    e.preventDefault()
                    break;
                case 38: // Arrow Key Up
                    if (item_pos == 0) {
                        //if we reach min items do nothing
                        item_pos = 0;
                    } else {
                        item_pos--;
                        if (item_pos == $(`${SEARCH_RESULT_ITEM}.active`).index()) {
                            item_pos--;
                        }
                    }
                    hoverResultItem(item_pos)
                    scrollToActiveItem(item_pos)
                    e.preventDefault()
                    break;
                case 9: // Tab Key
                    if(r_item && (value.includes(r_item) || value != r_item)){
                        $(SEARCH_VALUE).val(`${r_item} `)
                    }
                    e.preventDefault()
                    break;
                case 13: // Enter Key
                    if(value != ""){
                        if($(`${SEARCH_RESULT_ITEM}`).length > 0){
                            $(`${SEARCH_RESULT_ITEM}:eq(${item_pos})`).trigger('click')
                        } else if (typeof triggerAction.trigger == "function") {
                            triggerAction.trigger('click')
                        }
                    }
                    e.preventDefault()
                    break;
            }
        }else if($(e.target).is(SHORTCUT_VALUE)){
            e.preventDefault()
            shortcuts.shortcut = []
            if(e.metaKey)  shortcuts.shortcut.push(["Meta","metaKey",true])
            if(e.ctrlKey)  shortcuts.shortcut.push(["Ctrl","ctrlKey",true])
            if(e.shiftKey) shortcuts.shortcut.push(["Shift","shiftKey",true])
            if(e.altKey)   shortcuts.shortcut.push(["Alt","altKey",true])
            if(shortcuts.shortcut.length>0){
                if(String.fromCharCode(e.keyCode).match(/\w/)){
                    shortcuts.shortcut.push([e.key, "keyCode", e.keyCode])
                    localStorage.setItem("quick-search-shortcuts", JSON.stringify(shortcuts))
                    setShortcutInput()
                }else if(String.fromCharCode(e.keyCode).match(/\s/)){
                    shortcuts.shortcut.push(["Space", "keyCode", e.keyCode])
                    localStorage.setItem("quick-search-shortcuts", JSON.stringify(shortcuts))
                    setShortcutInput()
                }
            }
        }else if($(e.target).is(SEARCH_MIN)){
            e.preventDefault()
        }
    })

    $(SEARCH_MIN).on('focus', () => {
        $(SEARCH_MODAL).modal('show')
    })

    $(SEARCH_MODAL).on('shown.bs.modal', () => {
        $(SEARCH_VALUE).focus()
    })

    $(SECLECT_THEME).on("change", (e)=>{
        localStorage.setItem("quick-search-theme", e.val)
        themes.map((item)=>{
            $(MODAL).removeClass(item.id)
        })
        $(MODAL).addClass(e.val)
    })

    const manageSearch = (search = $(SEARCH_VALUE).val(), response) => {
        clearTimeout(timer)
        $(SEARCH_HINT).val("")
        timer = setTimeout(() => {
            item_pos = 0
            showResult(false)
            try{
                if (validateBeforeSearch(search)) {
                    search = getSpaceClearedText(search)
                    showResult()
                    if (search.match(regex_cus)) {
                        // Search By Customer
                        response(searchCustomer(search))
                    }
                    else if (search.match(regex_action)) {
                        // Search Actions
                        response(searchAction(search))
                    }
                    else {
                        // Search Applications
                        response(searchApplication(search))
                    }
                    hoverResultItem(item_pos)
                } else {
                    showResult(false)
                    response([])
                }
            }catch{
                showResult(false)
                response([])
            }
            scrollToActiveItem(item_pos)
        }, 1)
    }

    function validateBeforeSearch(search){
        try{
            return (search && search != "" &&  search != prefixs.action && 
                    search != prefixs.customer && !search.endsWith(" "))
        } catch{
            return false
        }
    }

    function searchCustomer(search_param = "") {
        let results     = []
        let has_results = false
        let search      = search_param.split(prefixs.customer)[1]
        if(search.length>2){
            sections.map((section) => {
                $.ajax({
                    url: `${section.url}${search}`,
                    async: false,
                    type: "GET",
                    success: (data) => {
                        if (data.items.length && data.items.length > 0) {
                            has_results = true
                            section["is_section"] = has_results
                            appendResultItem(section)
                            data.items.slice(0, 5).map((item, index) => {
                                item['index'] = index
                                item['label'] = `${section.text}-${item.id}`
                                item['url']   = `${section.action_url}${item.id}`
                                item['text']  =  getPrefixedText(prefixs.customer, item.text)
                                appendResultItem(item)
                            })
                            results = [...results, ...data.items]
                        }
                    }
                })
            })
        }
        if(has_results) {
            triggerAction = $(`${SEARCH_RESULT_ITEM}:eq(${item_pos})`)
        } else {
            showResult(false)
        }
        return results
    }

    function searchApplication(search_param = "", prefix_param = "") {
        search_param     = prefix_param == "" ? search_param : search_param.split(prefix_param)[1]
        const search     = getSpaceClearedText($(SEARCH_VALUE).val())
        const sort_regex = new RegExp(`^${search}.*`, "giu")
        const regex      = new RegExp(`${search_param}.*`, "giu")
        let results      = []
        second_item.map((item)=>{
            const label   = getSpaceClearedText(item.label)
            if (item.url != "" && (label.match(regex) || search.toLowerCase().includes(label.toLowerCase()))) {
                results.push({...item, ...{
                    id: label,
                    label: label,
                    url: `/Morakot/${item.url}`,
                    text: getPrefixedText(prefix_param, label)
                }})
            }
        })
        results.sort((a, b)=>(a.text > b.text) ? 1: -1).sort((a, b)=>b.text.match(sort_regex) ? 1:-1)
        // Search Aliases
        Object.keys(aliases).map((key)=>{
            if(key!=="" && search.toLowerCase().includes(key.toLowerCase())){
                results.unshift({
                    id: key,
                    label: aliases[key].label,
                    url: aliases[key].url,
                    text: `${key} (Alias:${aliases[key].label})`
                })
            }
        })
        if(results.length > 0) {
            //if(prefix_param == "") appendResultItem(app_section)
            results.map((item, index) => {
                if(prefix_param != "" && (item.type_url=="Form" || item.type_url=="MainForm")) {
                    item["url"] = `${item.url}${getActionUrl(prefix_param)}`
                }
                appendResultItem(item)
            })
            triggerAction = $(`${SEARCH_RESULT_ITEM}:eq(${item_pos})`)
        } else {
            showResult(false)
        }
        return results
    }

    function searchAction(search_param = "") {
        const regex     = new RegExp(`${search_param}.*`, "giu")
        let access_key  = getActionKey(search_param)
        let has_result  = false
        access_keys.map((item, index) => {
            if (item != "" && item.match(regex)) {
                appendResultItem({ index, text: item, id: "", icon: "", url: "" })
                has_result = true
            }
            const i_regex = new RegExp(`${access_key}.*`, "gui")
            if(item.match(i_regex)){
                search_param = search_param.replace(access_key, item)
                access_key   = item
            }
        })
        if(has_result){ 
            triggerAction = $(`${SEARCH_RESULT_ITEM}:eq(${item_pos})`)
        } else {
            showResult(access_keys.length>0)
            return searchApplication(search_param, access_key + " ")
        }
        return access_keys
    }

    function getActionKey(search, split=" "){
        try {
            return search.split(split)[0]
        } catch{
            return ""
        }
    }

    function getPrefixedText(prefix, text){
        return text.includes(prefix) ? text : `${prefix}${text}`
    }

    function showResult(is_show=true){
        if(is_show){
            $(SEARCH_RESULT).removeClass("hide")
        } else {
            $(SEARCH_RESULT).addClass("hide").empty()
        }
    }

    function appendResultItem(item) {
        const search  = $(SEARCH_VALUE).val()
        const s_search= search.split(/\s+/)
        let text = item.text
        text = getBoldText(text, search)
        s_search.map((item)=>{
            text = getBoldText(text, item)
        })
        $(SEARCH_RESULT).append(`
            <!-- Result Item -->
            <a href="#" class="quick-search ${item.is_section ? "section disabled" : "item"} list-group-item" 
                onclick="onClickResultItem('${item.text}','${item.label}','${item.url}')"
                ${item.is_section ? '' : 'onmouseover="hoverResultItemBySelector($(this))"'}>
                <div>
                    <i class="quick-search menu-icon ${item.icon || "fa fa-search"}"></i>
                    <span class="quick-search item-text">${text}</span>
                </div>
                ${item.is_section ? '' : '<i class="quick-search menu-icon right fa fa-angle-right"></i>' }
            </a>
            <div class="quick-search ${item.is_section ? "section" : ""} devider"></div>
            <!-- End Result Item -->
        `)
    }

    function onClickResultItem(text, label, url) {
        if(url!=""){
            text          = getSpaceClearedText(text)
            const search  = getSpaceClearedText($(SEARCH_VALUE).val())
            const s_regex = new RegExp(`${search}|${search}.*`, "giu")
            const t_regex = new RegExp(`${text}`, "giu")
            if(search == text||search.match(regex_cus)||search.match(t_regex)||text.match(s_regex)) {
                const record_id = search.split(t_regex)[1]
                url   = `${url}${record_id ? "/" + getSpaceClearedText(record_id) : ""}`
                label = `${label||text}${record_id ? "-" + getSpaceClearedText(record_id) : ""}`
                addTab(label, url)
                $(SEARCH_MODAL).modal('hide')
                $(SEARCH_VALUE).val("")
                $(SEARCH_HINT).val("")
                showResult(false)
            }
        }
    }

    function onClickSetting() {
        $(SEARCH_RESULT).toggle()
        $(SEARCH_SETTING_MODAL).modal("toggle")
    }

    function hoverResultItem(position) {
        $(SEARCH_RESULT_ITEM).removeClass("active")
        $(`${SEARCH_RESULT_ITEM}:eq(${position})`).addClass("active")
    }

    function hoverResultItemBySelector(selector){
        item_pos = selector.index(SEARCH_RESULT_ITEM)
        $(SEARCH_RESULT_ITEM).removeClass("active")
        selector.addClass("active")
    }

    function scrollToActiveItem(position){
        let sectlength= $(SEARCH_RESULT_SECT).length
        let search    = $(SEARCH_VALUE).val()
        let elHeight  = $(`${SEARCH_RESULT_ITEM}:eq(${position})`).outerHeight(true) + 2;
        let scrollTop = $(SEARCH_RESULT).scrollTop();
        let rsHeight  = $(SEARCH_RESULT).height();
        let viewport  = scrollTop + rsHeight;
        let elOffset  = elHeight * position;
        
        if(search.match(regex_cus) && viewport <= (elOffset+ elHeight*sectlength)  ){
            rsHeight -= elHeight*$(SEARCH_RESULT_SECT).length
            $(SEARCH_RESULT).scrollTop(elOffset - rsHeight + 40);
        } else if(viewport <= (elOffset + elHeight)){
            $(SEARCH_RESULT).scrollTop(elOffset - rsHeight + 40);
            if(viewport < (elOffset + elHeight) && search.match(regex_cus)){
                rsHeight -= elHeight
                $(SEARCH_RESULT).scrollTop(elOffset - (rsHeight/sectlength));
            }
        } else if(elOffset <= scrollTop) {
            $(SEARCH_RESULT).scrollTop(elOffset);
            $(SEARCH_RESULT).scrollTop(elOffset);
        }
        $(SCROLL_BAR).css("top", $(SEARCH_RESULT).scrollTop())
    }

    function getBoldText(text, search){
        const matched = text.match(new RegExp(search, "gui"))
        if(matched){
            return text.replace(matched[0], `<b>${matched[0]}</b>`)
        }
        return text
    }

    function getActionUrl(search){
        const action = search.split(" ")[0].split(prefixs.action)[1]
        return `${action ? "/"+ action : ""}`
    }

    function getSpaceClearedText(text){
        return (text.match(/\S+(?:\s+\S+)*/)||[""])[0]
    }
    
    // Setting Functions

    function addAlias( alias_name = "", alias_label = "", alias_url = "", init=false) {
        if(!aliases.hasOwnProperty(alias_name) || init==true){
            if(init==false){
                addAliasToLocalStorage(alias_name, alias_label, alias_url)
            }
            $(`
                <!-- Alias Item -->
                <div style="display: none;">
                    <div href="#" class="quick-search list-group-item collapse-item disable-hover" style="align-items:flex-start"> 
                        <button class="quick-search button-square danger delete-alias" style="margin-right:5px; display:none;"
                            onclick="deleteAlias($(this))">
                            <i class="fa fa-trash"></i>
                        </button>
                        <div style="display:flex; flex-direction: column; flex:1;">
                            <input id="alias-name" onblur="onBlurAliasName($(this),'${alias_name}')" type="text" class="quick-search collapse-input"
                                placeholder="Input alias name..." autocomplete="off" value="${alias_name}">
                            <span id="alias-message" class="quick-search danger" style="padding-left:5px;display:none;" ></span>
                        </div>
                        <input id="alias-label" onblur="onBlurAliasLabel($(this))" style="margin-left: 10px" type="text" class="quick-search collapse-input"
                            placeholder="Input alias label..." autocomplete="off" value="${alias_label}">
                        <input id="alias-url" onblur="onBlurAliasUrl($(this))" style="margin-left: 10px" type="text" class="quick-search collapse-input right"
                            placeholder="Input alias url..." autocomplete="off" value="${alias_url}">
                    </div>
                    <!-- End Alias Item -->
                    <!-- Devider -->
                    <div class="quick-search devider"></div>
                    <!-- End Devider -->
                </div>
                <!-- End Alias Item -->
            `).appendTo(ALIASES).show(duration);
        }
    }

    function onBlurAliasName(element, default_value=""){
        const alias_name = getSpaceClearedText(element.val())
        const alias_url  = getSpaceClearedText(element.parents().siblings('#alias-url').val())
        const alias_label= getSpaceClearedText(element.parents().siblings('#alias-label').val())
        if(default_value != alias_name && validateAlias(element, alias_name)){
            element.attr('onblur',`onBlurAliasName($(this),'${alias_name}')`);
            removeAliasFromLocalStorage(default_value)
            addAliasToLocalStorage(alias_name, alias_label, alias_url)
        }
    }

    function onBlurAliasLabel(element){
        const alias_name = getSpaceClearedText(element.siblings('div').children('#alias-name').val())
        const alias_url  = getSpaceClearedText(element.siblings('#alias-url').val())
        if(validateAlias(element, alias_name)){
            addAliasToLocalStorage(alias_name, element.val(), alias_url)
        }
    }

    function onBlurAliasUrl(element){
        const alias_name = getSpaceClearedText(element.siblings('div').children('#alias-name').val())
        const alias_label= getSpaceClearedText(element.siblings('#alias-label').val())
        if(validateAlias(element, alias_name)){
            addAliasToLocalStorage(alias_name, alias_label, element.val())
        }
    }

    function validateAlias(element, alias_name){
        if(aliases.hasOwnProperty(alias_name)) {
            element.siblings("#alias-message").show().text("This alias is already exist.")
        } else if(second_item.filter(item=>item.label.toLowerCase() == alias_name.toLowerCase() && item.url != "").length > 0) {
            element.siblings("#alias-message").show().text("This alias is duplicated to application name.")
        } else {
            element.siblings("#alias-message").hide().text("")
            return true
        }
        return false
    }

    function addAliasToLocalStorage(alias_name, alias_label, alias_url){
        delete aliases[""]
        aliases[alias_name] = {url: alias_url, label: alias_label}
        localStorage.setItem("quick-search-aliases", JSON.stringify(aliases))
    }

    function removeAliasFromLocalStorage(alias_name){
        delete aliases[alias_name]
        localStorage.setItem("quick-search-aliases", JSON.stringify(aliases))
    }

    function deleteAlias(selector){
        const alias_name = selector.siblings('div').children('#alias-name').val()
        removeAliasFromLocalStorage(alias_name)
        selector.parent().parent().hide(duration,()=>{
            selector.parent().parent().remove()
        })
    }

    function showDeleteAlias(){
        $(BTN_DELETE_ALIAS).hide()
        $(BTN_ADD_ALIAS).hide()
        $(BTN_CANCEL_DEL_ALIAS).fadeIn()
        $(BTNS_DELETE_ALIAS).fadeIn()
    }

    function hideDeleteAlias(){
        $(BTN_DELETE_ALIAS).fadeIn()
        $(BTN_ADD_ALIAS).fadeIn()
        $(BTN_CANCEL_DEL_ALIAS).hide()
        $(BTNS_DELETE_ALIAS).fadeOut()
    }

    function setShortcutInput(){
        let value = ""
        shortcuts.shortcut.map((item,index)=>{
            value += index < shortcuts.shortcut.length-1 ? `${item[0]} + ` : item[0]
        })
        $(SHORTCUT_VALUE).val(value)
        $(SEARCH_MIN).val(`Search (${value})`)
    }

</script>
<!-- End Quick Search Modal Script -->