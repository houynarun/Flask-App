{% extends "layout.html" %}

{% block css %}
<style type="text/css">
	/*tr{
		height:35px;
	}*/
	.panel-group{
		margin-bottom: 5px !important;
	}
	.accordion-toggle::after {
		right: auto;
	}
	.colunm-padding {
		padding: 9px 5px 9px 10px;
	}
	.colunm-padding-first {
		padding: 9px 5px 9px 50px;
	}
	.uninstall-padding{

		display: inline-block;
		padding-left: 25px;
		padding-top: 4px;
		vertical-align: top;
	}
}
.table-borderless td,
.table-borderless th
{
	border: 0 !important;
	padding-top: 3px !important;
}

.modal-lg {
	width: 95%;
}
iframe{
	border: 0px;
	overflow-x:hidden;
}
#Iframe {
	overflow-x: hidden;
}

radio:disabled {
	color:blue;
}

</style>
{% endblock %}

{% block content %}


{% macro AnswerChecked(qid, atype,aid) -%}
	{%if SurveyDeObj%}
		{%for row in SurveyDeObj%}
			{%if row.AnswerType==atype and row.Question==qid and row.Answer == aid%}
					checked="checked"
			{%endif%}
		{%endfor%}
	{%endif%}
{%- endmacro%}

{%- macro getAnswerFreeText(qid) -%}
	{%-if SurveyDeObj-%}
		{%-for row in SurveyDeObj-%}
			{%-if row.AnswerType=='3' and row.Question==qid %}
{{row.Other}}
			{%-endif%}
		{%-endfor%}
	{%-endif%}
{%- endmacro%}

{% macro getAnswers(qid,atype) -%}
	{%set AnswerObj = AnswerObj.query.filter(AnswerObj.ID==qid).all()%}
	{%if atype == '1'%}
		{%for row in AnswerObj%}
			<div class="form-check form-check-inline">
			  <label class="form-check-label" style="font-weight: normal;cursor: pointer;">
				<input class="form-check-input" type="radio"
				name="Answer[{{qid}}]" id="{{qid}}_{{atype}}" value="{{row.AnswerID}}" required {{AnswerChecked(qid,atype,row.AnswerID)}}> {{row.Answer}}
			  </label>
			</div>
		{%endfor%}

	{%elif atype == '2' %}
		{%for row in AnswerObj%}
			<div class="form-check">
			  <label class="form-check-label" style="font-weight: normal;cursor: pointer;">
				<input class="form-check-input" type="checkbox" name="Answer[{{qid}}]" id="{{qid}}_{{atype}}" value="{{row.AnswerID}}" {{AnswerChecked(qid,atype,row.AnswerID)}}> {{row.Answer}}
			  </label>
			</div>
		{%endfor%}
	{%else%}
		<textarea class="form-control" name="Answer[{{qid}}]" data-q="{{qid}}" data-answer="{{atype}}">{{getAnswerFreeText(qid)}}</textarea>
	{%endif%}
			<input type="hidden" class="form-control" id="QuestionID" name="QuestionID" value="{{qid}}" data-original-title="" title="">

{%- endmacro %}


<div class="form-horizontal">
<form action="/Morakot/UpdateSurvey/{{QuestionID}}" method='POST' name="frm_survey">
	<div class="form-group" style="display: none;">
	   <label for="Survey" class="col-sm-2 control-label"><label for="Survey">Survey</label>
		<div class="col-sm-10">
			<input class="form-control" id="Survey" name="Survey" type="text" value="{{ID}}" data-original-title="" title="">
		</div>
	</div>
	{%if SurveyCurr%}
		<div class="form-group" style="display: none;">
		   <label for="Curr" class="col-sm-2 control-label"><label for="Curr">Curr</label></label>
			<div class="col-sm-10">
				<input class="form-control" id="Curr" name="Curr" type="text" value="{{SurveyCurr if SurveyCurr else ''}}" data-original-title="" title="">
			</div>
		</div>
	{%endif%}
	
		{%for row in QuestionList %}
		<div class="form-group">
			<label for="Question" class="col-sm-2 control-label"><label for="Question">Question {{loop.index}}:</label></label>
			<div class="col-sm-6 control-label" style="text-align: left">
				{{row.get('2')}}
			</div>
		</div>
		<div class="form-group" style="margin-top:-15px;">
			<label for="Question" class="col-sm-2 control-label"><label for="Question">Answer:</label></label>
			<div class="col-sm-6 control-label" style="text-align: left;">
				{{getAnswers(row.get('1'),row.get('3'))}}
			</div>
		</div>
		<hr style="text-align: center; width:80%;">
		{%endfor%}
		
		<input type="submit" value="Save" class="btn btn-default" style="display: none;">
</form>
</div>


</div>

<div class="clearfix">&nbsp;</div>


{% endblock %}



{% block js %}
	<script src="{{ url_for('static',filename='javascripts/dynamic_con.js') }}"></script>
	<script>
		function checkModified(){
			var path = window.parent.location.pathname.split('/')[2];
			var path1 = "SurveyDetail";
			MainClone = localStorage.getItem("cloneobj"+path);
			SubClone  = localStorage.getItem("cloneobj"+path1);
			MainForm   = window.parent.$("form").serialize();
			SubForm = $("form").serialize();
			value_id=window.parent.$('#ID').val();
			if (window.parent.location.pathname.split('/')[3]=="Edit"){
				if (MainClone!=null && SubClone != null){
					 if (SubForm==SubClone && MainForm == MainClone) {
					 	alert("Data has no change. Will not submit to server.")
					 	return true;
					 }else if(MainClone == MainForm && SubClone != SubForm){
						return false; 
					 }

				}
			}
		}
		$(document).ready(function(){
			var ID = window.parent.$('#ID').val();
			$('#Survey').val(ID);
			window.parent.$('#Questionnaire').change(function(){
				Questionnaire = $(this).val();
				window.parent.$('#Iframe').attr('src','/Morakot/SurveyDetail/'+Questionnaire);
				window.parent.$('#Iframe').css('display','block');

				
			});
			
			window.parent.$('#Save').off('click');
			window.parent.$('#Save').click(function(event) {
					if(checkModified()){
						window.parent.location.href="/Morakot/Survey"+"/Cancel/"+ value_id +"/";
						return 0;
					}
					$(':focus').blur();
					window.parent.document.forms["frm"].action="/Morakot/Survey"+"/";
					window.parent.document.forms["frm"].submit();
					$('form[name="frm_survey"]').trigger('submit');
				});	
			var msg = '';
			{%if result==True%}
				alert(result);
				msg =  '<div class="alert alert-info">';
				msg += '<button type="button" class="close" data-dismiss="alert">Ã—</button>';
				msg += 'Record was added successfully';
				msg += '</div>';
				window.parent.$('div.navbar').after(msg);
				alert = function() {};
			{%endif%}
			// Get Survey ID into form name Survey
			var ID = window.parent.$('#ID').val();
			$('#Survey').val(ID);
			
			// Check if it is a list live record or not
			// If yes, disable all radio button and textarea until click on edit, 
			// Then enable for edit.
			if(window.parent.$('#Edit').length > 0){
				$('input:radio,textarea,input:checkbox').attr('disabled','disabled');
			}
			
			$('form[name="frm_survey"]').submit(function() {
				
			})
		})

	</script>
{% endblock %}