{% extends "layout.html" %}

{% block css %}
<style type="text/css">

	h3.header-3{
		/*color: #888 !important; */
		font-size: 16px;
		font-weight: bold;
		margin: 5px 0 10px;
		padding: 10px 18px 0;
	}

	h4.header-4{
		/*color: #888 !important; */
		font-size: 14px;
		font-weight: normal;
		margin: 5px 0 10px;
		padding: 0px 18px 0;
	}
	table tbody td {
	  	vertical-align: top !important;
	}
	.td-limit {
	    max-width: 200px;
	    text-overflow: ellipsis;
	    white-space: nowrap;
	    overflow: hidden;
	}
	.table-responsive {
	    width: 100%;
	    margin-bottom: 15px;
	    overflow-y: hidden;
	    overflow-x: scroll;
	    -ms-overflow-style: 
	    -ms-autohiding-scrollbar;
	    border: 1px solid #DDD;
	    -webkit-overflow-scrolling: touch;
	}
	.row-solid {
		border-bottom: 2px solid #aaa;
	}

</style>

{% endblock %}

{% block content %}

<div class="navbar navbar-default navbar-static-top" id="CriteriaSetting" >
	<div class="col-sm-12">
		<div style="margin-top: 8px;"></div> 
		<div class="col-sm-6" style="margin-top: 15px;">
            <!-- Button Export -->
          {{ exportButtonLink(Branch) }}

      		{#{% from "print.html" import exportButtonLink %}
                {{exportButtonLink()}} #}
        </div>
		<!-- <a href="javascript:void(0)" title="Refresh" id="Refresh" class="btn btn-flat btn-labeled btn-warning pull-right" style="margin-left: 5px;">
            <span class="btn-label icon fa fa-refresh"></span> Refresh
        </a> -->
		<button  type="button" data-toggle="modal" data-target="#getCustomRange"  class="btn btn-flat btn-labeled btn-success pull-right" >
            <span class="btn-label icon fa fa-gear" ></span> Custom 
        </button>        
        
	</div> 
</div>

<!-- Modal Custom -->
<div class="modal fade" id="getCustomRange" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="form-horizontal" action="/Morakot/GLAudit/" method="GET">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">Custom</h4>
                </div>
                <div class="modal-body">

                    <div class="form-group">
                        <label for="Branch" class="col-sm-4 control-label">{{ getLanguage('Branch') }}:</label>
                        <div class="col-sm-6">
                            <input name="Branch" value="{{ Branch }}" class="input-sm form-control" style="width: 100%;">
                        </div>
                        <div class="col-sm-2"></div>
                    </div>
                    <div class="form-group">
                        <label for="Branch" class="col-sm-4 control-label">Transaction Date:</label>
                        <div class="col-sm-6">
                        	<select class="form-control select-sm select2" name="Expression" style="width: 35%;float: left;">
                        		<option value="EQ" {{ 'selected' if Expression == 'EQ' else '' }}>Equal</option>
                        		<option value="BTW" {{ 'selected' if Expression == 'BTW' else '' }}>Between</option>
                        	</select>
                            <input name="TransactionDate" id="TransactionDate" value="{{ TransactionDate }}" class="input-sm form-control" style="width: 65%;">
                            <script type="text/javascript">
                                $(document).ready(function() {                                   
                                    init.push(function () {
                                        var options = {
	                                        orientation: $('body').hasClass('right-to-left') ? "auto right" : 'auto auto',
	                                        format:"yyyy-mm-dd",
	                                        autoclose:true,
	                                        multidate: true,
	                                        multidateSeparator:' '
                                        }
                                        $('#TransactionDate').datepicker(options);
                                    });
                                });
                                
                            </script>
                        </div>
                        <div class="col-sm-2"></div>
                    </div> 
                    <div class="form-group">
                        <label for="Inputer" class="col-sm-4 control-label">Inputter:</label>
                        <div class="col-sm-6">
                            <input name="Inputer" value="{{ Inputer }}" class="input-sm form-control" style="width: 100%;">
                        </div>
                        <div class="col-sm-2"></div>
                    </div> 
                    <div class="form-group">
                        <label for="Reviewer" class="col-sm-4 control-label">Reviewer:</label>
                        <div class="col-sm-6">
                            <input name="Reviewer" value="{{ Reviewer }}" class="input-sm form-control" style="width: 100%;">
                        </div>
                        <div class="col-sm-2"></div>
                    </div> 
                    <div class="form-group">
                        <label for="Authorizer" class="col-sm-4 control-label">Authorizer:</label>
                        <div class="col-sm-6">
                            <input name="Authorizer" value="{{ Authorizer }}" class="input-sm form-control" style="width: 100%;">
                        </div>
                        <div class="col-sm-2"></div>
                    </div>
                    <div class="form-group">
                        <label for="CheckUnCheck" class="col-sm-4 control-label">Check/Uncheck:</label>
                        <div class="col-sm-6">   
                        	<select class="form-control select-sm select2" name="CheckUnCheck" style="width: 100%">
                        		<option value="ALL" {{ 'selected' if CheckUnCheck == 'ALL' else '' }}>ALL</option>
                        		<option value="Check" {{ 'selected' if CheckUnCheck == 'Check' else '' }}>Check</option>
                        		<option value="Uncheck" {{ 'selected' if CheckUnCheck == 'Uncheck' else '' }}>Uncheck</option>
                        	</select>                  
                           
                        </div>
                        <div class="col-sm-2"></div>
                    </div>               

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">{{ getLanguage('Apply') }}</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">{{ getLanguage('Cancel') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- End Modal Custom -->
<!--  message  -->
<div class="clearfix"></div>
{% include 'msg_error.html' %}

<!-- Report Header -->
<div class="col-sm-12">
    <table width="100%" border="0">
        <tbody>
            <tr>
                <td class="text-left" rowspan="3" width="20%">
                    {#<img src="{{ url_for('static', filename='company/logo.png') }}">#}
                </td>
                <td class="text-center" width="60%">
                    <h3 class="header-3">
                        {# {{ CompanyObj.CompanyName }} #} 
                    </h3>
                </td>
                <td class="text-right" width="20%"></td>
            </tr>

            <tr>
                <td class="text-center">
                    <h3 class="header-3">GL Audit Listing</h3>
                </td>
                <td class="text-right" width="20%"></td>
            </tr>
            <tr>
                <td class="text-center">
                    <h4 class="header-4">
                        <strong>Branch: </strong> {{ Branch }} 
                    </h4>
                    <h4 class="header-4">
                    	<strong>Date: </strong>
                    	{% if Expression == 'EQ' %}                    		
                    		{% for index in  range(TransactionDateList | length) %}
                    			{{ TransactionDateList[index] if index == 0 else " , " + TransactionDateList[index] }} 
                    		{% endfor %}
                    	{% endif %}   

                    	{% if Expression == 'BTW' and TransactionDateList|length == 2 %}
                    		From {{ TransactionDateList[0] }} To {{ TransactionDateList[1] }}
                    	{% endif %} 
                    </h4>
                </td>
                <td class="text-right" width="20%"></td>
            </tr>  
        </tbody>
    </table>
</div>
<!-- End Report Header -->

<!-- Report Filter -->
<div class="col-sm-12">
    <table> 
        {% if Inputer != "" %}       
        <tr>
            <td width="150"><strong>Inputter</strong></td>
            <td>: &nbsp;{{ Inputer }}  </td>
        </tr> 
        {% endif %}   
        {% if Reviewer != "" %}   
        <tr>
            <td width="150"><strong>Reviewer</strong></td>
            <td>: &nbsp;{{ Reviewer }}  </td>
        </tr>
        {% endif %}
        {% if Authorizer != "" %}
        <tr>
            <td width="150"><strong>Authorizer</strong></td>
            <td>: &nbsp;{{ Authorizer }}  </td>
        </tr>
        {% endif %}
        {% if CheckUnCheck == "Check" or CheckUnCheck == "Uncheck" %}
	    <tr>
	        <td width="150"><strong>Check/Uncheck: </strong></td>
	        <td>: &nbsp;{{ CheckUnCheck }}  </td>
	    </tr>
	    {% endif %}        
        
    </table>
</div>
<!-- End Report Filter -->

<!-- Datatable -->
<form id="frm" method="POST" action="">
	<div class="clearfix">&nbsp;</div>
	<div class="col-sm-12">
		<!-- <div class="table-responsive"> -->			
			<table id="mktlist" class="table table-striped table-bordered display" width="100%">
				<thead>
					<tr>
			            <th rowspan="2"><input name="select_all" value="0" id="checkbox-select-all" type="checkbox" /></th>
			            <th rowspan="2" style="display: none">CheckStaus</th>
			            <th rowspan="2" style="display: none">Reference</th>
			            <th rowspan="2">Branch</th>
			            <th rowspan="2">Reference</th>
			            <th rowspan="2" class="text-left">Debits</th>
			            <th rowspan="2" class="text-left">Credits</th>
			            <th colspan="2" class="text-center">Amount</th>
			            <th rowspan="2" class="text-left">Currency</th>
			            <th rowspan="2">Transaction</th>
			            <th rowspan="2">Notes</th>
			            <th rowspan="2">Transaction Date</th>
			            <th rowspan="2">User Reference</th>            
			            <th rowspan="2">Inputter</th>
			            <th rowspan="2">Authorizer</th>
			            <th rowspan="2">Reviewed By</th>
			            <th rowspan="2">Reviewed Date</th>
			            <th rowspan="2">Remark</th>			            
			        </tr>
			        <tr>
			        	<th class="text-right">Debit</th>
			            <th class="text-right">Credit</th>

			        </tr>
				</thead>
				<tbody>			
					{% for row in DicRecords %}
						<tr class="row-solid">
							<td></td>
							<td style="display: none">{{ row.get('CheckStatus') }}</td>
							<td style="display: none">{{ row.Reference }}</td>
							<td>{{ row.Branch }}</td>
							<td class="text-left" title="View Detail">
								<a href="javascript:void(0)" onClick="ClickView('{{DicModule.get(row.Module)}}','{{DicModule.get(row.Module)}}','{{row.Reference}}')">
                                    {{ row.Reference }}
                                </a>
							</td>

							{%set Template = renderDrCrTemplate(row.Debits, row.Credits) %}
							<td class="text-left td-limit">{{ Template.get('Debit') | safe }} <hr style="margin:0px"></td>
							<td class="text-left td-limit">{{ Template.get('Br') | safe }} <hr style="margin:0px"> {{ Template.get('Credit') | safe }}</td>
							<td class="text-right">{{ Template.get('DrAmount') | safe }} <hr style="margin:0px"></td>
							<td class="text-right">{{ Template.get('Br') | safe }} <hr style="margin:0px"> {{ Template.get('CrAmount') | safe }}</td>
							<td class="text-left">{{ Template.get('DrCurrency') | safe }} <hr style="margin:0px"> {{ Template.get('CrCurrency') | safe }}</td>
							<td class="text-left td-limit">{{ Template.get('DrTransaction') | safe }} <hr style="margin:0px"> {{ Template.get('CrTransaction') | safe }}</td>
							<td class="text-left td-limit">{{ Template.get('DrNotes') | safe }} <hr style="margin:0px"> {{ Template.get('CrNotes') | safe }}</td>

							<td class="text-left" style="min-width: 80px">{{ row.get('TransactionDate') }}</td>
							<td class="text-left" style="min-width: 80px">{{ row.get('UserReference') if row.get('UserReference') else '' }}</td><!--User Reference -->
							<td class="text-left">{{ row.get('Inputter') }}</td>
							<td class="text-left">{{ row.get('Authorizer') }}</td>
							<td class="text-left">{{ row.get('Reviewer') if row.get('Reviewer') and row.get('CheckStatus') == 'Yes' else '' }}</td>
							<td class="text-left" style="min-width: 130px">{{ row.get('ReviewDate') if row.get('ReviewDate') and row.get('CheckStatus') == 'Yes' else ''  }}</td><!--Review Date -->
							<td class="text-left" style="min-width: 200px">
								<a href="#" id="TextRemark_{{row.get('Reference')}}" class="Remark">{{ row.get('Remark') if row.get('Remark') else '' }}</a>
								<input type="hidden" name="Remark_{{row.get('Reference')}}" id="Remark_{{row.get('Reference')}}" value="{{ row.Remark if row.Remark else '' }}">
								<script>
									$(document).ready(function() {
										$("#TextRemark_{{row.get('Reference')}}").editable({
											type    :  	'textarea',
											title   : 	'Remark',
											placement:  'left',
											emptytext:  '<i class="fa fa-pencil text-primary"></i>',
											success: function(data) {
										    }

			                        	})
			                        	
			                        	$("#TextRemark_{{row.get('Reference')}}").on('shown', function(e, editable) {
										    $(document).on('change', editable, function() {							                
										        var new_value = editable.input.$input[0].value;
										        $("#Remark_{{row.get('Reference')}}").val(new_value);

										        //set edit["SuperYes"] if user change text in remark column
										        var table = $('#mktlist').DataTable()
										        var row = table.row($("#TextRemark_{{row.get('Reference')}}").parents('tr')).nodes();
										        var rowData = table.row($("#TextRemark_{{row.get('Reference')}}").parents('tr')).data();

										        var isEdit = $('input[name="IsEdit"]', row).val()
												$('input[name="Edit['+isEdit+']"]', row).attr('name', 'Edit[SuperYes]');	
												$('input[name="IsEdit"]', row).val('SuperYes')

										    });
										});
									})
								</script>
							</td>
						</tr>				
						
					{% endfor %}
					
				</tbody>				
			</table>
		<!-- </div> -->
	</div>
</form>
<!-- end -->

{% endblock %}

{% block js %}

{% from "print.html" import exportIncludeJS %}
{{exportIncludeJS()}}

<script type="text/javascript">
	$(document).ready(function() {	
		$(".select2").select2();
		var table = $('#mktlist').DataTable({	
			"lengthMenu": [[25,50,100,200, -1], [25,50,100,200, "All"]],
			"bSort" : false,
			'columnDefs': [{
				'targets': 0,
				'searchable':false,
				'orderable':false,
				'className': '',
				'render': function (data, type, row){
					var Reference = row[2]
					var CheckStatus = row[1]
					if (CheckStatus == "None") {
						CheckStatus = "No"
					}
					else
					{
						CheckStatus = CheckStatus
					}
					return '<input type="checkbox" name="CheckBoxReferences[]" value="'+ Reference +'">'+
						   '<input type="hidden" name="CheckStatus_'+ Reference +'" value="'+ CheckStatus +'">'+
						   '<input type="hidden" name="Edit[No]" value="'+ Reference +'">'+
						   '<input type="hidden" name="IsEdit" value="No">'
				}
      		}]
		});

		$("div.table-caption").html('<button class="btn btn-flat btn-labeled btn-primary pull-right"><span class="btn-label icon fa fa-floppy-o"></span> Submit Your Review</button>');

		{% from "print.html" import exportDataTable %}
        {{exportDataTable("#mktlist","GLAudit")}}

		// Handle click on "Select all" control
		$('#checkbox-select-all').on('click', function(){
		  	// Check/uncheck all checkboxes in the table
			var rows = table.rows({ 'search': 'applied' }).nodes();	
			var rowsData = 	table.rows({ 'search': 'applied' }).data();		
			$('input[type="checkbox"]', rows).prop('checked', this.checked);

			for (index = 0; index < rowsData.length ; index++) {				

				var isEdit = $('input[name="IsEdit"]', rows[index]).val();
				var CheckStatus = $('input[name="CheckStatus_'+rowsData[index][2]+'"]', rows).val();

				if (this.checked == true){//select all
					if (isEdit == "Yes" && CheckStatus == "Yes") {
						$('input[name="Edit['+isEdit+']"]', rows[index]).attr('name', 'Edit[Yes]');	
						$('input[name="IsEdit"]', rows[index]).val('Yes')
					}
					if (isEdit == "No" && CheckStatus == "Yes") {
						$('input[name="Edit['+isEdit+']"]', rows[index]).attr('name', 'Edit[No]');	
						$('input[name="IsEdit"]', rows[index]).val('No')
					}
					if (isEdit == "Yes" && CheckStatus == "No") {
						$('input[name="Edit['+isEdit+']"]', rows[index]).attr('name', 'Edit[No]');	
						$('input[name="IsEdit"]', rows[index]).val('No')
					}
					if (isEdit == "No" && CheckStatus == "No") {
						$('input[name="Edit['+isEdit+']"]', rows[index]).attr('name', 'Edit[Yes]');	
						$('input[name="IsEdit"]', rows[index]).val('Yes')
					}

					$('input[name="CheckStatus_'+rowsData[index][2]+'"]', rows).val('Yes')
				}
				else //unselect all
				{
					if (isEdit == "Yes" && CheckStatus == "Yes") {
						$('input[name="Edit['+isEdit+']"]', rows[index]).attr('name', 'Edit[No]');	
						$('input[name="IsEdit"]', rows[index]).val('No')
					}
					if (isEdit == "No" && CheckStatus == "Yes") {
						$('input[name="Edit['+isEdit+']"]', rows[index]).attr('name', 'Edit[Yes]');	
						$('input[name="IsEdit"]', rows[index]).val('Yes')
					}
					if (isEdit == "Yes" && CheckStatus == "No") {
						$('input[name="Edit['+isEdit+']"]', rows[index]).attr('name', 'Edit[Yes]');	
						$('input[name="IsEdit"]', rows[index]).val('Yes')
					}
					if (isEdit == "No" && CheckStatus == "No") {
						$('input[name="Edit['+isEdit+']"]', rows[index]).attr('name', 'Edit[No]');	
						$('input[name="IsEdit"]', rows[index]).val('No')
					}

					$('input[name="CheckStatus_'+rowsData[index][2]+'"]', rows).val('No')
				}				
		        
		    }//end
		});

		// Handle click on checkbox to set state of "Select all" control
		$('#mktlist tbody').on('change', 'input[type="checkbox"]', function(){
		  	// If checkbox is not checked
			if(!this.checked){
				var el = $('#checkbox-select-all').get(0);
				if(el && el.checked && ('indeterminate' in el)){
					el.indeterminate = true;
				}
			}
		});	
		

		//Diplay Check on checkbox if CheckStatus is Yes 
		var rows = table.rows({ 'search': 'applied' }).nodes();
		var rowsData = table.rows({ 'search': 'applied' }).data();

		for (var index = 0; index < rowsData.length; index ++){
			var CheckStatus = $('input[name="CheckStatus_'+rowsData[index][2]+'"]', rows).val();
			if (CheckStatus == "Yes"){
				$('input[value="'+rowsData[index][2]+'"]', rows).prop("checked", true);
			}
		}//end

		//set status to Yes or No if user click on checkbox in table body
		$('#mktlist tbody').on('change', 'input[name="CheckBoxReferences[]"]', function(){
			var row = table.row($(this).parents('tr')).nodes();
		  	// If checkbox is not checked
			if(!this.checked){
				$('input[name="CheckStatus_'+this.value+'"]').val('No')	
			}else{
				$('input[name="CheckStatus_'+this.value+'"]').val('Yes')	
			}
			
			var isEdit = $('input[name="IsEdit"]', row).val()
			if (isEdit == "No") {
				$('input[name="Edit['+isEdit+']"]', row).attr('name', 'Edit[Yes]');	
				$('input[name="IsEdit"]', row).val('Yes')
			}
			else if (isEdit == "Yes") {
				$('input[name="Edit['+isEdit+']"]', row).attr('name', 'Edit[No]');	
				$('input[name="IsEdit"]', row).val('No')	
			}else{
				$('input[name="Edit['+isEdit+']"]', row).attr('name', 'Edit[SuperYes]');	
				$('input[name="IsEdit"]', row).val('SuperYes')
			}
			
		});

		$('#frm').on('submit', function (e) {
	        // Force all the rows back onto the DOM for postback
	        table.rows().nodes().page.len(-1).draw(false);  // This is needed
	        if ($(this).valid()) {
	            return true;
	        }
	        e.preventDefault();
	    });

		$( "#print").click(function() {

			table.destroy();
			$('#exportButton').hide();
			$('.ActionHeader').hide();
			$('.ActionFotter').hide();
			$('#title').show();
			var title = window.parent.$('.nav-tabs .active a').text(); //get Current Tab
			$('#title').text(title);
			{% if PrintingDate %}
			{% endif %}
			window.print();
			window.location.reload(true);

		});
		
	});
	

</script>

{% endblock %}
{% macro exportButtonLink(Branch) %}
     <div id=“exportButton”>
        <b>Also available in :</b>
        <a title="Download to Excel" href="/Morakot/GLAudit/Excel/" style=“cursor:pointer;“>
            <i class='fa fa-file-excel-o'></i> Excel
        </a> | 
        <a href="javascript:void(0)" id="print"><i class='fa fa-print'></i>&nbsp;Print</a>

    </div> 

{% endmacro %}