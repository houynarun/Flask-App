{% extends "layout.html" %}

{% block css %}
 <style type="text/css">

	th.table-header{
		border-bottom: 2px solid #ccc !important;
		font-size: 13px;
	}
	#Main {
		width: 1px;
		min-width: 100%;
		*width: 100%;
	}
 </style>
{% endblock %}

{% block content %}

<script src="{{ url_for('static',filename='javascripts/jquery.datatables.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/dataTables.tableTools.js') }}"></script>

<!-- <link rel=stylesheet type=text/css href="{{ url_for('static', filename='stylesheets/jquery.datatables.css') }}">
 -->
 <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.1/css/responsive.bootstrap.min.css">
 <link rel=stylesheet type=text/css href="{{ url_for('static', filename='stylesheets/dataTables.tableTools.css') }}">
 <script src="{{ url_for('static',filename='javascripts/dataTables.responsive.min.js') }}"></script>

<div id="Main">
<!--  message  -->
<div class="col-sm-12 text-center" >
	<h2>Data Enquiry</h2>
</div>

<div class="clearfix"></div>
{% include 'msg_error.html' %}

<div class="col-sm-12" style="display: none;" id="message-parent">
    <div class="alert" id="message-alert">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <div id="error-message"></div>
    </div>
</div>


{% if FieldRequired %}
<div class="col-sm-12">
	<div class="clearfix"></div>
	<div class="alert alert-danger" id="alert-danger">
			<button type="button" class="close" data-dismiss="alert">&times;</button>
			<ol>
				{% for message in FieldRequired %}
				<li id="lblTableName">
					<a class="error_pointer">
						<label for="TableName">
							{{message[0]}} <span style="color:#d38e99">*:</span>
						</label>
					</a> {{message[1]}}
				</li>
				{% endfor %}
			</ol>
		</div>
	</div>
</div>
{% endif %}



<div class="col-sm-12">

	<form action="/Morakot/DataEnquiry" method="post" enctype="multipart/form-data" id="frmData" >

		<div class="row" style="margin-bottom: 15px; margin-top:10px; padding-left:10px;">

			<div class="col-sm-12">

				<div class="row">
					<div class="col-sm-1">
							<label for="ImportOpt">Import</label> <span style="color:#d38e99">*</span>
					</div>

					<div class="col-sm-3">
						<select name="ImportOpt" id="ImportOpt" style="width:100% !important;">
							{% for key,value in OptionDict.iteritems() %}
								<option value={{key}} {% if ImportOpt == key %} selected {% endif %}>{{value}}</option>
							{% endfor %}

						</select>
						<script type="text/javascript">
							init.push(function () {
								// Single select
								$("#ImportOpt").select2({
									allowClear: true,
									placeholder: "Import Option"
								});
							});
						</script>
					</div>
				</div>

			</div>


			<div class="col-sm-12">

				<div class="row" style="margin-top: 15px">
					<div class="col-sm-1">
						<label for="Uploadfile"> File Upload </label> <span style="color:#d38e99">*</span>
					</div>

					<div class="col-sm-3">
						<input type="file" name="file" id="fileUpload" style="width:40% !important;">
						<!-- Javascript -->
						<script>
							init.push(function () {
								$('#fileUpload').pixelFileInput({ placeholder: 'No file selected...' });
							})
						</script>
					</div>

					<div class="col-sm-1">
						<button type="submit" class="btn btn-flat btn-primary" id="btnImport">
							<span class="btn-label icon fa fa-download"></span> &nbsp;Import
						</button>
					</div>

				</div>
			</div>

		</div>


		<div class="col-sm-12">

			<div id="container_tab" class="tab-content">

				<ul class="nav nav-tabs" role="tablist" id="">
					<li class="active"><a data-toggle="tab" href="#DataSource">Data Source</a></li>
					<li id="tab-output"><a data-toggle="tab" href="#Output">Output</a></li>
				</ul>

				<div id="DataSource" class="tab-pane fade in active " style="margin:0px;">

					<div class="navbar navbar-default navbar-static-top" style="margin-bottom: 0px !important;">

						<div class="col-sm-6" style="margin-bottom: 15px; padding-top:10px; padding-left:10px;">
							<!-- Button Export -->
							{% from "print.html" import exportButtonLink %}
							{{exportButtonLink()}}
						</div>

						<div class="col-sm-6" style="margin-top: 8px;">
							<a href="javascript:void(0)" title="Refresh" id="Refresh" class="btn btn-flat btn-labeled btn-warning pull-right" style="margin-left: 5px;">
								<span class="btn-label icon fa fa-refresh"></span> Refresh
							</a>
						</div>

					</div>

					<table id="mktlist1" class="table table-striped table" cellspacing="0" width="100%">
						<thead>
						<tr>
							<th>Reference</th>
							<th>Field1</th>
							<th>Field2</th>
							<th>Field3</th>
							<th>Field4</th>
							<th>Field5</th>
							<th>Field6</th>
							<th>Field7</th>
							<th>Field8</th>
							<th>Field9</th>
							<th>Notes</th>
						</tr>
						</thead>
						<tbody>

						{% for row in DataEnquiryObj.all() %}
						{% set Highlight = "bg-danger" if row.Notes%}
							<tr>
								<td class=" {{Highlight}}">{{escapeNone(row.Reference)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field1)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field2)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field3)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field4)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field5)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field6)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field7)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field8)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Field9)}}</td>
								<td class=" {{Highlight}}">{{escapeNone(row.Notes)}}</td>
							</tr>
						{% endfor %}
						</tbody>
					</table>
				</div>

				<div id="Output" class="tab-pane fade">

					{% if ReportID %}
						<div class="row" style="margin-bottom: 15px; margin-top:10px; padding-left:10px;">
							<div class="col-sm-1">
								<label for="Report">Report ID</label> <span style="color:#d38e99">*</span>
							</div>
							<div class="col-sm-3">
								<select name="ReportID" id="ReportID" style="width:100% !important;">
									{% set ReportList = ReportID.split(" ") %}
									{% for item in ReportList%}
									{% set NewReportObj = ReportObj.get(item) %}
										{% set ReportName = NewReportObj.ReportTitile if NewReportObj else "" %}
										<option value={{item}}>{{item}} - {{ReportName}}</option>
									{% endfor %}
								</select>
								<script type="text/javascript">
									init.push(function () {
										// Single select
										$("#ReportID").select2({
											allowClear: true,
											placeholder: "Select Report"
										});
									});
								</script>
							</div>
							{% if ImportOpt != 'N' %}
								<div class="col-sm-6">
									<a href="#" id="save" class="btn btn-flat btn-primary"><i class="fa fa-floppy-o" aria-hidden="true"></i> Save to system</a>
								</div>
							{% endif %}

							<div class="col-sm-2"></div>
						</div>
						<iframe id="OutputFrame" style="width:100%; height: 1500px;" frameborder="0"></iframe>
					{% endif %}
				</div>

			</div>
		</div>
	</form>
	
</div>
</div> <!-- End Main -->
{% endblock %}

{% block js %}

{% from "print.html" import exportIncludeJS %}
{{exportIncludeJS()}}

<script type="text/javascript">
	//Search dataTable
	$(document).ready(function() {

		function fn_fadeIn(){
			var $getParentEle = window.parent.$("#animated")
			$getParentEle.fadeIn("slow");
		}

		function fn_fadeOut(){
			var $getParentEle = window.parent.$("#animated")
			$getParentEle.fadeOut("slow");
		}


		$('#mktlist1').dataTable({
			"lengthMenu": [[25,50,100,200, -1], [25,50,100,200, "All"]],
			"bSort" : false,
			"sScrollX": "100%",
			"bScrollCollapse": true,
			responsive: true,
			// "bLengthChange" :false,
		});
		$("#Refresh").click(function() {
			fn_fadeIn();
			window.location.reload(true);
		});
		{% from "print.html" import exportDataTable %}
		{{exportDataTable('#mktlist1','Branch Productivity')}}



		$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
			var target = $(e.target).attr("href") // activated tab
			fn_fadeIn();
			var iframe = document.getElementById('OutputFrame');
			var report_id = $("#ReportID").val();
			if (iframe) {
				iframe.src = '/Morakot/Report/'+report_id;
			}
			fn_fadeOut();
		});


		$('#btnImport').on('click', function(event){
			fn_fadeIn();
			var ImportMode = $('#ImportMode').val();
			var r = false;
			if (ImportMode == 'O'){
				r = confirm('Are you sure want to overwrite the data in the table?');
			} else if (ImportMode == 'C'){
				r = confirm('Are you sure want to clear the data before insert new data into the table?');
			} else
				r = true;

			if (r == true){
				fn_fadeIn();
			} else {
				fn_fadeOut();
				event.preventDefault();
			}
		});

		$('#save').on('click', function(event){
			fn_fadeIn();
			var data = $('#OutputFrame').contents().find('#mktlist').dataTable({responsive: true});
			var report_id = $('#ReportID').val();
			var json_data = {
				'data': data.fnGetData(),
				'report_id': report_id,
				'import_opt': $('#ImportOpt').val()
				}
			$.ajax({
				type: 'POST',
				url: '/Morakot/SaveDataEnquiry',
				data: JSON.stringify(json_data),
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function(data){
				$('#message-parent').show();
				$('#message-alert').removeClass('alert-danger').addClass('alert-info');
				$('#error-message').text(data.msg);
				$('#OutputFrame')[0].contentWindow.location.reload(true);
					fn_fadeOut();
				},
				error: function(errMsg) {
					$('#message-parent').show();
					$('#message-alert').removeClass('alert-info').addClass('alert-danger');
					$('#error-message').text(errMsg.responseJSON.msg);
					$('#OutputFrame')[0].contentWindow.location.reload(true);
					fn_fadeOut();
				}
			});
		});

		$("#ReportID").click(function() {
			var report_id = $("#ReportID").val();
			$("#OutputFrame").attr("src","/Morakot/Report/"+report_id);
		});
	});

</script>


{% endblock %}

{% macro escapeNone (Text)%}
	{%if Text!='' and Text!=None %}
		{{Text}}
	{%endif%}
{% endmacro %}