{% extends "layout.html" %}

{% block css %}
<style type="text/css">
#t1 {
   padding-right: 21px;
   display: inline;
}

#t2 {
    -moz-tab-size: 16; /* Code for Firefox */
    -o-tab-size: 16; /* Code for Opera 10.6-12.1 */
    tab-size: 16;
}

	.my-col-left{
		width: 95%;
		float: left;
	}

	.my-col-right{
		width: 5%;
		float: right;
		padding-left: 0;
	}
</style>
{% endblock %}

{% block content %}

	<!--  message  -->
	<div class="clearfix"></div>
	{% include 'msg_error.html' %}

	<div class="clearfix"></div>

	{% if Date %}

		<div class="my-col-left">
			<div class="col-sm-12">
				<h3 class="header-3">
					EOD Overal Status - {{ SystemDate }}
					<!-- <span class="pull-right">Holiday: {{ HolidayList }}</span> -->
					<span class="text-success pull-right" id="Duration_Overal">Duration: 0:00:00</span>
				</h3>
			</div>
		</div>
		<div class="my-col-right"></div>

		<div class="col-sm-12">

			<div class="row">
				<div class="my-col-left">
					<div id="ProgressBar" class="col-sm-12">	
						<div class="progress progress-striped active" style="height: 30px;"><div class="progress-bar progress-bar-success" style="width: {{Percentage}}%; height: 30px;"></div></div>
					</div>
				</div>
				<div class="my-col-right">
					<div class="col-sm-12" id="OveralCompleted" style="padding-left: 0; display: none;">
						<i class="fa fa-check-circle text-success" style="font-size:30px;"></i>
					</div>
				</div>
			</div>

			{% if BjStat %}

				{% for item in BjStat %}

					<div class="row">

						<div class="my-col-left">
							<div class="col-sm-12">
								<h6 class="text-light-gray text-semibold text-xs" style="margin:20px 0 10px 0;">{{ item.Description }} ( <span id="Prog_{{ item.Module }}">0</span> of <span id="Rec_{{ item.Module }}">{{ item.NumberOfRecord }}</span>) <span class="pull-right" id="Duration_{{ item.Module }}">Duration: 0:00:00</span></h6>
								<div id="M{{ item.Module }}">
									<div class="progress progress-striped active" style="margin-bottom: 0; height: 20px;"><div class="progress-bar" style="width: {{ str(item.Completed) }}%; height: 20px;"></div></div>
								</div>
							</div>
						</div>

						<div class="my-col-right" id="Check_{{ item.Module }}" style="padding-top:39px; display: none; ">
							<div class="col-sm-12" style="padding-left: 0;">
								<i class="fa fa-check-circle text-info" style="font-size:23px;"></i>
							</div>
						</div>

					</div>

				{% endfor %}

			{% endif %}

		</div>

	{% else %}

		<div style="padding: 10% 0;">

			<div class="col-sm-12">
				<h1 class="header-3 text-center">EOD Batch Processing<br><span style="font-size: 18px;">{{ SystemDate }}</span></h1>
			</div>

			<div class="col-sm-12" style="padding:5px 10px">
				<input type="hidden" id="CurrentDate" value="{{ SystemDate }}">
				<h4 class="header-3 text-center">Please make sure you have backed-up database before running EOD. 
					<a href="javascript:void(0);" id="LinkToBackup">Backup Now</a>
					<script type="text/javascript">
                        init.push(function () {
                            $("#LinkToBackup").click(function(){
                                if ( self !== top ) {
                                    window.parent.addTab("Bankup", "/Morakot/Backup");
                                }else{
                                    window.parent.location.href="/Morakot/Backup";
                                }
                            });
                        });
                    </script>
				</h4>
			</div>

			{% if Error and Error == 'Y' %}

				<div class="col-sm-12" style="padding:20px 10px">
					<h4 class="header-3 text-center">
						<a href="javascript:void(0);" id="RemoteEODonServer" class="btn btn-flat btn-labeled btn-warning" style="padding: 25px 50px;">
							<b style="font-size: 20px;">Resume EOD</b>
						</a>
					</h4>
				</div>

			{% else %}

				<div class="col-sm-12" style="padding:20px 10px">
					<h4 class="header-3 text-center">
						<a href="javascript:void(0);" id="RemoteEODonServer" class="btn btn-flat btn-labeled btn-success" style="padding: 25px 50px;">
							<b style="font-size: 20px;">Start EOD</b>
						</a>
					</h4>
				</div>

			{% endif %}

		</div>

	{% endif %}

{% endblock %}

{% block js %}

	<script type="text/javascript">
		$(document).ready(function() {
			
			var poll_loop;
			 
			$("#RemoteEODonServer").click(function() {
				var CurrentDate = $("#CurrentDate").val();

				bootbox.confirm({
					{% if Error and Error == 'Y' %}
						message: "Are you sure you want to resume EOD?",
					{% else %}
						message: "Are you sure you want to start EOD?",
					{% endif %}
					
					callback: function(result) {
						if(result==true){
							$.ajax({
						        beforeSend: function() {
						            // $('#statusbox').html("Running deployment...");
						        },
						        type: "GET",
						        url: "/Morakot/EOD/Running/",
						        data: {},
						        success: function() {
						            console.log('Qa-run OK');
						            window.location.href="/Morakot/EOD/?Date={{ SystemDate }}";
						        },
						        error: function() {
						            console.log('Qa-run failed.');
						        }
						    });
						}
						
					},
					className: "bootbox-sm"
				});

			});
		});
	</script>

	<script type="text/javascript">
		$(document).ready(function() {
			
			$('#btnBackup').on("click",function(event) 
			{
				window.parent.$("#animated").fadeIn("slow");
			});

			{% set Dic = {} %}
			{% for i in BjStat %}
				{% if Dic.update({'M': Dic.get('M','')+' '+ i.Module}) %}{% endif %}
			{% endfor %}

			var ModuleList = '{{Dic.get('M')}}'.split(' ');

			function getBJStat(){

				sse = new EventSource('/Morakot/BJStatBar/?Date={{ SystemDate }}');
				sse.onmessage = function(e) {

					var strdata = JSON.stringify(eval('('+e.data+')'));
					var data = JSON.parse(strdata);

					if(data['Check'] == '1'){
					
						var resutl = '<div class="progress progress-striped active" style="height: 30px;"><div class="progress-bar progress-bar-success" style="width: '+ data['Overal'] +'%; height: 30px;"></div></div>';
						$("#ProgressBar").html(resutl);

						var i = 0
						for (l=ModuleList.length; i<l; i++) {
							$("#M"+ModuleList[i]).html('<div class="progress progress-striped active" style="margin-bottom: 0; height: 20px;"><div class="progress-bar" style="width: '+ data[ModuleList[i]] +'%; height: 20px;"></div></div>');
							$("#Prog_"+ModuleList[i]).html(data['Num'+ModuleList[i]]);
							$("#Rec_"+ModuleList[i]).html(data['Rec'+ModuleList[i]]);

							if (data['Duration_'+ModuleList[i]] != '00:00:00'){
								$("#Duration_"+ModuleList[i]).html("Duration: " + data['Duration_'+ModuleList[i]]);
							}
						  	if(parseFloat(data[ModuleList[i]]) == parseFloat(100)){
								$("#Check_"+ModuleList[i]).show();
							}else{
								$("#Check_"+ModuleList[i]).hide();
							}
						}
						
						if (data['OveralCompleted'] == 'Y')
						{
							$("#OveralCompleted").show();
							$('#uidemo-modals-alerts-success').modal('show');
						}

						if (data['Duration_Overal'] != '00:00:00')
						{
							$("#Duration_Overal").html("Duration: " + data['Duration_Overal']);
						}

						{% if len(HolidayList) > 0 and StopEOD == False %}

							if (data['BankDate'] != "{{ SystemDate }}")
							{
								window.location.href="/Morakot/EOD/?Date=" + data['BankDate'];
							}

						{% endif %}

						{% if Date != "" %}

							if (data['Error'] != "")
							{
							    $('#uidemo-modals-alerts-danger').modal('show');
							}

						{% endif %}
						
					}
				}
			}

			getBJStat();

		});
	</script>

	<!-- Danger -->
	<div id="uidemo-modals-alerts-danger" class="modal modal-alert modal-danger fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<i class="fa fa-times-circle"></i>
				</div>
				<div class="modal-title">Oop!</div>
				<div class="modal-body" id="ShowMsgError">
					There is something wrong during EOD. Please check your error log, fix the issue and try again.
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">OK</button>
				</div>
			</div> <!-- / .modal-content -->
		</div> <!-- / .modal-dialog -->
	</div> <!-- / .modal -->
	<!-- / Danger -->

	<!-- Danger -->
	<div id="uidemo-modals-alerts-success" class="modal modal-alert modal-success fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<i class="fa fa-check-circle"></i>
				</div>
				<!-- <div class="modal-title">Successfully!</div> -->
				<div class="modal-body" id="ShowMsgError">
					EOD was sucessfully completed for {{ SystemDate }}.
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-success" data-dismiss="modal">OK</button>
				</div>
			</div> <!-- / .modal-content -->
		</div> <!-- / .modal-dialog -->
	</div> <!-- / .modal -->
	<!-- / Danger -->

{% endblock %}