{% extends "layout.html" %}

{% block css %}
	<style>
		h3.header-3{
			color: #888 !important;
			font-size: 16px;
			font-weight: bold;
			margin: 5px 0 10px;
			padding: 10px 18px 0;
			line-height: 30px;
		}

		h3.header-33{
			color: #888 !important;
			font-size: 16px;
			font-weight: bold;
			margin: 0px 0 10px;
			line-height: 20px;
		}

		h4.header-4{
			color: #888 !important;
			font-size: 14px;
			font-weight: normal;
			margin: 5px 0 10px;
			padding: 0px 18px 0;
		}

		.input-sm {

			width: 214px !important;
		}

		.modal-dialog{

			width: 428px !important;

		}

		.form-label{
			padding-top: 7px;
		}

		.modal-body {
			z-index: 99999 !important;
		}

		.form-label{
			padding-top: 7px;
		}
		.cls-border td{
			border-bottom: 1px solid #000 !important;
		}
	</style>
{% endblock %}

{% block content %}
	 <!-- Navbar -->
	 <div class="navbar navbar-default navbar-static-top" id="CriteriaSetting" >
		<div class="col-sm-12">
			<div style="margin-top: 8px;">

			</div> 
			<div class="col-sm-6" style="padding-top:10px; padding-left:0px;">

				{% from "print.html" import exportButtonLink %}
				{{exportButtonLink()}}

			</div>
			<a href="javascript:void(0)" title="Refresh" id="Refresh" class="btn btn-flat btn-labeled btn-warning pull-right" style="margin-left: 5px;">
				<span class="btn-label icon fa fa-refresh"></span> Refresh
			</a>
			<button  type="button" data-toggle="modal" data-target="#getCustomRange"  class="btn btn-flat btn-labeled btn-success pull-right" >
			<span class="btn-label icon fa fa-gear" ></span> Custom </button>
		</div> 
	</div>
	<!-- End Navbar -->

	<!-- Modal Custom -->
	<div class="modal fade" id="getCustomRange" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form class="form-horizontal" action="/Morakot/Report/COPerformance/" method="GET">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="exampleModalLabel">Custom</h4>
					</div>
					<div class="modal-body">

						<div class="form-group">
							<label for="Branch" class="col-sm-4 control-label">{{ getLanguage('Branch') }}:</label>
							<div class="col-sm-8">
								<input name="Branch" value="{{ Branch }}" class="input-sm form-control" style="width: 100%;">
							</div>
						</div>

						<div class="form-group">
							<label for="LoanClass" class="col-sm-4 control-label"> Loan class from: </label>
							<div class="col-sm-8">
								<select class="input-sm form-control" id="LoanClass" name="LoanClass" style="width:100%;">
									<optgroup label="LoanClass">
										{%for row in AssetClassObj %}
										<option value="{{row.ID}}"> {{row.ID}} - {{row.Description}} </option> 
										{%endfor%}
									 </optgroup>
								</select>
								<script type="text/javascript">
									init.push(function () {
										// Single select
										$("#LoanClass").val('{{ LoanClass }}');
										$("#LoanClass").select2({
											allowClear: true,
											placeholder: "Loan Class"
										});

									});
								</script>
							</div>
						</div>

					</div>
					<div class="modal-footer">
						<button type="submit" class="btn btn-primary">{{ getLanguage('Apply') }}</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">{{ getLanguage('Cancel') }}</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- End Modal Custom -->

	<!-- Report Header -->
	<div class="col-sm-12">
		<table width="100%" border="0">
			<tbody>
				<tr>
					<td class="text-left" rowspan="3" width="20%">
						<img src="{{ url_for('static', filename='company/logo.png') }}" width="50%">
					</td>
					<td class="text-center" width="60%">
						<h3 class="header-3">
							{{ CompanyObj.CompanyName }}
						</h3>
					</td>
					<td class="text-right" width="20%"></td>
				</tr>

				<tr>
					<td class="text-center">
						<h3 class="header-33">CO Performance Report</h3>
					</td>
					<td class="text-right" width="20%"></td>
				</tr>

				<tr>
					<td class="text-center">
						<h4 class="header-4">
							<strong>As of:</strong> {{ BankDate }} 
						</h4>
					</td>
					<td class="text-right" width="20%"></td>
				</tr>

				<tr>
					<td class="text-left" width="20%"></td>
					<td class="text-center">
						<h4 class="header-4">
							<strong>Currency:</strong> {{ BaseCurrencyObj.ID }} 
						</h4>
					</td>
					<td class="text-right" width="20%"></td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- End Report Header -->

	<!-- Report Filter -->
	<div class="col-sm-12">
		<table>
			<tr>
				<td width="150"><strong>Branch</strong></td>
				<td>: &nbsp;{{ Branch }}  </td>
			</tr>
			<tr>
				<td width="150"><strong>Loan class from</strong></td>
				<td>: &nbsp;{{LoanClass}} - {{ AssetClassObj.filter_by(ID=LoanClass).first().Description }}  </td>
			</tr>
		</table>
	</div>
	<!-- End Report Filter -->

	<!-- Data table -->
	<div class="clearfix">&nbsp;</div>
	<div class="col-sm-12">

		<table id="mktlist" class="table table-hover table-striped" cellspacing="0" width="100%">
			<thead>
				<tr>
					<th>CO ID</th>
					<th>CO Name</th>
					<th>Currency</th>
					<th class="text-right">#Borrowers</th>
					<th class="text-right">#Loans</th>
					<th class="text-right">Disbursed Amt.</th>
					<th class="text-right">Oustanding Amt.</th>
					<th class="text-right">Loan Balance</th>
					<th class="text-right">#PARs</th>
					<th class="text-right">PAR Amt.</th>
					<th class="text-right">PAR Rate</th>
					<th class="text-right">PD Principal</th>
					<th class="text-right">PD Interest</th>
					<th class="text-right">PD Penalty</th>
					<th class="text-right">Arrear Rate</th>
				</tr>
			</thead>
			<tbody>
				{% for row in ListOfficer %}
					{% set Dict = DictTotal.get(row,{}) %}
					{% if Dict %}
						{% for col in CurrencyObj.all() %}
							{% set DictDetail = Dict.get(row + col.ID) %}
							{% if DictDetail %}
								<tr>
									<td class="text-left">{{row}}</td>
									<td class="text-left">{{Dict.get('COName',"")}}</td>
									<td class="text-left">{{col.ID}}</td>
									<td class="text-right">{{DictDetail.get('NoOfBorrower',0)}}</td>
									<td class="text-right">{{DictDetail.get('NoOfLoan',0)}}</td>
									<td class="text-right">{{toMoney(float(DictDetail.get('DisbursedAmt',0)), CurrencyObj.get(col.ID))}}</td>
									<td class="text-right">{{toMoney(float(DictDetail.get('OutstandingAmt',0)), CurrencyObj.get(col.ID))}}</td>
									<td class="text-right">{{toMoney(float(DictDetail.get('LoanBalance',0)), CurrencyObj.get(col.ID))}}</td>
									<td class="text-right">{{DictDetail.get('NoOfPAR',0)}}</td>
									<td class="text-right">{{toMoney(float(DictDetail.get('PARsAmt',0)), CurrencyObj.get(col.ID))}}</td>
									<td class="text-right">{{formatNumber(DictDetail.get('PARsRate',0.00))}} %</td>
									<td class="text-right">{{toMoney(float(DictDetail.get('PrincipalArrear',0)), CurrencyObj.get(col.ID))}}</td>
									<td class="text-right">{{toMoney(float(DictDetail.get('InterestArrear',0)), CurrencyObj.get(col.ID))}}</td>
									<td class="text-right">{{toMoney(float(DictDetail.get('PenaltyArrear',0)), CurrencyObj.get(col.ID))}}</td>
									<td class="text-right">{{formatNumber(DictDetail.get('ArrearRate',0.00))}} %</td>
								</tr>
								{% endif %}
						{% endfor %}
						{% if CheckCurrency.all() | length > 1%}
						<tr class="text-bold cls-border">
							<td class="text-left"></td>
							<td class="text-left">SubTotal</td>
							<td class="text-left">{{BaseCurrencyObj.ID}}</td>
							<td class="text-right">{{Dict.get('NoOfBorrower',0)}}</td>
							<td class="text-right">{{Dict.get('NoOfLoan',0)}}</td>
							<td class="text-right">{{toMoney(float(Dict.get('DisbursedAmt',0)), BaseCurrencyObj)}}</td>
							<td class="text-right">{{toMoney(float(Dict.get('OutstandingAmt',0)), BaseCurrencyObj)}}</td>
							<td class="text-right">{{toMoney(float(Dict.get('LoanBalance',0)), BaseCurrencyObj)}}</td>
							<td class="text-right">{{Dict.get('NoOfPAR',0)}}</td>
							<td class="text-right">{{toMoney(float(Dict.get('PARsAmt',0)), BaseCurrencyObj)}}</td>
							<td class="text-right">{{formatNumber(Dict.get('PARsRate',0.00))}} %</td>
							<td class="text-right">{{toMoney(float(Dict.get('PrincipalArrear',0)), BaseCurrencyObj)}}</td>
							<td class="text-right">{{toMoney(float(Dict.get('InterestArrear',0)), BaseCurrencyObj)}}</td>
							<td class="text-right">{{toMoney(float(Dict.get('PenaltyArrear',0)), BaseCurrencyObj)}}</td>
							<td class="text-right">{{formatNumber(Dict.get('ArrearRate',0.00))}} %</td>
						</tr>
						{% endif %}
					{% endif %}
				{% endfor %}
				<tr class="text-bold">
					<td class="text-left"></td>
					<td class="text-left">GrandTotal</td>
					<td class="text-left">{{BaseCurrencyObj.ID}}</td>
					<td class="text-right">{{DictTotal.get('NoOfBorrower',0)}}</td>
					<td class="text-right">{{DictTotal.get('NoOfLoan',0)}}</td>
					<td class="text-right">{{toMoney(float(DictTotal.get('DisbursedAmt',0)), BaseCurrencyObj)}}</td>
					<td class="text-right">{{toMoney(float(DictTotal.get('OutstandingAmt',0)), BaseCurrencyObj)}}</td>
					<td class="text-right">{{toMoney(float(DictTotal.get('LoanBalance',0)), BaseCurrencyObj)}}</td>
					<td class="text-right">{{DictTotal.get('NoOfPAR',0)}}</td>
					<td class="text-right">{{toMoney(float(DictTotal.get('PARsAmt',0)), BaseCurrencyObj)}}</td>
					<td class="text-right">{{formatNumber(DictTotal.get('PARsRate',0.00))}} %</td>
					<td class="text-right">{{toMoney(float(DictTotal.get('PrincipalArrear',0)), BaseCurrencyObj)}}</td>
					<td class="text-right">{{toMoney(float(DictTotal.get('InterestArrear',0)), BaseCurrencyObj)}}</td>
					<td class="text-right">{{toMoney(float(DictTotal.get('PenaltyArrear',0)), BaseCurrencyObj)}}</td>
					<td class="text-right">{{formatNumber(DictTotal.get('ArrearRate',0.00))}} %</td>
				</tr>
			</tbody>
			<tfoot style="border-top: 2px solid #CCC;">

			</tfoot>
		</table>
	</div>
	<!-- End Data table -->

	<!-- Note -->
	<div class="col-sm-12">
		<table>
		<h5><strong><u>Note:</u></strong></h5>
			<tbody>
				<tr>
					<td colspan="2"><li><b>(1)</b> Amount in SubTotal and GrandTotal are converted to base currency <b>{{ BaseCurrencyObj.ID }}</b>.</li></td>
				</tr>
				<tr>
					<td colspan="2"><li><b>(2)</b> These columns will be affected by custom filter <b>Loan class from</b>.</li></td>
				</tr>
				<tr>
					<td colspan="2">
						<li><b>N/A-HO</b> in column CO ID means Loan Contract(s) has no officer in branch HO.
							This is mostly caused by data migration missing Officer ID in Loan Contracts.
						</li>
					</td>
				</tr>
				<tr>
					<td colspan="2"><hr></td>
				</tr>
				<tr>
					<th width="250">#Borrowers:</th>
					<td>Total number borrowers of Credit Officer.</td>
				</tr>
				<tr>
					<th>#Loans:</th>
					<td>Total number loans of all borrowers.</td>
				</tr>
				<tr>
					<th>Oustanding Amt.:</th>
					<td>Total outstanding amount. (1)</td>
				</tr>
				<tr>
					<th>Loan Balance:</th>
					<td>Total schedule balance. (1)</td>
				</tr>
				<tr>
					<th>Disbursed Amt.:</th>
					<td>Total disbursed amount. (1)</td>
				</tr>
				<tr>
					<th>#PARs:</th>
					<td>(<b>PAR</b>: <b>P</b>ortfolio <b>A</b>t <b>R</b>isk) Total number of all loans in arrear. (2)</td>
				</tr>
				<tr>
					<th>PAR Amt.:</th>
					<td>Total outstanding amount of all loans in arrear. (1) (2)</td>
				</tr>
				<tr>
					<th>PAR Rate:</th>
					<td>PAR Amount comparing to total outstanding amount as percentage. (2)</td>
				</tr>
				<tr>
					<th>PD Principal:</th>
					<td>Total principal due of all loans in arrear. (1) (2)</td>
				</tr>
				<tr>
					<th>PD Interest:</th>
					<td>Total interest due of all loans in arrear. (1) (2)</td>
				</tr>
				<tr>
					<th>PD Penalty:</th>
					<td>Total penalty due of all loans in arrear. (1) (2)</td>
				</tr>
				<tr>
					<th>Arrear Rate:</th>
					<td>Total principal in arrear comparing to total outstanding amount as percentage. (2)</td>
				</tr>
			</tbody>
		</table>
	</div>
	<!-- End note -->
{% endblock %}

{% block js %}
	
	{% from "print.html" import exportIncludeJS %}
	{{exportIncludeJS()}}
	
	<script type="text/javascript">
		$(document).ready(function() {

			$('#mktlist').dataTable({
							"lengthMenu": [[25,50,100,200, -1], [25,50,100,200, "All"]],
							"bSort"         : false,
						});

			$("#Refresh").click(function() {
				fn_fadeIn();
				window.location.reload(true);
			});
			// $(".table-caption").append("<a class='btn btn-primary' href='/Morakot' role='button' title='Refresh'><i class='fa fa-save'></i> Save Schedule</a>");
			{% from "print.html" import exportDataTable %}
			{{exportDataTable('#mktlist', "CO Performance")}}
		});
	</script>
{% endblock %}