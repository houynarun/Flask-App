{% extends "layout.html" %}

{% block css %}
   
	<style type="text/css">
		.form-control
		{
			width: 100% !important;
		}
		table.borderless td, .borderless th {
			border: none !important;
		}

		@page {
			margin: 0.1cm 0.5cm;
		}

	body{
		background-color: #fff;
		color: #555;
		/*font-family: "Suwannaphum", Helvetica, Arial, sans-serif;*/
		font-size: 14px;
		line-height: 1.42857;
	}

	.header{
		margin: 10px 0;
	}

	.logo{
		width: 20%;
		/*border: 1px solid;*/
		float: left;
		text-align: center;
	}

	.company{
		width: 75%;
		/*border: 1px solid;*/
		float: left;
	}

	.clearfix{
		clear: both;
		width: 10%;
		height: 15px;
	}

	.companyKh
	{
		font-family: 'Moul', Arial;
	}
	h3 {
		font-size: {% if CompanyKh|length > 25 %} 10pt {% else %} 11pt {% endif %};
	}

	@media print {
		.hideprint {
			display:none;
		}

		.id_table {
			
		}
	}

	</style>
{% endblock %}

{% block content %}
	<div class="se-pre-con1"></div>
	<div class="navbar navbar-default navbar-static-top ActionFotter" id="CriteriaSetting" >
		<div class="col-sm-12">
				<div style="margin-top: 8px;">
				</div> 
				<div class="col-sm-6" style="padding-top:10px; padding-left:0px;">

					{% from "print.html" import exportButtonLink %}
					{{exportButtonLink()}}

				</div>  
		</div> 
	</div>
 
	<div class="col-sm-12 hideprint" id="navberCriteria">
		{% include 'msg_error.html' %}
		<form action="" method="POST" role="FORM" id="generate_estimate">
			<div class="col-lg-5 col-xs-12">
				<div class="panel colourable panel-info panel-dark" style="height: 564px;">
						<div class="panel-heading">
							<span class="panel-title"><i class="fa fa-calculator" aria-hidden="true"></i> Simulation Prepayment</span>
						</div>
						<div class="panel-body">
							<div class="form-group">
							<label class="col-sm-4">Loan Contract :</label>
							<div class="col-sm-5">
							   <select class="form-control" id="LoanID" name="LoanID" required="required">
									<option value=""></option>
									{%for row in LoanObj %}
									<option value="{{row[0].ID}}" {{'selected' if row[0].ID == LoanID else '' }} > {{row[0].ID}} - {{row[1].LastNameEn }} {{row[1].FirstNameEn}} </option> 
									{%endfor%}
								</select>
								<script type="text/javascript">
									init.push(function () {
										// Single select
										$("#LoanID").select2({
											allowClear: true,
											placeholder: "Loan Contract ID"
										});

									});
								</script>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-4">Operation :</label>
							<div class="col-sm-5">
								<select class="form-control" id="Operation" name="Operation" required="required">
									<option value="" ></option>
									<option value="AMT" {{'selected' if Operation == 'AMT' else '' }}> 1 - Partial Prepayment </option>
									<option value="TMN" {{'selected' if Operation == 'TMN' else '' }}> 2 - Terminate </option>
								</select>
								<script type="text/javascript">
									init.push(function () {
										// Single select
										$("#Operation").select2({
											allowClear: true,
											placeholder: "Operation"
										});

									});
								</script>
							</div>
						</div>

						<div class="form-group">
							<label class="col-sm-4">Request Date :</label>
							<div class="col-sm-5">
								<input class="input-sm form-control" type="text" value="{{RequestDate if RequestDate else mktdate.getBankDate() }}" placeholder="" name="RequestDate" id="RequestDate"  style="width:214px;">
								<script type="text/javascript">

									init.push(function () {
										var options = {
										orientation: $('body').hasClass('right-to-left') ? "auto right" : 'auto auto',
										format:"yyyy-mm-dd",
										autoclose:true
										}
										$('#RequestDate').datepicker(options);
									});

								</script>
							</div>
						</div>

						<div class="form-group">
							<label class="col-sm-4">Amendment Date :</label>
							<div class="col-sm-5">
								<input class="input-sm form-control" type="text" value="{{AmendmentDate if AmendmentDate else mktdate.getBankDate() }}" placeholder="" name="AmendmentDate" id="AmendmentDate"  style="width:214px;">
								<script type="text/javascript">

									init.push(function () {
										var options = {
										orientation: $('body').hasClass('right-to-left') ? "auto right" : 'auto auto',
										format:"yyyy-mm-dd",
										autoclose:true
										}
										$('#AmendmentDate').datepicker(options);
									});

								</script>
							</div>
						</div>

						<div class="form-group">
							<label class="col-sm-4">Deduct Amount :</label>
							<div class="col-sm-5">
								<input class="input-sm form-control" type="text" value="{{DeductAmount if DeductAmount else 0 }}" placeholder="" name="DeductAmount" id="DeductAmount"  style="width:214px;" >
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-sm-12 form-group text-center">
							<input type="submit" id="Generate" value="Calculate" class="btn btn-info">
						</div>
					</div>
				</div>
			</div>

			<div class="col-lg-7 col-xs-12">
				<div class="panel colourable panel-info panel-dark">
					<div class="panel-heading">
						<span class="panel-title"><i class="fa fa-pie-chart" aria-hidden="true"></i> Summary</span>
					</div>
					<div class="panel-body responsive" style="height: 520px; line-height: 170%; position: relative;">
						<table class="table">
							<tr>
								<th>Loan Outstanding: </th>
								<td>
									<span style="text-decoration: line-through;">{{ toMoney(float(ContractObj.OutstandingAmount), CurrencyObj,1) if ContractObj else '$ 0.00'}}</span>
								</td>
							</tr>
							<tr>
								<th>Loan Balance: </th>
								{% if DictData.get("Operation") == "AMT" %}
								<td>
									<span style="text-decoration: line-through;">{{ toMoney(float(DictData.get("LoanBalance")), CurrencyObj,1) if ContractObj and DictData.get("LoanBalance") else '$ 0.00'}}</span>
								</td>
								{% else %}
								<td>
									<strong>{{ toMoney(float(DictData.get("LoanBalance")), CurrencyObj,1) if ContractObj and DictData.get("LoanBalance") else '$ 0.00'}}</strong>
								</td>
								{% endif %}
							</tr>

							<tr>
								<th>Deduct Amount: </th>
								{% if DictData.get("Operation") == "TMN" %}
								<td>
									<span style="text-decoration: line-through;">{{ toMoney(float(DictData.get("DeductAmount")), CurrencyObj,1) if ContractObj and DictData.get("DeductAmount") else '$ 0.00'}}</span>
								</td>
								{% else %}
								<td>
									<strong>{{ toMoney(float(DictData.get("DeductAmount")), CurrencyObj,1) if ContractObj and DictData.get("DeductAmount") else '$ 0.00'}}</strong>
								</td>
								{% endif %}
							</tr>

							<tr>
								<th>Accru Current Interest: </th>
								{% if DictData.get("Operation") == "TMN" %}
								<td>
									<strong>{{ toMoney(float(DictData.get("AccrCurrentInt")), CurrencyObj,1) if ContractObj and DictData.get("AccrCurrentInt") else '$ 0.00'}}</strong>
								</td>								
								{% else %}
								<td>
									<span style="text-decoration: line-through;">{{ toMoney(float(DictData.get("AccrCurrentInt")), CurrencyObj,1) if ContractObj and DictData.get("AccrCurrentInt") else '$ 0.00'}}</span>
								</td>
								
								{% endif %}
							</tr>
							
							<tr>
								<th>PastDue :</th>
								<td width="200" ><b>
									{{ toMoney(float(DictData.get("TotPD")), CurrencyObj,1) if ContractObj and DictData.get("TotPD") else '$ 0.00'}}</b>
								</td>
							</tr>
							<tr>
								<td colspan="2" style="padding-top: 2px; padding-bottom: 2px;">
									<table class="table borderless pull-right" style="width: 70% !important; margin: 0px;">
										<tbody>
											<tr>
												<td>Principal :</td>
												<td width="240" style="padding-left: 55px;">
													{{ toMoney(float(DictData.get("PDPrincipal")), CurrencyObj,1) if ContractObj and DictData.get("PDPrincipal") else '$ 0.00'}}
												</td>
											</tr>
											<tr>
												<td>Interest :</td>
												<td style="padding-left: 55px;">
													{{ toMoney(float(DictData.get("PDInterest")), CurrencyObj,1) if ContractObj and DictData.get("PDInterest") else '$ 0.00'}}
												</td>
											</tr>
											<tr>
												<td>Penalty :</td>
												<td style="padding-left: 55px;">
													{{ toMoney(float(DictData.get("PDPenalty")), CurrencyObj,1) if ContractObj and DictData.get("PDPenalty") else '$ 0.00'}}
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
							<tr>
								<th>Insurance : </th>
								<td>
									<strong>{{ toMoney(float(DictData.get("Insurance")), CurrencyObj,1) if ContractObj and DictData.get("Insurance") else '$ 0.00'}}</strong>
								</td>
							</tr>
							
							<tr>
								<th>Penalty Amendment/Terminate : </th>
								<td>
									<strong class="text-danger">{{ toMoney(float(DictData.get("PenaltyAmend")), CurrencyObj,1) if ContractObj and DictData.get("PenaltyAmend") else '$ 0.00'}}</strong>
								</td>
							</tr>

							<tr>
								<td colspan="2" style="padding-top: 2px; padding-bottom: 2px;">
									<table class="table borderless pull-right" style="width: 70% !important; margin: 0px;">
										<tbody>
											<tr>
												<td>On Amendment :</td>
												<td width="240" style="padding-left: 55px;">
													{{ toMoney(float(DictData.get("PenaltyOnAmend")), CurrencyObj,1) if ContractObj and DictData.get("PenaltyOnAmend") else '$ 0.00'}}
												</td>
											</tr>
											<tr>
												<td>On Notification :</td>
												<td style="padding-left: 55px;">
													{{ toMoney(float(DictData.get("PenaltyOnNotice")), CurrencyObj,1) if ContractObj and DictData.get("PenaltyOnNotice") else '$ 0.00'}}
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>

							<tr>
								<th>Total:</th>
								<td>
									<strong class="text-primary">									
										{{ toMoney(float(DictData.get("TotPayment")), CurrencyObj,1) if ContractObj and DictData.get("TotPayment") else '$ 0.00'}}						
									</strong>
								</td>
							</tr>	
						</table>
					</div>
				</div>
			</div>

		</form>
	</div>

	{% if "TotPayment" in DictData %}

		<div class="container">
			<div class="header">
				<div class="col-xs-12">
					<div class="row text-center">
						<div class="col-xs-3" style="height: 150px;">
							<img style="max-width: 100%; max-height: 95%; margin-top: 20px;" 
								src="{{ url_for('static', filename='company/logo.png') }}">
						</div>
						<div class="col-xs-6" style="margin-top:10px;">
							<h4 class="companyKh">{{CompanyObj.CompanyName}}</h4>
							{#<h3>{{CompanyObj.CompanyName}}</h3>#}
							<div style="text-align: center; height:24px;"><img src="/static/artwork/lineheader.png"/></div>
							<h4 class="companyKh">Simulation Prepayment</h4>
						</div>
						<div class="col-xs-3 text-left id_table">
							<table class="" style="width: 100%; margin-top: 30px; margin-right: 30px;" frame="box">
                                <tbody>
                                    <tr style="height: 25px;">
                                        <td style="padding-left: 10px;">Account: </td>
                                        <td><b>{{ ContractObj.Account }}</b></td>
                                    </tr>
                                    <tr style="height: 25px">
                                        <td style="padding-left: 10px;">Customer: </td>
                                        <td>{{ ContractObj.ContractCustomerID }}</td>
                                    </tr>
                                    <tr style="height: 25px">
                                        <td style="padding-left: 10px;">Application: </td>
                                        <td>{{ ContractObj.LoanApplicationID }}</td>
                                    </tr>
                                    <tr style="height: 25px">
                                        <td style="padding-left: 10px;">Contract: </td>
                                        <td>{{ ContractObj.ID }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
					</div>
				</div>
			 </div>

			<div class="clearfix">&nbsp;</div>


			{% set ValueList = [{"Description": "Past due from principal" , "Amount": DictData.get("PDPrincipal") },
			                    {"Description": "Past due from interest" , "Amount": DictData.get("PDInterest") },
			                    {"Description": "Past due penalty" , "Amount": DictData.get("PDPenalty")},
			                    {"Description": "Insurance" , "Amount": DictData.get("Insurance") },
			                    {"Description": "Penalty on amendment / terminate" , "Amount": DictData.get("PenaltyOnAmend")},
			                    {"Description": "Penalty on notification" , "Amount": DictData.get("PenaltyOnNotice")}] 
            %}

            {% if DictData.get("Operation") == "TMN" %}
				{% if   ValueList.append({"Description": "Loan Balance due from customer" , "Amount": DictData.get("LoanBalance") }) %} {%endif%}
				{% if   ValueList.append({"Description": "Accrue interest current installment" , "Amount": DictData.get("AccrCurrentInt")}) %} {%endif%}
			                    
            {% else %}
            	{% if   ValueList.append({"Description": "Deduct Amount due from customer" , "Amount": DictData.get("DeductAmount") }) %} {%endif%}
            {% endif %}

            <div class="col-lg-12 col-sm-12 col-xs-12">
                <table style="width: 100%;margin-bottom: 20px" border="0">
                    <tbody>
                        <tr style="height: 25px;">
                            <td><b>Customer Name:</b> {{ CustomerObj.LastNameEn + " " +  CustomerObj.FirstNameEn }}</td>
                            <td><b>Value Date:</b> {{mktdate.formatDate(ContractObj.ValueDate,'dd/mm/yyyy')}}</td>
                            <td><b>Maturity Date:</b> {{mktdate.formatDate(ContractObj.MaturityDate,'dd/mm/yyyy')}} </td> 
                        </tr>
                        <tr style="height: 25px;">
                            <td><b>Disbursed:</b> {{ toMoney(float(ContractObj.Disbursed), CurrencyObj,1) }}</td>
                            <td><b>Interest Rate:</b> {{ ContractObj.InterestRate }} % </td>
                            <td><b>Term:</b> {{ ContractObj.Term }} Months </td> 
                        </tr>
                        <tr style="height: 25px;">
                            <td><b>Operation:</b> {{ "Terminate" if DictData.get("Operation") == "TMN" else "Partial Prepayment" }}</td>
                            <td><b>Request Date:</b> {{ mktdate.formatDate(str(DictData.get("RequestDate")),'dd/mm/yyyy') }}</td>
                            <td><b>Amend Date:</b> {{ mktdate.formatDate(str(DictData.get("AmendmentDate")),'dd/mm/yyyy') }} </td>
                        </tr>
                        <tr style="height: 25px;">
                        	<td><b>Deduct Amount:</b> {{ toMoney(float(DictData.get("DeductAmount")), CurrencyObj,1) }}</td> 
                        	{% if DictData.get("DictPenalty") %}
                            <td><b>Num. Day Notify:</b> {{ DictData.get("DictPenalty").get("NumDayNotify") }}</td>
                            <td><b>Num. Day Penalty:</b> {{ DictData.get("DictPenalty").get("NumDayPenalty") }}</td>
                            {% endif %}
                        </tr>
                    </tbody>
                </table>
                        
            </div>
            

			<table class="table table-striped table-hover" cellpadding="0" >
				<thead>
					<tr>
						<th>No.</th>
						<th>Description</th>
						<th>Amount</th>						
					</tr>
				</thead>
				<tbody>
					{% for item in ValueList %}
						<tr>
							<td>{{ loop.index }}</td>
							<td>{{ item.get("Description") }}</td>
							<td>{{ toMoney(float(item.get("Amount")), CurrencyObj,1) }}</td>					
						</tr>
					{% endfor %}

				</tbody>
				<tfooter>
					<tr style="font-weight: bold;">
						<td></td>
						<td>Total</td>
						<td>{{ toMoney(float(DictData.get("TotPayment")), CurrencyObj,1) }}</td>
					</tr>
				</tfooter>
			</table>
		</div><br><br><br>

	{% endif %}

{% endblock %}

{% block js %}

{% from "print.html" import exportIncludeJS %}
{{exportIncludeJS()}}

<script type="text/javascript">

	$(document).ready(function() {

		{% from "print.html" import exportDataTable %}
		{{exportDataTable("#mktlist","")}}

		$("#Operation").on("change",function(){
			var operation = $(this).val()

			if (operation == 'TMN'){
				$("#DeductAmount").attr("readonly","readonly").val("0")
			}else{
				$("#DeductAmount").removeAttr("readonly")
			}
		})

		$("#Operation").trigger("change")
		
	});

</script>
{% endblock %}