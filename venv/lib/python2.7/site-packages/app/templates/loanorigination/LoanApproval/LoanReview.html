{% extends "layout.html" %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='stylesheets/jquery.datatables.css') }}">
<style type ="text/css">
	/*CSS*/
	.disable-link{
		background: none
	}
</style>
{% endblock %}


{# Define Macro #}
{# Macro for select full name #}
{% macro getUserName(Inputter) -%}
	{%set InputterName = User.query.filter(User.ID==Inputter).first() %}
	{%if InputterName%}
		{{InputterName.DisplayName}}
	{%endif%}
{%- endmacro %}

{# Macro for select next reviewer #}
{% macro getNextReviewer(LoanAppID) -%}
	{%set NextReviewer = ApprovalObj.query.filter(ApprovalObj.LoanApplicationID==LoanAppID) %}
	{%if NextReviewer%}
		{%set Count = NextReviewer.count()%}
		{# Get it from config setting #}
		{%set Reveiwer = ['BM','HoC','BDM','CFO','CEO'] %}
		{{Reveiwer[Count]}}
	{%endif%}
{%- endmacro %}

{# Macro for select the role that already review a loan #}
{% macro getRejected(LoanAppID) -%}
	{%set Approver = ApprovalObj.query.filter(ApprovalObj.LoanApplicationID==LoanAppID).filter(ApprovalObj.Action=='3').all() %}
	{%if Approver%}
		{%for row in Approver%}
			{%if loop.last%}
				{{getUserName(row.Inputter)}}
			{%endif%}
		{%endfor%}
	{%endif%}
{%- endmacro%}

{# Macro for select the role that already approved a loan #}
{% macro getApproval(LoanAppID) -%}
	{%set Approver = ApprovalObj.query.filter(ApprovalObj.LoanApplicationID==LoanAppID).filter(ApprovalObj.Action=='2').all() %}
	{%if Approver%}
		{%for row in Approver%}
			{%if loop.last%}
				{{getUserName(row.Inputter)}}
			{%endif%}
		{%endfor%}
	{%endif%}
{%- endmacro%}

{# Macro for select customre full name #}
{% macro getCustomerName(CustomerID,Lang='En') -%}
	{%set CustomerName = CustomerObj.query.filter(CustomerObj.ID==CustomerID).first() %}
	{%if CustomerName%}
		{%if Lang=='En'%}
			{{CustomerName.LastNameEn}} {{CustomerName.FirstNameEn}}
		{%elif Lang=='Kh'%}
			{{CustomerName.LastNameKh}} {{CustomerName.FirstNameKh}}
		{%endif%}
	{%endif%}
{%- endmacro %}

{%set Count = LoanList|length%}
{% block content %}

	<h3 class="header-3 text-center">Loan Application to Review and Approve</h3>
			{% include 'msg_error.html' %}
	<div style="clear:both;"></div>
	<div class="panel colourable panel-info panel-dark">
		<div class="panel-heading">
			<div class="panel-title">Loan Application to Review and Approve &nbsp;<span class=" badge badge-info" style="background: #006F90;">{{Count}}</span>
				<div class="panel-heading-controls">
					<div class="panel-heading-icon" style="padding-top:0px;">
						<a title="Refresh" class="link"><i id="LoanApprovalRefresh" class="fa fa-refresh" style="color:#fff"></i></a>
					</div>
				</div>
			</div>
		</div>

			{#
				Role 7  = MB
				Role 17 = SBM
				Role 14 = HoC
					Limit Role:
					Loan Amount		 Total Exposure		Reviewer		Approver
				1)	≤US$ 5,000 		 ≤U$ 10,000			SBM		 		BM
				2)	≤S$ 5,000		 >US$ 10,000		BM, BM, HoC		LCC
				3)	>US$ 5,000		 Any amount			SBM, BM, HoC	LCC

			#}

			{# User Sub-BM  #}
			{% set LoanApplicationObj=LoanList %}

		<div class="panel-body">
			<div class="table-responsive">
				<table id="mktlist" class="table table-striped table-hover table display" cellspacing="0" width="100%" >
					<thead class="text-center">
						<th>Branch</th>
						<th>ID</th>
						<th>Customer ID</th>
						<th>Name (EN)</th>
						<th>Name (KH)</th>
						<th>Approved Amount</th>
						<th>Applied Date</th>
						<th>Rate</th>
						<th>Term</th>
						<th>Prepared By</th>
						<th class="text-center">Reviewed By</th>
						<th class="text-center">Rejected By</th>
						<th class="text-center">Approved By</th>
						<th>Next Level</th>
					</thead>
					<tbody>
						{% if LoanApplicationObj %}
							{% for LoanApplication in LoanApplicationObj %}
							<!-- Function has Reviewed by -->
							{%set Approval = ApprovalObj.query.filter(ApprovalObj.LoanApplicationID==LoanApplication.ID).filter(ApprovalObj.Action=='1')%}
							{%set LinkDetail= "CustomClickView('LoanReviewDetail','LoanReviewDetail/?ID="+LoanApplication.ID+"')" %}
							{%set Class_Link = "link" %}
							{%set Text_Mute = "" %}
							{%set Title_ToolTip = "" %}
							{% if Branch != LoanApplication.Branch %}
								{% set LinkDetail = "" %}
								{% set Class_Link = "text-muted" %}
								{% set Text_Mute = "text-muted" %}
								{% set Title_ToolTip = "Please switch to %s branch in order to review/approve this LA" % (LoanApplication.Branch) %}
							{% endif %}
							<tr title="{{Title_ToolTip}}">
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{LoanApplication.Branch}}</td>
								<td class="{{Text_Mute}}">{{LoanApplication.ID}}</td>
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{LoanApplication.LNCustomerID}}</td>
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{getCustomerName(LoanApplication.LNCustomerID)}}</td>
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{getCustomerName(LoanApplication.LNCustomerID,'Kh')}}</td> 
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{toMoney(float(LoanApplication.Amount),CurrencyObj(LoanApplication.Currency),2)}}</td>
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{LoanApplication.AppDate}}</td>
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{LoanApplication.InterestRate}}</td>
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{LoanApplication.Term}}</td>
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">{{getUserName(LoanApplication.PreparedBy)}}</td>
								<td onClick="{{LinkDetail}}" class="{{Class_Link}}">
									{%for row in Approval%}
										{{getUserName(row.Inputter)}}
										{%if not loop.last%}
										,&nbsp;
										{%endif%}
									{%endfor%}
								</td>
								<td class="{{Text_Mute}}">{{getRejected(LoanApplication.ID)}}</td>
								<td class="{{Text_Mute}}">{{getApproval(LoanApplication.ID)}}</td>
								<td class="{{Text_Mute}}">{{getNextReviewer(LoanApplication.ID)}}</td>
							</tr>
							{% endfor %}
						{% endif %}
						</tbody>
						<tfoot>
						</tfoot>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="col-sm-12">
<h5><strong><u>Note:</u></strong></h5>
	<table>		
		<tbody>
			<tr>
				<td colspan="2"><b>**</b> <span class='text-muted'>Example: LA......................</span> You need to switch to its branch in order to review/approve on this loan application.</td>
			</tr>
			
		</tbody>
	</table>
</div>

	<!-- End DataTable -->
	{% endblock %}

	{% block js %}
	<script type="text/javascript" src="{{ url_for('static', filename='javascripts/jquery.datatables.min.js') }}"></script>
	<script type="text/javascript">
		$(document).ready(function(){
			$('table.table').dataTable({
				"ordering": false
			});

			init.push(function () {
				$('#LoanApprovalRefresh').on("click",function(e){
					fn_fadeIn();
					window.location.reload(true);
				});
			});
		})
	</script>
	{% endblock %}