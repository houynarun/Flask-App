{% extends "layout.html" %}

{% block css %}
    
 {#    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheets/jquery.datatables.css') }}"> #}
    <style>

        h3.header-3{
            color: #888 !important;
            font-size: 16px;
            font-weight: bold;
            margin: 5px 0 10px;
            padding: 10px 18px 0;
        }

        h4.header-4{
            color: #888 !important;
            font-size: 14px;
            font-weight: normal;
            margin: 5px 0 10px;
            padding: 0px 18px 0;
        }

        .se-pre-con1 {
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: #FFF url("{{ url_for('static',filename='images/loading.gif') }}") center no-repeat;
            opacity: 0.4;
            display: none;
        }

        .form-label{
            padding-top: 7px;
        }
        .form-control
        {
            width: 100% !important;
        }
        #Main {
          width: 1px;
          min-width: 100%;
          *width: 100%;
        }
        .panel {
          width: 100%;
        }
    </style>

{% endblock %}

{% block content %}
<script src="{{ url_for('static',filename='javascripts/jquery.datatables.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/dataTables.tableTools.js') }}"></script>

<!-- <link rel=stylesheet type=text/css href="{{ url_for('static', filename='stylesheets/jquery.datatables.css') }}">
 -->
 <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.1/css/responsive.bootstrap.min.css">
 <link rel=stylesheet type=text/css href="{{ url_for('static', filename='stylesheets/dataTables.tableTools.css') }}">
 <script src="{{ url_for('static',filename='javascripts/dataTables.responsive.min.js') }}"></script>
 <div id="Main">
    <div class="navbar navbar-default navbar-static-top">
        <form method="GET" id="frm" name="frm" role="form" action="/Morakot/PenaltyWaive/">
            <div class="col-sm-12">

                    <div class="col-sm-6" style="margin-top: 8px;padding-left: 0;">
                        <div class="col-sm-6" style="padding-left: 0;">

                            {% from "print.html" import searchCustomer %}
                            {{searchCustomer('/Morakot/LoanID','ID',ID,'','Input Loan ID or Customer Name',AllowPutID='Y')}}
                        </div>

                        <div class="col-sm-3" style="margin-top:0px;">
                            <label >
                                <button type="submit" class="btn btn-flat btn-labeled btn-primary" style="padding: 7px 25px;">
                                    Show
                                </button>
                            </label>
                        </div>
                    </div>

                    {% if ListPD and PD %}
                        <div class="col-sm-6" style="margin-top: 8px;padding-right: 0;">
                            {#{% if float(PD.TotInterestDue) > 0 %}
                                <a href="javascript:void(0);" onclick="setNew('Waive Interest','',0,'','WI','{{ID}}','{{PD.TotInterestDue}}')") style="margin-left: 5px;" class="btn btn-flat btn-labeled btn-warning pull-right">
                                <span class="btn-label icon fa fa-dollar"></span>Waive All Interest</a>
                            
                            {% endif %}
                            {% if float(PD.TotPenaltyDue) > 0 %}
                                
                                <a href="javascript:void(0);" onclick="setNew('Penalty Collection','','{{PD.TotPenaltyDue}}','','C','{{ID}}')") style="margin-left: 5px;" class="btn btn-flat btn-labeled btn-info pull-right">
                                <span class="btn-label icon fa fa-dollar"></span>Collect All Penalty</a>
                                <a href="javascript:void(0);" onclick="setNew('Waive Penalty','','{{PD.TotPenaltyDue}}','','W','{{ID}}')") style="margin-left: 5px;" class="btn btn-flat btn-labeled btn-warning pull-right">
                                <span class="btn-label icon fa fa-dollar"></span>Waive All Penalty</a>
                            
                            {% endif %}#}
                            {#{% if Loan %}
                                {% if Loan.Penalty == 'N' %}
                                    <a href="/Morakot/PenaltyWaive/Prevent/?ID={{ ID }}" class="btn btn-flat btn-labeled btn-warning pull-right">
                                        <span class="btn-label icon fa fa-check"></span> Disabled Penalty
                                    </a>
                                {% else %}
                                    <a href="/Morakot/PenaltyWaive/Prevent/?ID={{ ID }}" class="btn btn-flat btn-labeled btn-success pull-right">
                                        <span class="btn-label icon fa fa-check"></span> Enabled Penalty
                                    </a>
                                {% endif %}
                            {% endif %}#}

                            <button  type="button" data-toggle="modal" data-target="#getCustomRange" class="btn btn-flat btn-labeled btn-success pull-right" >
                                <span class="btn-label icon fa fa-gear" ></span> Custom 
                            </button> 

                        </div>
                    {% endif %}

            </div>
        </form>
    </div>
{% if ListPD and PD %}
<!-- Modal Custom -->
<div class="modal fade" id="getCustomRange" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="form-horizontal">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">Custom</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="CheckUnCheck" class="col-sm-4 control-label">Operation: </label>
                        <div class="col-sm-6">
                            <select class="form-control select-sm select2" name="OperationAll" id="OperationAll" style="width: 100%">
                                {% if float(PD.TotPenaltyDue) > 0 %}
                                    <option value="C">Collect All Penalty</option>
                                    <option value="W">Waive All Penalty</option>
                                {% endif %}
                                {% if float(PD.TotInterestDue) > 0 %}
                                    <option value="WI">Waive All Interest</option>
                                {% endif %}
                            </select>
                        </div>
                        <!-- <div class="col-sm-2"></div> -->
                        <script>                            
                            $(document).ready(function(){
                                $("#OperationAll").select2();
                                $("#Apply").on('click', function(){
                                    var Operation = $("#OperationAll").val();
                                    if (Operation == "C"){
                                        CustomClickView('Penalty Collect','Penalty/New/?PDID=&Amount={{PD.TotPenaltyDue}}&DueDate=&Operation=C&LoanID={{ID}}&InterestAmount=0')
                                    }
                                    if (Operation == "W"){
                                        CustomClickView('Penalty Waive','Penalty/New/?PDID=&Amount={{PD.TotPenaltyDue}}&DueDate=&Operation=W&LoanID={{ID}}&InterestAmount=0')
                                    }
                                    if (Operation == "WI"){
                                        CustomClickView('Interest Waive','Penalty/New/?PDID=&Amount=0&DueDate=&Operation=WI&LoanID={{ID}}&InterestAmount={{PD.TotInterestDue}}')
                                    }
                                    $('.modal').modal('hide');
                                })
                            })
                        </script>
                    </div>

                </div>
                <div class="modal-footer">
                    <a href="javascript:void();" class="btn btn-primary" id="Apply">{{ getLanguage('Apply') }}</a>
                    <a href="javascript:void();" class="btn btn-default" data-dismiss="modal">{{ getLanguage('Cancel') }}</a>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- End Modal Custom -->
{% endif %}

    <div class="clearfix"></div>
    {% include 'msg_error.html' %}

    {% if ListPD and PD %}
        <div class="col-sm-12">
            <h3 class="header-3 text-center">Past Due - {{ PDID }}</h3>
            <h4 class="header-4 text-center">Total Over Due Amount: {{ toMoney(float(PD.TotODAmount), getCurrencyObj(PD.Currency)) }}</h4>
            <h4 class="header-4 text-center">Currency: {{ PD.Currency }}</h4>
        </div>

        <div class="col-sm-12">
            <div class="col-sm-6">
            <table>
                <tr>
                    <td width="150"><strong>Customer</strong></td>
                    <td>: &nbsp <a href='javascript:void(0)' onClick=CustomClickView('Customer','{{g_getUrlExtend(Module="Customer")}}?ID={{PD.Customer}}')>{{ PD.Customer }}</a></td>
                </tr>
                <tr>
                    <td><strong>Customer Name</strong></td>
                    <td>: &nbsp  {{ VLOOKUP(['MKT_CUSTOMER', 'ID', PD.Customer, 'LastNameEn']) }} {{ VLOOKUP(['MKT_CUSTOMER', 'ID', PD.Customer, 'FirstNameEn']) }} - {{ VLOOKUP(['MKT_CUSTOMER', 'ID', PD.Customer, 'LastNameKh']) }} {{ VLOOKUP(['MKT_CUSTOMER', 'ID', PD.Customer, 'FirstNameKh']) }}</td>
                </tr>
                <tr>
                    <td><strong>Account</strong></td>
                    <td>: &nbsp   <a href='javascript:void(0)' onClick=CustomClickView('Account&nbspStatement','AccountStatement/?ID={{ Loan.Account }}')>{{ Loan.Account }}</a> </td>
                </tr>
                <tr>
                    <td><strong>Loan ID</strong></td>
                    <td>: &nbsp  <a href='javascript:void(0)' onClick=CustomClickView('Loan-Centre','LoanCentre?ID={{ID}}')>{{ ID }}</a> </td>
                </tr>
                <tr>
                    <td><strong>Disbursed</strong></td>
                    <td>: &nbsp  {{ toMoney(float(Loan.Disbursed), getCurrencyObj(Loan.Currency)) }}</td>
                </tr> 
                <tr>
                    <td><strong>Loan Balance</strong></td>
                    <td>: &nbsp  {{ toMoney(float(Loan.Amount), getCurrencyObj(Loan.Currency)) }}</td>
                </tr>                 
                <tr>
                    <td><strong>Loan Outstanding</strong></td>
                    <td>: &nbsp  {{ toMoney(float(Loan.OutstandingAmount), getCurrencyObj(Loan.Currency)) }}</td>
                </tr>                
                <tr>
                    <td><strong>Currency</strong></td>
                    <td>: &nbsp  {{ PD.Currency }}</td>
                </tr>
                
                
            </table>
        </div>
        
        </div>

        <div class="clearfix">&nbsp;</div>

        <div class="panel panel-default">
            <div class="table-responsive">
            <table id="mktlist" class="display table table-striped" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th><b>Date</b></th>
                        <th><b>Day Due</b></th>
                        <th><b>Status</b></th>
                        <th class="text-right" style="padding-right: 35px;"><b>Amount</b></th>
                        <th class="text-right" style="padding-right: 35px;"><b>Out Amount</b></th>
                        <th class="text-right" style="padding-right: 35px;"><b>Principal</b></th>
                        <th class="text-right" style="padding-right: 35px;"><b>Interest</b></th>
                        <th class="text-right" style="padding-right: 35px;"><b>Penalty</b></th>
                        <th class="text-right" style="padding-right: 35px;"><b>Charge</b></th>
                        <th class="text-center">Action Penalty</th>
                        <th class="text-center">Action Interest</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in ListPD: %}
                        <tr>
                            <td>{{ row.DueDate }}</td>
                            <td>{{ row.NumDayDue }}</td>
                            <td>{{ row.ODStatus }}</td>
                            <td class="text-right" style="padding-right: 35px;">{{ formatNumber(row.TotODAmount,1,9) }}</td>
                            <td class="text-right" style="padding-right: 35px;">{{ formatNumber(row.OutAmount,1,9) }}</td>
                            <td class="text-right" style="padding-right: 35px;">{{ formatNumber(row.OutPriAmount,1,9) }}</td>

                            {#<td class="text-right" style="padding-right: 35px;">{{ toMoney(float(row.OutIntAmount), getCurrencyObj(PD.Currency)) }}</td>#}
                            <td class="text-right" style="padding-right: 35px;">{{ formatNumber(row.OutIntAmount,1,9) }}</td>

                            <td class="text-right" style="padding-right: 35px;">{{ formatNumber(row.OutPenAmount,1,9)}}</td>
                            <td class="text-right" style="padding-right: 35px;">{{ formatNumber(row.OutChgAmount,1,9)}}</td>
                            <td class="text-center">
                                {% if float(row.OutPenAmount) > 0 %}
                                    <a href="javascript:void(0);" onclick="CustomClickView('Penalty Collection','Penalty/New/?PDID={{row.PDID}}&Amount={{row.OutPenAmount}}&DueDate={{row.DueDate}}&Operation=C&LoanID={{ID}}&InterestAmount=0')") class="text-warning">Collect</a> /
                                    <a href="javascript:void(0);" onclick="CustomClickView('Penalty Waive','Penalty/New/?PDID={{row.PDID}}&Amount={{row.OutPenAmount}}&DueDate={{row.DueDate}}&Operation=W&LoanID={{ID}}&InterestAmount=0')") class="text-warning">Waive</a>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if float(row.OutIntAmount) > 0 %}
                                    <a href="javascript:void(0);" onclick="CustomClickView('Interest Waive','Penalty/New/?PDID={{row.PDID}}&Amount=0&DueDate={{row.DueDate}}&Operation=WI&LoanID={{ID}}&InterestAmount={{row.OutIntAmount}}')") class="text-warning">Waive</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfooter>
                    <tr class="text-bold">
                        <td><b>Total</b></td>
                        <td></td>
                        <td></td>

                        <td class="text-right" style="padding-right: 35px;">{{ formatNumber(ListPD |sum(attribute='TotODAmount'),1,9) }}</td>

                        <td class="text-right" style="padding-right: 35px;">{{ formatNumber(ListPD |sum(attribute='OutAmount'),1,9) }}</td>

                        <td class="text-right" style="padding-right: 35px;">{{ formatNumber(ListPD |sum(attribute='OutPriAmount'),1,9)}}</td>

                        <td class="text-right" style="padding-right: 35px;">{{ formatNumber(ListPD |sum(attribute='OutIntAmount'),1,9) }}</td>

                        <td class="text-right" style="padding-right: 35px;">{{ formatNumber(ListPD |sum(attribute='OutPenAmount'),1,9) }}</td>

                        <td class="text-right" style="padding-right: 35px;">{{ formatNumber(ListPD |sum(attribute='OutChgAmount'),1,9) }}</td>

                        <td></td>
                        <td></td>
                    </tr>
                </tfooter>

            </table>
            </div>
        </div>

        <div class="col-sm-12">
        <h5><strong><u>Note:</u></strong></h5>
            <table>     
                <tbody>
                    <tr>
                        <td colspan="2"><b>**</b> <span class="text-bold">Amount </span> is not rounded for purpose of able to waive all decimal place. Example: 18.282012210</td>
                    </tr>
                    
                </tbody>
            </table>
        </div>

    {% endif %}
</div>
{% endblock %}

{% block js %}

    {# <script src="{{ url_for('static',filename='javascripts/jquery.datatables.min.js') }}"></script> #}

    <script type="text/javascript">
        function setNew(Title,ID,Amount,DueDate,Operation,LoanID,InterestAmount=0) {
            Param = "?PDID="+ID+"&Amount="+Amount+"&DueDate="+DueDate+"&Operation="+Operation+"&LoanID="+LoanID+"&InterestAmount="+InterestAmount
            // you're in an iframe
            if ( self !== top ) {
                window.parent.addTab(Title+"-"+ID,"/Morakot/Penalty/New/"+Param);
            }else{
                window.parent.location.href="/Morakot/Penalty/New/"+Param
            }
        }
        $(document).ready(function() {

            $('#mktlist').dataTable({
                responsive: true,
            });


        });
    </script>



{% endblock %}