from datetime import datetime, date, timedelta
import time, logging, socket, pickle, os
from .constant import *
from app import app
from logger import *

#create binfile to keep license code
def writeBin(fileName,fileContent):
	try:
		output_file = open(app.config.get("CURRENT_PATH")+fileName+".mktbin","wb")
		pickle.dump(fileContent, output_file)
		output_file.close()
		print "File has been created successfully"
	except Exception, e:
		print "Cannot open file"
#open Binary file to read
def readBin(fileName):
	try:
		input_content = {}
		pathfile = app.config.get("CURRENT_PATH")+fileName+".mktbin"
		
		if os.path.exists(pathfile):
			# print 'License file found.'
			input_file = open(pathfile,"rb")
			input_content = pickle.load(input_file)
			input_file.close()
			# print input_file
		else:
			logging.critical(msg_license_not_found)
		return input_content
	except Exception, e:
		logging.critical(msg_license_not_found)

#encode license code
def enLicense(computerName,nUser,expDate,isNew=True):

	nJulien = juLienDate (expDate)
	reSult = (int(nJulien)/7 *10 + int(nJulien) % 7 ) * 3 + int(nUser) + conAscii(computerName)
	#create file and write the content
	file_content = {"id":hash('M'+str(reSult)), "computerName":computerName,"nUser":nUser,"expDate":expDate}
	if isNew:
		writeBin(computerName,file_content)
	return file_content


#decode license code
def deLicense():
	
	input_file = readBin(socket.gethostname())
	
	if input_file:
		enCode = enLicense (socket.gethostname(),input_file.get('nUser'),input_file.get('expDate'),False)
	else:
		return False

	if enCode == input_file :
		return True
	else :
		return False

#convert Ascii
def conAscii(strName):
	getNum = 0
	for c in strName :
		getNum = getNum + int(ord(c))
	return getNum *5


#return julien date 
def juLienDate(enddate):
	getJulien 	=	""
	date_format =	"%Y-%m-%d"
	startdate 	=	datetime.strptime(enddate,date_format)
	getJulien 	=	startdate.timetuple().tm_yday
	return getJulien

#Apply license code
def applyLicense(fileContent):
	try:
		File = app.config.get("CURRENT_PATH")+socket.gethostname()+".mktbin"
		ObjFile = open(File,'w+')
		ObjFile.truncate()
		ObjFile.write(fileContent)
		ObjFile.close()
		return True
	except Exception as e:
		logger.critical(e)
		raise e

#Check file license
def isFileLicense(filename):
	#if allow funtion return True
	return '.' in filename and filename.rsplit('.', 1)[1] in set(['mktbin'])