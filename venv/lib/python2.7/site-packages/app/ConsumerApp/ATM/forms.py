from app.mktcore.wtfimports import *
from .models 				import *
import app.tools.mktaddress as mktaddress
from app.Province.models	import *
from app.District.models	import *
from app.Commune.models		import *
from app.Village.models		import *

#function
def getRecord():
	try:
		result = MKT_ATM_INAU.query.filter_by(ID=g.formID).all()
		if not result:
			result = MKT_ATM.query.filter_by(ID=g.formID).all()
		elif not result:
			result = MKT_ATM_HIST.query.filter_by(ID=g.formID).all()
		Dict={}
		if result:
			for row in result:
				Dict.update({'Province'			:str(row.Province)})
				Dict.update({'District'			:str(row.District)})
				Dict.update({'Commune'			:str(row.Commune)})
				Dict.update({'Village'			:str(row.Village)})
			return Dict
		else:
			return Dict

	except Exception as e:
		return jsonify(message={'message':[str(e)]}),500

def loadProvince():
	return mktaddress.getProvince()

def loadDistrict():
	if request.method == 'POST':
		Province = request.form["Province"]
	else:
		if len(getRecord())>0:
			Record = getRecord()
			return MKT_DISTRICT.query.filter_by(ID=Record['District'])  
		else:
			return MKT_DISTRICT.query.filter_by(ID='').all()

	return mktaddress.getLoadDistrict(Province)

def loadCommune():
	if request.method == 'POST':
		District=request.form["District"]
	else:
		if len(getRecord())>0:
			Record = getRecord()
			return MKT_COMMUNE.query.filter_by(ID=Record['Commune'])  
		else:
			return MKT_COMMUNE.query.filter_by(ID='').all()

	return mktaddress.getLoadCommune(District)

def loadVillage():
	if request.method == 'POST':
		Commune=request.form["Commune"]
	else:
		if len(getRecord())>0:
			Record = getRecord()
			return MKT_VILLAGE.query.filter_by(ID=Record['Village'])  
		else:
			return MKT_VILLAGE.query.filter_by(ID='').all()

	return mktaddress.getLoadVillage(Commune)

class FRM_ATM(exform):
	Description 	= 	TextField(requiredlabel(getLanguage("Description"), "*"), [validators.Required()])
	Location 		= 	LocationField("Location (late,long)")
	Province 		= 	QuerySelectField(requiredlabel(getLanguage('Province'),'*'),query_factory=loadProvince, 
							 get_label='Description',
							 allow_blank=True,
							 blank_text=u'--Choose Province--',
							 )
	District 		= 	QuerySelectField(requiredlabel(getLanguage('District'),'*'),query_factory=loadDistrict, 
							 get_label='Description',
							 allow_blank=True,
							 blank_text=u'--Choose District--',
							 )
	Commune 		=	QuerySelectField(requiredlabel(getLanguage('Commune'),'*'),query_factory=loadCommune, 
							 get_label='Description',
							 allow_blank=True,
							 blank_text=u'--Choose Commune--',
							 )
	Village 		=	QuerySelectField(getLanguage('Village'),query_factory=loadVillage, 
							 get_label='Description',
							 allow_blank=True,
							 blank_text=u'--Choose Village--')

	@staticmethod
	def hotSelectField():
		hotfield=[]

		fielddisplay="District,#Commune,#Village"
		varname="ProvinceID:$('#Province').val()"
		fun=["Province", varname ,fielddisplay, "/Morakot/DistrictID", "click"]
		hotfield.append(fun)

		fielddisplay="Commune,#Village"
		varname="DistrictID:$('#District').val()"
		fun=["District", varname ,fielddisplay, "/Morakot/CommuneID", "click"]
		hotfield.append(fun)

		fielddisplay="Village"
		varname="CommuneID:$('#Commune').val()"
		fun=["Commune", varname ,fielddisplay, "/Morakot/VillageID", "click"]
		hotfield.append(fun)

		return hotfield