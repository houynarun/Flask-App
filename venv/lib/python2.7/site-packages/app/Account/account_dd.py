from wtforms 							import DecimalField, IntegerField
from app.mktcore.wtfimports 			import *
from .models 							import *
from .. 								import app, db
from sqlalchemy 						import *
from datetime 							import datetime, date, timedelta
from decimal 							import *
import time
import string

from app.CategoryType.models 			import MKT_CATEG_TYPE
from app.AccProduct.models 				import MKT_ACC_PRODUCT
from app.Currency.models 				import MKT_CURRENCY
from app.JAccount.models 				import MKT_JACCOUNT
from app.InterestRate.models 			import MKT_INTEREST_RATE
from app.ChargeRate.models 				import MKT_CHARGE_RATE
from app.AccRuleDetail.models 			import MKT_ACC_RULE_DE
from app.User.models 					import MKT_USER
from app.Tax.models 					import MKT_TAX
from app.AccEntry.models 				import MKT_ACC_ENTRY

from app.tools.mktcustomer 				import *
from app.tools.catetool 				import *
from app.tools.mktmoney 				import *
from app.tools.user 					import *
from app.tools.mktofficer 				import *
from app.tools.mktroute 				import *
import app.tools.mktaccounting 			as mktaccounting
import app.tools.mktdate 				as mktdate
import app.tools.mktaccount 			as mktaccount
import app.tools.mktteller 				as mktteller
import app.tools.mktsetting 			as mktsetting

def loadCategoryType():
	return MKT_CATEG_TYPE.query

def loadParent():
	return MKT_CATEGORY.query

def loadAccProduct():
	return MKT_ACC_PRODUCT.query.filter_by(ProductType = 'E').all()

def loadCurrency(Default = False):
	AccSetting 	= mktsetting.getAccSetting() #Get Acccounting Setting
	Currency 	= AccSetting.BaseCurrency

	if Default:
		return MKT_CURRENCY.query.get(Currency)
	else:
		return MKT_CURRENCY.query.order_by(asc(MKT_CURRENCY.ID)).all()

def loadJAccount():
	return MKT_JACCOUNT.query

def getAccountProductSetup():
	return MKT_ACC_PRODUCT.query.get('101')

def loadAccCategory():
	try:

		AccRecord 	= 	getAccountProductSetup()
		Category 	=	""
		if AccRecord:
			Category 	=	AccRecord.CategoryList

		return Category

	except:
		raise

def loadInterestRate():
	try:

		AccRecord 		= 	getAccountProductSetup()
		Rate 			=	"0"

		if AccRecord:
			# InterestKey = 	AccRecord.InterestKey
			InterestKey	= 	AccRecord.InterestKey
			RateID		= 	str(InterestKey) + 'KHR'
			AccRate 	= 	MKT_INTEREST_RATE.query.get(RateID)
			if AccRate:
				Rate 	= 	AccRate.Rate
				Rate 	=	Rate.split()
				if len(Rate) > 0:
					Rate 	= 	Rate[0]
				else:
					Rate 	=	'0'

		return str(Rate)

	except:
		raise

def loadInterestRateType():
	try:

		AccRecord 	= 	getAccountProductSetup()
		FixedRate 	=	"F"
		if AccRecord:
			Charge 	= 	AccRecord.Charge
			ID 		=	str(Charge) + "KHR"
			AccCha 	=  	MKT_CHARGE_RATE.query.get(ID)
			if AccCha:
				FixedRate = str(AccCha.Rate)

		return FixedRate

	except:
		raise

def loadAccCharge():
	try:

		AccRecord 	= 	getAccountProductSetup()
		ChargeRate 	=	"0"
		if AccRecord:
			Charge 	= 	AccRecord.Charge
			ID 		=	str(Charge) + "KHR"
			AccCha 	=  	MKT_CHARGE_RATE.query.get(ID)
			if AccCha:
				ChargeRate = str(AccCha.Value)

		return ChargeRate

	except:
		raise

def loadTax():
	AccRecord 	= 	getAccountProductSetup()
	Tax 		=	""
	if AccRecord:
		Tax 	= 	AccRecord.Tax

	return Tax

def loadCurrentDate():
	return mktdate.getBankDate()

def loadDefaultCurrency():
	return mktaccounting.getDefaultCurrency()

class FRM_ACCOUNT_DD(exform):

	CustomerList 	= 	RemoteTextField(requiredlabel(getLanguage('Customer'), "*"), [validators.Required()])
	AccName 		= 	TextField(requiredlabel(getLanguage("Account Name"), "*"), [validators.Required()])
	Currency 		= 	QuerySelectField(requiredlabel(getLanguage("Currency"), "*"),
							query_factory=loadCurrency,
							get_label=u'ID',
							default=lambda:loadCurrency(Default=True),
							validators=[validators.Required()]
						)

	JAccount 		=	TextField(getLanguage("Join Account"))
	JoinID 			=	TextField(getLanguage("Join ID"))
	AccProduct 		=	TextField(getLanguage("Account Product"), default='101')
	AccCategory 	=	TextField(getLanguage("Category"), default=loadAccCategory)
	InterestRate 	=	TextField(getLanguage("Interest Rate"), default=loadInterestRate)
	FixedRate 		=	TextField(getLanguage("Fixed/Rate"), default=loadInterestRateType)
	Charge 			=	TextField(getLanguage("Charge"), default=loadAccCharge)
	Tax 			=	TextField(getLanguage("Tax"), default=loadTax)

	OpenDate 		= 	DateField(requiredlabel(getLanguage("Opening Date"), "*"), [validators.Required()], default=loadCurrentDate)

	AccStatus 		= 	SelectField(getLanguage('Status'),
							choices=[('O', 'Open'),
									 ('C', 'Close')],
							coerce=str
						)
	Background		= 	TextField("Background", default='Gradient-Secondary.png')
	ClosingDate 	= 	DateField(getLanguage("Closing Date"), [validators.Optional()])

	OfficerID 		=	TextField(getLanguage("Officer"), default="")

	AccrInterest 	= 	DecimalField(getLanguage("Accrual Interest"), [validators.Optional()], default=0)
	AccrCurMonth 	= 	DecimalField(getLanguage("Accr Int for Booking"), [validators.Optional()], default=0)
	AccrCurCapital 	= 	DecimalField(getLanguage("Accr Int for Capitalization"), [validators.Optional()], default=0)
	AccrIntBooked 	=	DecimalField(getLanguage("Accr Int was Booked"), [validators.Optional()], default=0)

	Balance 		= 	DecimalField(getLanguage("Balance"), [validators.Optional()], default=0)
	AvailableBal 	= 	DecimalField(getLanguage("Available Balance"), [validators.Optional()], default=0)
	UserID 			= 	RemoteTextField(getLanguage("User"))
	

	def validate_Charge(form, field):
		Value = form.Charge.data
		if str(Value).find("%") != -1:
			Value = Value.split("%")[0]

		try:
			Value = Decimal(Value)
		except Exception as exe:
			raise ValidationError("The chare you have enter is wrong number value")

		form.Charge.data = Value

	def validate_AccStatus(form, field):
		try:

			AccountBalance 	= request.form['Balance']
			AccountStatus  	= request.form['AccStatus']
			Currency 		= request.form['Currency']
			CurrencyObj 	= mktmoney.getCurrencyObj(Currency)
			if AccountStatus.upper() == "C":
				if AccountBalance > 0 :
					AccountBalance = float(AccountBalance) if AccountBalance else float(0)
					if AccountBalance != float(0):
						raise ValidationError("Account balance must be zero for closing account. Current balance is %s" % mktmoney.formatNumber(AccountBalance,DecimalPlace=CurrencyObj.DecimalPlace))
		except:
			raise


	def validate_ClosingDate(form, field):

		AccountClosingDate 	= request.form['ClosingDate']
		AccountStatus  		= request.form['AccStatus']

		if AccountStatus.upper() == "C":
			try:
				datetime.strptime(str(AccountClosingDate),'%Y-%m-%d')
			except:
				raise ValidationError("This field must be in date format.")

	@staticmethod
	def moneyField():
		return [("Balance", "Currency"), ("Charge", "Currency"), ("AvailableBal", "Currency"), ("AccrInterest", "Currency"), ("AccrCurMonth", "Currency"), ("AccrCurCapital", "Currency"), ("AccrIntBooked", "Currency")]

	@staticmethod
	def formatMoney():
		return ["Balance", "AvailableBal", "AccrInterest", "AccrCurCapital", "AccrCurMonth", "AccrIntBooked"], "Currency"

	@staticmethod
	def setWidth():

		Fields = [('Currency', len1),
				  ('JAccount', len1),
				  ('JoinID', len2),
				  ('AccCategory', len2),
				  ('FixedRate', len1),
				  ('OpenDate', len3),
				  ('AccStatus', len1),
				  ('ClosingDate', len3),
				  ('Blocked', len1),
				  ('Normant', len1)]

		return Fields

	@staticmethod
	def setVisible():		
		control_list = ['JAccount', 'JoinID', 'AccProduct', 'AccCategory', 'Tax',
						'InterestRate', 'FixedRate', 'Charge', 'AccrInterest',
						'AccrCurMonth', 'AccrCurCapital', 'Balance', 'AvailableBal', 'UserID',
						'OfficerID', 'AccrIntBooked', 'Background']
		return control_list

	@staticmethod
	def listField():

		Fields = ["ID", "CustomerList", "AccName", "Currency", "AccCategory",
				  "OpenDate","AccStatus" ,"ClosingDate","Balance", "AvailableBal"]
		# return Fields
		return Fields, ["ID*LK*DD"]

	@staticmethod
	def hotField():
		hotfield = []

		fielddisplay 	= "$('#InterestRate').val(data.InterestKey); $('#Charge').val(data.ChargeRate); $('#FixedRate').val(data.FixedRate)"
		varname 		= "AccProductID:$('#AccProduct').val(), Currency:$('#Currency').val()"
		fun 			= ["Currency", varname, fielddisplay, "/Morakot/AccProductID", "change"]
		hotfield.append(fun)

		fielddisplay 	= 	"$('#ClosingDate').val(data.ClosingDate)"
		varname			=	"AccStatus:$('#AccStatus').val()"
		fun 			=	["AccStatus", varname, fielddisplay, "/Morakot/AccountClosingDate", "change"]
		hotfield.append(fun)

		fielddisplay 	= 	"$('#AccName').val(data.CustomerName)"
		varname			=	"CustomerList:$('#CustomerList').val()"
		fun 			=	["CustomerList", varname, fielddisplay, "/Morakot/CustomerNameBySelected", "change"]
		hotfield.append(fun)

		fielddisplay = "$('input[name=JoinID]').attr('readonly', data.Bool)"
		varname = "JAccountID:$('#JAccount').val()"
		fun = ["JAccount", varname, fielddisplay, "/Morakot/JoinID", "change"]
		hotfield.append(fun)

		return hotfield

	@staticmethod
	def setDisable():
		return [('AccCategory'), ('FixedRate'), ('AccrInterest'), ('Balance'),
				('NextAccrDate'), ('Branch'), ('UserID'), ("AvailableBal"), ("AccrCurMonth"), ("AccrCurCapital")]
	
	@staticmethod
	def setDisableforEdit():
		return [("Currency")]

	@staticmethod
	def reverseRec():
		ID = g.formID
		AllowReverse = mktaccount.isAllowReverseAccount(ID)
		if AllowReverse[0]:
			return True,''
		else:
			# Record not allow to reverse. 
			return True, AllowReverse[1]


	@staticmethod
	def IsAcceptOverride():

		Override 	= False
		Branch 		= mktuser.getCurrentBranch()
		Msg 		= ""
		ID 			= request.form['ID']
		AccStatus 	= request.form['AccStatus']
		Customer 	= request.form["CustomerList"]
		CustomerObj = MKT_CUSTOMER.query.get(Customer)
		
		if CustomerObj.Branch != Branch:
			Override 	= True
			Msg 		= "Customer <a href='javascript:void(0)' onClick=CustomClickView('Customer','Customer/?ID=%s')><u>%s</u></a> is from different Branch <b>%s</b>. " %(Customer, Customer, CustomerObj.Branch)
		
		if AccStatus == 'C':
			Override 	= True
			Msg 		= "You will be close this account %s." %ID

		Msg += " Do you want to procceed?"

		return Override, Msg

	@staticmethod
	def IsAcceptOverrideINAU():
		Override 		= False
		ID 				= g.formID
		Branch 			= mktuser.getCurrentBranch()
		Msg 			= ""
		AccountnObj		= MKT_ACCOUNT_INAU.query.get(ID)
		Customer 		= AccountnObj.CustomerList
		CustomerObj 	= MKT_CUSTOMER.query.get(Customer)

		AccStatus 		= AccountnObj.AccStatus
		if CustomerObj.Branch != Branch:
			Override 	= True
			Msg 		= "Customer <a href='javascript:void(0)' onClick=CustomClickView('Customer','Customer/?ID=%s')><u>%s</u></a> is from different Branch <b>%s</b>. " %(Customer, Customer, CustomerObj.Branch)

		if AccStatus == 'C':
			Override 	= True
			Msg 		= "You will be close this account %s." %ID

		Msg 		+= "Do you want to procceed?"

		return Override, Msg