# -*- coding: utf-8 -*-
'''
Report Name: 	MONTHLY REPORT OF UNIFORM COA
				
URL 		: 	/Morakot/Report/NBC/N04
'''
from app.mktcore.imports 		import *
import app.tools.mktnbc			as mktnbc
from app.GLBalance.models         import MKT_GL_BALANCE, MKT_GL_BALANCE_BACKUP
from app.Currency.models        import MKT_CURRENCY

import app.tools.mktdate         as mktdate
import app.tools.mktsetting     as mktsetting
import app.tools.mktmoney         as mktmoney
import app.tools.mktnbc            as mktnbc
import app.tools.mktgl             as mktgl
import app.tools.mktmessage     as mktmessage
from decimal                     import Decimal
from app.NBCReport.models 		import *
import app.NBCReport.V2.BANK.BankSetting  as NBCBankSetting



def getGLValueForField(Branch = "ALL", Period = 2,NBCBank04Key='', NBCExchangeRateDict={},**Kargs):
	return NBCBankSetting.getGLValueFromField(Branch, Period, "NBCBankN04",NBCBank04Key, NBCExchangeRateDict,**Kargs)

def getBANK01(Branch="ALL", ReportedDate="",Period=2,Month = "", Year = ""):
	try:
		Data 			= []
		Excel 			= {}
		ReportHeader 	= {}
		ReportHeader 	= mktnbc.getHeaderReport(	ReportName 		=	u'MONTHLY REPORT OF UNIFORM COA',
													Title 			=	u'របាយការណ៏ប្រចាំខែសី្តពី ប្លង់គណនីឯកភាព',
													Form 			=	'U.COA'
													)
		ID = 'N004'
		Result 			=	mktnbc.getNBCLineReport(ID, int(Period), Branch, ReportedDate, Year=Year, Month=Month)
		Data1 			= 	Result[0].get("Data",[])
		Result1 			=	mktnbc.getNBCLineReport(ID, 5, Branch, ReportedDate, Year=Year, Month=Month)
		Data2 			= 	Result1[0].get("Data",[])
		RecordRow 	= []
		ReportingRate = ReportHeader.get('ReportingRate',0)
		Excel.update({
				"B4" : ((ReportHeader.get('CompanyName',"")).splitlines())[0],
				"A4" : u'កាលបរិច្ឆេទ/As Of: %s'%(NBCBankSetting.formatDateNBC(ReportHeader.get('ReportedDate',""))),
				"F5" : u'%s%s'%(ReportingRate,''),
			})
		CurrencyList 	=		[' ','KHR','USD','EUR','JPY','Other']
		Condition 	= []
		if Year and Month:
			GLTable       = MKT_GL_BALANCE_BACKUP
			Condition     = [GLTable.GLYear == Year,GLTable.GLMonth == Month]
			CYear         = Year
			CMonth        = Month
		else:
			GLTable       = MKT_GL_BALANCE
			BankDate      = mktdate.getBankDate()
			CYear         = BankDate.year
			CMonth        = BankDate.month
		GLObj             = GLTable.query.filter(*Condition)
		Kargs             = {'GLTable':GLTable, 'GLObj':GLObj, 'FCY':True}
		CurrencyDic       =   mktnbc.getNBCExchangeRate(CYear, CMonth)
		CellRow 		  = 11

		TableHeader 	= {}
		TableHeader 	= mktnbc.setTableHeader(Text=u'NATIONAL BANK OF CAMBODIA', 
											Rowspan=0,Colspan=7,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'', 
											Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		#----------------------------------------------------------------------------------------------------------------#
		TableHeader 	= mktnbc.setTableHeader(Text=u'', 
											Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'', 
											Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		#----------------------------------------------------------------------------------------------------------------#
		TableHeader 	= mktnbc.setTableHeader(Text=u'', 
											Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'', 
											Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'Amount', 
											Rowspan=0,Colspan=2,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader 	= mktnbc.setTableHeader(Text=u'L1', 
											Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'L2', 
											Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		#----------------------------------------------------------------------------------------------------------------#
		TableHeader 	= mktnbc.setTableHeader(Text=u'L3', 
											Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'L4', 
											Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'ACCOUNT DESCRIPTION', 
											Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		#----------------------------------------------------------------------------------------------------------------#
		TableHeader 	= mktnbc.setTableHeader(Text=u'USD', 
											Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'KHR', 
											Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		# Result.update({'TableHeader':TableHeader,'ReportHeader':ReportHeader,'Data':Data, 'Excel': Excel})
		RowNumber = 10 
		Data  = Data1 + Data2
		for item in Data:
			row = dict(item)
			Description = row.get("Description","")
			AmountInDollars = row.get("AmountInDollars",0)
			AmountInRiels 	= row.get("AmountInRiels",0)
			LineType 	= row.get("LineType",'LD')
			Indent		= row.get("Indent",0)
			RowBGColor 	= row.get("RowBGColor","")
			LineFormat  = row.get("LineFormat","")
			LineNumber 	= int(row.get("LineNumber",""))
			if LineNumber >= 221 and LineNumber <= 10058:
				RecordRow.append({
							1:"",
							2:"",
							3:"",
							4:"",
							5:Description,
							6:"" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else mktmoney.formatNumber(AmountInDollars, 1, 2),
							7:"" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else mktmoney.formatNumber(AmountInRiels, 1, 2),
							'LineType':LineType,
							'Indent':Indent,
							'RowBGColor':RowBGColor,
							'LineFormat':'LineFormat'
						})
				if LineType == 'LD' and LineNumber != 7465 and LineNumber != 3092 and LineNumber != 9981:
					Excel.update({
									"F%s"%(RowNumber) : "" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else AmountInDollars,
									"G%s"%(RowNumber) : "" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else AmountInRiels,
								})
					RowNumber += 1
				if LineNumber == 3092:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber += 1
				if LineNumber == 9981:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber += 1
				if LineNumber == 7465:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber += 3 
				if LineType == 'ST':
					RowNumber += 1
			if LineNumber >= 15338 and LineNumber <=15789:
				RecordRow.append({
							1:"",
							2:"",
							3:"",
							4:"",
							5:Description,
							6:"" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else mktmoney.formatNumber(AmountInDollars, 1, 2),
							7:"" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else mktmoney.formatNumber(AmountInRiels, 1, 2),
							'LineType':LineType,
							'Indent':Indent,
							'RowBGColor':RowBGColor,
							'LineFormat':'LineFormat'
						})
				if LineType == 'LD':
					Excel.update({
									"F%s"%(RowNumber) : "" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else AmountInDollars,
									"G%s"%(RowNumber) : "" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else AmountInRiels,
								})
					RowNumber += 1
				if LineNumber == 15568:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber += 1
				elif LineType == 'ST':
					RowNumber += 1
			if LineNumber >= 10059 and LineNumber <= 15337:
				RecordRow.append({
							1:"",
							2:"",
							3:"",
							4:"",
							5:Description,
							6:"" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else mktmoney.formatNumber(AmountInDollars, 1, 2),
							7:"" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else mktmoney.formatNumber(AmountInRiels, 1, 2),
							'LineType':LineType,
							'Indent':Indent,
							'RowBGColor':RowBGColor,
							'LineFormat':'LineFormat'
						})
				if LineType == 'LD' and LineNumber != 10060:
					Excel.update({
									"F%s"%(RowNumber) : "" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else AmountInDollars,
									"G%s"%(RowNumber) : "" if Description == 'ACCOUNT DESCRIPTION' or Description == 'Contra Account' or Description == 'Derivative Instruments' else AmountInRiels,
								})
					RowNumber += 1
				if LineNumber == 10060:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber += 2
				if LineNumber == 13100:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber += 2
				if LineNumber == 13529:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber += 1
				if LineNumber == 15336:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber -= 1
				if LineNumber == 15337:
					Excel.update({
								"F%s"%(RowNumber) : " ",
								"G%s"%(RowNumber) : " ",
							})
					RowNumber += 1
				if LineType == 'ST':
					RowNumber += 1
			if RowNumber > 15578:
				break
		Result = {'ReportHeader': ReportHeader, 'TableHeader': TableHeader, 'Data':RecordRow, 'Excel':Excel}
		CellStyle = {
			'A7':'top*medium,FF000000:bottom*medium,FF000000',
			'B7':'top*medium,FF000000:bottom*medium,FF000000',
			'C7':'top*medium,FF000000:bottom*medium,FF000000',
			'D7':'top*medium,FF000000:bottom*medium,FF000000',
			'E7':'top*medium,FF000000:right*medium,FF000000:bottom*medium,FF000000',
			'A8':'right*medium,FF000000',
			'B8':'right*medium,FF000000',
			'C8':'right*medium,FF000000',
			'D8':'right*medium,FF000000',
			'E8':'right*medium,FF000000',
			'F8':'top*medium,FF000000:bottom*medium,FF000000',
			'G8':'top*medium,FF000000:right*medium,FF000000:bottom*medium,FF000000',
			'A9':'top*medium,FF000000:bottom*medium,FF000000:right*medium,FF000000',
			'B9':'top*medium,FF000000:bottom*medium,FF000000:right*medium,FF000000',
			'C9':'top*medium,FF000000:bottom*medium,FF000000:right*medium,FF000000',
			'D9':'top*medium,FF000000:bottom*medium,FF000000:right*medium,FF000000',
			'E9':'top*medium,FF000000:bottom*medium,FF000000:right*medium,FF000000',
			'F9':'bottom*medium,FF000000:right*medium,FF000000',
			'G9':'bottom*medium,FF000000:right*medium,FF000000',
		}
		return Result,CellStyle
	except Exception, e:
		raise

