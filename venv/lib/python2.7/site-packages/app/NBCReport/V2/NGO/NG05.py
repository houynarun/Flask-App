# -*- coding: utf-8 -*-
'''
Report Name: Credit By Type
'''

from app.mktcore.imports 		import *

import app.tools.mktsetting     as mktsetting
import app.tools.mktmoney       as mktmoney
import app.tools.mktnbc         as mktnbc

from app.Customer.models 		import MKT_CUSTOMER
from app.Currency.models 		import MKT_CURRENCY
from app.LoanContract.models 	import MKT_LOAN_CONTRACT
from decimal import Decimal


def getNGO05(Branch = "ALL", ReportedDate = ""):
	''' This function must return result like below:
		Result = {
			'Data': 		Data,
			'Excel': 		Excel,
			'ReportHeader': ReportHeader,
			'TableHeader': 	TableHeader
			}
	'''
	try:
		TableHeader     = {}
		RowRecord 		= []
		ExcelRecord 	= {}

		ReportHeader 	= mktnbc.getHeaderReport(	ReportName 		=	u'របាយការណ៍ប្រចាំត្រីមាសស្តីពី ឥណទានចំណាត់ថ្នាក់តាមប្រភេទរូបិយប័ណ្ណ',
													Title 			=	'',
													Form 			=	'5-Credit by Currencies')

		ExcelRecord.update({
			"B2" : ReportHeader.get('ReportedDate',""),
			"B4" : ReportHeader.get('CompanyName',""),
			"D6" : Decimal(ReportHeader.get('ReportingRate',0))
			})

		TableHeader = mktnbc.setTableHeader(Text=u'ប្រភេទរូបិយប័ណ្ណ', 
											Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader )

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនឥណទាន', 
											Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader )

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនទឹកប្រាក់តាមប្រភេទរូបិយប័ណ្ណ', 
											Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader )

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនទឹកប្រាក់ គិតជារៀល', 
											Rowspan=0,Colspan=0,RowIndex=1, TableHeader=TableHeader )

		TableHeader = mktnbc.setTableHeader(Text=u'អត្រាការប្រាក់ដែលយក (ប្រចាំខែ, ឆ្នាំ ឬផ្សេងទៀត)', 
											Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader )

		TableHeader = mktnbc.setTableHeader(Text=u'កំណត់សំគាល់', 
											Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader )
				
		TableHeader = mktnbc.setTableHeader(Text=u'1', 
											Rowspan=2,Colspan=0,RowIndex=2, TableHeader=TableHeader )

		TableHeader = mktnbc.setTableHeader(Text=u'2 = 1 / អត្រាប្តូរប្រាក់', 
											Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader )

		CurrencyDesc    =   {'KHR':u'១. ប្រាក់រៀល',
									'USD':u'២. ប្រាក់ដុល្លារអាមេរិក',
									'THB':u'៣. ប្រាក់បាតថៃ',
									}
		RecordObj       =   db.session.query(
								MKT_CURRENCY.ID,
								func.count(MKT_CURRENCY.ID).label('NumberOfLoan'),
								func.sum(MKT_LOAN_CONTRACT.OutstandingAmount).label('OutstandingAmount'),
							).\
							outerjoin(
								MKT_LOAN_CONTRACT,
								MKT_LOAN_CONTRACT.Currency == MKT_CURRENCY.ID
							).\
							outerjoin(
								MKT_CUSTOMER, 
								MKT_CUSTOMER.ID == MKT_LOAN_CONTRACT.ContractCustomerID
							).\
							filter(MKT_LOAN_CONTRACT.DisbursedStat == 'Y').\
							filter(MKT_LOAN_CONTRACT.OutstandingAmount > 0).\
							group_by(MKT_CURRENCY.ID).\
							order_by(MKT_CURRENCY.ID.asc())

		if Branch != "ALL":
			Branch      =   Branch.split()
			RecordObj   =   RecordObj.\
							filter(MKT_LOAN_CONTRACT.Branch.in_(Branch))

		DataDict        =   {}

		if RecordObj:
			for item in RecordObj:
				KeyGroupBy = '%s'%(item.ID)
				DataDict.update({KeyGroupBy: {
				'OutstandingAmount': item.OutstandingAmount,
				'NumberOfLoan': item.NumberOfLoan
				}}) 
      
		CurrencyDic     =   ReportHeader['DicExchangeRate']


		TotalAmountInRiel 	=   0
		TotalNumberOfLoan 	=   0
		CellRow 			=	9
		for item in CurrencyDesc:

		
			DictResult 		= DataDict.get(item,{})
			ExchageRate     =   Decimal(CurrencyDic.get(item,1))
			"""
			    Resident
			"""
			# Block Resident 
			OutstandingAmount     =   DictResult.get('OutstandingAmount',0)

			AmountInRiel    =   OutstandingAmount * ExchageRate / 1000000

			NumberOfLoan    =   DictResult.get('NumberOfLoan',0)
			# Total
			TotalNumberOfLoan	+=  NumberOfLoan
			TotalAmountInRiel   +=  AmountInRiel


			RowRecord.append({
					1:u'%s'%CurrencyDesc.get(item,''),
					2:u'%s' %(mktmoney.formatNumber(float(NumberOfLoan), 1, 0)),
					3:u'%s' %(mktmoney.formatNumber(float(OutstandingAmount), 1, 2)),
					4:u'%s' %(mktmoney.formatNumber(float(AmountInRiel), 1, 2)),
					5:u'',
					6:u'',
			    })
			ExcelRecord.update({
					"B%s"%(CellRow) : NumberOfLoan,
					"C%s"%(CellRow) : OutstandingAmount,
					"D%s"%(CellRow)	: AmountInRiel,
					"E%s"%(CellRow) : "",
					"F%s"%(CellRow) : ""
				})
			CellRow += 1

		RowRecord.append({
					1:u"៤. រូបិយវត្ថុផ្សេងទៀត",
					2:u'0',
					3:u'0.0',
					4:u'0.0',
					5:u'',
					6:u'',
		})
		ExcelRecord.update({
				"B%s"%(CellRow) : 0,
				"C%s"%(CellRow) : 0,
				"E%s"%(CellRow) : "",
				"F%s"%(CellRow) : ""
			})

		RowRecord.append({
					1:u"TOTAL LOANS",
					2:u'%s' %(mktmoney.formatNumber(float(TotalNumberOfLoan), 1, 0)),
					3:u'-',
					4:u'%s' %(mktmoney.formatNumber(float(TotalAmountInRiel), 1, 2)),
					5:u'',
					6:u'',
					'LineType':'GH',
					'Indent':0,
					'RowBGColor':mktnbc.BG_HEADER_COLOR,
					'LineFormat':'bold'
		})
		Result 	=	{'Data':RowRecord, 'ReportHeader':ReportHeader,'TableHeader':TableHeader, 'Excel': ExcelRecord}
		return Result

	except Exception, e:
		raise
	else:
		pass
	finally:
		pass