# -*- coding: utf-8 -*-
'''
Report Name: Large Exposure
'''

from app.mktcore.imports 		import *

import app.tools.mktsetting     as mktsetting
import app.tools.mktmoney       as mktmoney
import app.tools.mktnbc         as mktnbc
import app.tools.mktaddress 	as mktaddress

from decimal                    import *

from app.LoanContract.models    import MKT_LOAN_CONTRACT
from app.Customer.models        import MKT_CUSTOMER
from app.Sector.models          import MKT_SECTOR
from app.LoanProduct.models 	import MKT_LOAN_PRODUCT
from app.Collateral.models 		import MKT_COLLATERAL_DE
from app.CollateralType.models 	import MKT_COLLATERAL_TYPE
from app.LoanApplication.models import MKT_LOAN_COLLATERAL
from app.Currency.models 		import MKT_CURRENCY


def getNGO06(Branch = "ALL", ReportedDate = ""):
	''' This function must return result like below:
			Result = {
				'Data': 		Data,
				'Excel': 		Excel, 
				'ReportHeader': ReportHeader,
				'TableHeader': 	TableHeader
				}
	'''
	try:
		ReportHeader 	=   mktnbc.getHeaderReport(	ReportName 		=	u'របាយការណ៏ប្រចាំខែសី្តពី ឥណទានតាមឥណទានធំបំផុត ចំនួន៥០',
													Title 			=	'',
													Form 			=	'6-Large Exposure')
		Result			=   {}
		TableHeader 	= 	{}

		TableHeader = mktnbc.setTableHeader(Text=u'ល.រ', 
									 Rowspan=3,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		
		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"អ្នកខ្ចី", 
									 Rowspan=0,Colspan=2,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u"គោត្តនាម និងនាម", 
									 Rowspan=2,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u"អាស័យដ្ឋាន", 
									 Rowspan=2,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"កាលបរិច្ឆេទ",
									 Rowspan=0,Colspan=2,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u"បញ្ចេញឥណទាន",
									 Rowspan=2,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u"កាលកំណត់",
									 Rowspan=2,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"ប្រភេទឥណទាន",
									 Rowspan=3,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"គោលបំណងឥណទាន",
									 Rowspan=3,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"កម្រិតអនុម័ត",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u"1",
									 Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"ឥណទានជាក់ស្តែង",
									 Rowspan=3,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"អត្រាការប្រាក់ប្រចាំឆ្នាំ\n(%)",
									 Rowspan=3,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		
		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"វត្ថុបញ្ចាំ",
									 Rowspan=0,Colspan=2,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u"ប្រភេទ",
									 Rowspan=2,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u"តម្លៃ",
									 Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")\

		TableHeader = mktnbc.setTableHeader(Text=u"2",
									 Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u"អនុបាតឥណទានធៀបនឹងវត្ថុធានា\n(%)",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u"3 = 1 / 2",
									 Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")


		Data,Excel = getLargeExposureDetail(Branch, ReportHeader)


		Result.update({'TableHeader':TableHeader,'ReportHeader':ReportHeader,'Data':Data,'Excel':Excel})
		return Result

	except Exception as e:
		raise

def getLargeExposureDetail(Branch, ReportHeader):
	try:
		RecordRow 	= []
		ExcelRecord 	= {}
		ExcelRecord.update({
				"D2" : ReportHeader.get('ReportedDate',""),
				"C3" : ReportHeader.get('CompanyName',""),
				"K5" : Decimal(ReportHeader.get('ReportingRate',0))
			})

		CurrencyDic = ReportHeader['DicExchangeRate'] 
		
		LoanObj 	= getQueryLargeExposure(Branch, CurrencyDic)

		i 			= 1

		LoanProductObj 	= MKT_LOAN_PRODUCT.query
		CollateralTypeObj 	= MKT_COLLATERAL_TYPE.query
		CollateralDeObj = MKT_COLLATERAL_DE.query
		SectorObj 		= MKT_SECTOR.query

		NBCLoanTypeIndividualLoan 		=	mktsetting.getAppSetting('NBCIndividualLoan').split()
		NBCLoanTypeGroupLoan 			=	mktsetting.getAppSetting('NBCGroupLoan').split()

		NBCLargeExposureLoanTypes 		=	mktsetting.getAppSetting('NBCLargeExposureLoanTypes').splitlines()
		DictSetting = {}
		for item in NBCLargeExposureLoanTypes:
			Value = item.split('*')
			DictSetting.update({Value[0]:Value[1].split()})
		NBCLoanTypeOverDraft 			=	DictSetting.get('Overdraft',[])
		NBCLoanTypeTermLoan 			=	DictSetting.get('TermLoan',[])
		NBCLoanTypeTrustReceipt 		=	DictSetting.get('TrustReceipt',[])
		NBCLoanTypeBillOfExchange 		=	DictSetting.get('BillOfExchange',[])
		NBCLoanTypeFinancingCommitment 	=	DictSetting.get('FinancingCommitment',[])
		NBCLoanTypeGuarantee 			=	DictSetting.get('Guarantee',[])
		NBCLoanTypeOthers 				=	DictSetting.get('Others',[])

		LoanTypeList = [("1","Individual", NBCLoanTypeIndividualLoan),
					 	("2","Group", NBCLoanTypeGroupLoan),
						("3","OverDraft", NBCLoanTypeOverDraft),
					 	("4","Term Loan", NBCLoanTypeTermLoan),
					 	("5","Trust Receipt", NBCLoanTypeTrustReceipt),
					 	("6","Bill of Exchange", NBCLoanTypeBillOfExchange),
					 	("7","Financing Commitment", NBCLoanTypeFinancingCommitment),
					 	("8","Guarantee", NBCLoanTypeGuarantee),
					 	("9","Others", NBCLoanTypeOthers)]

		# Default first cell in Excel file (6-Large Exposure)
		CellRow 	= 8
		TotApprovedAmount 	= 0
		TotOutstanding 		= 0
		TotValuationPrice 	= 0

		if LoanObj.all():
			for item in LoanObj:
				Currency 		= item.Currency
				ExchangeRate 	= CurrencyDic.get(Currency)

				CustomerName 	= '%s %s - %s %s' %(item.LastNameEn,item.FirstNameEn,item.LastNameKh,item.FirstNameKh)
				Address 		= mktaddress.getAddress(item.Province, item.District, item.Commune, item.Village, Locale='kh')

				ValueDate 		= str(item.ValueDate)
				MaturityDate 	= str(item.MaturityDate)

				LoanType 		= str(LoanProductObj.get(item.LoanProduct).Description) if item.LoanProduct else ""
				LoanPurpose 	= str(SectorObj.get(item.LoanPurpose).Description) if item.LoanPurpose else ""

				ApprovedAmount 	= Decimal(item.ApprovedAmount) * ExchangeRate if item.ApprovedAmount > 0 else Decimal(item.Disbursed) * Exchange
				ApprovedAmount 	= ApprovedAmount / mktnbc.OneMillion

				Outstanding     = Decimal(item.OutstandingAmount) * ExchangeRate
				Outstanding 	= Outstanding / mktnbc.OneMillion

				InterestRate 	= item.InterestRate

				CollateralType 	= ""
				ValuationPrice 	= 0

				ValuationObj 	= CollateralDeObj.filter(MKT_COLLATERAL_DE.CollateralID == item.CollateralID).all()
				for row in ValuationObj: 
					ColExchangeRate = CurrencyDic.get(row.Currency)
					ValuationPrice += row.ValuationPrice * ColExchangeRate
					CollateralType += "%s, "%(CollateralTypeObj.get(row.CollateralType).Description)

				if ValuationPrice:
					ValuationPrice 	= ValuationPrice / mktnbc.OneMillion

				try:
					CollateralRatio = ApprovedAmount / ValuationPrice if ValuationPrice != 0 else 0
				except ZeroDivisionError as e:
					raise

				TotApprovedAmount 	+= ApprovedAmount
				TotOutstanding 		+= Outstanding
				TotValuationPrice 	+= ValuationPrice

				LoanProduct = "Others"
				for loanTypeItem in LoanTypeList:
					if item.LoanProduct in loanTypeItem[2]:
						LoanProductID = loanTypeItem[0]
						LoanProduct = loanTypeItem[1]

				RecordRow.append({
									1:str(i),
									2:CustomerName,
									3:Address,
									4:ValueDate,
									5:MaturityDate,
									6:LoanProduct,
									7:LoanPurpose,
									8:mktmoney.formatNumber(ApprovedAmount),
									9:mktmoney.formatNumber(Outstanding),
									10:"%s %%" %(InterestRate),
									11:CollateralType,
									12:mktmoney.formatNumber(ValuationPrice),
									13:mktmoney.formatNumber(CollateralRatio),
									'LineType':'GH',
									'Indent':0,
									'RowBGColor':'',
									'LineFormat':''
								})

				ExcelRecord.update({
						"B%s"%(CellRow) : CustomerName,
						"C%s"%(CellRow) : Address,
						"D%s"%(CellRow) : ValueDate,
						"E%s"%(CellRow) : MaturityDate,
						"F%s"%(CellRow) : LoanProduct,
						"G%s"%(CellRow) : LoanPurpose,
						"H%s"%(CellRow) : ApprovedAmount,
						"I%s"%(CellRow) : Outstanding,
						"J%s"%(CellRow) : InterestRate,
						"K%s"%(CellRow) : CollateralType,
						"L%s"%(CellRow) : ValuationPrice
					})

				i 		+= 1
				CellRow += 1

			# TOTAL
			TotCollateralRatio 	= TotApprovedAmount / TotValuationPrice if TotValuationPrice != 0 else 0
			RecordRow.append({
								1:'',
								2:'',
								3:'',
								4:u'សរុប',
								5:'',
								6:'',
								7:'',
								8:mktmoney.formatNumber(TotApprovedAmount),
								9:mktmoney.formatNumber(TotOutstanding),
								10:'',
								11:'',
								12:mktmoney.formatNumber(TotValuationPrice),
								13:mktmoney.formatNumber(TotCollateralRatio),
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':mktnbc.BG_BODY_COLOR,
								'LineFormat':'bold'
							})
		else:
			i=1
			while i <= 50:
				RecordRow.append({
						1:str(i),
						2:"",
						3:"",
						4:"",
						5:"",
						6:"",
						7:"",
						8:"",
						9:"",
						10:"",
						11:"",
						12:"",
						13:"",
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':''
					})
				i = i+1
		return RecordRow,ExcelRecord
	except Exception as e:
		raise

def getQueryLargeExposure(Branch, CurrencyDic):
	CurrencyObj = db.session.query(MKT_CURRENCY)

	ConvertToBaseCurrency = case([(MKT_LOAN_CONTRACT.Currency == item.ID, MKT_LOAN_CONTRACT.Disbursed * CurrencyDic.get(item.ID)) for item in CurrencyObj]).label("BaseCurrencyAmount")

	LoanObj = db.session.query(	MKT_LOAN_CONTRACT.ID,
								MKT_LOAN_CONTRACT.Currency,
								MKT_CUSTOMER.FirstNameEn,
								MKT_CUSTOMER.LastNameEn,
								MKT_CUSTOMER.FirstNameKh,
								MKT_CUSTOMER.LastNameKh,
								MKT_CUSTOMER.Province,
								MKT_CUSTOMER.District,
								MKT_CUSTOMER.Commune,
								MKT_CUSTOMER.Village,
								MKT_LOAN_CONTRACT.LoanProduct,
								MKT_LOAN_CONTRACT.LoanPurpose,
								MKT_LOAN_CONTRACT.Currency,
								MKT_LOAN_CONTRACT.Disbursed,
								MKT_LOAN_CONTRACT.ValueDate,
								MKT_LOAN_CONTRACT.MaturityDate,
								MKT_LOAN_CONTRACT.InterestRate,
								MKT_LOAN_CONTRACT.OutstandingAmount,
								MKT_LOAN_CONTRACT.ApprovedAmount,
								MKT_LOAN_COLLATERAL.Collateral.label("CollateralID"),
								ConvertToBaseCurrency
						).\
						join(
							MKT_CUSTOMER,
							MKT_CUSTOMER.ID == MKT_LOAN_CONTRACT.ContractCustomerID
						).\
						join(
							MKT_LOAN_COLLATERAL,
							MKT_LOAN_COLLATERAL.ID == MKT_LOAN_CONTRACT.ID
						).\
						filter(MKT_LOAN_CONTRACT.OutstandingAmount > 0).\
						filter(MKT_LOAN_CONTRACT.DisbursedStat =='Y').\
						order_by(MKT_LOAN_CONTRACT.Disbursed.desc())

	if Branch != "ALL":
		Branch      =   Branch.split()
		LoanObj     =   LoanObj.\
						filter(MKT_LOAN_CONTRACT.Branch.in_(Branch))
	LoanObj = LoanObj.limit(50)

	return LoanObj