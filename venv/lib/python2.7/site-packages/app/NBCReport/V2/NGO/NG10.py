# -*- coding: utf-8 -*-
'''
Report Name: Loan Classification
'''
from app.mktcore.imports 			import *

import app.tools.mktdate 			as mktdate
import app.tools.mktmoney 			as mktmoney
import app.tools.mktnbc				as mktnbc
import sqlalchemy
import collections

from decimal 						import *
from sqlalchemy.sql.expression      import cast

from app.LoanContract.models 		import *
from app.LoanApplication.models 	import *
from app.Collateral.models 			import *
from app.TermDepositContract.models import *
from app.TermDepositProduct.models 	import *
from app.PeriodicInterest.models 	import *



def getNGO10(Branch = "ALL", ReportedDate = ""):
	''' This function must return result like below:
		Result = {
			'Data': 		Data,
			'Excel': 		Excel,
			'ReportHeader': ReportHeader,
			'TableHeader': 	TableHeader
			}
	'''

	try:
		TableHeader 	= 	{}
		RowRecord 		= 	[]
		ExcelRecord 	=	{}

		ReportHeader 	=   mktnbc.getHeaderReport(	ReportName 		=	u'របាយការណ៍ប្រចាំត្រីមាសស្តីពី ការតាមដានមធ្យមភាគអត្រាការប្រាក់ក្រោយថ្លឹងចំពោះប្រាក់បញ្ញើនិងឥណទានថ្មីៗ',
													Title 			=	'',
													Form 			=	'10-Weigth Interest Rate')
		ExcelRecord.update({
				"E3" : ReportHeader.get('ReportedDate',""),
				"E5" : ReportHeader.get('CompanyName',"")
			})

		TableHeader = mktnbc.setTableHeader(Text=u'ប្រភេទគណនី (១)\nTypes of Accounts​ (1)', 
									 	Rowspan='',Colspan='',RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u'រៀល​(២)\nKHR(2)', 
									 	Rowspan='',Colspan='',RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u'ដុល្លារអាមេរិក(៣)\nUSD (3)', 
									 	Rowspan='',Colspan='',RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u'រួបិយប័ណ្ណផ្សេង(៤)\nOther FCs (4)', 
									 	Rowspan='',Colspan='',RowIndex=1, TableHeader=TableHeader)


		CellRow 	=	9
		# Loan product ID from App Setting
		NBCWeightInterestRateLoanTypes	= 	mktsetting.getAppSetting('NBCWeightInterestRateLoanTypes').splitlines()
		DictSetting = {}
		for item in NBCWeightInterestRateLoanTypes:
			Value = item.split('*')
			DictSetting.update({Value[0]:Value[1].split()})
		NBCLoansToFIs 		 	=	DictSetting.get("LoansToFIs",[])
		NBCOverdraftConsumer 	=	DictSetting.get("OverdraftConsumer",[])
		NBCOverdraftBusiness 	=	DictSetting.get("OverdraftBusiness",[])
		NBCConsumerLoan 		=	DictSetting.get("Consumer",[])
		NBCBusinessLoan 		=	DictSetting.get("Business",[])
		NBCOtherLoan 			=	DictSetting.get("Others",[])
		# Get loan info by product

		RowRecord.append({ 1:u'ប្រាក់បញ្ញើ \nDeposits:',  
						2:"", 
						3:"", 
						4:"",
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold',
					})

		RowRecord.append({ 1:u'១. ប្រាក់បញ្ញើចរន្ត\nDemand Deposits',  
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold', })
		ExcelRecord.update({
						"F%s"%(CellRow) : 0,
						"G%s"%(CellRow) : 0,
						"H%s"%(CellRow) : 0
					})
		CellRow += 1

		RowRecord.append({ 	1:u'២. ប្រាក់បញ្ញើសំចៃ\nSaving Deposits',  
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold', })
		ExcelRecord.update({
						"F%s"%(CellRow) : 0,
						"G%s"%(CellRow) : 0,
						"H%s"%(CellRow) : 0
					})
		CellRow += 2

		TermDeposit = 	MKT_TERM_DEPOSIT_CONTRACT.query

		RowRecord.append({ 	1:u'៣. ប្រាក់បញ្ញើមានកាលកំណត់\nTerm Deposits:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold',})

		TermDic 	=	getTermDeposit(TermDeposit.filter(cast(MKT_TERM_DEPOSIT_CONTRACT.Term, sqlalchemy.Integer) <= 1))

		RowRecord.append({ 1:u'៣.១. រហូតដល់​ ១​ ខែ\nOne month or less', 
						2:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('KHR',0))), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('USD',0))), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('Other',0))), "%"), 
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''
						 })
		ExcelRecord.update({
						"F%s"%(CellRow) : TermDic.get('KHR',0),
						"G%s"%(CellRow) : TermDic.get('USD',0),
						"H%s"%(CellRow) : TermDic.get('Other',0)
					})
		CellRow += 1

		TermDic 	=	getTermDeposit(TermDeposit.filter(cast(MKT_TERM_DEPOSIT_CONTRACT.Term, sqlalchemy.Integer) > 1, cast(MKT_TERM_DEPOSIT_CONTRACT.Term, sqlalchemy.Integer) <= 3))
		RowRecord.append({ 1:u'៣.២. លើសពី ១ ខែ រហូតដល់ ៣ ខែ\nGreater than one month to three months', 
						2:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('KHR',0))), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('USD',0))), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('Other',0))), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''})
		ExcelRecord.update({
						"F%s"%(CellRow) : TermDic.get('KHR',0),
						"G%s"%(CellRow) : TermDic.get('USD',0),
						"H%s"%(CellRow) : TermDic.get('Other',0)
					})
		CellRow += 1

		TermDic 	=	getTermDeposit(TermDeposit.filter(cast(MKT_TERM_DEPOSIT_CONTRACT.Term, sqlalchemy.Integer) > 3, cast(MKT_TERM_DEPOSIT_CONTRACT.Term, sqlalchemy.Integer) <= 6))
		RowRecord.append({ 1:u'៣.៣. លើសពី ៣ ខែ រហូតដល់ ៦ ខែ​\nGreater than three months to six months ', 
						2:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('KHR',0))), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('USD',0))), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('Other',0))), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''})
		ExcelRecord.update({
						"F%s"%(CellRow) : TermDic.get('KHR',0),
						"G%s"%(CellRow) : TermDic.get('USD',0),
						"H%s"%(CellRow) : TermDic.get('Other',0)
					})
		CellRow += 1

		TermDic 	=	getTermDeposit(TermDeposit.filter(cast(MKT_TERM_DEPOSIT_CONTRACT.Term, sqlalchemy.Integer) > 6, cast(MKT_TERM_DEPOSIT_CONTRACT.Term, sqlalchemy.Integer) <= 12))
		RowRecord.append({ 1:u'៣.៤. លើសពី ៦ ខែ រហូតដល់ ១ ឆ្នាំ\nGreater than six months to one year', 
						2:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('KHR',0))), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('USD',0))), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('Other',0))), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })
		ExcelRecord.update({
						"F%s"%(CellRow) : TermDic.get('KHR',0),
						"G%s"%(CellRow) : TermDic.get('USD',0),
						"H%s"%(CellRow) : TermDic.get('Other',0)
					})
		CellRow += 1

		TermDic 	=	getTermDeposit(TermDeposit.filter(cast(MKT_TERM_DEPOSIT_CONTRACT.Term, sqlalchemy.Integer) > 12))
		RowRecord.append({ 1:u'៣.៥. លើសពី ១ ឆ្នាំ\nGreater than one year', 
						2:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('KHR',0))), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('USD',0))), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(float(TermDic.get('Other',0))), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''})
		ExcelRecord.update({
						"F%s"%(CellRow) : TermDic.get('KHR',0),
						"G%s"%(CellRow) : TermDic.get('USD',0),
						"H%s"%(CellRow) : TermDic.get('Other',0)
					})
		CellRow += 1

		RowRecord.append({ 1:u'៤. ប្រាក់បញ្ញើផ្សេងៗ\nOther ​​Deposits', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'})
		ExcelRecord.update({
						"F%s"%(CellRow) : 0,
						"G%s"%(CellRow) : 0,
						"H%s"%(CellRow) : 0
					})
		CellRow += 2

		RowRecord.append({ 1:u'ឥណទាន\nLoans:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold', })

		OverdraftConsumer 	 =	getAverageInterestRateOfLoan('', NBCOverdraftConsumer)
		RowRecord.append({ 1:u'១. ឥណទានវិបារូបន៍ -​ ទៅអ្នកប្រើប្រាស់\nOverdraft - Consumer', 
						2:u'%s %s' %(mktmoney.formatNumber(float(OverdraftConsumer.get('KHR',{'N':0})['N']+OverdraftConsumer.get('KHR',{'Y':0})['Y']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(OverdraftConsumer.get('USD',{'N':0})['N']+OverdraftConsumer.get('USD',{'Y':0})['Y']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(OverdraftConsumer.get('Other',{'N':0})['N']+OverdraftConsumer.get('Other',{'Y':0})['Y']), 1, 2), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold' })
		ExcelRecord.update({
						"F%s"%(CellRow) : OverdraftConsumer.get('KHR',{'N':0})['N']+OverdraftConsumer.get('KHR',{'Y':0})['Y'],
						"G%s"%(CellRow) : OverdraftConsumer.get('USD',{'N':0})['N']+OverdraftConsumer.get('USD',{'Y':0})['Y'],
						"H%s"%(CellRow) : OverdraftConsumer.get('Other',{'N':0})['N']+OverdraftConsumer.get('Other',{'Y':0})['Y']
					})
		CellRow += 1

		OverdraftBusiness 	 =	getAverageInterestRateOfLoan('', NBCOverdraftBusiness)
		RowRecord.append({ 	1:u'២. ឥណទានវិបារូបន៍ -​ ទៅធុរកិច្ច\nOverdraft - Business', 
						2:u'%s %s' %(mktmoney.formatNumber(float(OverdraftBusiness.get('KHR',{'N':0})['N']+OverdraftBusiness.get('KHR',{'Y':0})['Y']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(OverdraftBusiness.get('USD',{'N':0})['N']+OverdraftBusiness.get('USD',{'Y':0})['Y']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(OverdraftBusiness.get('Other',{'N':0})['N']+OverdraftBusiness.get('Other',{'Y':0})['Y']), 1, 2), "%"), 
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold' })
		ExcelRecord.update({
						"F%s"%(CellRow) : OverdraftBusiness.get('KHR',{'N':0})['N']+OverdraftBusiness.get('KHR',{'Y':0})['Y'],
						"G%s"%(CellRow) : OverdraftBusiness.get('USD',{'N':0})['N']+OverdraftBusiness.get('USD',{'Y':0})['Y'],
						"H%s"%(CellRow) : OverdraftBusiness.get('Other',{'N':0})['N']+OverdraftBusiness.get('Other',{'Y':0})['Y']
					})
		CellRow += 1

		RowRecord.append({ 	1:u'៣. ប័ណ្ណឥណទាន\nCredit Card', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'
						 })
		ExcelRecord.update({
						"F%s"%(CellRow) : "",
						"G%s"%(CellRow) : "",
						"H%s"%(CellRow) : ""
					})
		CellRow += 2

		RowRecord.append({ 	1:u'៤. ឥណទានចំពោះគ្រឹះស្ថានហិរញ្ញវត្ថុ\nLoans to FIs:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold' })

		NBCLoansToFIs 	=	getAverageInterestRateOfLoan('', NBCLoansToFIs , Condition=('Term','<=', 1))
		RowRecord.append({ 	1:u'៤.១. រហូតដល់​ ១​ ខែ\nOne month or less', 
						2:u'%s %s' %(mktmoney.formatNumber(float(NBCLoansToFIs.get('KHR',{'N':0})['N']+NBCLoansToFIs.get('KHR',{'Y':0})['Y']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(NBCLoansToFIs.get('USD',{'N':0})['N']+NBCLoansToFIs.get('USD',{'Y':0})['Y']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(NBCLoansToFIs.get('Other',{'N':0})['N']+NBCLoansToFIs.get('Other',{'Y':0})['Y']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''})
		ExcelRecord.update({
						"F%s"%(CellRow) : NBCLoansToFIs.get('KHR',{'N':0})['N']+NBCLoansToFIs.get('KHR',{'Y':0})['Y'],
						"G%s"%(CellRow) : NBCLoansToFIs.get('USD',{'N':0})['N']+NBCLoansToFIs.get('USD',{'Y':0})['Y'],
						"H%s"%(CellRow) : NBCLoansToFIs.get('Other',{'N':0})['N']+NBCLoansToFIs.get('Other',{'Y':0})['Y']
					})
		CellRow += 1

		NBCLoansToFIs 	=	getAverageInterestRateOfLoan('', NBCLoansToFIs ,Condition=('Term','>', 1))
		RowRecord.append({ 	1:u'៤.២. លើសពី ១ ខែ \nGreater than one month', 
						2:u'%s %s' %(mktmoney.formatNumber(float(NBCLoansToFIs.get('KHR',{'N':0})['N']+NBCLoansToFIs.get('KHR',{'Y':0})['Y']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(NBCLoansToFIs.get('USD',{'N':0})['N']+NBCLoansToFIs.get('USD',{'Y':0})['Y']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(NBCLoansToFIs.get('Other',{'N':0})['N']+NBCLoansToFIs.get('Other',{'Y':0})['Y']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })
		ExcelRecord.update({
						"F%s"%(CellRow) : NBCLoansToFIs.get('KHR',{'N':0})['N']+NBCLoansToFIs.get('KHR',{'Y':0})['Y'],
						"G%s"%(CellRow) : NBCLoansToFIs.get('USD',{'N':0})['N']+NBCLoansToFIs.get('USD',{'Y':0})['Y'],
						"H%s"%(CellRow) : NBCLoansToFIs.get('Other',{'N':0})['N']+NBCLoansToFIs.get('Other',{'Y':0})['Y']
					})
		CellRow += 3

		RowRecord.append({ 	1:u'៥. ឥណទានមានកាលកំណត់ - ទៅអ្នកប្រើប្រាស់\nTerm Loans - Consumer:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'})

		RowRecord.append({ 1:u'៥.១. មិនមានការធានា\nUnsecured:', 2:u'', 3:u'', 4:u'',
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })

		ConsumerListLess =	getAverageInterestRateOfLoan('N', NBCConsumerLoan )
		ConsumerListMore =	getAverageInterestRateOfLoan('Y', NBCConsumerLoan)
		# print ConsumerListMore,'ConsumerListMore',ConsumerListLess
		RowRecord.append({
						1:u'៥.១.១. រហូតដល់​ ១​ ឆ្នាំ\nOne year or less ',
						2:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListLess.get('KHR',{'N':0})['N']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListLess.get('USD',{'N':0})['N']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListLess.get('Other',{'N':0})['N']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : ConsumerListLess.get('KHR',{'N':0})['N'],
						"G%s"%(CellRow) : ConsumerListLess.get('USD',{'N':0})['N'],
						"H%s"%(CellRow) : ConsumerListLess.get('Other',{'N':0})['N']
					})
		CellRow += 1

		RowRecord.append({
						1:u'៥.១.២. លើសពី ១ ឆ្នាំ\nGreater than one year',
						2:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListMore.get('KHR',{'N':0})['N']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListMore.get('USD',{'N':0})['N']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListMore.get('Other',{'N':0})['N']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : ConsumerListMore.get('KHR',{'N':0})['N'],
						"G%s"%(CellRow) : ConsumerListMore.get('USD',{'N':0})['N'],
						"H%s"%(CellRow) : ConsumerListMore.get('Other',{'N':0})['N']
					})
		CellRow += 2

		RowRecord.append({ 	1:u'៥.២. មានការធានា\nSecured:', 2:u'', 3:u'', 4:u'',
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })

		RowRecord.append({
						1:u'៥.២.១. រហូតដល់​ ១​ ឆ្នាំ\nOne year or less ',
						2:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListLess.get('KHR',{'Y':0})['Y']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListLess.get('USD',{'Y':0})['Y']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListLess.get('Other',{'Y':0})['Y']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : ConsumerListLess.get('KHR',{'Y':0})['Y'],
						"G%s"%(CellRow) : ConsumerListLess.get('USD',{'Y':0})['Y'],
						"H%s"%(CellRow) : ConsumerListLess.get('Other',{'Y':0})['Y']
					})
		CellRow += 1

		RowRecord.append({
						1:u'៥.២.២. លើសពី ១ ឆ្នាំ\nGreater than one year',
						2:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListMore.get('KHR',{'Y':0})['Y']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListMore.get('USD',{'Y':0})['Y']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(ConsumerListMore.get('Other',{'Y':0})['Y']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : ConsumerListMore.get('KHR',{'Y':0})['Y'],
						"G%s"%(CellRow) : ConsumerListMore.get('USD',{'Y':0})['Y'],
						"H%s"%(CellRow) : ConsumerListMore.get('Other',{'Y':0})['Y']
					})
		CellRow += 3

		RowRecord.append({ 	1:u'៦. ឥណទានមានកាលកំណត់ - ទៅធុរកិច្ច\nTerm Loans - Business:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'
						 })

		RowRecord.append({ 	1:u'៦.១. មិនមានការធានា Unsecured:', 2:u'', 3:u'', 4:u'',
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })

		BusinessListLess=	getAverageInterestRateOfLoan('N', NBCBusinessLoan)
		BusinessListMore=	getAverageInterestRateOfLoan('Y', NBCBusinessLoan)
		# print BusinessListLess, 'BusinessListLess',BusinessListMore
		RowRecord.append({
						1:u'៦.១.១. រហូតដល់​ ១​ ឆ្នាំ\nOne year or less ',
						2:u'%s %s' %(mktmoney.formatNumber(float(BusinessListLess.get('KHR',{'N':0})['N']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(BusinessListLess.get('USD',{'N':0})['N']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(BusinessListLess.get('Other',{'N':0})['N']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : BusinessListLess.get('KHR',{'N':0})['N'],
						"G%s"%(CellRow) : BusinessListLess.get('USD',{'N':0})['N'],
						"H%s"%(CellRow) : BusinessListLess.get('Other',{'N':0})['N']
					})
		CellRow += 1

		RowRecord.append({
						1:u'៦.១.២. លើសពី ១ ឆ្នាំ\nGreater than one year',
						2:u'%s %s' %(mktmoney.formatNumber(float(BusinessListMore.get('KHR',{'N':0})['N']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(BusinessListMore.get('USD',{'N':0})['N']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(BusinessListMore.get('Other',{'N':0})['N']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : BusinessListMore.get('KHR',{'N':0})['N'],
						"G%s"%(CellRow) : BusinessListMore.get('USD',{'N':0})['N'],
						"H%s"%(CellRow) : BusinessListMore.get('Other',{'N':0})['N']
					})
		CellRow += 2

		RowRecord.append({ 	1:u'៦.២. មានការធានា Secured:', 2:u'', 3:u'', 4:u'', 
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''
						 })

		RowRecord.append({
						1:u'៦.២.១. រហូតដល់​ ១​ ឆ្នាំ\nOne year or less ',
						2:u'%s %s' %(mktmoney.formatNumber(float(BusinessListLess.get('KHR',{'Y':0})['Y']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(BusinessListLess.get('USD',{'Y':0})['Y']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(BusinessListLess.get('Other',{'Y':0})['Y']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : BusinessListLess.get('KHR',{'Y':0})['Y'],
						"G%s"%(CellRow) : BusinessListLess.get('USD',{'Y':0})['Y'],
						"H%s"%(CellRow) : BusinessListLess.get('Other',{'Y':0})['Y']
					})
		CellRow += 1

		RowRecord.append({
						1:u'៦.២.២. លើសពី ១ ឆ្នាំ\nGreater than one year',
						2:u'%s %s' %(mktmoney.formatNumber(float(BusinessListMore.get('KHR',{'Y':0})['Y']), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(BusinessListMore.get('USD',{'Y':0})['Y']), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(BusinessListMore.get('Other',{'Y':0})['Y']), 1, 2), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : BusinessListMore.get('KHR',{'Y':0})['Y'],
						"G%s"%(CellRow) : BusinessListMore.get('USD',{'Y':0})['Y'],
						"H%s"%(CellRow) : BusinessListMore.get('Other',{'Y':0})['Y']
					})
		CellRow += 1

		OtherListLess	=	getAverageInterestRateOfLoan('N', NBCOtherLoan)
		OtherListMore	=	getAverageInterestRateOfLoan('Y', NBCOtherLoan)
		KHR 	=	OtherListLess.get('KHR',{'Y':0})['Y'] + OtherListLess.get('KHR',{'N':0})['N'] + OtherListMore.get('KHR',{'Y':0})['Y'] + OtherListMore.get('KHR',{'N':0})['N']
		USD 	=	OtherListLess.get('USD',{'Y':0})['Y'] + OtherListLess.get('USD',{'N':0})['N'] + OtherListMore.get('USD',{'Y':0})['Y'] + OtherListMore.get('USD',{'N':0})['N']
		Other 	=	OtherListLess.get('Other',{'Y':0})['Y'] + OtherListLess.get('Other',{'N':0})['N'] + OtherListMore.get('Other',{'Y':0})['Y'] + OtherListMore.get('Other',{'N':0})['N']
		RowRecord.append({
						1:u'៧. ឥណទានផ្សេងៗ\nOther​ Loans',
						2:u'%s %s' %(mktmoney.formatNumber(float(KHR), 1, 2), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(float(USD), 1, 2), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(float(Other), 1, 2), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'
					})
		ExcelRecord.update({
						"F%s"%(CellRow) : KHR,
						"G%s"%(CellRow) : USD,
						"H%s"%(CellRow) : Other
					})

		Result 	=	{
			'Data':RowRecord,
			'ReportHeader':ReportHeader,
			'TableHeader':TableHeader,
			'Excel': ExcelRecord
		}
		# print Result
		return Result

	except:
		raise

def getTermDeposit(TermDeposit):
	TermDeposit =	TermDeposit.all()
	DepositList = 	{}
	Data 		= 	{}
	TermProductObj 	=	MKT_TERM_DEPOSIT_PRODUCT.query

	if TermDeposit:
		for t in TermDeposit:
			TermProductRecord 	=	TermProductObj.get(t.AccountProduct)
			if TermProductRecord:
				InterestRateObj =	db.session.query(
										MKT_PER_INTEREST.ID,
										MKT_PER_INTEREST_DE.Term,
										MKT_PER_INTEREST_DE.Rate,
									).join(MKT_PER_INTEREST_DE, MKT_PER_INTEREST_DE.ID == MKT_PER_INTEREST.ID).\
									filter(cast(MKT_PER_INTEREST_DE.Term, sqlalchemy.Integer) == t.Term).\
									filter(MKT_PER_INTEREST.ID == '%s%s'%(TermProductRecord.InterestKey, t.Currency)).first()

				if InterestRateObj:
					# {Currency: {'AmountList':[], 'Total':0} }
					AmountList = LoanList.get(item.Currency,{'AmountList':[], 'Total':0})
					AmountList.update({'Total':AmountList.get('Total',0) + item.Amount}) 
					AmountList['AmountList'].append(Decimal(InterestRateObj.Rate) * item.Amount)
					DepositList.update({item.Currency: AmountList})

		for k,l in DepositList.iteritems():
			Currency = k
			Percentage = sum(l.get('AmountList', [])) / l['Total']

			if not k in ['KHR', 'USD']:
				Currency 	= 'Other'
				Percentage 	= Percentage + Data.get(k,0)

			Data.update({Currency: Percentage})

	return Data

def getAverageInterestRateOfLoan(MoreThanOneYear='', ListGroup=[], Condition=()):
	try:
		
		# Query LC Information by Term
		LoanObj 	=	db.session.query(
							MKT_LOAN_CONTRACT.ID,
							MKT_LOAN_CONTRACT.Currency,
							MKT_LOAN_CONTRACT.InterestRate,
							MKT_LOAN_CONTRACT.Disbursed,
							MKT_LOAN_CONTRACT.LoanApplicationID
						).\
						filter(MKT_LOAN_CONTRACT.MoreThanOneYear == MoreThanOneYear).\
						filter(MKT_LOAN_CONTRACT.LoanProduct.in_(ListGroup))

		if MoreThanOneYear:
			LoanObj =	LoanObj.filter(MKT_LOAN_CONTRACT.DisbursedStat == 'Y')

		if Condition:
			LoanObj =	eval('LoanObj.filter(cast(MKT_LOAN_CONTRACT.%s , sqlalchemy.Integer) %s %s)'%Condition)
						
		LoanObj 	=	LoanObj.all()
		ListLoan 	=	{}
		LoanList 	=	{}
		Data 		= 	{}

		if LoanObj:

			for item in LoanObj:

				Disbursed 	=	item.Disbursed
				Secured 	=	"Y"
				# SecureObj 	=	MKT_GUARANTOR.query.\
				# 				filter(or_(MKT_GUARANTOR.ID == item.ID, MKT_GUARANTOR.ID == item.LoanApplicationID))

				# if not SecureObj:
					
				SecureObj 	=	MKT_COLLATERAL.query.\
								filter(or_(MKT_COLLATERAL.ID == item.ID, MKT_COLLATERAL.ID == item.LoanApplicationID))
				# print SecureObj.first(), item.ID
				if not SecureObj.first():
					Secured = "N"

				# {Currency: { Secured: {'AmountList':[], 'Total':0} }}
				DicCurrency = 	LoanList.get(item.Currency,{})
				AmountList 	= 	DicCurrency.get(Secured,{'AmountList':[], 'Total':0})
				AmountList.update({'Total':AmountList.get('Total',0) + item.Disbursed}) 
				AmountList['AmountList'].append(Decimal(item.InterestRate) * item.Disbursed)
				DicCurrency.update({Secured:AmountList})
				LoanList.update({item.Currency: DicCurrency})
				
			for k,l in LoanList.iteritems():
				Currency = k
				Y = l.get('Y',{'AmountList':[], 'Total':1})
				Y = sum(Y['AmountList']) / Y['Total']
				N = l.get('N',{'AmountList':[], 'Total':1})
				N = sum(N['AmountList']) / N['Total']
				if not k in ['KHR', 'USD']:
					Currency = 'Other'
					Y = Y + Data.get(Currency,{'Y':0}['Y']) 
					N = N + Data.get(Currency,{'N':0}['N']) 
				Data.update({Currency:{'Y':Y, 'N':N }})

		return Data

	except Exception, e:
		raise