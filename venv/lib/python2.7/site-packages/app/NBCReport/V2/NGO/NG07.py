# -*- coding: utf-8 -*-
'''
Report Name: Deposit by Types
'''

from app.mktcore.imports 		import *

import app.tools.mktsetting     as mktsetting
import app.tools.mktmoney       as mktmoney
import app.tools.mktnbc         as mktnbc
import app.tools.mktaddress 	as mktaddress
import app.tools.mktmessage 	as mktmessage

from decimal                    import *

from app.AccSetting.models 		import *
from app.Currency.models 		import MKT_CURRENCY
from app.Category.models 		import *
from app.AccProduct.models 		import *
from app.Account.models 		import MKT_ACCOUNT
from app.InterestRate.models 	import MKT_INTEREST_RATE



def getNGO07(Branch = "ALL", ReportedDate = ""):
	''' This function must return result like below:
		Result = {
			'Data': 		Data,
			'Excel': 		Excel,
			'ReportHeader': ReportHeader,
			'TableHeader': 	TableHeader
			}
	'''
	try:
		ReportHeader 	=   mktnbc.getHeaderReport(	ReportName 		=	u'ប្រាក់បញ្ញើតាមប្រភេទនិងទំហំទឹកប្រាក់',
													Title 			=	'',
													Form 			=	'7-Deposit by Types')
		Result			=   {}
		TableHeader 	= 	{}

		TableHeader = mktnbc.setTableHeader(Text=u'ប្រភេទ', 
                                            Rowspan=3,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'អត្រាការប្រាក់\nបានបង់/គ្រាបង់', 
                                            Rowspan=3,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u'តិចជាង ២៥០.០០០រៀល', 
		                                    Rowspan=0,Colspan=2,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនគណនី', 
		                                    Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនទឹកប្រាក់', 
		                                    Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text= '1', 
		                                   Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'2', 
		                                   Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u'ពី ២៥០.០០០រៀល ដល់ ១.០០០.០០០រៀល', 
		                                    Rowspan=0,Colspan=2,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនគណនី', 
		                                    Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនទឹកប្រាក់', 
		                                    Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'3', 
		                                   Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'4', 
		                                   Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u'ច្រើនជាង ១.០០០.០០០រៀល', 
		                                    Rowspan=0,Colspan=2,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនគណនី', 
		                                    Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនទឹកប្រាក់', 
		                                    Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'5', 
		                                   Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'6', 
		                                   Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		#-----------------------------------------------------------------------------------#
		TableHeader = mktnbc.setTableHeader(Text=u'សរុប', 
		                                    Rowspan=0,Colspan=2,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនគណនី', 
		                                    Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'ចំនួនទឹកប្រាក់', 
		                                    Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'7 = 1 + 3 + 5', 
		                                   Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")

		TableHeader = mktnbc.setTableHeader(Text=u'8 = 2 + 4 + 6', 
		                                   Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		
		Data, Excel = getBreakDownDeposit(Branch, ReportHeader)


		Result.update({'TableHeader':TableHeader,'ReportHeader':ReportHeader,'Data':Data, 'Excel': Excel})
		return Result

	except Exception as e:
		raise

def getBreakDownDeposit(Branch, ReportHeader):
	AccountTypeDic = {
				'Demand':u'១.១ ចរន្ត',
				'Saving':u'១.២ សំចៃ',
				'Term':u'១.៣ មានកាលកំណត់',
				'Other':u'១.៤ ផ្សេងៗ',
				u'Program 1':u'២.១ កម្មវិធីទី ១',
				u'Program 2':u'២.២ កម្មវិធីទី ២',
				u'Program 3':u'២.៣ កម្មវិធីទី ៣'
			}

	if Branch != "ALL":
		Branch = Branch.split()

	Language 	=	mktnbc.getDefaultLang()
	ColRecord 	= {}
	RowRecord 	= []
	ExcelRecord 	= {}
	ExcelRecord.update({
					"D2" : ReportHeader.get('ReportedDate',""),
					"C3" : ReportHeader.get('CompanyName',""),
					"I4" : Decimal(ReportHeader.get('ReportingRate',0))
				})

	DicObj 		= {}
	TotalAmount 		= 0

	CurrencyObj 	= MKT_CURRENCY.query
	AccSettingObj 	= MKT_ACCOUNTING_SETTING.query.get('SYSTEM')

	if AccSettingObj:
		BaseCurrency 	= AccSettingObj.BaseCurrency
		BaseCurrencyObj = CurrencyObj.get(BaseCurrency)

		if BaseCurrencyObj:

			AccObj 			= 		MKT_ACCOUNT.query.\
									filter(MKT_ACC_PRODUCT.ProductType=="E").\
									join(
										MKT_ACC_PRODUCT,
										MKT_ACC_PRODUCT.ID == MKT_ACCOUNT.AccProduct
									).\
									join(
										MKT_CATEGORY,
										MKT_CATEGORY.ID == MKT_ACCOUNT.AccCategory
									)

			if Branch != "ALL":
				AccObj 	= 	AccObj.\
							filter(MKT_ACCOUNT.Branch.in_(Branch))

			AccObj 		=	AccObj.\
							filter(MKT_ACCOUNT.Balance != 0)

			ExchangeRateDic =	ReportHeader['DicExchangeRate'] 
			AccountDic 		=	{}

			# get BreakDownOfDeposit AppSetting
			BreakDownDepositSetting = 	mktsetting.getAppSetting('NBCBreakDownOfDeposit').splitlines()
			for b in BreakDownDepositSetting:
				Key = b.split('*')
				AccountDic.update({Key[0]:Key[1].split()})
				# AccountDic 	=	{'Demand':['101'], 'Saving':['102','122'], 'Term':['103'], 'Other':[], 'Program1':['101'], 'Program2':[], 'Program3':[]}
			
			TmpDic 	= 	{}
			Total1 	=	0
			Total2 	=	0
			Total3 	=	0

			for k, v in AccountDic.iteritems():
				AccountObj = AccObj.filter(MKT_ACC_PRODUCT.ID.in_(v)).all()
				if AccountObj:
					TotalTA = 0

					AccProductObj = MKT_ACC_PRODUCT.query.get(AccountObj[0].AccProduct)
					DisplayRate = ""
					if AccProductObj:
						InterestObj = 	MKT_INTEREST_RATE.query.filter(MKT_INTEREST_RATE.ID == AccProductObj.InterestKey).first()
						if InterestObj:
							Rate = InterestObj.Rate.split()
							DisplayRate = "%s / Year"%(Rate)
					TmpDic.update({k:DisplayRate})
					
					for a in AccountObj:
						Currency 		= 	a.Currency
						Rate 			=	ExchangeRateDic[Currency]
						Balance 		= 	float(a.Balance) * float(Rate)
						

						if 250000 > Balance:
							TmpDic.update({'1%s'%k:TmpDic.get('1%s'%k,0)+Balance, '1A%s'%k:TmpDic.get('1A%s'%k,0)+1})
							Total1 += Balance
						elif 250000 <= Balance <= 1000000 :
							Total2 += Balance
							TmpDic.update({'2%s'%k:TmpDic.get('2%s'%k,0)+Balance, '2A%s'%k:TmpDic.get('2A%s'%k,0)+1})
						elif 1000000 < Balance :
							Total3 += Balance
							TmpDic.update({'3%s'%k:TmpDic.get('3%s'%k,0)+Balance, '3A%s'%k:TmpDic.get('3A%s'%k,0)+1})
			
			# Saving
			RowRecord.append({
								1:u'១. ស្ម័គ្រចិត្ត',
								2:'',
								3:'',
								4:'',
								5:'',
								6:'',
								7:'',
								8:'',
								9:'',
								10:'',
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':'',
								'LineFormat':'bold'
							})

			Subtotal1 	=	0
			Subtotal2 	=	0
			Subtotal3 	=	0
			SubtotalC1  =	0
			SubtotalC2  =	0
			SubtotalC3  =	0
			CellRow 	= 	9

			for x in ['Demand', 'Saving', 'Term', 'Other']:
				R1 	=	TmpDic.get('1%s'%x,0) / mktnbc.OneMillion
				R2 	=	TmpDic.get('2%s'%x,0) / mktnbc.OneMillion
				R3 	=	TmpDic.get('3%s'%x,0) / mktnbc.OneMillion
				RT 	=	R1+R2+R3
				Subtotal1 	+=	R1
				Subtotal2 	+=	R2
				Subtotal3 	+=	R3

				C1 	= 	TmpDic.get('1A%s'%x,0)
				C2 	= 	TmpDic.get('2A%s'%x,0)
				C3 	= 	TmpDic.get('3A%s'%x,0)
				CT  =	C1+C2+C3
				SubtotalC1  +=	C1
				SubtotalC2  +=	C2
				SubtotalC3  +=	C3

				RowRecord.append({  
									1:AccountTypeDic.get(x,''), 
									2:TmpDic.get(x,''), 
									3:str(C1), 
									4:mktmoney.formatNumber(R1),
									5:str(C2), 
									6:mktmoney.formatNumber(R2),
									7:str(C3), 
									8:mktmoney.formatNumber(R3),
									9:str(CT), 
									10:mktmoney.formatNumber(RT),
									'LineType':'GH',
									'Indent':1,
									'RowBGColor':'',
									'LineFormat':''
									})

				ExcelRecord.update({
									"C%s"%(CellRow) : TmpDic.get(x,''),
									"D%s"%(CellRow) : C1,
									"E%s"%(CellRow) : R1,
									"F%s"%(CellRow) : C2,
									"G%s"%(CellRow) : R2,
									"H%s"%(CellRow) : C3,
									"I%s"%(CellRow) : R3
								})

				CellRow += 1

			GTotalC 	=	SubtotalC1+SubtotalC2+SubtotalC3
			TotalAmount = 	Subtotal1+Subtotal2+Subtotal3

			RowRecord.append({
								1:u'សរុបប្រាក់បញ្ញើស្ម័គ្រចិត្ត',
								2:'',
								3:str(SubtotalC1), 
								4:mktmoney.formatNumber(Subtotal1),
								5:str(SubtotalC2), 
								6:mktmoney.formatNumber(Subtotal2),
								7:str(SubtotalC3), 
								8:mktmoney.formatNumber(Subtotal3),
								9:str(GTotalC), 
								10:mktmoney.formatNumber(TotalAmount),
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':mktnbc.BG_BODY_COLOR,
								'LineFormat':'bold'
							})


			#Loan
			RowRecord.append({	
								1:u'២. កាតព្វកិច្ច',
								2:'',
								3:'',
								4:'',
								5:'',
								6:'',
								7:'',
								8:'',
								9:'',
								10:'',
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':'',
								'LineFormat':'bold'
							})
			PSubtotal1 	=	0
			PSubtotal2 	=	0
			PSubtotal3 	=	0
			PSubtotalC1  =	0
			PSubtotalC2  =	0
			PSubtotalC3  =	0
			CellRow 	=	15
			for x in ['Program 1', 'Program 2', 'Program 3']:
				R1 	=	TmpDic.get('1%s'%x,0) / mktnbc.OneMillion
				R2 	=	TmpDic.get('2%s'%x,0) / mktnbc.OneMillion
				R3 	=	TmpDic.get('3%s'%x,0) / mktnbc.OneMillion
				RT 	=	R1+R2+R3
				PSubtotal1 	+=	R1
				PSubtotal2 	+=	R2
				PSubtotal3 	+=	R3

				PC1 	= 	TmpDic.get('1A%s'%x,0)
				PC2 	= 	TmpDic.get('2A%s'%x,0)
				PC3 	= 	TmpDic.get('3A%s'%x,0)
				PCT  =	PC1+PC2+PC3
				PSubtotalC1  +=	PC1
				PSubtotalC2  +=	PC2
				PSubtotalC3  +=	PC3

				RowRecord.append({  
									1:AccountTypeDic.get(x,''), 
									2:TmpDic.get(x,''), 
									3:str(PC1), 
									4:mktmoney.formatNumber(R1),
									5:str(PC2), 
									6:mktmoney.formatNumber(R2),
									7:str(PC3), 
									8:mktmoney.formatNumber(R3),
									9:str(PCT), 
									10:mktmoney.formatNumber(RT),
									'LineType':'GH',
									'Indent':1,
									'RowBGColor':'',
									'LineFormat':''
								})

				ExcelRecord.update({
								"C%s"%(CellRow) : TmpDic.get(x,''),
								"D%s"%(CellRow) : PC1,
								"E%s"%(CellRow) : R1,
								"F%s"%(CellRow) : PC2,
								"G%s"%(CellRow) : R2,
								"H%s"%(CellRow) : PC3,
								"I%s"%(CellRow) : R3
							})
				CellRow 	+= 1

			PGTotalC 	=	PSubtotalC1+PSubtotalC2+PSubtotalC3
			PTotalAmount = 	PSubtotal1+PSubtotal2+PSubtotal3

			RowRecord.append({	
								1:u'សរុបប្រាក់បញ្ញើកាតព្វកិច្ច',
								2:'',
								3:str(PSubtotalC1), 
								4:mktmoney.formatNumber(PSubtotal1),
								5:str(PSubtotalC2), 
								6:mktmoney.formatNumber(PSubtotal2),
								7:str(PSubtotalC3), 
								8:mktmoney.formatNumber(PSubtotal3),
								9:str(PGTotalC), 
								10:mktmoney.formatNumber(PTotalAmount),
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':mktnbc.BG_BODY_COLOR,
								'LineFormat':'bold'
								})

			RowRecord.append({	
								1:u'សរុបប្រាក់សំចៃកេណ្ឌប្រមូល',
								2:'',
								3:str(PSubtotalC1+SubtotalC1), 
								4:mktmoney.formatNumber(PSubtotal1+Subtotal1),
								5:str(PSubtotalC2+SubtotalC2), 
								6:mktmoney.formatNumber(PSubtotal2+Subtotal2),
								7:str(PSubtotalC3+SubtotalC3), 
								8:mktmoney.formatNumber(PSubtotal3+Subtotal3),
								9:str(PGTotalC+GTotalC), 
								10:mktmoney.formatNumber(PTotalAmount+TotalAmount),
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':mktnbc.BG_BODY_COLOR,
								'LineFormat':'bold'
								})

	return RowRecord, ExcelRecord
