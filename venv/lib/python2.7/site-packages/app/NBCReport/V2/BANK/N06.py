# -*- coding: utf-8 -*-
'''
	Report Name: MONTHLY REPORT ON SOLVENCY RATIO

'''
from decimal                    import *
from app.mktcore.imports        import *
from app.GLBalance.models       import MKT_GL_BALANCE, MKT_GL_BALANCE_BACKUP
from app.LoanContract.models    import MKT_LOAN_CONTRACT
from app.Customer.models        import MKT_CUSTOMER
from app.Sector.models          import MKT_SECTOR
from app.LoanProduct.models     import MKT_LOAN_PRODUCT
from app.Currency.models 		import MKT_CURRENCY

import app.tools.mktdate        as mktdate
import app.tools.mktsetting     as mktsetting
import app.tools.mktmoney       as mktmoney
import app.tools.mktnbc         as mktnbc
import app.tools.mktgl          as mktgl
import app.tools.mktmessage     as mktmessage
import app.tools.mkttool        as mkttool
from app.Currency.models        import *
import app.NBCReport.V2.BANK.BankSetting as nbcbanksetting


def getGLValueForField(Branch = "ALL", Period = 2,NBCBankN06Key='', NBCExchangeRateDict={},**Kargs):
	return nbcbanksetting.getGLValueFromField(Branch, Period, "NBCBankN06",NBCBankN06Key, NBCExchangeRateDict,**Kargs)


def getBANK06(Branch = "ALL", ReportedDate="", Period = 2, Year = "", Month = "",NBCN011=False):

	OutstandingAmountN11 = getLoanContract()
	TotalOutStandingAmount =0
	for item in OutstandingAmountN11:
		OutAmount = item.OutstandingAmount
		TotalOutStandingAmount +=OutAmount

	try:
		ID              =   "N006" # ID of Report 01 Balance Sheet

		Condition = []
		if Year and Month:
			GLTable   	= MKT_GL_BALANCE_BACKUP
			Condition 	= [GLTable.GLYear == Year,GLTable.GLMonth == Month]
			CYear 	  	= Year
			CMonth 	  	= Month
		else:
			GLTable   	= MKT_GL_BALANCE
			BankDate  	= mktdate.getBankDate()
			CYear 	  	= BankDate.year
			CMonth 	  	= BankDate.month

		GLObj           =   GLTable.query.filter(*Condition)
		Kargs           =   {'GLTable':GLTable, 'GLObj':GLObj, 'FCY':True}

		Result          = {}
		Data            = []
		Excel           = {}
		TableHeader     = {}
		ReportHeader	= {}

		ReportHeader    = mktnbc.getHeaderReport(   ReportName      =   u'MONTHLY REPORT ON NET WORTH CALCULATION',
													Title           =   u'របាយការណ៍ប្រចាំខែស្តីពី ការគណនាមូលនិធិផ្ទាល់សុទ្ឌ',
													Form            =   'Networth'
													)
		Excel.update({
						"A5" : u'As of:  %s'% mktdate.formatDate(ReportedDate,'%d %B %Y'),
						"E7" : ((ReportHeader.get('CompanyName',"")).splitlines())[0],
						"E8" : ((ReportHeader.get('CompanyName',"")).splitlines())[1],
						"L8" : Decimal(ReportHeader.get('ReportingRate',0))
					})

		Data            =   []
		ReportingRate = Decimal(ReportHeader.get('ReportingRate',0))
		DataList        =   mktnbc.getNBCLineDetail(ID, Branch, Period, GLTable=GLTable, GLObj=GLObj, Year=CYear, Month=CMonth)
		SubTotal        =   0
		SubTotalKh 		= 	0
		SubTOtalCKh 	= 	0
		CurrencyDic     =   mktnbc.getNBCExchangeRate(CYear, CMonth)
		if not CurrencyDic:
			flash(msg_error+"NBC Exchange Rate isn't defined")
			return []

# Solvency A

		Data.append({
						1:u"ដើមទុនថ្នាក់ទី១:  (ដើមទុនស្នូល) Tier 1: (Core Capital)",
						2:u'ចំនួនប្រាក់ជាដុល្លាអាមេរិក (X១,០០០)\nin USD (x1,000)',
						3:u'ចំនួនប្រាក់ជារៀល (X១,០០០,០០០)\nin KHR (x1,000,000)',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold',
					})

		Data.append({
						1:u"I. សរុបរង​ A (ខ្ទង់ត្រូវបូក) Sub-Total A",
						2:u'',
						3:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'

					})

		PaidUpCapitalUSD 	  	=   getGLValueForField(Branch, Period, 'PaidUpCapital', **Kargs)
		PaidUpCapitalUSD 		= PaidUpCapitalUSD*1000
		SubTotal        		+=  Decimal(PaidUpCapitalUSD)

		PaidUpCapital   		=   getGLValueForField(Branch, Period, 'PaidUpCapital', CurrencyDic, **Kargs)
		SubTotalKh        		+=  Decimal(PaidUpCapital)

		Data.append({
						1:u"ដើមទុន ឬទាយជ្ជទានដែលបានបង់ Paid-in Capital/ Capital endowment",
						2:u'%s' %mktmoney.formatNumber(float(PaidUpCapitalUSD),1,2),
						3:u'%s' %mktmoney.formatNumber(float(PaidUpCapital), 1, 2),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J17" : Decimal(PaidUpCapitalUSD)
					})

		NBCBankFieldSetting = nbcbanksetting.getNBCBankFieldSetting('NBCBankN06')
		RevaluationEn 	= 	NBCBankFieldSetting.get('OtherRevaluationReservEn',0)
		if RevaluationEn:
			SubTotal 		+= 	Decimal(RevaluationEn)
		RevaluationKh 	= 	NBCBankFieldSetting.get('OtherRevaluationReservKh',0)
		if RevaluationKh:
			SubTotalKh 		+= Decimal(RevaluationKh)


		Data.append({
						1:u"ទុនបម្រុង (មិនមែនជាទុនបម្រុងដែលបានវាយតម្លៃឡើងវិញ) Reserves (other then revaluation reserves)",
						2:u'%s' %(RevaluationEn),
						3:u'%s' %(RevaluationKh),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J18" : RevaluationEn
					})

		PremiumEn     =   NBCBankFieldSetting.get('PremiumEn',0)
		if PremiumEn:
			SubTotal    +=  Decimal(PremiumEn)
		PremiumKh   =   (Decimal(PremiumEn)*ReportingRate)/1000
		if PremiumKh:
			SubTotalKh    +=  Decimal(PremiumKh)


		Data.append({
						1:u"ប្រាក់ចំណេញសុទ្ធដែលត្រូវបានធ្វើសវនកម្មរួចហើយ (ឆ្នាំហិរញ្ញវត្ថុកន្លងទៅ) Audited Net Profit (last financial year)",
						2:u'%s' %(PremiumEn),
						3:u'%s' %mktmoney.formatNumber(float(PremiumKh), 1, 2),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J19" : Decimal(PremiumEn)
					})

		ProvisionRiskEn   		=		NBCBankFieldSetting.get('ProvisionRiskEn',0) 
		if ProvisionRiskEn:
			SubTotal        	+=  Decimal(ProvisionRiskEn)
		ProvisionRiskKh   		=		NBCBankFieldSetting.get('ProvisionRiskKh',0) 
		if ProvisionRiskKh:
			SubTotalKh        	+=  Decimal(ProvisionRiskKh) 
		Data.append({
						1:u"ប្រាក់ចំណេញរក្សាទុក Retained Earnings",
						2:u'%s' %ProvisionRiskEn ,
						3:u'%s' %ProvisionRiskKh,
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J20" : ProvisionRiskEn
					})

		RetainedEarning    =   getGLValueForField(Branch, Period, 'RetainedEarning', CurrencyDic, **Kargs)
		if RetainedEarning <= 0: RetainedEarning = 0
		SubTotal            +=  Decimal(RetainedEarning)

		Data.append({
						1:u"ខ្ទង់ដទៃទៀត (រៀបរាប់លំអិត ​និងមានការយល់ព្រមជាមុនពីធនាគារជាតិនៃកម្ពុជា) \nOther Items (to be detailed and supported by and NBC approval to be referred to)",
						2:u'%s' %(mktmoney.formatNumber(float(RetainedEarning), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(RetainedEarning), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J15" : ''
					})
		AuditedNetProfit = getGLValueForField(Branch, Period, 'AuditedNetProfit', CurrencyDic, **Kargs)
		SubTotal        += AuditedNetProfit
		Data.append({
						1:u"១. សេចក្តីយោងនិងការអនុញ្ញាតរបស់ធនាគារជាតិនៃកម្ពុជា Provide reference of NBC's authority/approval",
						2:u'%s' %AuditedNetProfit,
						3:u'%s' %AuditedNetProfit,
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J24" : Decimal(AuditedNetProfit)
					})
		ItemByNBC = getGLValueForField(Branch, Period, 'ItemByNBC', CurrencyDic, **Kargs)
		SubTotal        +=  Decimal(ItemByNBC)
		Data.append({
						1:u"២. សេចក្តីយោងនិងការអនុញ្ញាតរបស់ធនាគារជាតិនៃកម្ពុជា ។ល។ Provide reference of NBC's authority/approval",
						2:u'%s' %(mktmoney.formatNumber(float(ItemByNBC), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(ItemByNBC), 1, 2)),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J25" : Decimal(ItemByNBC)
					})

		Data.append({
						1:u"សរុបរង A Sub-Total A",
						2:u'%s' %(mktmoney.formatNumber(float(SubTotal), 1, 2)),
						3:u'%s'%(mktmoney.formatNumber(float(SubTotalKh),1,2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		SubTotalA   =   SubTotal

		RetainedEarning    =   getGLValueForField(Branch, Period, 'RetainedEarning', CurrencyDic, **Kargs)
		if RetainedEarning <= 0: RetainedEarning = 0
		SubTotal            +=  Decimal(RetainedEarning)

		Data.append({
						1:u"កម្រិតកំណត់លើប្រាក់ចំណេញរក្សាទុក Limited check on Retained Earnings \n(អតិបរមា២០% នៃសរុបរង A) (max. 20% of Sub-Total A)",
						2:u'%s' %(mktmoney.formatNumber(float(RetainedEarning), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(RetainedEarning), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		# Excel.update({
		# 				"J18" : Decimal(RetainedEarning)
		# 			})

		Data.append({
						1:u"II. សរុបរង B: (ខ្ទង់ ត្រូវដក) II-Sub-Total B (Deduction)",
						2:u'',
						3:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})

		SubTotalB           =   0
		UnpaidPortCapital   =   getGLValueForField(Branch, Period, 'UnpaidPortCapital', CurrencyDic, **Kargs)
		InsiderTotal        =   Decimal(TotalOutStandingAmount)
		# InsiderTotal        =   getGLValueForField(Branch, Period, 'InsiderTotal', CurrencyDic, **Kargs)
		ShareOwner          =   UnpaidPortCapital + InsiderTotal
		SubTotalB           +=  Decimal(ShareOwner)
		Data.append({
						1:u"ភាគហ៊ុនផ្ទាល់ដែលកាន់កាប់ដោយធនាគារ (តាមតម្លៃចុះបញ្ជី) Own Shares Held (at Book Value)",
						2:mktmoney.formatNumber(ShareOwner, 2,2),
						3:mktmoney.formatNumber(ShareOwner, 2,2),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J33" : Decimal(UnpaidPortCapital)
					})

		Data.append({
						1:u"ការខាតបង្គរ Accumulated Losses",
						2:mktmoney.formatNumber(UnpaidPortCapital, 2, 2),
						3:mktmoney.formatNumber(UnpaidPortCapital, 2, 2),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J34" : Decimal(UnpaidPortCapital)
					})

		Data.append({
						1:u"ទ្រព្យសកម្មអរូបីដែលត្រូវដកចេញ Intangible Assets to be Deducted",
						2:mktmoney.formatNumber(InsiderTotal, 2, 2),
						3:mktmoney.formatNumber(InsiderTotal, 2, 2),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J35" : Decimal(InsiderTotal)
					})

		HoldingOfOwn    = getGLValueForField(Branch, Period, 'HoldingOfOwn', CurrencyDic, **Kargs)
		SubTotalB       += Decimal(HoldingOfOwn)
		Data.append({
						1:u"ចំពោះភាគទុនិក គណៈនាយក និងភាគីសម្ព័ន្ធញ្ញាតិ (ដកចេញ) Shareholders, Directors, Related Parties (Deduct)",
						2:u'%s' %HoldingOfOwn,
						3:u'%s' %HoldingOfOwn,
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J23" : Decimal(HoldingOfOwn)
					})
		AuditedNetProfit    =   getGLValueForField(Branch, Period, 'AccumulatedLoss', CurrencyDic, **Kargs)
		AccumulatedLoss = AuditedNetProfit
		if AuditedNetProfit > 0: AccumulatedLoss = 0
		AccumulatedLoss = abs(AccumulatedLoss)
		SubTotalB       +=  AccumulatedLoss
		Data.append({
						1:u"១. ចំណែកដើមទុន ឬទាយជ្ជទាន ដែលមិនទាន់បានបង់ (a) Unpaid Portion (s) of capital (a)",
						2:mktmoney.formatNumber(AccumulatedLoss, 2, 2),
						3:mktmoney.formatNumber(AccumulatedLoss, 2, 2),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J37" : Decimal(AccumulatedLoss)
					})
		
		FormationExp    =   getGLValueForField(Branch, Period, 'FormationExp', CurrencyDic, **Kargs)
		SubTotalB       +=  FormationExp
		Data.append({
						1:u"២. ប្រាក់កម្ចី ឥណទានវិបារូបន៍ និងបុរេប្រទាន (b) Loans, overdrafts and other advances (b)",
						2:mktmoney.formatNumber(FormationExp,2,2),
						3:mktmoney.formatNumber(FormationExp,2,2),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J38" : Decimal(FormationExp)
					})
		CurrentYear     =   0
		Losses          =   getGLValueForField(Branch, Period, 'LossDetermined', CurrencyDic, **Kargs)
		if Decimal(Losses) < 0:
			CurrentYear     -=  Decimal(Losses)
			SubTotalB       +=  Decimal(CurrentYear)
		
		Data.append({
						1:u"៣. ឧបករណ៍បំណុលដែលកាន់កាប់ដោយធនាគារដែលមានហត្ថលេខារបស់ភាគទុនិក គណៈនាយក និងភាគីសម្ព័ន្ធញ្ញាតិ (c)\nDebt instruments held bearing signature of shareholders, directors, related parties ©",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J39" : Decimal(CurrentYear)
					})

		Data.append({
						1:u"ការខាតផ្សេងៗ Other Loss(ES)",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J41" : Decimal(CurrentYear)
					})

		Data.append({
						1:u"ធាតុ (a), (b) និង ( c) ត្រូវរាយការណ៍លម្អិតក្នុងរបាយការណ៍ដាច់ដោយឡែក \n(a), (b), and © to be itimized in an attachment",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J26" : Decimal(CurrentYear)
					})

		Data.append({
						1:u"សរុបរង B \n Sub-total B",
						2:u'%s' %(mktmoney.formatNumber(SubTotalB, 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(SubTotalB, 1, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})
		CoreCapitalABEn = SubTotal - SubTotalB
		CoreCapitalABKh = SubTotalKh - SubTotalB
		Data.append({
						1:u"សរុបដើមទុនថ្នាក់ទី១ (ដើមទុនស្នូល) = សរុបរង A - សរុបរង B Total Tier 1 (Core Capital) (A) - (B)",
						2:u'%s' %(mktmoney.formatNumber(float(CoreCapitalABEn), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CoreCapitalABKh), 1, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})

		Data.append({
						1:u"ដើមទុនថ្នាក់ទី២:  (ដើមទុនបំពេញបន្ថែម) Tier 2: (Complementary Capital)",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J26" : Decimal(CurrentYear)
					})

		# SubTOtalC   =   
		SubTOtalC   =   0

		Data.append({
						1:u"III. សរុបរង C: (ខ្ទង់ ត្រូវបូក ) Sub-Total C",
						2:u'',
						3:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})

		Data.append({
						1:u"ការវាយតមៃ្លទុនបំរុងឡើងវិញ (ដោយមានការយល់ព្រមជាមុនពីធនាគារជាតិនៃកម្ពុជា)\nReevaluation Reserves (NBC's Approval ref.)",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J52" : Decimal(CurrentYear)
					})

		Data.append({
						1:u"សំវិធានធនសម្រាប់ហានិភ័យទូទៅរបស់ធនាគារ (ដោយមានការយល់ព្រមជាមុនពីធនាគារជាតិនៃកម្ពុជា)\nProvisions for general banking risks (NBC's Approval ref.)",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J54" : Decimal(CurrentYear)
					})

		AA = 1000000/ ReportingRate
		Subordinated    =   getGLValueForField(Branch, Period, 'Subordinated', CurrencyDic, **Kargs)
		SubordinatedEn    =   getGLValueForField(Branch, Period, 'Subordinated', CurrencyDic, **Kargs)
		SubordinatedEn = SubordinatedEn *AA /1000
		Data.append({
						1:u"សំវិធានធនទូទៅ១% (ប្រកាសស្តីពីការធ្វើចំណាត់ថ្នាក់ និងសំវិធានធនលើទ្រព្យសកម្មរបស់គ្រឹះស្ថានធនាគារ\nនិងហិរញ្ញវត្ថុ) 1% General Provision (Prakas on Asset Class).)",
						2:u'%s' %(mktmoney.formatNumber(float(SubordinatedEn),1,2)),
						3:u'%s' %(mktmoney.formatNumber(float(Subordinated), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J56" : Decimal(SubordinatedEn)
					})

		Data.append({
						1:u"ឧបករណ៍បំណុលបន្ទាប់បន្សំ (ត្រូវបំពេញឲ្យតាមលក្ខខណ្ឌ ដូចមានចែងក្នុងប្រការ៧)\nSubordinated Debt Instruments (Provided complying with condition set forth in article 7)",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J58" : Decimal(CurrentYear)
					})

		Data.append({
						1:u"ខ្ទង់ដទៃទៀត (ត្រូវរៀបរាប់លំអិត ​និងមានការយល់ព្រមជាមុនពីធនាគារជាតិនៃកម្ពុជា)\nOther Items (to be detailed and supported)",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J26" : Decimal(CurrentYear)
					})

		Data.append({
						1:u"១. សេចក្តីយោងនិងការអនុញ្ញាតរបស់ធនាគារជាតិនៃកម្ពុជា Provide reference of NBC's authority/approval",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J62" : Decimal(CurrentYear)
					})

		Data.append({
						1:u"២. សេចក្តីយោងនិងការអនុញ្ញាតរបស់ធនាគារជាតិនៃកម្ពុជា ។ល។ Provide reference of NBC's authority/approval",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J63" : Decimal(CurrentYear)
					})
		SubTOtalC 		+= SubordinatedEn
		SubTOtalCKh 	+= Subordinated
		Data.append({
						1:u"សរុបរង C\nSub-total C",
						2:u'%s' %(mktmoney.formatNumber(float(SubTOtalC),1,2)),
						3:u'%s' %(mktmoney.formatNumber(float(SubTOtalCKh),1,2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		Data.append({
						1:u"កម្រិតកំណត់លើបំណុលបន្ទាប់បន្សំ (អតិបរមា៥០% នៃដើមទុនថ្នាក់ទីមួយ )\nLimit check on subordinated debt (max. 50% of Tier 1 Capital)",
						2:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J26" : Decimal(CurrentYear)
					})


		SubTotalD   =   0

		Data.append({
						1:u'IV. សរុបរង D (ដើមទុនថា្នក់ទី២,​ ខ្ទង់ត្រូវដក) Sub-Total D (Tier 2, Deductions)',
						2:u'',
						3:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})
		RevaluationReserv = getGLValueForField(Branch, Period, 'RevaluationReserv', CurrencyDic, **Kargs)
		SubTotalD   +=   RevaluationReserv

		Data.append({
						1:u"ការចូលភាគកម្មតាមតម្លៃសុទ្ធចុះបញ្ជីក្នុងគ្រឹះស្ថានធនាគារ ឬហិរញ្ញវត្ថុ Equity Participations Bank & Fin. Instit.",
						2:u'%s' %(mktmoney.formatNumber(float(RevaluationReserv), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(RevaluationReserv), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J72" : Decimal(RevaluationReserv)
					})

		OtherItemsOfSubTotalD =   getGLValueForField(Branch, Period, 'OtherItemsOfSubTotalD', CurrencyDic, **Kargs)
		SubTotalD   +=   RevaluationReserv

		Data.append({
						1:u"ខ្ទង់ផ្សេងទៀត ដូចជាបន្ទុកចំណាយដែលត្រូវបង់ Other Items to be Deducted (def. Charg.,…)",
						2:u'%s' %(mktmoney.formatNumber(float(RevaluationReserv), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(RevaluationReserv), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J73" : Decimal(RevaluationReserv)
					})

		Data.append({
						1:u"សរុបរង D\nSub-total D",
						2:u'%s' %SubTotalD,
						3:u'%s' %SubTotalD,
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})
		FullTotalCD = SubTOtalC - SubTotalD
		FullTotalCDEn = SubTOtalCKh - SubTotalD
		Data.append({
						1:u'សរុបដើមទុនថា្នក់ទី2  (ដើមទុនត្រូវបំពេញ) (C) - (D) Total Teir 2 (Compl. Capital) ( C) - (D)',
						2:u'%s' %(mktmoney.formatNumber(float(FullTotalCD), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(FullTotalCDEn), 1, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})
		CoreCapitalCDEn =  FullTotalCD / CoreCapitalABEn * 100
		CoreCapitalCDKh =  FullTotalCDEn / CoreCapitalABKh * 100
		Data.append({
						1:u"កម្រិតលើដើមទុនថា្នក់ទី២ (ដើមទុនថា្នក់ទី2 = អតិបរមា ១០០ % នៃដើមទុនថា្នក់ទី១)\nLimit check on Tier 2 Capital (Teir 2 = max. 100% of Tier 1)",
						2:u'%s' %(mktmoney.formatNumber(float(CoreCapitalCDEn), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(CoreCapitalCDKh), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J31" : ''
					})

		RegulationNetworthEn   =   CoreCapitalABEn + FullTotalCD
		RegulationNetworthKh   =   CoreCapitalABKh + FullTotalCDEn
		Data.append({
						1:u"ការគណនាមូលនិធិផា្ទល់សុទ្ធ [(A) - (B) + (C) - (D)] Regulation Net Worth [(A)-(B)+( C)-(D)]",
						2:u'%s' %(mktmoney.formatNumber(float(RegulationNetworthEn), 1, 2)),
						3:u'%s' %(mktmoney.formatNumber(float(RegulationNetworthKh), 1, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"J82" : Decimal(RegulationNetworthEn)
					})
# 		
		Result.update({'TableHeader':TableHeader,'ReportHeader':ReportHeader,'Data':Data, 'Excel': Excel})
		if NBCN011:
			return RegulationNetworthKh
		CellSyle = {
					
		 			}
		# if NBCN011==True:
		# 	return SubTOtalC
		return Result,CellSyle

	except Exception, e:
		raise

def getLoanContract():
	ReadAs 			= 1000000
	LoanPartyID 	= mktsetting.getAppSetting('NBCInsiderOtherPartyLoan')
	LoanObj = db.session.query(	MKT_LOAN_CONTRACT.Branch,
								MKT_LOAN_CONTRACT.ID,
								MKT_LOAN_CONTRACT.ContractCustomerID,
								MKT_CUSTOMER.FirstNameEn,
								MKT_CUSTOMER.LastNameEn,
								MKT_CUSTOMER.FirstNameKh,
								MKT_CUSTOMER.LastNameKh,
								MKT_CUSTOMER.Province,
								MKT_CUSTOMER.District,
								MKT_CUSTOMER.Commune,
								MKT_CUSTOMER.Village,
								MKT_LOAN_CONTRACT.LoanProduct,
								MKT_LOAN_PRODUCT.Description.label('LoanProductDescription'),
								MKT_LOAN_CONTRACT.LoanPurpose,
								MKT_LOAN_CONTRACT.Currency,
								(MKT_LOAN_CONTRACT.Disbursed * cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label('Disbursed'),
								MKT_LOAN_CONTRACT.ValueDate,
								MKT_LOAN_CONTRACT.MaturityDate,
								MKT_LOAN_CONTRACT.InterestRate,
								(MKT_LOAN_CONTRACT.OutstandingAmount * cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label("OutstandingAmount"),
								(MKT_LOAN_CONTRACT.ApprovedAmount * cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label('ApprovedAmount')
						).\
						join(MKT_CUSTOMER, MKT_CUSTOMER.ID == MKT_LOAN_CONTRACT.ContractCustomerID).\
						join(MKT_LOAN_PRODUCT, MKT_LOAN_PRODUCT.ID==MKT_LOAN_CONTRACT.LoanProduct).\
						join(MKT_CURRENCY, MKT_CURRENCY.ID==MKT_LOAN_CONTRACT.Currency).\
						filter(MKT_LOAN_CONTRACT.LoanProduct==LoanPartyID).\
						filter(MKT_LOAN_CONTRACT.DisbursedStat =='Y').all()
	return LoanObj
