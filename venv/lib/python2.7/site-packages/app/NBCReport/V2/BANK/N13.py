# -*- coding: utf-8 -*-
'''
Report Name: 	MONTHLY REPORT ON CREDIT CLASSIFICATION
				Sub Standard Loan (Provisioning 10%)"
				
URL 		: 	/Morakot/Report/NBC/N13
'''


from app.mktcore.imports 		import *
import app.tools.mktmessage 	as mktmessage
import app.tools.mktdate		as mktdate
import app.tools.mktnbc			as mktnbc
import app.tools.mktmoney		as mktmoney
from decimal import Decimal
from app.GLBalance.models 		import MKT_GL_BALANCE, MKT_GL_BALANCE_BACKUP
from app.LoanContract.models 	import *
from app.Customer.models 		import *
from app.IdType.models	 		import *
from app.LoanProduct.models 	import *
from app.Industry.models 		import *
from app.Collateral.models 		import *
from app.CollateralType.models 	import *
from app.LoanApplication.models import *
from app.Currency.models 		import *
from app.AssetClass.models 		import *
from app.Sector.models 			import *
from app.LoanAmendment.models 	import *
from .BankSetting 				import *


def getBANK13(ReportID,Branch,ReportedDate):
	try:
		''' This function must return result like below:
			Result = {
				'Data': 		Data,
				'Excel': 		Excel,
				'ReportHeader': ReportHeader,
				'TableHeader': 	TableHeader
				}
		'''
		Result			=   {}
		Data 			= 	[]
		Excel 			= 	{}
		TableHeader 	= 	{}
		LimitObj = {}
		StartLine = {}
		TableHeader = mktnbc.setTableHeader(Text=u'ល.រ\nNo.', 
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"អតិថិជន\nBorrowers", 
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"អត្តសញ្ញាណប័ណ្ណ/​​​ លិខិតឆ្លងដែន\nID Number/ Passport",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"លេខគណនីបំណុល\nAccount Number",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"អាជីវកម្ម\nBusiness",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"ប្រភេទឥណទាន\nTypes of Loan",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"កម្រិតអនុម័ន\nApproved Limit",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"ឥណទានជាក់ស្តែង\nOutstanding Loan",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"អត្រាការប្រាក់\nInterest Rate",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"ការប្រាក់បង្គរ\nAccrued Interest",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"សំវិធានធន\nProvision",
									 Rowspan=2,Colspan=0,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"រយៈពេលឥណទាន\nLoan Period",
									 Rowspan='',Colspan=2,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"វត្ថុបញ្ចាំ\nCollateral",
									 Rowspan='',Colspan=3,RowIndex=1, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"ចាប់ផើ្តម\nDisburse",
									 Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"កាលវសាន្ត\nMaturity",
									 Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"ប្រភេទ\nType",
									 Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader)

		TableHeader = mktnbc.setTableHeader(Text=u"តម្លៃ\nValue",
									 Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader)


		if ReportID == "13":

			ReportName 		=	u'MONTHLY REPORT ON CREDIT CLASSIFICATION',
			Title 			=	u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន',
			Form 			=	u'Special',
			SubTitleReport 	=	u'ឥណទានឃាំ្លមើល (សំវិធានធន ៣%)\n Special Mention Loan (Provisioning 3%)'
			AssetClass 		= '20'
			LimitObj.update({'NumOfSecuredLC':101,'NumOfUnSecuredLC':5,'StartLineSecuredLC':122,'StartLineUnSecuredLC':17})

		elif ReportID == "14":
			ReportName 		=	u'MONTHLY REPORT ON CREDIT CLASSIFICATION',
			Title 			=	u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន',
			Form 			=	u'Substandard',
			SubTitleReport 	=	u'ឥណទានក្រោមស្តង់ដា (សំវិធានធន ២០%)\n Substandard Loan (Provisioning 20%)' 
			AssetClass 		= '30'
			LimitObj.update({'NumOfSecuredLC':103,'NumOfUnSecuredLC':25,'StartLineSecuredLC':112,'StartLineUnSecuredLC':15})

		elif ReportID == "15":
			ReportName 		= 'MONTHLY REPORT ON CREDIT CLASSIFICATION'
			Title 			= u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន'
			Form 			= 'Doubful Loan'
			SubTitleReport 	= u"ឥណទានសង្ស័យ (សំវិធានធន ៥០%) \n Doubtful Loan (Provisioning ៥0%)"
			AssetClass 		= '40'
			LimitObj.update({'NumOfSecuredLC':103,'NumOfUnSecuredLC':25,'StartLineSecuredLC':118,'StartLineUnSecuredLC':15})
		elif ReportID == "16":
			ReportName 		= 'MONTHLY REPORT ON CREDIT CLASSIFICATION'
			Title 			= u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន'
			Form 			= 'Loss'
			SubTitleReport 	= u"ឥណទានខាត់បង់ (សំវិធានធន ១០០%) \n Loss Loan (Provisioning 100%)"
			AssetClass 		= '50'
			LimitObj.update({'NumOfSecuredLC':103,'NumOfUnSecuredLC':25,'StartLineSecuredLC':118,'StartLineUnSecuredLC':15})

		ReportHeader 	=   mktnbc.getHeaderReport(	ReportName 		=	'%s' %ReportName,
													Title 			=	'%s' %Title,
													Form 			=	'%s' %Form,
													SubTitleReport 	=	'%s' %SubTitleReport )

		Data, Excel =	getLoan( ReportHeader, TableHeader,AssetClass,LimitObj)

		Result.update({'ReportHeader':ReportHeader,'TableHeader':TableHeader,'Data':Data,'Excel':Excel})
		if ReportID == "13":
			CellSyle = {

						'M11':'top*medium,FF000000',
						'O11':'top*medium,FF000000:right*medium,FF000000',
						'O14':'right*medium,FF000000:left*thin,FF000000',
						'C14':'left*thin,FF000000:right*thin,FF000000',
						'E14':'left*thin,FF000000:right*thin,FF000000',
						'G14':'left*thin,FF000000:right*thin,FF000000',
						'I14':'left*thin,FF000000:right*thin,FF000000',
						'K14':'left*thin,FF000000:right*thin,FF000000',
						'M14':'left*thin,FF000000:right*thin,FF000000',
						'B127':'top*medium,FF000000:bottom*medium,FF000000',
						'B128':'bottom*medium,FF000000',
						'C128':'bottom*medium,FF000000',
						'D128':'bottom*medium,FF000000',
						'E128':'bottom*medium,FF000000',
						'F128':'bottom*medium,FF000000',
						}
		elif ReportID == "14":
			CellSyle = {
						'M11':'top*medium,FF000000',
						'O11':'top*medium,FF000000:right*medium,FF000000',
						'O14':'right*medium,FF000000:left*thin,FF000000',
						'C14':'left*thin,FF000000:right*thin,FF000000',
						'E14':'left*thin,FF000000:right*thin,FF000000',
						'G14':'left*thin,FF000000:right*thin,FF000000',
						'I14':'left*thin,FF000000:right*thin,FF000000',
						'K14':'left*thin,FF000000:right*thin,FF000000',
						'M14':'left*thin,FF000000:right*thin,FF000000',
						'B138':'top*medium,FF000000:bottom*medium,FF000000',
						'B139':'bottom*medium,FF000000',
						'C139':'bottom*medium,FF000000',
						'D139':'bottom*medium,FF000000',
						'E139':'bottom*medium,FF000000',
						'F139':'bottom*medium,FF000000',
						}
		elif ReportID == "15":
			CellSyle = {
						'M11':'top*medium,FF000000',
						'O11':'top*medium,FF000000:right*medium,FF000000',
						'O14':'right*medium,FF000000:left*thin,FF000000',
						'C14':'left*thin,FF000000:right*thin,FF000000',
						'E14':'left*thin,FF000000:right*thin,FF000000',
						'G14':'left*thin,FF000000:right*thin,FF000000',
						'I14':'left*thin,FF000000:right*thin,FF000000',
						'K14':'left*thin,FF000000:right*thin,FF000000',
						'M14':'left*thin,FF000000:right*thin,FF000000',
						'B136':'top*medium,FF000000:bottom*medium,FF000000',
						'B137':'bottom*medium,FF000000',
						'C137':'bottom*medium,FF000000',
						'D137':'bottom*medium,FF000000',
						'E137':'bottom*medium,FF000000',
						'F137':'bottom*medium,FF000000',
						}
		elif ReportID == "16":
			CellSyle = {
						'M11':'top*medium,FF000000',
						'O11':'top*medium,FF000000:right*medium,FF000000',
						'O14':'right*medium,FF000000:left*thin,FF000000',
						'C14':'left*thin,FF000000:right*thin,FF000000',
						'E14':'left*thin,FF000000:right*thin,FF000000',
						'G14':'left*thin,FF000000:right*thin,FF000000',
						'I14':'left*thin,FF000000:right*thin,FF000000',
						'K14':'left*thin,FF000000:right*thin,FF000000',
						'M14':'left*thin,FF000000:right*thin,FF000000',
						'B137':'top*medium,FF000000:bottom*medium,FF000000',
						'B138':'bottom*medium,FF000000',
						'C138':'bottom*medium,FF000000',
						'D138':'bottom*medium,FF000000',
						'E138':'bottom*medium,FF000000',
						'F138':'bottom*medium,FF000000',
						}
		return Result,CellSyle
	except:
		raise

def getLoan(ReportHeader, TableHeader,AssetClass,LimitObj):
	RecordRow 	= []
	ExcelRecord 	= {}
	ReportedDate		=	ReportHeader.get('ReportedDate',"")
	ExcelRecord.update({
				"A4" : u'As of:  %s'% mktdate.formatDate(ReportedDate,'%d %B %Y'),
				"C5" : ((ReportHeader.get('CompanyName',"")).splitlines())[0],
				"C6" : ((ReportHeader.get('CompanyName',"")).splitlines())[1],
				"K8" : u'%s'%Decimal(ReportHeader.get('ReportingRate',0)),
				"K9" : u'%s'%Decimal(ReportHeader.get('ReportingRate',0)),
			})
	try:
		
		RecordRow.append({
							1:u"",
							2:u'១. ឥណទានមិនវត្ថុបញ្ចាំ\n1. Unsecured Loan',
							3:u'',
							4:u'',
							5:u'',
							6:u'',
							7:u'',
							8:u'',
							9:u'',
							10:u'',
							11:u'',
							12:u'',
							13:u'',
							14:u'',
							15:u'',
							'LineType':'GH',
							'Indent':0,
							'RowBGColor':mktnbc.BG_BODY_COLOR,
							'LineFormat':'bold'
						})
		CurrencyDic = 	ReportHeader['DicExchangeRate'] 
		i = 1
		# Default first cell in Excel file (Un-Secure)
		CellRow 	= 15
		TotApprovedAmountUnSecure 	= 0
		TotOutstandingUnSecure 		= 0
		TotValuationPriceUnSecure 	= 0
		TotAccrInterestUnSecure		= 0
		TotProvisionUnSecure		= 0

		TotApprovedAmountSecure 	= 0
		TotOutstandingSecure 		= 0
		TotValuationPriceSecure 	= 0
		TotAccrInterestSecure		= 0
		TotProvisionSecure			= 0
		SectorN13 				= mktsetting.getAppSetting('SectorN13')
		NumOfSecuredLC 			= LimitObj.get('NumOfSecuredLC',0)
		NumOfUnSecuredLC 		= LimitObj.get('NumOfUnSecuredLC',0)
		StartLineSecuredLC 		= LimitObj.get('StartLineSecuredLC',0)
		StartLineUnSecuredLC 	= LimitObj.get('StartLineUnSecuredLC',0)
		CellRow = StartLineUnSecuredLC
		LoanObj = getLoanContract(AssetClass, False);
		if LoanObj:
			# Unsecured Loan
			for Loan in LoanObj:
				FullName 		= '%s %s - %s %s' %(Loan.LastNameEn, Loan.FirstNameEn, Loan.LastNameKh, Loan.FirstNameKh)
				IDNumber 		= '%s'%(Loan.IDNumber)
				Position 		= Loan.Position 
				if SectorN13:
					Position = Loan.Sector
				# if Loan.Operation=='AMT':
				# 	TypeOfLoan = 'Reschedule'
				# else:
				# 	TypeOfLoan = 'Installment'
				TypeOfLoan = 'Term Loan'
				ApprovedAmount 	= Loan.ApprovedAmount 
				Outstanding 	= Loan.OutstandingAmount
				AccrInterest 	= Loan.AccrInterest 
				InterestRate 	= Loan.InterestRate
				Provisioning 	= Loan.Provisioning
				ValuationPrice 	= Loan.ValuationPrice if Loan.ValuationPrice else 0
				Collateral 		= Loan.CollaterType if Loan.CollaterType else ''
				ValueDate 		= Loan.ValueDate
				MaturityDate 	= Loan.MaturityDate
				TotApprovedAmountUnSecure 	+= float(mktmoney.formatNumber(ApprovedAmount,0))
				TotOutstandingUnSecure 		+= float(mktmoney.formatNumber(Outstanding,0))
				TotValuationPriceUnSecure 	+= float(mktmoney.formatNumber(ValuationPrice,0))
				TotAccrInterestUnSecure		+= float(mktmoney.formatNumber(AccrInterest,0))
				TotProvisionUnSecure		+= float(mktmoney.formatNumber(Provisioning,0))
				
				RecordRow.append({
								1:str(i),
								2: FullName,
								3:IDNumber,
								4:Loan.LegacyID,
								5:Position,
								6:TypeOfLoan,
								7:mktmoney.formatNumber(ApprovedAmount,0),
								8:mktmoney.formatNumber(Outstanding,0),
								9:'%s %s' %(InterestRate,'%'),
								10:mktmoney.formatNumber(AccrInterest,0),
								11:mktmoney.formatNumber(Provisioning,0),
								12:formatDateNBC(ValueDate),
								13:formatDateNBC(MaturityDate),
								14:Collateral,
								15:mktmoney.formatNumber(ValuationPrice,0),
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':'',
								'LineFormat':''
							})

				ExcelRecord.update({
					"A%s"%(CellRow) : str(i),
					"B%s"%(CellRow) : FullName,
					"C%s"%(CellRow) : IDNumber,
					"D%s"%(CellRow) : Loan.LegacyID,
					"E%s"%(CellRow) : Position,
					"F%s"%(CellRow) : TypeOfLoan,
					"G%s"%(CellRow) : float(str(mktmoney.formatNumber(ApprovedAmount)).replace(',','')),
					"H%s"%(CellRow) : float(str(mktmoney.formatNumber(Outstanding)).replace(',','')),
					"I%s"%(CellRow) : '%s %s' %(InterestRate,'%'),
					"J%s"%(CellRow) : float(str(mktmoney.formatNumber(AccrInterest)).replace(',','')),
					"K%s"%(CellRow) : float(str(mktmoney.formatNumber(Provisioning)).replace(',','')),
					"L%s"%(CellRow) : formatDateNBC(ValueDate),
					"M%s"%(CellRow) : formatDateNBC(MaturityDate),
					"N%s"%(CellRow) : Collateral,
					"O%s"%(CellRow) : float(str(mktmoney.formatNumber(ValuationPrice,0)).replace(',','')),
				})
				i+=1
				CellRow+=1

		if i < NumOfSecuredLC:
			while i <= NumOfSecuredLC:
				RecordRow.append({
									1:str(i),
									2:u"",
									3:'',
									4:'',
									5:'',
									6:'',
									7:'',
									8:'',
									9:'',
									10:'',
									11:'',
									12:'',
									13:'',
									14:'',
									15:'',
									'LineType':'GH',
									'Indent':0,
									'RowBGColor':'',
									'LineFormat':''
								})
				i +=1
				CellRow+=1
		RecordRow.append({
								1:'',
								2:u"សរុប\nTOTAL",
								3:'',
								4:'',
								5:'',
								6:'',
								7:u'%s' %TotApprovedAmountUnSecure,
								8:u'%s' %TotOutstandingUnSecure,
								9:'',
								10:u'%s' %TotAccrInterestUnSecure,
								11:u'%s' %TotProvisionUnSecure,
								12:'',
								13:'',
								14:'',
								15:u'%s' %TotValuationPriceUnSecure,
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':mktnbc.BG_BODY_COLOR,
								'LineFormat':'bold'
							})
		RecordRow.append({
							1:u"",
							2:u"២. ឥណទានមានវត្ថុបញ្ចាំ\n2. Secured Loan",
							3:u'',
							4:u'',
							5:u'',
							6:u'',
							7:u'',
							8:u'',
							9:u'',
							10:u'',
							11:u'',
							12:u'',
							13:u'',
							14:u'',
							15:u'',
							'LineType':'GH',
							'Indent':0,
							'RowBGColor':mktnbc.BG_BODY_COLOR,
							'LineFormat':'bold'
						})
		i = 1
		CellRowUn = 122
		TotalApprovedAmount = 0
		TotalOustanding 	= 0
		TotalAccrInterest 	= 0
		TotalProvision 		= 0
		TotalValuationPrice = 0
		TotApprovedAmountSecure 	= 0
		TotOutstandingSecure 		= 0
		TotValuationPriceSecure 	= 0
		TotAccrInterestSecure		= 0
		TotProvisionSecure			= 0
		CellRowUn = StartLineSecuredLC
		LoanObj = getLoanContract(AssetClass);
		if LoanObj:
			# Secured Loan
			for Loan in LoanObj:
				FullName 		= '%s %s - %s %s' %(Loan.LastNameEn, Loan.FirstNameEn, Loan.LastNameKh, Loan.FirstNameKh)
				IDNumber 		= '%s'%(Loan.IDNumber)
				Position 		= Loan.Position 
				if SectorN13:
					Position = Loan.Sector
				# if Loan.Operation=='AMT':
				# 	TypeOfLoan = 'Reschedule'
				# else:
				# 	TypeOfLoan = 'Installment'
				TypeOfLoan = 'Term Loan'
				ApprovedAmount 	= Loan.ApprovedAmount 
				Outstanding 	= Loan.OutstandingAmount
				AccrInterest 	= Loan.AccrInterest 
				InterestRate 	= Loan.InterestRate
				Provisioning 	= Loan.Provisioning
				ValuationPrice 	= Loan.ValuationPrice if Loan.ValuationPrice else 0
				Collateral 		= Loan.CollaterType if Loan.CollaterType else ''
				ValueDate 		= Loan.ValueDate
				MaturityDate 	= Loan.MaturityDate

				TotApprovedAmountSecure 	+= float(str(mktmoney.formatNumber(ApprovedAmount,0)).replace(',',''))
				TotOutstandingSecure 		+= float(str(mktmoney.formatNumber(Outstanding,0)).replace(',',''))
				TotValuationPriceSecure 	+= float(str(mktmoney.formatNumber(ValuationPrice,0)).replace(',',''))
				TotAccrInterestSecure		+= float(str(mktmoney.formatNumber(AccrInterest,0)).replace(',',''))
				TotProvisionSecure			+= float(str(mktmoney.formatNumber(Provisioning,0)).replace(',',''))
				
				RecordRow.append({
								1:str(i),
								2: FullName,
								3:IDNumber,
								4:Loan.LegacyID,
								5:Position,
								6:TypeOfLoan,
								7:mktmoney.formatNumber(ApprovedAmount),
								8:mktmoney.formatNumber(Outstanding),
								9:'%s %s' %(InterestRate,'%'),
								10:mktmoney.formatNumber(AccrInterest),
								11:mktmoney.formatNumber(Provisioning),
								12:formatDateNBC(ValueDate),
								13:formatDateNBC(MaturityDate),
								14:Collateral,
								15:mktmoney.formatNumber(ValuationPrice,0),
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':'',
								'LineFormat':''
							})
				print 'CellRow',i,CellRow
				ExcelRecord.update({
					"A%s"%(CellRowUn) : str(i),
					"B%s"%(CellRowUn) : FullName,
					"C%s"%(CellRowUn) : IDNumber,
					"D%s"%(CellRowUn) : Loan.LegacyID,
					"E%s"%(CellRowUn) : Position,
					"F%s"%(CellRowUn) : TypeOfLoan,
					"G%s"%(CellRowUn) : float(str(mktmoney.formatNumber(ApprovedAmount)).replace(',','')),
					"H%s"%(CellRowUn) : float(str(mktmoney.formatNumber(Outstanding)).replace(',','')),
					"I%s"%(CellRowUn) : '%s %s' %(InterestRate,'%'),
					"J%s"%(CellRowUn) : float(str(mktmoney.formatNumber(AccrInterest)).replace(',','')),
					"K%s"%(CellRowUn) : float(str(mktmoney.formatNumber(Provisioning)).replace(',','')),
					"L%s"%(CellRowUn) : formatDateNBC(ValueDate),
					"M%s"%(CellRowUn) : formatDateNBC(MaturityDate),
					"N%s"%(CellRowUn) : Collateral,
					"O%s"%(CellRowUn) : float(str(mktmoney.formatNumber(ValuationPrice,0)).replace(',','')),
				})
				i+=1
				CellRowUn+=1
				if i > 5 :
					break

		if i < NumOfUnSecuredLC:
			while i <= NumOfUnSecuredLC:
				RecordRow.append({
									1:str(i),
									2:u"",
									3:'',
									4:'',
									5:'',
									6:'',
									7:'',
									8:'',
									9:'',
									10:'',
									11:'',
									12:'',
									13:'',
									14:'',
									15:'',
									'LineType':'GH',
									'Indent':0,
									'RowBGColor':'',
									'LineFormat':''
								})
				i +=1
				CellRowUn+=1
		RecordRow.append({
								1:'',
								2:u"សរុប\nTOTAL",
								3:'',
								4:'',
								5:'',
								6:'',
								7:u'%s' %TotApprovedAmountSecure,
								8:u'%s' %TotOutstandingSecure,
								9:'',
								10:u'%s' %TotAccrInterestSecure,
								11:u'%s' %TotProvisionSecure,
								12:'',
								13:'',
								14:'',
								15:u'%s' %TotValuationPriceSecure,
								'LineType':'GH',
								'Indent':0,
								'RowBGColor':mktnbc.BG_BODY_COLOR,
								'LineFormat':'bold'
							})
			
		return RecordRow,ExcelRecord
	except Exception, e:
		raise
	else:
		pass
	finally:
		pass


def getLoanContract(AssetClass,Secured=True):
	ReadAs 		= 1000000
	CollateralVaule = db.session.query(MKT_COLLATERAL_DE.CollateralID,
										MKT_COLLATERAL_DE.CollateralType,
										func.sum(MKT_COLLATERAL_DE.ValuationPrice).label('ValuationPrice')).\
										group_by(MKT_COLLATERAL_DE.CollateralID,MKT_COLLATERAL_DE.CollateralType).subquery()
	LoanObj = db.session.query(
								MKT_LOAN_CONTRACT.ID,
								MKT_LOAN_CONTRACT.LegacyID.label('LegacyID'),
								MKT_LOAN_CONTRACT.Currency,
								MKT_LOAN_COLLATERAL.Collateral.label('ColID')	,
								MKT_CUSTOMER.FirstNameEn,
								MKT_CUSTOMER.LastNameEn,
								MKT_CUSTOMER.FirstNameKh,
								MKT_CUSTOMER.LastNameKh,
								MKT_CUSTOMER.IDNumber,
								MKT_COLLATERAL_TYPE.Description.label('CollaterType'),
								MKT_LOAN_AMENDMENT.Operation,
								MKT_SECTOR.Description.label('Sector'),
								MKT_ID_TYPE.Description.label('IDType'),
								MKT_INDUSTRY.Description.label('Position'),
								MKT_LOAN_PRODUCT.Description.label('LoanProduct'),
								(MKT_LOAN_CONTRACT.ApprovedAmount* cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label('ApprovedAmount'),
								(MKT_LOAN_CONTRACT.OutstandingAmount * cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label('OutstandingAmount') ,
								MKT_LOAN_CONTRACT.InterestRate,
								(MKT_LOAN_CONTRACT.AccrInterest* cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label('AccrInterest') ,
								case(
									[(
										MKT_LOAN_CONTRACT.AssetClass.in_(['20','30','40']),
										MKT_LOAN_CONTRACT.OutstandingAmount * cast(MKT_CURRENCY.OtherRate1, Float) * cast(MKT_ASSET_CLASS_PRO.ProvPerc, Float)/100/ReadAs
									)],
								else_=0
								).label('Provisioning'),
								MKT_LOAN_CONTRACT.ValueDate,
								MKT_LOAN_CONTRACT.MaturityDate,
								MKT_LOAN_COLLATERAL.ID.label('CollateralID'),
								MKT_COLLATERAL.Description.label('Collateral'),
								(CollateralVaule.c.ValuationPrice* cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label('ValuationPrice')
							).\
							join(MKT_CUSTOMER, MKT_CUSTOMER.ID==MKT_LOAN_CONTRACT.ContractCustomerID).\
							join(MKT_LOAN_PRODUCT,MKT_LOAN_PRODUCT.ID==MKT_LOAN_CONTRACT.LoanProduct).\
							join(MKT_CURRENCY,MKT_LOAN_CONTRACT.Currency==MKT_CURRENCY.ID).\
							outerjoin(MKT_ASSET_CLASS_PRO, MKT_LOAN_CONTRACT.AssetClass==MKT_ASSET_CLASS_PRO.ID).\
							outerjoin(MKT_LOAN_AMENDMENT, MKT_LOAN_AMENDMENT.LoanID==MKT_LOAN_CONTRACT.ID).\
							outerjoin(MKT_SECTOR, MKT_SECTOR.ID==MKT_LOAN_CONTRACT.Sector).\
							outerjoin(MKT_ID_TYPE,MKT_CUSTOMER.IDType==MKT_ID_TYPE.ID).\
							outerjoin(MKT_INDUSTRY,MKT_CUSTOMER.Industry==MKT_INDUSTRY.ID).\
							outerjoin(MKT_LOAN_COLLATERAL,MKT_LOAN_COLLATERAL.ID==MKT_LOAN_CONTRACT.ID).\
							outerjoin(CollateralVaule,CollateralVaule.c.CollateralID==MKT_LOAN_COLLATERAL.Collateral).\
							outerjoin(MKT_COLLATERAL_TYPE,MKT_COLLATERAL_TYPE.ID==CollateralVaule.c.CollateralType).\
							outerjoin(MKT_COLLATERAL, MKT_COLLATERAL.ID==CollateralVaule.c.CollateralID).\
							filter(MKT_LOAN_CONTRACT.AssetClass == AssetClass).\
							distinct(MKT_LOAN_CONTRACT.ID).\
							limit(30).\
							subquery()
	if Secured != False:
		LoanObj = db.session.query(LoanObj).\
									filter(LoanObj.c.ColID != None).subquery()
	else:
		LoanObj = db.session.query(LoanObj).\
									filter(LoanObj.c.ColID == None).subquery()
	LoanObj = db.session.query(LoanObj).all()
	return LoanObj

