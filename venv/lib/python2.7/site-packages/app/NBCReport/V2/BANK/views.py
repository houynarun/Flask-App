# -*- coding: utf-8 -*-
from app.mktcore.imports 		import *
from app.tools.mktdate 			import *
import app.tools.mktnbc 		as mktnbc
import os
from .N01 import *
from .N02 import *
from .N03 import *
from .N05 import *
from .N06 import *
from .N07 import *
from .N08 import *
from .N09 import *
from .N10 import *
from .N11 import *
from .N12 import *
from .N13 import *
from .N14 import *
from .N15 import *
from .N16 import *
from .N17 import *
from .N18 import *
from .N19 import *
from .N20 import *
from .N21 import *
from .N22 import *
from .N23 import *
from .N24 import *
from .N25 import *
from .N26 import *
from .N27 import *
from .N31 import *

try:
	from openpyxl import load_workbook
except Exception, e:
	pass

FILENAME = os.path.dirname(__file__)+'/EXCEL_BANK.xlsx'


def setReportList(**kwargs):
	Branch 			= kwargs.get("Branch", "ALL")
	ReportedDate 	= kwargs.get("ReportedDate","")
	Month 			= kwargs.get("Month","")
	Year			= kwargs.get("Year","")

	ReportList  = 	{ 	
						'01':{	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ទ្រព្យសកម្មនិងទ្រព្យអកម្ម',
								'English'	:'MONTHLY REPORT ON BALANCE SHEET',
								'Title'		:'NBC-BALANCE SHEET',
								'Result'	:'getBANK01(Branch, ReportedDate, 2, Month="", Year="")'
								},

						'02':{ 	'Khmer'		:u'របាយការណ៏ប្រចាំខែសី្តពី ចំណូល និងចំណាយ',
								'English'	:'MONTHLY REPORT ON INCOME STATEMENT',
								'Title'		:'NBC-INCOME STATEMENT',
								'Result'	:'getBANK02(Branch, ReportedDate, 1, Month="", Year="")'
								},

						'03':{	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ក្រៅតារាងតុល្យការ',
								'English'	:'MONTHLY REPORT ON OFF-BALANCE SHEET',
								'Title'		:'NBC-OFF BALANCE SHEET',
								'Result'	:'getBANK03(Branch, ReportedDate, 2, Month="", Year="")'
								},

						# '04':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ប្លង់គណនីឯកភាព',
						# 		'English'	:'',
						# 		'Title'		:'NBC-UNIFORM COA',
						# 		'Result'	:'getBANK04(Branch, ReportedDate, 2, Month="", Year="")'
						# 		},

						'05':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី អនុបាតសាធនភាព',
								'English'	:'MONTHLY REPORT ON SOLVENCY RATIO',
								'Title'		:'NBC-SOLVENCY RATIO',
								'Result'	:'getBANK05(Branch, ReportedDate, 2, Month="", Year="")'
								},

						'06':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ការគណនាមូលនិធិផ្ទាល់សុទ្ឌ',
								'English'	:'MONTHLY REPORT ON NET WORTH CALCULATION',
								'Title'		:'NBC-NET WORTH CALCULATION',
								'Result'	:'getBANK06(Branch, ReportedDate, 2, Month="", Year="")'
								},

						'07':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ស្ថានភាពចំហសុទ្ធ នៃរូបិយប៍ណ្ណ',
								'English'	:'MONTHLY REPORT ON NET OPEN POSITION',
								'Title'		:'NBC-NET OPEN POSITON',
								'Result'	:'getBANK07(Branch, ReportedDate)'
								},

						'08':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ហានិភ៍យធំៗរបស់ធនាគារ',
								'English'	:'MONTHLY REPORT ON LARGE EXPOSURES OF BANK',
								'Title'		:'NBC-LARGE EXPOSURES OF BANK',
								'Result'	:'getBANK08(Branch, ReportedDate, 2, Month="", Year="")'
								},
						'09':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំត្រីមាសស្តីពី ឥណទានចំពោះសម្ព៍ន្ធញ្ញាតិ',
								'English'	:'MONTHLY REPORT ON LOANS TO RELATED PARTIES',
								'Title'		:'NBC-LOANS TO RELATED PARTIESs',
								'Result'	:'getBANK09(Branch, ReportedDate, 2, Month="", Year="")'
								},

						'10':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ប្រភពទុនជាប្រាក់បញ្ញើសំរាប់ប្រើប្រាស់ក្នុងស្រុក',
								'English'	:'MONTHLY REPORT ON SOURSES OF FUNDS FROM DEPOSITS FOR LOCAL USE',
								'Title'		:'NBC-SOURSES OF FUNDS',
								'Result'	:'getBANK10(Branch, ReportedDate, 2, Month="", Year="")'
								},
						
						'11':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ទ្រពសម្បត្តិរឹបអូសតាមផ្លូវច្បាប់',
								'English'	:'MONTHLY REPORT ON  PROPERTIES ACQUIRED THROUGH FORECLOSURE',
								'Title'		:'NBC-PROPERTIES ACQUIRED',
								'Result'	:'getBANK11(Branch, ReportedDate, 2, Month="", Year="")'
								},

						'12':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន (ឥណទានស្តង់ដា)',
								'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Standard Loan)',
								'Title'		:'NBC-CREDIT CLASSIFICATION (Standard Loans)',
								'Result'	:'getBANK12(Branch, ReportedDate, 2, Month="", Year="")'
								},

						'13':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន - ឥណទានឃាំ្លមើល (សំវិធានធន ៣%)',
								'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Special Mention Loans)',
								'Title'		:'NBC-CREDIT CLASSIFICATION (Special Mention Loans)',
								'Result'	:'getBANK13("13",Branch,ReportedDate)'
								},

						'14':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន - ឥណទានក្រោមស្តង់ដា (សំវិធានធន ២០%)',
								'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Sub-Standard Loans)',
								'Title'		:'NBC-CREDIT CLASSIFICATION (Sub-Standard Loans)',
								'Result'	:'getBANK14(Branch, ReportedDate)'
								},

						'15':{ 	'Khmer'		:u'ររបាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន - ឥណទានខាត់បង់ (សំវិធានធន ៥០%)',
								'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Doubtful Loan)',
								'Title'		:'NBC-LOAN CLASSIFICATION',
								'Result'	:'getBANK15(Branch, ReportedDate)'
								},

						'16':{ 	'Khmer'		:u'ររបាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន​ - ឥណទានខាត់បង់ (សំវិធានធន ១០០%)',
								'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Loss Loan)',
								'Title'		:'NBC-LOAN CLASSIFICATION',
								'Result'	:'getBANK16(Branch, ReportedDate)'
								},

						'17':{ 'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ឥណទានតាមប្រភេទជំនួញនិងម្ចាស់កម្មសិទ្ធិក្នុងវិស៍យសេដ្ឋកិច្ច',
								'English'	:'MONTHLY REPORT ON CREDIT BY INDUSTRY AND OWNERSHIP IN THE ECONOMIC SECTOR',
								'Title'		:'NBC-CREDIT BY INDUSTRY AND OWNERSHIP IN THE ECONOMIC SECTOR',
								'Result'	:'getBANK17(Branch, ReportedDate)'
								},

						'18':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី អ្នកដាក់ប្រាក់បញ្ញើខ្ពស់បំផុតចំនួន​ ២០',
								'English'	:'MONTHLY REPORT ON TOP TWENTY DEPOSITORS',
								'Title'		:'NBC-TOP TWENTY DEPOSITORS',
								'Result'	:'getBANK18(Branch, ReportedDate)'
								},

						'19':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ប្រាក់បញ្ញើចំណាត់ថ្នាក់តាមប្រភេទ អតិថិជននិងរូបិយប៍ណ្ណ',
								'English'	:'MONTHLY REPORT ON DEPOSITS CLASSIFIED BY TYPES OF DEPOSITORS AND CURRENCIES',
								'Title'		:'NBC-DEPOSITS CLASSIFIED BY TYPES OF DEPOSITORS AND CURRENCIES',
								'Result'	:'getBANK19(Branch, ReportedDate)'
								},

						'20':{	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ប្រាក់បញ្ញើចំណាត់ថ្នាក់តាមប្រភេទ គណនីនិងទំហំទឹកប្រាក់',
								'English'	:'MONTHLY REPORT ON DEPOSITS CLASSIFIED BY TYPES OF ACCOUNTS AND DEPOSIT AMOUNTS',
								'Title'		:'NBC-DEPOSITS CLASSIFIED BY TYPES OF ACCOUNTS AND DEPOSIT AMOUNTS',
								'Result'	:'getBANK20(Branch, ReportedDate)'
								},

						'21':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី កាលវសាន្តនៃទ្រព្យសកម្មនិងទ្រព្យអកម្ម',
								'English'	:'MONTHLY REPORT ON MATURITY PROFILE',
								'Title'		:'NBC-MATURITY PROFILE',
								'Result'	:'getBANK21(Branch, ReportedDate)'
								},

						'22':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី លាភការរបស់គណៈគ្រប់គ្រង',
								'English'	:'MONTHLY REPORT ON REMUNERATION FOR MANAGEMENT',
								'Title'		:'NBC-MATURITY PROFILE',
								'Result'	:'getBANK22(Branch, ReportedDate)'
								},

						'23':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ទ្រព្យសកម្មឬទ្រព្យអកម្មសុទ្ធនៅធនាគារមេ ទីស្នាក់ការកណ្តាល ឬ​ សាខា',
								'English'	:'MONTHLY REPORT ON NET ASSETS OR LIABILITIES OF FOREIGN BANK TO ITS PARENT HEAD OFFICE OR AFFILIATES',
								'Title'		:'NBC-NET ASSETS OR LIABILITIES OF FOREIGN BANK TO ITS PARENT HEAD OFFICE OR AFFILIATES',
								'Result'	:'getBANK23(Branch, ReportedDate)'
								},

						'24':{ 'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពីការតាមដានមធ្យមភាគអត្រាការប្រាក់ក្រោយថ្លឹងចំពោះប្រាក់បញ្ញើនិងឥណទានថ្មីៗ',
								'English'	:'MONTHLY REPORT ON SUVERY CURRENT WEIGHTED AVERAGE INTEREST RATES ON NEW DEPOSITS AND LOANS',
								'Title'		:'NBC-SUVERY CURRENT WEIGHTED AVERAGE INTEREST RATES ON NEW DEPOSITS AND LOANS',
								'Result'	:'getBANK24(Branch, ReportedDate)'
								},

						'25':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី គំលាតវេទយិតភាពការប្រាក់',
								'English'	:'MONTHLY REPORT ON INTEREST SENSITIVITY GAP',
								'Title'		:'NBC-INTEREST SENSITIVITY GAP',
								'Result'	:'getBANK25(Branch, ReportedDate)'
								},

						'26':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី រូបិយវត្ថុ និងប្រតិបតិ្តការទីផ្សារអន្តរធនាគារ',
								'English'	:'MONTHLY REPORT ON MONEY AND INTERBANK MARKET TRANSACTION',
								'Title'		:'NBC-MONEY AND INTERBANK MARKET TRANSACTION',
								'Result'	:'getBANK26(Branch, ReportedDate)'
								},

						'27':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី បណ្តាញពត៌មាន',
								'English'	:'MONTHLY REPORT ON NETWORK INFORMATION',
								'Title'		:'NBC-NETWORK INFORMATION',
								'Result'	:'getBANK27(Branch, ReportedDate)'
								},

						# '28':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ប្លង់គណនីឯកភាព',
						# 		'English'	:'MONTHLY REPORT OF UNIFORM COA',
						# 		'Title'		:'NBC-UNIFORM COA',
						# 		'Result'	:'getBANK28(Branch, ReportedDate, 2, Month="", Year="")'
						# 		},

						# '29':{ 'Khmer'	:u'របាយការណ៍ប្រចាំខែស្តីពី ប្លង់គណនីឯកភាព',
						# 		'English'	:'MONTHLY REPORT OF UNIFORM COA SHORT',
						# 		'Title'		:'NBC-UNIFORM COA SHORT',
						# 		'Result'	:'getBANK29(Branch, ReportedDate, 2, Month="", Year="")'
						# 		},
								
						# '28':{ 	'Khmer'		:u'របាយការណ៏ប្រចាំខែ CALL REPORT SPREAD SHEET',
						# 		'English'	:'MONTHLY REPORT ON CALL REPORT ON SPREAD SHEET',
						# 		'Title'		:'NBC-CALL REPORT ON SPREAD SHEET',
						# 		'Result'	:'getBANK28(Branch, ReportedDate)'
						# 		},

						# '29':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពីអត្រាការប្រាក់',
						# 		'English'	:'MONTHLY REPORT ON INTEREST RATE ',
						# 		'Title'		:'NBC-INTEREST RATE',
						# 		'Result'	:'getBANK29(Branch, ReportedDate)'
						# 		},

						# '30':{ 	'Khmer'		:u'របាយការណ៏ប្រចាំខែស្តីពីសាជីវកម្មទទួលប្រាក់បញ្ញើផ្សេងៗ',
						# 		'English'	:'OTHER DEPOSITORY CORPORATIONS REPORT FORM',
						# 		'Title'		:'NBC-OTHER DEPOSITORY CORPORATIONS REPORT FORM',
						# 		'Result'	:'getBANK30(Branch, ReportedDate)'
						# 		},
						'31':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពីអត្រាការប្រាក់មធ្យមថ្លឹងចំពោះប្រាក់បញ្ញើនិងឥណទាន',
								'English'	:'MONTHLY REPORT ON WEIGHTED AVERAGE INTEREST RATES ON DEPOSITS AND LOANS ',
								'Title'		:'MONTHLY REPORT ON WEIGHTED AVERAGE INTEREST RATES ON DEPOSITS AND LOANS ',
								'Result'	:'getBANK31(Branch, ReportedDate)'
								}, 
						
						}

	return ReportList

@app.route('/Morakot/Report/NBC/BANK', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getNBCBANKReport():
	try:

		ErrorMsg 	= []
		getCheck 	= checkAccess("/Morakot/Report/NBC/BANK","Search")
		if getCheck != True: 
			ErrorMsg.append(msg_error+msg_permission)
			return render_template("permission.html",ErrorMsg=ErrorMsg)


		Branch 			=	request.args.get("Branch") if "Branch" in request.args else session.get("ChangeBranch")

		ReportList 	=	setReportList(	Branch 			= Branch)
		html        =   "nbc/v2/nbc.html"
		Title 		=	"Bank"
		Type 		=	"BANK"
		Function 	=	"getNBCBANKReport"

		return render_template(	html,
								ReportList 	= ReportList,
								Title 		= Title,
								Type 		= Type,
								Function 	= Function,
								sorted 		= sorted,
								Branch 		= Branch)

	except:
		raise

@app.route('/Morakot/Report/NBC/BANK/<ID>', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getNBCBANKReportDetail(ID):
	try:
		ErrorMsg    = []
		getCheck    = checkAccess("/Morakot/Report/NBC/BANK","Search")
		if getCheck != True: 
			ErrorMsg.append(msg_error+msg_permission)
			return render_template("permission.html",ErrorMsg=ErrorMsg)

		''' Setup parameters '''
		Branch 			=	request.args.get("Branch") if "Branch" in request.args else session.get("ChangeBranch")
		ReportedDate 	= mktnbc.getHeaderReport().get("ReportedDate","")
		Month 			= mktnbc.getHeaderReport().get("Month","")
		Year			= mktnbc.getHeaderReport().get("Year","")
		ReportList 	=	setReportList(	Branch 			= Branch, 
										ReportedDate 	= ReportedDate,
										Month 			= Month,
										Year 			= Year)

		Result , Style		=	eval(ReportList.get(ID,{}).get('Result',{}))
		Type 		= 	"BANK"
		Function 	=	"getNBCBANKReportDetail"
		html 		= 	"nbc/v2/nbc_master.html"

		return render_template(html,
								ID 				=	ID,
								str 			=	str,
								mktmoney 		=	mktmoney,
								float 			=	float,
								Branch 			=	Branch,
								Result 			=	Result,
								Type 			=	Type,
								Function 		=	Function
								)
		return Result
	except:
		raise
from openpyxl.styles import Border, Side

@app.route('/Morakot/Report/NBC/BANK/Excel', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getNBCBANKExcel():
	try:
		workbook = load_workbook(FILENAME, keep_links=False)

		''' Setup parameters '''
		Branch 			=	request.args.get("Branch") if "Branch" in request.args else session.get("ChangeBranch")
		ReportedDate 	= 	mktnbc.getHeaderReport().get("ReportedDate","")
		Month 			= 	mktnbc.getHeaderReport().get("Month","")
		Year			= 	mktnbc.getHeaderReport().get("Year","")
		
		ReportList 		= 	setReportList(	Branch 			= Branch, 
											ReportedDate 	= ReportedDate,
											Month 			= Month,
											Year 			= Year)

		for key,value in ReportList.iteritems():
			Result 		= eval(value.get('Result',{}))
			Excel 		= Result[0].get('Excel',{})
			SheetName 	= Result[0].get("ReportHeader",{}).get('Form',"")
			bs_sheet 	= mktnbc.getSheet(workbook, SheetName)

			mktnbc.setWriteWorkSheet(bs_sheet, Excel)
			setBorder(bs_sheet,Result[1])
			
		response = mktnbc.getExcelFile(workbook, 'NBC_REPORTS_BANK')

		return response
	except Exception as e:
		raise

def setBorder(Sheet,DictData):
	# Dict = {'G8':'left*thin,FF000000:right*thin,FF000000',
	# 'K7':'top*medium,FF000000',
	# 'L8':'bottom*thin,FF000000:right*thin,FF000000',
	# 'F25':'left*medium,FF000000'
	# }

	if Sheet:
		if isinstance(DictData, dict):

			for key, value in DictData.iteritems():
				Dict = {}
				Val1 = value.split(':')
				for v in Val1:
					Val2 = v.split('*')
					Val3 = Val2[1].split(',')
					Dict.update({Val2[0]:Side(border_style=Val3[0],color=Val3[1])})
				
				Sheet.cell(key).border = Border(**Dict)

""" Route to export each report to excel """
@app.route('/Morakot/Report/NBC/BANK/Excel/<ID>', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getNBCBANKSheet(ID):
	try:
		ID = str(ID)
		ReportName = 'NBC_REPORTS_BANK_%s'%ID
		if ID == '31':
			workbook = load_workbook(FILENAME1, keep_links=False)
			ReportName = 'NBC_REPORTS_BANK1_%s'%ID
		else:
			workbook = load_workbook(FILENAME, keep_links=False)

		''' Setup parameters '''
		Branch 			= request.args.get("Branch") if "Branch" in request.args else session.get("ChangeBranch")
		ReportedDate 	= mktnbc.getHeaderReport().get("ReportedDate","")
		Month 			= mktnbc.getHeaderReport().get("Month","")
		Year			= mktnbc.getHeaderReport().get("Year","")

		ReportList 		= 	setReportList(	Branch 			= Branch, 
											ReportedDate 	= ReportedDate,
											Month 			= Month,
											Year 			= Year)

		Result 		=	eval(ReportList.get(ID,{}).get('Result',{}))
		Excel 		= 	Result[0].get('Excel',{})
		SheetName 	= 	Result[0].get("ReportHeader",{}).get('Form',"")

		bs_sheet = mktnbc.getSheet(workbook, SheetName)
		mktnbc.setWriteWorkSheet(bs_sheet, Excel)
		setBorder(bs_sheet,Result[1])

		response = mktnbc.getExcelFile(workbook, ReportName)

		return response
	except Exception as e:
		raise

