# -*- coding: utf-8 -*-
'''
Report Name: Net Open Position
'''

from app.mktcore.imports 		import *
from app.GLBalance.models 		import MKT_GL_BALANCE, MKT_GL_BALANCE_BACKUP
from app.Currency.models		import MKT_CURRENCY

import app.tools.mktdate 		as mktdate
import app.tools.mktsetting 	as mktsetting
import app.tools.mktmoney 		as mktmoney
import app.tools.mktnbc			as mktnbc
import app.tools.mktgl 			as mktgl
import app.tools.mktmessage 	as mktmessage
from .N27 import 				 *
from decimal 					import Decimal
import app.NBCReport.V2.BANK.BankSetting  as NBCBankSetting

def getGLValueForField(Branch = "ALL", Period = 2,NBCBank10Key='', NBCExchangeRateDict={},**Kargs):
	return NBCBankSetting.getGLValueFromField(Branch, Period, "NBCBankN10",NBCBank10Key, NBCExchangeRateDict,**Kargs)


def getBANK10(Branch = "ALL", ReportedDate = "", Period = 2, Month = "", Year = ""):
	''' 
		This function must return result like below:
		Result = {
			'Data': 		Data,
			'Excel': 		Excel,
			'ReportHeader': ReportHeader,
			'TableHeader': 	TableHeader
			}
	'''

	try:
		ID 					= 	"N001" # ID of Report 01 Balance Sheet
		LiabilityEquityLine =	'133' # TOTAL LIABILITIES AND SHAREHOLDER’S EQUITY
		TotalAssetLine 		=	'70' # TOTAL ASSETS
		TotalEquityLine 	=	'123' # Shareholder’s Equities 
		CurrencyObj			=	MKT_CURRENCY.query
		ReadAs = 1000000
		Condition = []
		if Year and Month:
			GLTable   	= MKT_GL_BALANCE_BACKUP
			Condition 	= [GLTable.GLYear == Year,GLTable.GLMonth == Month]
			CYear 	  	= Year
			CMonth 	  	= Month
		else:
			GLTable   	= MKT_GL_BALANCE
			BankDate  	= mktdate.getBankDate()
			CYear 	  	= BankDate.year
			CMonth 	  	= BankDate.month

		GLObj 			= GLTable.query.filter(*Condition)
		Kargs			= {'GLTable':GLTable, 'GLObj':GLObj, 'FCY':True}
		Result 			= {}
		Data 			= []
		Excel 			= {}
		CurrencyDic     =   mktnbc.getNBCExchangeRate(CYear, CMonth)


		LineObj 		=	mktnbc.getNBCLineReport(ID, int(Period), Branch, ReportedDate, Year=Year, Month=Month)[0].get("Data",[])
		DataList 		=	mktnbc.getNBCLineDetail(ID, Branch, Period, GLTable=GLTable, GLObj=GLObj, Year=CYear, Month=CMonth)

		ReportHeader 	= {}
		ReportHeader 	= mktnbc.getHeaderReport(	ReportName 		=	u'MONTHLY REPORT ON SOURCES OF FUNDS FROM DEPOSITS FOR LOCAL USE',
													Title 			=	u'របាយការណ៍ប្រចាំខែស្តីពី ប្រភពទុនជាប្រាក់បញ្ញើសំរាប់​ប្រើប្រាស់ក្នុងស្រុក',
													Form 			=	'Source of Funds',
													)
		
		TableHeader 	= {}
		TableHeader 	= mktnbc.setTableHeader(Text=u'ពិពណ៌នា \n Description', 
                                            Rowspan=1,Colspan=1,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'រូបិយប័ណ្ណផ្សេងៗគិតជារៀល \n Foreign Curreny Translated in Riel', 
                                            Rowspan=1,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'រៀល \n Riel', 
                                            Rowspan=1,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'សរុប \n Total', 
                                            Rowspan=1,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		#----------------------------------------------------------------------------------------------------------------#
		
		ReportingRate = float(ReportHeader.get('ReportingRate',0))
		Excel.update({
				"A4" : u'As of:  %s'% mktdate.formatDate(ReportedDate,'%d %B %Y'),
				"E6" : ((ReportHeader.get('CompanyName',"")).splitlines())[0],
				"E7" : ((ReportHeader.get('CompanyName',"")).splitlines())[1],
				"H7" : u'%s'%ReportingRate,
				"H8" : u'%s'%ReportingRate
			})

		CellRow = 13
		# Block I.1
		Resident   					= getGLValueForField(Branch, Period, 'Resident', CurrencyDic, **Kargs)
		NonResident 				= getGLValueForField(Branch, Period, 'NonResident', CurrencyDic, **Kargs)
		LocalInterbankDeposits 		= getGLValueForField(Branch, Period, 'LocalInterbankDeposits', CurrencyDic, **Kargs)
		Data.append({
							1:u"1- ប្រភពទុនប្រមូលក្នុងស្រុក Sources of Funds Locally Collected ",
							2:u'0.00',
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':0,
							'RowBGColor':mktnbc.BG_BODY_COLOR,
							'LineFormat':'bold'
						})

		Data.append({
							1:u"1.1- ប្រាក់បញ្ញើអតិថិជន Customers' Deposits",
							2:u'0.00',
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':1,
							'RowBGColor':'',
							'LineFormat':'bold'
						})
		
		Data.append({
							1:u"1.1.1- និវេសជន Resident",
							2:u'%s' %mktmoney.formatNumber(float(Resident), 1, 2),
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':2,
							'RowBGColor':'',
							'LineFormat':'bold'
						})
		
		Data.append({
							1:u"1.1.2- អនិវេសជន Non-Resident",
							2:u'%s' %mktmoney.formatNumber(float(NonResident), 1, 2),
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':2,
							'RowBGColor':'',
							'LineFormat':'bold'
						})
		
		Data.append({
							1:u"1.2- ប្រាក់បញ្ញើក្នុងស្រុកអន្តរធនាគារ Local Interbank Deposits",
							2:u'%s' %mktmoney.formatNumber(float(LocalInterbankDeposits), 1, 2),
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':1,
							'RowBGColor':'',
							'LineFormat':'bold'
						})
		Excel.update({
					"H%s"%(CellRow) : float(str(mktmoney.formatNumber(Resident)).replace(',',''))
				})
		CellRow +=1
		Excel.update({
					"H%s"%(CellRow) : float(str(mktmoney.formatNumber(NonResident)).replace(',',''))
				})
		CellRow +=1
		Excel.update({
					"H%s"%(CellRow) : float(str(mktmoney.formatNumber(LocalInterbankDeposits)).replace(',',''))
				})
		CellRow +=2

		CashOnHand   		=   getGLValueForField(Branch, Period, 'CashOnHand', CurrencyDic, **Kargs)
		DepositswithLocalbanks = getGLValueForField(Branch, Period, 'DepositswithLocalbanks', CurrencyDic, **Kargs)
		DepositswithNBC 		= getGLValueForField(Branch, Period, 'DepositswithNBC', CurrencyDic, **Kargs)
		# LoansAndAdvances 		= getGLValueForField(Branch, Period, 'LoansAndAdvances', CurrencyDic, **Kargs) 
		LoansAndAdvances = getNBCReportByProvince(Branch, ReportHeader,NBC10=True)
		Data.append({
							1:u"2- ការប្រើប្រាស់ទុនក្នុងស្រុក Local Uses of Funds",
							2:u'0.00',
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':0,
							'RowBGColor':mktnbc.BG_BODY_COLOR,
							'LineFormat':'bold'
						})
		
		Data.append({
							1:u"2.1- សាច់ប្រាក់ក្នុងដៃ Cash on hand",
							2:u'%s' %mktmoney.formatNumber(float(CashOnHand), 1, 2),
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':1,
							'RowBGColor':'',
							'LineFormat':'bold'
						})

		Data.append({
							1:u"2.2- ប្រាក់បញ្ញើនៅធនាគារក្នុងស្រុក Deposits with Local banks",
							2:u'%s' %mktmoney.formatNumber(float(DepositswithLocalbanks), 1, 2),
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':1,
							'RowBGColor':'',
							'LineFormat':'bold'
						})

		Data.append({
							1:u"2.3- ប្រាក់បញ្ញើនៅធនាគារជាតិនៃកម្ពុជា (មិនគិតប្រាក់បញ្ញើធានាលើដើមទុន​)\nDeposits with NBC (Excluding capital guarantee deposit)",
							2:u'%s' %mktmoney.formatNumber(float(DepositswithNBC), 1, 2),
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':1,
							'RowBGColor':'',
							'LineFormat':'bold'
						})
		Data.append({
							1:u"2.4-​​ ប្រាក់ខ្ចីចងការនិងបុរេប្រទាន Loans and Advances",
							2:u'%s' %mktmoney.formatNumber(float(LoansAndAdvances), 1, 2),
							3:u'0.00',
							4:u'0.00',
							'LineType':'GH',
							'Indent':1,
							'RowBGColor':'',
							'LineFormat':'bold'
						})

		Data.append({
							1:u"ផលធៀបរវាងទុនប្រើប្រាស់ក្នុងស្រុកនិងប្រភពទុន​ (គិតជា%) Local Uses of Funds\n over Sources of Funds​ (in %) = (2/1)x100",
							2:u'0',
							3:u'0',
							4:u'0',
							'LineType':'GH',
							'Indent':0,
							'RowBGColor':'',
							'LineFormat':'bold'
						})
		Excel.update({
					"H%s"%(CellRow) : float(str(mktmoney.formatNumber(CashOnHand)).replace(',',''))
				})
		CellRow +=1
		Excel.update({
					"H%s"%(CellRow) : float(str(mktmoney.formatNumber(DepositswithLocalbanks)).replace(',',''))
				})
		CellRow +=1
		Excel.update({
					"H%s"%(CellRow) : float(str(mktmoney.formatNumber(DepositswithNBC)).replace(',',''))
				})
		CellRow +=1
		Excel.update({
					"H%s"%(CellRow) : float(str(mktmoney.formatNumber(LoansAndAdvances)).replace(',',''))
				})

		Result.update({'TableHeader':TableHeader,'ReportHeader':ReportHeader,'Data':Data, 'Excel': Excel})

		CellSyle = {
					'B9':'top*medium,FF000000',
					'C9':'top*medium,FF000000',
					'D9':'top*medium,FF000000',
					'E9':'top*medium,FF000000',
					'F9':'top*medium,FF000000',
					'G9':'top*medium,FF000000',

					'B11':'top*medium,FF000000',
					'C11':'top*medium,FF000000',
					'D11':'top*medium,FF000000',
					'E11':'top*medium,FF000000',
					'F11':'top*medium,FF000000',
					'G11':'top*medium,FF000000',

					'B22':'top*medium,FF000000',
					'C22':'top*medium,FF000000',
					'D22':'top*medium,FF000000',
					'E22':'top*medium,FF000000',
					'F22':'top*medium,FF000000',
					'G22':'top*medium,FF000000',
					}

		return Result,CellSyle

	except Exception, e:
		raise

