# -*- coding: utf-8 -*-
'''
Report Name: Net Open Position
'''

from app.mktcore.imports 		import *
from app.GLBalance.models 		import MKT_GL_BALANCE, MKT_GL_BALANCE_BACKUP
from app.Currency.models		import MKT_CURRENCY

import app.tools.mktdate 		as mktdate
import app.tools.mktsetting 	as mktsetting
import app.tools.mktmoney 		as mktmoney
import app.tools.mktnbc			as mktnbc
import app.tools.mktgl 			as mktgl
import app.tools.mktmessage 	as mktmessage
from decimal 					import Decimal
import app.NBCReport.V2.MFI.N11 	as N11
import app.NBCReport.V2.MFI.N10 	as N10
import app.NBCReport.V2.MFI.N05 	as N05



def getMFI06(Branch = "ALL", ReportedDate = "", Period = 2, Month = "", Year = ""):
	''' 
		This function must return result like below:
		Result = {
			'Data': 		Data,
			'Excel': 		Excel,
			'ReportHeader': ReportHeader,
			'TableHeader': 	TableHeader
			}
	'''

	try:
		ID 					= 	"N001" # ID of Report 01 Balance Sheet
		LiabilityEquityLine =	'66'
		TotalAssetLine 		=	'31'
		TotalEquityLine 	=	'57'
		CurrencyObj			=	MKT_CURRENCY.query

		Condition = []
		if Year and Month:
			GLTable   	= MKT_GL_BALANCE_BACKUP
			Condition 	= [GLTable.GLYear == Year,GLTable.GLMonth == Month]
			CYear 	  	= Year
			CMonth 	  	= Month
		else:
			GLTable   	= MKT_GL_BALANCE
			BankDate  	= mktdate.getBankDate()
			CYear 	  	= BankDate.year
			CMonth 	  	= BankDate.month

		GLObj   		=   GLTable.query.filter(*Condition)

		Result 			= {}
		Data 			= []
		Excel 			= {}


		LineObj 		=	mktnbc.getNBCLineReport(ID, int(Period), Branch, ReportedDate, Year=Year, Month=Month)[0].get("Data",[])

		ResultNetWorth 	= N05.getMFI05("ALL", ReportedDate, Period, Year, Month,True)
		TotalNetWorth 	=	ResultNetWorth
		ReportHeader 	= {}
		ReportHeader 	= mktnbc.getHeaderReport(	ReportName 		=	u'MONTHLY REPORT ON NET OPEN POSITION',
													Title 			=	u'របាយការណ៍ប្រចាំខែស្តីពី ការគណនាស្ថានភាពចំហសុទ្ធនៃរូបិយវត្ថុ',
													Form 			=	'6',
													NetWorth 		= 	u'%s' %mktmoney.formatNumber(float(TotalNetWorth), 1, 2)
													)
		Excel.update({
				"D3" : ReportHeader.get('ReportedDate',""),
				"C4" : ReportHeader.get('CompanyName',""),
				"C5" : Decimal(TotalNetWorth),
				"H6" : Decimal(ReportHeader.get('ReportingRate',0))
			})


		TableHeader 	= {}
		TableHeader 	= mktnbc.setTableHeader(Text=u'ល.រ\nNº', 
                                            Rowspan=4,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'រូបិយប័ណ្ណ\nCurrency', 
                                            Rowspan=4,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		#----------------------------------------------------------------------------------------------------------------#
		TableHeader 	= mktnbc.setTableHeader(Text=u'ខ្ទង់ផ្សេងៗបន្ទាប់ពីដកចេញសំវិធានធន\nElements after deduction of affected provision', 
                                            Rowspan=0,Colspan=4,RowIndex=1, TableHeader=TableHeader, Class="text-center")

		TableHeader 	= mktnbc.setTableHeader(Text=u'ទ្រព្យសកម្ម\nAssets', 
                                            Rowspan=2,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'1', 
                                            Rowspan=0,Colspan=0,RowIndex=4, TableHeader=TableHeader, Class="text-center")

		TableHeader 	= mktnbc.setTableHeader(Text=u'ទ្រព្យអកម្មនិងមូលធន\nLiabilities & Capital', 
                                            Rowspan=2,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'2', 
                                            Rowspan=0,Colspan=0,RowIndex=4, TableHeader=TableHeader, Class="text-center")

		TableHeader 	= mktnbc.setTableHeader(Text=u'រូបិយប័ណ្ណត្រូវទទួល\nCurrency receivables', 
                                            Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'ខ្ទង់ក្រៅតារាងតុល្យការ\nOff-balance sheet', 
                                            Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'3', 
                                            Rowspan=0,Colspan=0,RowIndex=4, TableHeader=TableHeader, Class="text-center")

		TableHeader 	= mktnbc.setTableHeader(Text=u'រូបិយប័ណ្ណត្រូវចំណាយ\nCurrency Payables', 
                                            Rowspan=0,Colspan=0,RowIndex=2, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'ខ្ទង់ក្រៅតារាងតុល្យការ\nOff-balance sheet', 
                                            Rowspan=0,Colspan=0,RowIndex=3, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'4', 
                                            Rowspan=0,Colspan=0,RowIndex=4, TableHeader=TableHeader, Class="text-center")
		#----------------------------------------------------------------------------------------------------------------#
		TableHeader 	= mktnbc.setTableHeader(Text=u'រូបិយប័ណ្ណចំហសុទ្ធ\nវែង ឬ ខ្លី\nNet open position\nLong or short',
                                            Rowspan=3,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'5 = 1 - 2 + 3 - 4',
                                            Rowspan=0,Colspan=0,RowIndex=4, TableHeader=TableHeader, Class="text-center")
		#----------------------------------------------------------------------------------------------------------------#
		TableHeader 	= mktnbc.setTableHeader(Text=u'រូបិយប័ណ្ណចំហសុទ្ធ/\nមូលនិធិផ្ទាល់សុទ្ធ (%)\nNet open position/\nNet worth (%)',
                                            Rowspan=4,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'កំរិតកំណត់ (%)\nLimit (%)',
                                            Rowspan=4,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		TableHeader 	= mktnbc.setTableHeader(Text=u'ភាពលើស (១)\nExcess (1)',
                                            Rowspan=4,Colspan=0,RowIndex=1, TableHeader=TableHeader, Class="text-center")
		LoanType11		= mktsetting.getAppSetting('NBCInsiderOtherPartyLoan')
		Data11,Excel11,TotOutstanding11 = N11.getLargeExposureDetail(Branch, ReportHeader, TotalNetWorth, LoanType11, "11")
		TotOutstanding11 	= Decimal(mktmoney.formatNumber(TotOutstanding11,1,2).replace(',',''))
		TotalNetWorth = TotalNetWorth
		ReportHeader 	= mktnbc.getHeaderReport(	ReportName 		=	u'MONTHLY REPORT ON NET OPEN POSITION',
													Title 			=	u'របាយការណ៍ប្រចាំខែស្តីពី ការគណនាស្ថានភាពចំហសុទ្ធនៃរូបិយវត្ថុ',
													Form 			=	'6',
													NetWorth 		= 	u'%s' %mktmoney.formatNumber(float(TotalNetWorth), 1, 2)
													)

		CurrencyList 	=	['KHR','USD','EUR','JPY','THB','HKD','MYR','SGD']
		SubTotal 		=	0
		TotalWeightedAmt=	0
		TotalC1 		=	0
		TotalC2 		=	0
		TotalF1 		=	0
		TotalF2 		=	0
		TotalST 		=	0
		NetOpenPosition =	0
		DataList 		=	mktnbc.getNBCLineDetail(ID, Branch, Period, GLTable=GLTable, GLObj=GLObj, Year=CYear, Month=CMonth)

		No 					= 	1
		CellRow 			=	11

		for currency in CurrencyList:
			Asset 		=	Decimal(mktnbc.getLineValue("Amount%s%s"%(currency, TotalAssetLine), DataList))
			Liabilities	=	Decimal(mktnbc.getLineValue("Amount%s%s"%(currency, LiabilityEquityLine), DataList))

			Off1 		=	0
			Off2 		=	0

			Total 		=	Asset - Liabilities + Off1 - Off2

			TotalC1 	=	Decimal(TotalC1) + Asset
			TotalC2 	=	Decimal(TotalC2) + Liabilities
			TotalF1 	=	Decimal(TotalF1) + Off1
			TotalF2 	=	Decimal(TotalF2) + Off2
			TotalST 	=	Decimal(TotalST) + Total
			RoundedTotal=   Decimal(mktmoney.formatNumber(float(Total), 1, 3).replace(',',''))
			NetWorth 	=	RoundedTotal / Decimal(TotalNetWorth) if RoundedTotal else 0

			Data.append({	1:'%s'%No,
							2:currency,
							3:u'%s' %(mktmoney.getAccountingFormat(Asset)),
							4:u'%s' %(mktmoney.getAccountingFormat(Liabilities)),
							5:u'%s' %(mktmoney.getAccountingFormat(Off1)),
							6:u'%s' %(mktmoney.getAccountingFormat(Off2)),
							7:u'%s' %(mktmoney.getAccountingFormat(Total)),
							8:u'%s' %(mktmoney.formatNumber(float(NetWorth))),
							9:u'20%',
							10:u'0',
							'LineType':'LD',
	                        'Indent':0,
	                        'RowBGColor':'',
	                        'LineFormat':'',
						})

			Excel.update({
				"C%s"%(CellRow) : Decimal(Asset),
				"D%s"%(CellRow) : Decimal(Liabilities),
				"E%s"%(CellRow) : Decimal(Off1),
				"F%s"%(CellRow) : Decimal(Off2)
			})

			CellRow 	= CellRow + 1
			No 			= No +1

		Data.append({	1:u"",
						2:u"សរុប\nTotal",
						3:u'%s' %mktmoney.getAccountingFormat(TotalC1),
						4:u'%s' %mktmoney.getAccountingFormat(TotalC2),
						5:u'%s' %mktmoney.getAccountingFormat(TotalF1),
						6:u'%s' %mktmoney.getAccountingFormat(TotalF2),
						7:u'%s' %mktmoney.getAccountingFormat(TotalST),
						8:u'',
						9:u'',
						10:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		Data.append({	1:u"",
						2:u'',
						3:u'(2)',
						4:u'(3)',
						5:u'',
						6:u'',
						7:u'(4)',
						8:u'',
						9:u'',
						10:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		Result.update({'TableHeader':TableHeader,'ReportHeader':ReportHeader,'Data':Data, 'Excel': Excel})

		CellSyle = {
					'B8':'left*thin,FF000000',
					'B9':'left*thin,FF000000:right*thin,FF000000',
					'B10':'bottom*thin,FF000000:left*thin,FF000000',
					'D10':'left*thin,FF000000:top*thin,FF000000',
					'D9':'left*thin,FF000000',

					'H8':'left*thin,FF000000:right*thin,FF000000',
					'H9':'left*thin,FF000000:right*thin,FF000000',
					'H10':'right*thin,FF000000',

					'J8':'left*thin,FF000000:right*medium,FF000000',
					'J9':'left*thin,FF000000:right*medium,FF000000',
					'J10':'left*thin,FF000000:right*medium,FF000000',

					'B21':'top*thin,FF000000:bottom*medium,FF000000',
					'G21':'right*thin,FF000000:bottom*medium,FF000000:top*thin,FF000000',

					}

		return Result, CellSyle

	except Exception, e:
		raise



