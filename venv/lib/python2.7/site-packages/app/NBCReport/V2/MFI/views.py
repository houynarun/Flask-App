# -*- coding: utf-8 -*-
from app.mktcore.imports 		import *
import app.tools.mktnbc 		as mktnbc
import os

from N02 	import *
from N03 	import *
from N04 	import *
from N05 	import *
from N06 	import *
from N07 	import *
from N08 	import *
from N09 	import *
from N10 	import *
from N11	import *
from N12	import *
from N13 	import *
from N14 	import *
from N15 	import *
from N16 	import *
from N17 	import *
from N18 	import *
from N19 	import *
from N20 	import *
from N21 	import *
from N22 	import *

try:
	from openpyxl import load_workbook
except Exception, e:
	pass

FILENAME = os.path.dirname(__file__)+'/EXCEL_MFI.xlsx'
def setReportList(**kwargs):
	Branch 			= kwargs.get("Branch", "ALL")
	ReportedDate 	= kwargs.get("ReportedDate", "")
	Month 			= kwargs.get("Month","")
	Year			= kwargs.get("Year","") 

	ReportList  	= 	{
							'02':{ 	'Khmer'		:u'របាយការណ៏ប្រចាំខែសី្តពី ទ្រព្យសកម្ម និងទ្រព្យអកម្ម',
									'English'	:'MONTHLY REPORT ON BALANCE SHEET',
									'Title'		:'NBC-BALANCE SHEET',
									'Result'	:'getMFI02(Branch, ReportedDate, 2, Month, Year)',
									},

							'03':{ 	'Khmer'		:u'របាយការណ៏ប្រចាំខែសី្តពី ចំណូល និងចំណាយ',
									'English'	:'MONTHLY REPORT ON INCOME STATEMENT',
									'Title'		:'NBC-INCOME STATEMENT',
									'Result'	:'getMFI03(Branch, ReportedDate, 1, Month, Year)',
									},

							'04':{ 	'Khmer'		:u'របាយការណ៏ប្រចាំខែសី្តពី ក្រៅតារាងតុល្យការ',
									'English'	:'MONTHLY REPORT ON OFF-BALANCE SHEET',
									'Title'		:'NBC-OFF-BALANCE SHEET',
									'Result'	:'getMFI04(Branch, ReportedDate, 2, Month, Year)',
									},

							'05':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី អនុបាតសាធនភាព',
									'English'	:'MONTHLY REPORT ON SOLVENCY RATIO',
									'Title'		:'NBC-SOLVENCY RATIO',
									'Result'	:'getMFI05(Branch, ReportedDate, 2, Month, Year)',
									},

							'06':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ការគណនាស្ថានភាពចំហសុទ្ធនៃរូបិយវត្ថុ',
									'English'	:'MONTHLY REPORT ON NET OPEN POSITION',
									'Title'		:'NBC-NET OPEN POSITION',
									'Result'	:'getMFI06(Branch, ReportedDate, 2, Month, Year)',
									},

							'07':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី អនុបាតសន្ទនីយភាព',
									'English'	:'MONTHLY REPORT ON LIQUIDITY RATIO',
									'Title'		:'NBC-LIQUIDITY RATIO',
									'Result'	:'getMFI07(Branch, ReportedDate, 2, Month, Year)',
									},

							'08':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ប្រភពហិរញ្ញប្បទាន',
									'English'	:'MONTHLY REPORT ON SOURCES OF FINANCING',
									'Title'		:'NBC-SOURSES OF FINANCING',
									'Result'	:'getMFI08(Branch)'
									},

							'09':{ 	'Khmer'		:u'របាយការណ៏ប្រចាំខែសី្តពី រូបិយវត្ថុ និងប្រតិបតិ្តការទីផ្សារអន្តរធនាគារ',
									'English'	:'MONTHLY REPORT ON MONEY AND INTERBANK MARKET TRANSACTION',
									'Title'		:'NBC-MONEY AND INTERBANK MARKET TRANSACTION',
									'Result'	:'getMFI09(Branch)'
									},

							'10':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ឥណទានមានហានិភ័យធំៗ',
									'English'	:'MONTHLY REPORT ON LARGE EXPOSURES',
									'Title'		:'NBC-LARGE EXPOSURES',
									'Result'	:'getMFI10("10", Branch, ReportedDate, 2, Month, Year)',
									},

							'11':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ឥណទានចំពោះអ្នកខាងក្នុង និងសម្ព័ន្ធញ្ញាតិ',
									'English'	:'MONTHLY REPORT ON LOANS TO INSIDERS AND RELATED PARTIES',
									'Title'		:'NBC-LOANS TO INSIDERS AND RELATED PARTIES',
									'Result'	:'getMFI11("11", Branch, ReportedDate, 2, Month, Year)'
									},

							'12':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន',
									'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Standard Loans)',
									'Title'		:'NBC-SOURSES OF FINANCING',
									'Result'	:'getMFI12(Branch)',
									},

							'13':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន - ឥណទានខាត់បង់ (សំវិធានធន ១០%)',
									'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Sub Standard Loan)',
									'Title'		:'NBC-LOAN CLASSIFICATION',
									'Result'	:'getMFI13("13", Branch)'
									},
							
							'14':{ 	'Khmer'		:u'ររបាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន - ឥណទានខាត់បង់ (សំវិធានធន ៣០%)',
									'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Doubtful Loan)',
									'Title'		:'NBC-LOAN CLASSIFICATION',
									'Result'	:'getMFI14("14", Branch)'
									},

							'15':{ 	'Khmer'		:u'ររបាយការណ៍ប្រចាំខែស្តីពី ចំណាត់ថ្នាក់ឥណទាន​ - ឥណទានខាត់បង់ (សំវិធានធន ១០០%)',
									'English'	:'MONTHLY REPORT ON CREDIT CLASSIFICATION (Loss Loan)',
									'Title'		:'NBC-LOAN CLASSIFICATION',
									'Result'	:'getMFI15("15", Branch)'
									},

							'16':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ការធ្វើចំណាត់ថ្នាក់ឥណទាន សំវិធានធន និងអនុបាតឥណទានមិនដំណើរការ',
									'English'	:'MONTHLY REPORT ON LOAN CLASSIFICATION, PROVISIONING AND NON-PERFORMING RATIO',
									'Title'		:'NBC-LOAN CLASSIFICATION',
									'Result'	:'getMFI16(Branch, ReportedDate)'
									},

							'17':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ឥណទានតាមប្រភេទជំនួញនិងម្ចាស់កម្មសិទ្ធិក្នុងវិស័យសេដ្ខកិច្ច',
									'English'	:'MONTHLY REPORT ON LOANS BY INDUSTRY AND OWNERSHIP IN THE ECONOMIC SECTOR',
									'Title'		:'NBC-LOANS BY INDUSTRY',
									'Result'	:'getMFI17(Branch, ReportedDate)'
									},

							'18':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ឥណទានចំណាត់ថ្នាក់តាមប្រភេទរូបិយប័ណ្ណ',
									'English'	:'MONTHLY REPORT ON LOANS CLASSIFIED BY TYPES OF CURRENCIES',
									'Title'		:'NBC-LOANS CLASSIFIED BY CURRENCIES',
									'Result'	:'getMFI18(Branch, ReportedDate)'
									},

							'19':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពីការតាមដានមធ្យមភាគអត្រាការប្រាក់ក្រោយថ្លឹងចំពោះប្រាក់បញ្ញើនិងឥណទានថ្មីៗ',
									'English'	:'MONTHLY REPORT ON SURVEY CURRENT WEIGHTED AVERAGE INTEREST RATES ON NEW DEPOSITS AND LOANS',
									'Title'		:'NBC-WEIGHTED AVERAGEINTEREST',
									'Result'	:'getMFI19(Branch, ReportedDate, 2, Month, Year)'
									},
									
							'20':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពី ព័ត៌មានបណ្តាញប្រតិបត្តិការ',
									'English'	:'MONTHLY REPORT ON NETWORK INFORMATION',
									'Title'		:'NBC-NETWORK INFORMATION',
									'Result'	:'getMFI20(Branch)'
									},

							'21':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំឆមាស ស្តីពីឥណទានទូទាំង ២៤ ខេត្ត និង ០១ រាជធានី',
									'English'	:'SEMETER REPORT ON LOAN IN 24 PROVINCES AND 1 CAPITAL',
									'Title'		:'NBC-LOAN IN 24 PROVINCES AND 1 CAPITAL',
									'Result'	:'getMFI21(Branch,ReportedDate)'
									},
							'22':{ 	'Khmer'		:u'របាយការណ៍ប្រចាំខែស្តីពីអត្រាការប្រាក់មធ្យមថ្លឹងចំពោះប្រាក់បញ្ញើនឹងឥណទាន',
									'English'	:'MONTHLY REPORT ON WEIGHTED AVERAGEINTEREST INTEREST RATE ON DEPOSITS AND LOANS',
									'Title'		:'NBC-WEIGHTED AVERAGEINTEREST INTEREST RATE',
									'Result'	:'getMFI22(Branch)'
									}
						}

	return ReportList

""" Route to view all reports """
@app.route('/Morakot/Report/NBC/MFI', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getNBCMFIReport():
	try:

		ErrorMsg 	= []
		getCheck 	= checkAccess("/Morakot/Report/NBC/MFI","Search")
		if getCheck != True: 
			ErrorMsg.append(msg_error+msg_permission)
			return render_template("permission.html", ErrorMsg=ErrorMsg)

		Branch 			=	request.args.get("Branch") if "Branch" in request.args else session.get("ChangeBranch")

		ReportList 	=	setReportList(	Branch 	= Branch)

		Title 			=	"Micro Finance"
		Type 			=	'MFI'
		html			=	"nbc/v2/nbc.html"

		return render_template(	html,
								ReportList 		= ReportList,
								Title 			= Title,
								Type 			= Type,
								sorted 			= sorted,
								Branch 			=	Branch)

	except:
		raise

""" Route to view each report """
@app.route('/Morakot/Report/NBC/MFI/<ID>', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getNBCMFIReportDetail(ID):
	try:
		ErrorMsg    = []
		getCheck    = checkAccess("/Morakot/Report/NBC/MFI","Search")
		if getCheck != True: 
			ErrorMsg.append(msg_error+msg_permission)
			return render_template("permission.html",ErrorMsg=ErrorMsg)

		''' Setup parameters '''
		Branch 			=	request.args.get("Branch") if "Branch" in request.args else session.get("ChangeBranch")
		ReportedDate 	= mktnbc.getHeaderReport().get("ReportedDate","")
		Month 			= mktnbc.getHeaderReport().get("Month","")
		Year			= mktnbc.getHeaderReport().get("Year","")

		ReportList 	=	setReportList(	Branch 	= Branch,
										ReportedDate = ReportedDate,
										Month = Month,
										Year = Year)

		Result, Style 	=	eval(ReportList.get(ID,{}).get('Result',{}))
		Type 		= 	"MFI"
		html 		= 	"nbc/v2/nbc_master.html"

		return render_template(html,
								ID 				=	ID,
								str 			=	str,
								mktmoney 		=	mktmoney,
								float 			=	float,
								Branch 			=	Branch,
								Result 			=	Result,
								Type 			= 	Type
								)
		return Result
	except:
		raise

# from openpyxl.styles import PatternFill, Border, Side, Alignment, Protection, Font
# from openpyxl.styles.borders import Border, Side
# from openpyxl import Workbook

from openpyxl.styles import Border, Side
""" Route to export all reports to excel """
@app.route('/Morakot/Report/NBC/MFI/Excel', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getNBCMFIExcel():
	try:
		workbook = load_workbook(FILENAME, keep_links=False)

		''' Setup parameters '''
		Branch 			= request.args.get("Branch") if "Branch" in request.args else session.get("ChangeBranch")
		ReportedDate 	= mktnbc.getHeaderReport().get("ReportedDate","")
		Month 			= mktnbc.getHeaderReport().get("Month","")
		Year			= mktnbc.getHeaderReport().get("Year","")
		ReportList 		= setReportList(Branch 	= Branch,
										ReportedDate = ReportedDate,
										Month = Month,
										Year = Year)

		for key,value in ReportList.iteritems():
			Result 		= eval(value.get('Result',{}))
			Excel 		= Result[0].get('Excel',{})
			SheetName 	= Result[0].get("ReportHeader",{}).get('Form',"")
			bs_sheet 	= mktnbc.getSheet(workbook, SheetName)

			mktnbc.setWriteWorkSheet(bs_sheet, Excel)
			setBorder(bs_sheet,Result[1])
			
		response = mktnbc.getExcelFile(workbook, 'NBC_REPORTS_MFI')

		return response
	except Exception as e:
		raise

def setBorder(Sheet,DictData):
	# Dict = {'G8':'left*thin,FF000000:right*thin,FF000000',
	# 'K7':'top*medium,FF000000',
	# 'L8':'bottom*thin,FF000000:right*thin,FF000000',
	# 'F25':'left*medium,FF000000'
	# }

	if Sheet:
		if isinstance(DictData, dict):

			for key, value in DictData.iteritems():
				Dict = {}
				Val1 = value.split(':')
				for v in Val1:
					Val2 = v.split('*')
					Val3 = Val2[1].split(',')
					Dict.update({Val2[0]:Side(border_style=Val3[0],color=Val3[1])})
				
				Sheet.cell(key).border = Border(**Dict)

""" Route to export each report to excel """
@app.route('/Morakot/Report/NBC/MFI/Excel/<ID>', methods=['GET'])
@checkLogOutSession
@checkLogOutTime
def getNBCMFISheet(ID):
	try:
		ID = str(ID)
		workbook = load_workbook(FILENAME, keep_links=False)

		''' Setup parameters '''
		Branch 			=	request.args.get("Branch") if "Branch" in request.args else session.get("ChangeBranch")
		ReportedDate 	= mktnbc.getHeaderReport().get("ReportedDate","")
		Month 			= mktnbc.getHeaderReport().get("Month","")
		Year			= mktnbc.getHeaderReport().get("Year","")

		ReportList 		= 	setReportList(Branch 	= Branch,
										  ReportedDate = ReportedDate,
										  Month = Month,
										  Year = Year)

		Result 			=	eval(ReportList.get(ID,{}).get('Result',{}))
		Excel 			= 	Result[0].get('Excel',{})
		SheetName 		= 	Result[0].get("ReportHeader",{}).get('Form',"")

		bs_sheet = mktnbc.getSheet(workbook, SheetName)
		mktnbc.setWriteWorkSheet(bs_sheet, Excel)
		setBorder(bs_sheet,Result[1])

		response = mktnbc.getExcelFile(workbook, 'NBC_REPORTS_MFI_%s'%ID)

		return response
	except Exception as e:
		raise
