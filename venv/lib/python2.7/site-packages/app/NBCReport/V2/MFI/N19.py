# -*- coding: utf-8 -*-
'''
MONTHLY REPORT ON SURVEY CURRENT WEIGHTED​ AVERAGE INTEREST RATES ON NEW DEPOSITS AND LOANS 
'''

from app.mktcore.imports 		import *
from app.GLBalance.models 		import MKT_GL_BALANCE, MKT_GL_BALANCE_BACKUP
from app.LoanContract.models 	import *
from app.LoanApplication.models import *
from app.Collateral.models 		import *
from app.TermDepositContract.models import *
from app.TermDepositProduct.models import *
from app.PeriodicInterest.models import *
from decimal 					import * 
import app.tools.mktdate 		as mktdate
import app.tools.mktsetting 	as mktsetting
import app.tools.mktmoney 		as mktmoney
import app.tools.mktnbc			as mktnbc
import app.tools.mktgl 			as mktgl
import app.tools.mkttool		as mkttool
import app.tools.mktmessage 	as mktmessage
import calendar
from datetime					import datetime, timedelta
from sqlalchemy.sql.expression 	import cast
import sqlalchemy
from app.Currency.models 		import *


def getMFI19(Branch = "ALL", ReportedDate = "", Period = 2, Month = "", Year = ""):
	''' This function must return result like below:
			Result = {
				'Data': 		Data,
				'Excel': 		Excel,
				'ReportHeader': ReportHeader,
				'TableHeader': 	TableHeader
				}
	'''
	try:
		getAccSetting 	=	mktsetting.getAccSetting()
		Currency 		=	'USD'
		BaseCurrency 	=	getAccSetting.BaseCurrency
		ID 				= 	'N001'

		Condition = []
		if Year and Month:
			GLTable   = MKT_GL_BALANCE_BACKUP
			Condition = [GLTable.GLYear == Year,GLTable.GLMonth == Month]
			CYear 	  = Year
			CMonth 	  = Month
		else:
			GLTable   = MKT_GL_BALANCE
			BankDate  = mktdate.getBankDate()
			CYear 	  = BankDate.year
			CMonth 	  = BankDate.month

		GLObj   =   GLTable.query.filter(*Condition)

		Result			=   {}
		Data 			= 	[]
		Excel 			= 	{}
		TableHeader 	= 	{}

		ReportName 		= 	u'MONTHLY REPORT ON SURVEY CURRENT WEIGHTED​ AVERAGE INTEREST RATES ON NEW DEPOSITS AND LOANS'
		Title 			= 	u'របាយការណ៍ប្រចាំខែស្តីពីការតាមដានមធ្យមភាគអត្រាការប្រាក់ក្រោយថ្លឹងចំពោះប្រាក់បញ្ញើនិងឥណទានថ្មីៗ'
		Form 			= 	'19'
		ReportHeader 	=	 mktnbc.getHeaderReport(ReportName 		=	ReportName,
													Title 			=	Title,
													Form 			=	Form)

		TableHeader = mktnbc.setTableHeader(Text=u'ប្រភេទគណនី (១)\nTypes of Accounts​ (1)', 
									 	Rowspan='',Colspan='',RowIndex=1, TableHeader=TableHeader)
		TableHeader = mktnbc.setTableHeader(Text=u'រៀល​(២)\nKHR(2)', 
									 	Rowspan='',Colspan='',RowIndex=1, TableHeader=TableHeader)
		TableHeader = mktnbc.setTableHeader(Text=u'ដុល្លារអាមេរិក(៣)\nUSD (3)', 
									 	Rowspan='',Colspan='',RowIndex=1, TableHeader=TableHeader)
		TableHeader = mktnbc.setTableHeader(Text=u'រួបិយប័ណ្ណផ្សេង(៤)\nOther FCs (4)', 
									 	Rowspan='',Colspan='',RowIndex=1, TableHeader=TableHeader)

		Data,Excel = getData(ID, Branch, Period, ReportedDate, GLObj=GLObj, GLTable=GLTable, Year=CYear, Month=CMonth, ReportHeader=ReportHeader)

		Result.update({'TableHeader':TableHeader,'ReportHeader':ReportHeader,'Data':Data,'Excel':Excel})

		CellSyle = {
					'B9':'top*medium,FF000000',
					'C9':'top*medium,FF000000',
					'D9':'top*medium,FF000000',
					'E9':'top*medium,FF000000',

					'B11':'top*thin,FF000000',
					'C11':'top*thin,FF000000',
					'D11':'top*thin,FF000000',
					'E11':'top*thin,FF000000',
					}
		return Result, CellSyle

	except:
		raise

def getData(ID, Branch='HO', Period=6, ReportedDate="", GLTable='', GLObj='', Year='', Month='',ReportHeader=""):
	try:

		RecordRow 	= []
		ExcelRecord = {}
		# CompanyNameEN = (ReportHeader.get('CompanyName',"")).split('\n')[1]
		# CompanyNameKH = (ReportHeader.get('CompanyName',"")).split('\n')[0]
		# print CompanyNameKH,'ReportHeader',CompanyNameEN
		ExcelRecord.update({				
			"E4" : ReportHeader.get('ReportedDate',""),
			"C6" : ReportHeader.get('CompanyName',"")
		})

		SubTotal 		=	0
		ReportingRate 	=	mktsetting.getAppSetting('NBCExchangeRate')
		TotalWeightedAmt=	0
		TotalC1 		=	0
		TotalC2 		=	0
		NetOpenPosition =	0

		TotalNetWorth 	=	0 #N016.getNBCN016(ID, Branch, Period, ReportedDate, GLObj=GLObj, GLTable=GLTable, Year=Year, Month=Month)['TotalNetWorth']
		
		CMonth  =	int(Month)
		CYear 	=	int(Year)
		if CMonth == 1:
			CYear 	=	Year - 1
			CMonth  =	13
			
		CMonth  	=	CMonth - 1
		CMonth 		=	'0%s'%Month if CMonth < 10 else CMonth
		Day 		=	calendar.monthrange(Year, Month)[1]
		FromDate 	=	'%s-%s-01'%(CYear, CMonth)
		ToDate 		=	'%s-%s-%s'%(CYear, CMonth, Day)

		NBCBusinessLoan 		= (mktsetting.getAppSetting('NBCBusinessLoanN19')).split()
		NBCConsumerLoan 		= (mktsetting.getAppSetting('NBCConsumerLoanN19')).split()
		NBCOtherLoan 			= (mktsetting.getAppSetting('NBCOtherLoanN19')).split()
		NBCBusinessLoanSector 		= (mktsetting.getAppSetting('NBCBusinessLoanSectorN19')).split()
		NBCConsumerLoanSector 		= (mktsetting.getAppSetting('NBCConsumerLoanSectorN19')).split()
		NBCOtherLoanSector 			= (mktsetting.getAppSetting('NBCOtherLoanSectorN19')).split()
		
		# Get loan info by product
		CellRow		= 	14
		RecordRow.append({ 1:u'ប្រាក់បញ្ញើ \nDeposits:',  
						2:u'', 
						3:u'', 
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold',
					})

		RecordRow.append({ 1:u'1- ប្រាក់បញ្ញើចរន្ត\nDemand Deposits',  
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold', })		
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 	1:u'2- ប្រាក់បញ្ញើសំចៃ\nSaving Deposits',  
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold', })

		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 	1:u'3- ប្រាក់បញ្ញើមានកាលកំណត់\nTerm Deposits:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold',})
		CellRow+=1

		RecordRow.append({ 1:u'3.1- រហូតដល់​ ១​ ខែ\nOne month or less', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''
						 })
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 1:u'3.2- លើសពី ១ ខែ រហូតដល់ ៣ ខែ\nGreater than one month to three months', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''})
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 1:u'3.3- លើសពី ៣ ខែ រហូតដល់ ៦ ខែ​\nGreater than three months to six months ', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''})
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 1:u'3.4- លើសពី ៦ ខែ រហូតដល់ ១ ឆ្នាំ\nGreater than six months to one year', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 1:u'3.5- លើសពី ១ ឆ្នាំ\nGreater than one year', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''})
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 1:u'4- ប្រាក់បញ្ញើផ្សេងៗ\nOther ​​Deposits', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'})
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 1:u'ឥណទាន\nLoans:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold', })
		
		CellRow+=3

		RecordRow.append({ 1:u'1- ឥណទានវិបារូបន៍ -​ ទៅអ្នកប្រើប្រាស់\nOverdraft - Consumer', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold' })

		ExcelRecord.update({					
					"F%s"%(CellRow) : 0,
					"G%s"%(CellRow) : 0,
					"H%s"%(CellRow) : 0
				})
		CellRow+=1

		RecordRow.append({ 	1:u'2- ឥណទានវិបារូបន៍ -​ ទៅធុរកិច្ច\nOverdraft - Business', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"), 
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold' })

		ExcelRecord.update({					
					"F%s"%(CellRow) : 0,
					"G%s"%(CellRow) : 0,
					"H%s"%(CellRow) : 0
				})
		CellRow+=1

		RecordRow.append({ 	1:u'3- ប័ណ្ណឥណទាន\nCredit Card', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'
						 })
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 	1:u'4- ឥណទានចំពោះគ្រឹះស្ថានហិរញ្ញវត្ថុ\nLoans to FIs:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold' })
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 	1:u'4.1- រហូតដល់​ ១​ ខែ\nOne month or less', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''})
		ExcelRecord.update({					
					"F%s"%(CellRow) : 0,
					"G%s"%(CellRow) : 0,
					"H%s"%(CellRow) : 0
				})
		CellRow+=1

		RecordRow.append({ 	1:u'4.2- លើសពី ១ ខែ \nGreater than one month', 
						2:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(0), "%"),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })
		ExcelRecord.update({					
					"F%s"%(CellRow) : 0,
					"G%s"%(CellRow) : 0,
					"H%s"%(CellRow) : 0
				})
		CellRow+=1
		
		RecordRow.append({ 	1:u'5- ឥណទានមានកាលកំណត់ - ទៅអ្នកប្រើប្រាស់\nTerm Loans - Consumer:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'})
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		# Variable short cut description
		# LC = Loan Contract
		# Int = Interest
		# Y1 = More Than One Year
		# N1 = Less Than One Year
		# Avg = Average
		# Sum = Total or Sum
		# Mul = Multiple
		CellRow+=1
		AvgIntRateKHRUnsecuredY1 	= 0
		AvgIntRateUSDUnsecuredY1 	= 0
		AvgIntRateOtherFCUnsecuredY1 = 0

		AvgIntRateKHRUnsecuredN1 	= 0
		AvgIntRateUSDUnsecuredN1 	= 0
		AvgIntRateOtherFCUnsecuredN1 = 0

		AvgIntRateKHRSecuredY1 	= 0
		AvgIntRateUSDSecuredY1 	= 0
		AvgIntRateOtherFCSecuredY1 	= 0

		AvgIntRateKHRSecuredN1 	= 0
		AvgIntRateUSDSecuredN1 	= 0
		AvgIntRateOtherFCSecuredN1 	= 0

		AVGIntRateOfUnsecuredLC = getAVGIntRateOfLoanContract("ALL",LoanProduct=NBCConsumerLoan,LoanSector=NBCConsumerLoanSector)
		if AVGIntRateOfUnsecuredLC:
			for AvgIntRate in AVGIntRateOfUnsecuredLC:
				if AvgIntRate.SecuredLoan == 'Y':
					if AvgIntRate.MoreThanOneYear == 'Y':
						AvgIntRateKHRSecuredY1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDSecuredY1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCSecuredY1 = AvgIntRate.AgvInterestOtherFC
					else:
						AvgIntRateKHRSecuredN1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDSecuredN1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCSecuredN1 = AvgIntRate.AgvInterestOtherFC
				else:
					# Loan not Secure are here
					if AvgIntRate.MoreThanOneYear == 'Y':
						AvgIntRateKHRUnsecuredY1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDUnsecuredY1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCUnsecuredY1 = AvgIntRate.AgvInterestOtherFC
					else:
						AvgIntRateKHRUnsecuredN1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDUnsecuredN1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCUnsecuredN1 = AvgIntRate.AgvInterestOtherFC

		RecordRow.append({ 1:u'5.1- មិនមានការធានា\nUnsecured:', 2:u'', 3:u'', 4:u'',
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })
		ExcelRecord.update({
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1
		
		RecordRow.append({
						1:u'5.1.1- រហូតដល់​ ១​ ឆ្នាំ\nOne year or less ',
						2:u'%s %s' %(mktmoney.formatNumber(AvgIntRateKHRUnsecuredN1), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AvgIntRateUSDUnsecuredN1), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AvgIntRateOtherFCUnsecuredN1), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
					"F%s"%(CellRow) : AvgIntRateKHRUnsecuredN1 / 100,
					"G%s"%(CellRow) : AvgIntRateUSDUnsecuredN1 /100,
					"H%s"%(CellRow) : AvgIntRateOtherFCUnsecuredN1 /100
				})
		CellRow+=1

		RecordRow.append({
						1:u'5.1.2- លើសពី ១ ឆ្នាំ\nGreater than one year',
						2:u'%s %s' %(mktmoney.formatNumber(AvgIntRateKHRUnsecuredY1), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AvgIntRateUSDUnsecuredY1), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AvgIntRateOtherFCUnsecuredY1), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})

		ExcelRecord.update({					
					"F%s"%(CellRow) : AvgIntRateKHRUnsecuredY1 / 100,
					"G%s"%(CellRow) : AvgIntRateUSDUnsecuredY1 / 100,
					"H%s"%(CellRow) : AvgIntRateOtherFCUnsecuredY1 /100
				})
		CellRow+=1

		RecordRow.append({ 	1:u'5.2- មានការធានា\nSecured:', 2:u'', 3:u'', 4:u'',
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({
						1:u'5.2.1- រហូតដល់​ ១​ ឆ្នាំ\nOne year or less ',
						2:u'%s %s' %(mktmoney.formatNumber(AvgIntRateKHRSecuredN1), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AvgIntRateUSDSecuredN1), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AvgIntRateOtherFCSecuredN1), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({					
					"F%s"%(CellRow) : AvgIntRateKHRSecuredN1 	 / 100,
					"G%s"%(CellRow) : AvgIntRateUSDSecuredN1 	 / 100,
					"H%s"%(CellRow) : AvgIntRateOtherFCSecuredN1 	 / 100
				})
		CellRow+=1

		RecordRow.append({
						1:u'5.2.2- លើសពី ១ ឆ្នាំ\nGreater than one year',
						2:u'%s %s' %(mktmoney.formatNumber(AvgIntRateKHRSecuredY1), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AvgIntRateUSDSecuredY1), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AvgIntRateOtherFCSecuredY1), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
					"F%s"%(CellRow) : AvgIntRateKHRSecuredY1 / 100,
					"G%s"%(CellRow) : AvgIntRateUSDSecuredY1 / 100,
					"H%s"%(CellRow) : AvgIntRateOtherFCSecuredY1 / 100
				})
		CellRow+=1
		AvgIntRateKHRUnsecuredY1 	= 0
		AvgIntRateUSDUnsecuredY1 	= 0
		AvgIntRateOtherFCUnsecuredY1 = 0

		AvgIntRateKHRUnsecuredN1 	= 0
		AvgIntRateUSDUnsecuredN1 	= 0
		AvgIntRateOtherFCUnsecuredN1 = 0

		AvgIntRateKHRSecuredY1 	= 0
		AvgIntRateUSDSecuredY1 	= 0
		AvgIntRateOtherFCSecuredY1 	= 0

		AvgIntRateKHRSecuredN1 	= 0
		AvgIntRateUSDSecuredN1 	= 0
		AvgIntRateOtherFCSecuredN1 	= 0

		AVGIntRateOfUnsecuredLC = getAVGIntRateOfLoanContract("ALL",LoanProduct=NBCBusinessLoan,LoanSector=NBCBusinessLoanSector)
		if AVGIntRateOfUnsecuredLC:
			for AvgIntRate in AVGIntRateOfUnsecuredLC:
				if AvgIntRate.SecuredLoan == 'Y':
					if AvgIntRate.MoreThanOneYear == 'Y':
						AvgIntRateKHRSecuredY1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDSecuredY1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCSecuredY1 = AvgIntRate.AgvInterestOtherFC
					else:
						AvgIntRateKHRSecuredN1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDSecuredN1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCSecuredN1 = AvgIntRate.AgvInterestOtherFC
				else:
					# Loan not Secure are here
					if AvgIntRate.MoreThanOneYear == 'Y':
						AvgIntRateKHRUnsecuredY1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDUnsecuredY1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCUnsecuredY1 = AvgIntRate.AgvInterestOtherFC
					else:
						AvgIntRateKHRUnsecuredN1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDUnsecuredN1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCUnsecuredN1 = AvgIntRate.AgvInterestOtherFC


		RecordRow.append({ 	1:u'6- ឥណទានមានកាលកំណត់ - ទៅធុរកិច្ច\nTerm Loans - Business:', 2:u'', 3:u'', 4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'
						 })
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({ 	1:u'6.1- មិនមានការធានា Unsecured:', 2:u'', 3:u'', 4:u'',
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'' })
		ExcelRecord.update({					
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({
						1:u'6.1.1- រហូតដល់​ ១​ ឆ្នាំ\nOne year or less ',
						2:u'%s %s' %(mktmoney.formatNumber(AvgIntRateKHRUnsecuredN1), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AvgIntRateUSDUnsecuredN1), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AvgIntRateOtherFCUnsecuredN1), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({					
					"F%s"%(CellRow) : AvgIntRateKHRUnsecuredN1 / 100,
					"G%s"%(CellRow) : AvgIntRateUSDUnsecuredN1 / 100,
					"H%s"%(CellRow) : AvgIntRateOtherFCUnsecuredN1 / 100
				})
		CellRow+=1

		RecordRow.append({
						1:u'6.1.2- លើសពី ១ ឆ្នាំ\nGreater than one year',
						2:u'%s %s' %(mktmoney.formatNumber(AvgIntRateKHRUnsecuredY1), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AvgIntRateUSDUnsecuredY1), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AvgIntRateOtherFCUnsecuredY1), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({					
					"F%s"%(CellRow) : AvgIntRateKHRUnsecuredY1 / 100,
					"G%s"%(CellRow) : AvgIntRateUSDUnsecuredY1 / 100,
					"H%s"%(CellRow) : AvgIntRateOtherFCUnsecuredY1 / 100
				})
		CellRow+=1

		RecordRow.append({ 	1:u'6.2- មានការធានា Secured:', 2:u'', 3:u'', 4:u'', 
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':''
						 })
		ExcelRecord.update({
					"F%s"%(CellRow) : "",
					"G%s"%(CellRow) : "",
					"H%s"%(CellRow) : ""
				})
		CellRow+=1

		RecordRow.append({
						1:u'6.2.1- រហូតដល់​ ១​ ឆ្នាំ\nOne year or less ',
						2:u'%s %s' %(mktmoney.formatNumber(AvgIntRateKHRSecuredN1), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AvgIntRateUSDSecuredN1), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AvgIntRateOtherFCSecuredN1), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({
					"F%s"%(CellRow) : AvgIntRateKHRSecuredN1 / 100,
					"G%s"%(CellRow) : AvgIntRateUSDSecuredN1 / 100,
					"H%s"%(CellRow) : AvgIntRateOtherFCSecuredN1 / 100
				})
		CellRow+=1

		RecordRow.append({
						1:u'6.2.2- លើសពី ១ ឆ្នាំ\nGreater than one year',
						2:u'%s %s' %(mktmoney.formatNumber(AvgIntRateKHRSecuredY1), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AvgIntRateUSDSecuredY1), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AvgIntRateOtherFCSecuredY1), "%"),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':''
					})
		ExcelRecord.update({					
					"F%s"%(CellRow) : AvgIntRateKHRSecuredY1 / 100,
					"G%s"%(CellRow) : AvgIntRateUSDSecuredY1 / 100,
					"H%s"%(CellRow) : AvgIntRateOtherFCSecuredY1 / 100
				})
		CellRow+=1
		AvgIntRateKHRUnsecuredY1 	= 0
		AvgIntRateUSDUnsecuredY1 	= 0
		AvgIntRateOtherFCUnsecuredY1 = 0

		AvgIntRateKHRUnsecuredN1 	= 0
		AvgIntRateUSDUnsecuredN1 	= 0
		AvgIntRateOtherFCUnsecuredN1 = 0

		AvgIntRateKHRSecuredY1 	= 0
		AvgIntRateUSDSecuredY1 	= 0
		AvgIntRateOtherFCSecuredY1 	= 0

		AvgIntRateKHRSecuredN1 	= 0
		AvgIntRateUSDSecuredN1 	= 0
		AvgIntRateOtherFCSecuredN1 	= 0

		AVGIntRateOfUnsecuredLC = getAVGIntRateOfLoanContract("ALL",LoanProduct=NBCOtherLoan,LoanSector=NBCOtherLoanSector)
		if AVGIntRateOfUnsecuredLC:
			for AvgIntRate in AVGIntRateOfUnsecuredLC:
				if AvgIntRate.SecuredLoan == 'Y':
					if AvgIntRate.MoreThanOneYear == 'Y':
						AvgIntRateKHRSecuredY1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDSecuredY1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCSecuredY1 = AvgIntRate.AgvInterestOtherFC
					else:
						AvgIntRateKHRSecuredN1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDSecuredN1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCSecuredN1 = AvgIntRate.AgvInterestOtherFC
				else:
					# Loan not Secure are here
					if AvgIntRate.MoreThanOneYear == 'Y':
						AvgIntRateKHRUnsecuredY1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDUnsecuredY1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCUnsecuredY1 = AvgIntRate.AgvInterestOtherFC
					else:
						AvgIntRateKHRUnsecuredN1 = AvgIntRate.AgvInterestRateKHR
						AvgIntRateUSDUnsecuredN1 = AvgIntRate.AgvInterestRateUSD
						AvgIntRateOtherFCUnsecuredN1 = AvgIntRate.AgvInterestOtherFC

		AgvInterestRateKHR = AvgIntRateKHRSecuredY1 + AvgIntRateKHRUnsecuredY1 + AvgIntRateKHRSecuredN1 + AvgIntRateKHRUnsecuredN1
		AgvInterestRateUSD = AvgIntRateUSDSecuredY1 + AvgIntRateUSDUnsecuredY1 + AvgIntRateUSDSecuredN1 + AvgIntRateUSDUnsecuredN1
		AgvInterestOtherFC = AvgIntRateOtherFCSecuredY1 + AvgIntRateOtherFCUnsecuredY1 + AvgIntRateOtherFCSecuredN1 + AvgIntRateOtherFCUnsecuredN1


		RecordRow.append({
						1:u'7- ឥណទានផ្សេងៗ\nOther​ Loans',
						2:u'%s %s' %(mktmoney.formatNumber(AgvInterestRateKHR), "%"),
						3:u'%s %s' %(mktmoney.formatNumber(AgvInterestRateUSD), "%"),
						4:u'%s %s' %(mktmoney.formatNumber(AgvInterestOtherFC), "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'bold'
					})
		ExcelRecord.update({
					"F%s"%(CellRow) : float(AgvInterestRateKHR) / 100,
					"G%s"%(CellRow) : float(AgvInterestRateUSD) / 100,
					"H%s"%(CellRow) : float(AgvInterestOtherFC) / 100
				})
		CellRow+=1

		return RecordRow,ExcelRecord

	except Exception, e:
		raise


def getAVGIntRateOfLoanContract(Branch = "ALL",**kwargs):
	BankDate 		= mktdate.getBankDate()
	Monthly = mktsetting.getAppSetting('MonthlyN22')
	if not Monthly:
		Monthly = 12
	BankDatePreMonth = BankDate - timedelta(days=1)
	BankDatePreMonth = str(BankDatePreMonth)[:7]
	LoanProduct = kwargs.get("LoanProduct",None)
	LoanSector = kwargs.get("LoanSector",None)

	if LoanProduct: LoanSector = None
	if LoanSector : LoanProduct = None
	
	LoanObj = db.session.query(
								MKT_LOAN_CONTRACT.Branch.label('Branch'),
								MKT_LOAN_CONTRACT.ID.label('ID'),
								MKT_LOAN_CONTRACT.LoanProduct.label('LoanProduct'),
								MKT_LOAN_COLLATERAL.Collateral.label('CollateralID'),
								MKT_LOAN_CONTRACT.MoreThanOneYear.label('MoreThanOneYear'),
								MKT_LOAN_CONTRACT.Sector.label('LoanSector'),
								(MKT_LOAN_CONTRACT.Disbursed * cast(MKT_CURRENCY.OtherRate1, Float)).label('DisbursedAmount'),
								case(
									[(
										or_(MKT_LOAN_COLLATERAL.Collateral == None, MKT_LOAN_COLLATERAL.Collateral == ''),
										'N'
									)],
								else_='Y'
								).label('SecuredLoan'),
								case(
									[(
										MKT_LOAN_CONTRACT.Currency == 'KHR',
										MKT_LOAN_CONTRACT.Disbursed * cast(MKT_CURRENCY.OtherRate1, Float)
									)],
								else_=0
								).label('DisbursedAmountKHR'),
								case(
									[(
										MKT_LOAN_CONTRACT.Currency == 'KHR',
										(MKT_LOAN_CONTRACT.Disbursed * cast(MKT_LOAN_CONTRACT.InterestRate, Float)) * cast(MKT_CURRENCY.OtherRate1, Float)/Monthly
									)],
								else_=0
								).label('InterestKHR'),
								case(
									[(
										MKT_LOAN_CONTRACT.Currency == 'USD',
										MKT_LOAN_CONTRACT.Disbursed * cast(MKT_CURRENCY.OtherRate1, Float)
									)],
								else_=0
								).label('DisbursedAmountUSD'),
								case(
									[(
										MKT_LOAN_CONTRACT.Currency == 'USD',
										(MKT_LOAN_CONTRACT.Disbursed * cast(MKT_LOAN_CONTRACT.InterestRate, Float)) * cast(MKT_CURRENCY.OtherRate1, Float)/Monthly
									)],
								else_=0
								).label('InterestUSD'),
								case(
									[(
										and_(MKT_LOAN_CONTRACT.Currency != 'KHR', MKT_LOAN_CONTRACT.Currency != 'USD'),
										MKT_LOAN_CONTRACT.Disbursed * cast(MKT_CURRENCY.OtherRate1, Float)
									)],
								else_=0
								).label('DisbursedAmountOtherFC'),
								case(
									[(
										and_(MKT_LOAN_CONTRACT.Currency != 'KHR', MKT_LOAN_CONTRACT.Currency != 'USD'),
										(MKT_LOAN_CONTRACT.Disbursed * cast(MKT_LOAN_CONTRACT.InterestRate, Float)) * cast(MKT_CURRENCY.OtherRate1, Float)/Monthly
									)],
								else_=0
								).label('InterestOtherFC')
								).\
								join(MKT_CURRENCY, MKT_CURRENCY.ID == MKT_LOAN_CONTRACT.Currency).\
								outerjoin(MKT_LOAN_COLLATERAL, MKT_LOAN_COLLATERAL.ID == MKT_LOAN_CONTRACT.ID).\
								outerjoin(MKT_COLLATERAL_DE, MKT_COLLATERAL_DE.CollateralID==MKT_LOAN_COLLATERAL.Collateral).\
								filter(MKT_LOAN_CONTRACT.ValueDate.ilike(BankDatePreMonth + '%')).\
								distinct(MKT_LOAN_CONTRACT.ID).\
								subquery()

	if Branch != 'ALL':
		LoanObj = db.session.query(LoanObj).\
									filter(LoanObj.c.Branch.in_(Branch)).\
									subquery()
	if LoanProduct:
		LoanObj = db.session.query(LoanObj).\
									filter(LoanObj.c.LoanProduct.in_(LoanProduct)).\
									subquery()
	if LoanSector:
		LoanObj = db.session.query(LoanObj).\
									filter(LoanObj.c.LoanSector.in_(LoanSector)).\
									subquery()

	if not LoanProduct and not LoanSector :
		LoanObj = db.session.query(LoanObj).\
									filter(LoanObj.c.LoanSector.in_('None All')).\
									subquery() 
	LoanObj = db.session.query(
								LoanObj.c.SecuredLoan.label('SecuredLoan'),
								LoanObj.c.MoreThanOneYear.label('MoreThanOneYear'),
								func.sum(LoanObj.c.DisbursedAmountKHR).label('TotalDisbursedAmountKHR'),
								func.sum(LoanObj.c.InterestKHR).label('TotalInterestKHR'),
								func.sum(LoanObj.c.DisbursedAmountUSD).label('TotalDisbursedAmountUSD'),
								func.sum(LoanObj.c.InterestUSD).label('TotalInterestUSD'),
								func.sum(LoanObj.c.DisbursedAmountOtherFC).label('TotalDisbursedAmountOtherFC'),
								func.sum(LoanObj.c.InterestOtherFC).label('TotalInterestOtherFC'),
								func.sum(LoanObj.c.DisbursedAmount).label('DisbursedAmount')
								).\
								group_by(LoanObj.c.SecuredLoan, LoanObj.c.MoreThanOneYear).\
								subquery()

	LoanObj = db.session.query(
								LoanObj.c.SecuredLoan.label('SecuredLoan'),
								LoanObj.c.MoreThanOneYear.label('MoreThanOneYear'),
								case(
									[(
										LoanObj.c.TotalDisbursedAmountKHR != 0,
										LoanObj.c.TotalInterestKHR / LoanObj.c.TotalDisbursedAmountKHR
									)],
									else_=0
								).label('AgvInterestRateKHR'),
								case(
									[(
										LoanObj.c.TotalDisbursedAmountUSD != 0,
										LoanObj.c.TotalInterestUSD / LoanObj.c.TotalDisbursedAmountUSD
									)],
									else_=0
								).label('AgvInterestRateUSD'),
								case(
									[(
										LoanObj.c.TotalDisbursedAmountOtherFC != 0,
										LoanObj.c.TotalInterestOtherFC / LoanObj.c.TotalDisbursedAmountOtherFC
									)],
									else_=0
								).label('AgvInterestOtherFC')
								).\
								subquery()

	LoanObj = db.session.query(LoanObj).order_by(LoanObj.c.SecuredLoan, LoanObj.c.MoreThanOneYear).all()

	return LoanObj
