# -*- coding: utf-8 -*-
'''
	Report Name: MONTHLY REPORT ON SOLVENCY RATIO

'''
from decimal                    import *
from app.mktcore.imports        import *
from app.GLBalance.models       import MKT_GL_BALANCE, MKT_GL_BALANCE_BACKUP
from app.LoanContract.models    import MKT_LOAN_CONTRACT
from app.Customer.models        import MKT_CUSTOMER
from app.Sector.models          import MKT_SECTOR
from app.LoanProduct.models     import MKT_LOAN_PRODUCT
from app.Currency.models 		import MKT_CURRENCY

import app.tools.mktdate        as mktdate
import app.tools.mktsetting     as mktsetting
import app.tools.mktmoney       as mktmoney
import app.tools.mktnbc         as mktnbc
import app.tools.mktgl          as mktgl
import app.tools.mktmessage     as mktmessage
import app.tools.mkttool        as mkttool
from app.Currency.models        import *
import app.NBCReport.V2.MFI.NBCMFISetting  as nbcmfisetting


def getGLValueForField(Branch = "ALL", Period = 2,NBCMFI05Key='', NBCExchangeRateDict={},**Kargs):
	return nbcmfisetting.getGLValueFromField(Branch, Period, "NBCMFI05",NBCMFI05Key, NBCExchangeRateDict,**Kargs)


def getMFI05(Branch = "ALL", ReportedDate="", Period = 2, Year = "", Month = "",NBCN011=False):

	OutstandingAmountN11 = getLoanContract()
	TotalOutStandingAmount =0
	for item in OutstandingAmountN11:
		OutAmount = item.OutstandingAmount
		TotalOutStandingAmount +=OutAmount

	try:
		ID              =   "N001" # ID of Report 01 Balance Sheet

		Condition = []
		if Year and Month:
			GLTable     = MKT_GL_BALANCE_BACKUP
			Condition   = [GLTable.GLYear == Year,GLTable.GLMonth == Month]
			CYear       = Year
			CMonth      = Month
		else:
			GLTable     = MKT_GL_BALANCE
			BankDate    = mktdate.getBankDate()
			CYear       = BankDate.year
			CMonth      = BankDate.month
			CMonth      -=  1
			if CMonth == 0:
				CMonth = 12
				CYear -= 1

		GLObj           =   GLTable.query.filter(*Condition)
		Kargs           =   {'GLTable':GLTable, 'GLObj':GLObj, 'FCY':True}

		Result          = {}
		Data            = []
		Excel           = {}
		TableHeader     = {}

		ReportHeader    = mktnbc.getHeaderReport(   ReportName      =   u'MONTHLY REPORT ON SOLVENCY RATIO',
													Title           =   u'របាយការណ៍ប្រចាំខែស្តីពី អនុបាតសាធនភាព',
													Form            =   '5'
													)
		Excel.update({
						"D4" : ReportHeader.get('ReportedDate',""),
						"D6" : ReportHeader.get('CompanyName',""),
						"E8" : Decimal(ReportHeader.get('ReportingRate',0))
					})

		Data            =   []

		DataList        =   mktnbc.getNBCLineDetail(ID, Branch, Period, GLTable=GLTable, GLObj=GLObj, Year=CYear, Month=CMonth)
		SubTotal        =   0

		CurrencyDic     =   mktnbc.getNBCExchangeRate(CYear, CMonth)
		if not CurrencyDic:
			flash(msg_error+"NBC Exchange Rate isn't defined")
			return []

# Solvency A

		Data.append({
						1:u"ភាគយក៖ មូលនិធិផ្ទាល់សុទ្ធ \nNUMBERATOR: NET WORTH",
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold',
					})

		Data.append({
						1:u"I. សរុបរង A៖ ខ្ទង់ត្រូវបូក \nI. Sub-total A: Items to be added",
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'

					})

		PaidUpCapital   =   getGLValueForField(Branch, Period, 'PaidUpCapital', CurrencyDic, **Kargs)
		SubTotal        +=  Decimal(PaidUpCapital)

		Data.append({
						1:u"ដើមទុន ឬទាយជ្ជទានដើមទុន \nCapital or endowment",
						2:u'',
						3:u'',
						4:u'%s' %mktmoney.formatNumber(float(PaidUpCapital), 1, 2),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G11" : Decimal(PaidUpCapital)
					})
		
		Revaluation     =   getGLValueForField(Branch, Period, 'OtherRevaluationReserv', CurrencyDic, **Kargs)
		SubTotal        +=  Decimal(Revaluation)

		Data.append({
						1:u"ទុនបំរុងក្រៅពីទុនបំរុងពីការវាយតំលៃឡើងវិញ \nReserve, other than revaluation reserves",
						2:u'',
						3:u'',
						4:u'%s' %mktmoney.formatNumber(float(Revaluation), 1, 2),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G12" : Decimal(Revaluation)
					})

		Premium     =   getGLValueForField(Branch, Period, 'Premium', CurrencyDic, **Kargs)
		SubTotal    +=  Decimal(Premium)
		Data.append({
						1:u"បុព្វលាទទាក់ទងនឹងដើមទុន (បុព្វលាទភាគហ៊ុន) \nPremium related to capital (share premiums)",
						2:'',
						3:u'',
						4:u'%s' %mktmoney.formatNumber(float(Premium), 1, 2),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G13" : Decimal(Premium)
					})

		ProvisionRisk   = getGLValueForField(Branch, Period, 'ProvisionRisk', CurrencyDic, **Kargs)
		SubTotal        +=  ProvisionRisk

		Data.append({
						1:u"សំវិធានធនចំពោះហានិភ័យទូទៅនៃប្រតិបត្តិការ \nProvision for general banking risks",
						2:'',
						3:u'',
						4:u'%s' %ProvisionRisk,
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G14" : Decimal(ProvisionRisk)
					})

		RetainedEarning    =   getGLValueForField(Branch, Period, 'RetainedEarning', CurrencyDic, **Kargs)
		if RetainedEarning <= 0: RetainedEarning = 0
		SubTotal            +=  Decimal(RetainedEarning)

		Data.append({
						1:u"ចំណេញរក្សាទុកសំរាប់វិនិយោគបន្ត \nRetained Earnings",
						2:'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(float(RetainedEarning), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G15" : Decimal(RetainedEarning)
					})
		AuditedNetProfit = getGLValueForField(Branch, Period, 'AuditedNetProfit', CurrencyDic, **Kargs)
		SubTotal        += AuditedNetProfit
		Data.append({
						1:u"ចំណេញសុទ្ធដែលបានផ្ទៀងផ្ទាត់ហើយសំរាប់ឆ្នាំហិរញ្ញវត្ថុចុងក្រោយ \nAudited Net Profit for the last financial year",
						2:u'',
						3:u'',
						4:u'%s' %AuditedNetProfit,
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G16" : Decimal(AuditedNetProfit)
					})
		ItemByNBC = getGLValueForField(Branch, Period, 'ItemByNBC', CurrencyDic, **Kargs)
		SubTotal        +=  Decimal(ItemByNBC)
		Data.append({
						1:u"ខ្ទង់ផ្សេងៗដែលអនុញ្ញាតដោយធនាគារជាតិនៃកម្ពុជា \nOther Items Approved by NBC",
						2:u'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(float(ItemByNBC), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G17" : Decimal(ItemByNBC)
					})

		Data.append({
						1:u"សរុបរង A \n Sub-total A",
						2:u'',
						3:'',
						4:u'%s' %(mktmoney.formatNumber(float(SubTotal), 1, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		SubTotalA   =   SubTotal

		Data.append({
						1:u"II. សរុបរង B៖ ខ្ទង់ត្រូវដក \nII. Sub-total B: Items to be deducted",
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})

		SubTotalB           =   0
		UnpaidPortCapital   =   getGLValueForField(Branch, Period, 'UnpaidPortCapital', CurrencyDic, **Kargs)
		InsiderTotal        =   Decimal(TotalOutStandingAmount)
		# InsiderTotal        =   getGLValueForField(Branch, Period, 'InsiderTotal', CurrencyDic, **Kargs)
		ShareOwner          =   UnpaidPortCapital + InsiderTotal
		SubTotalB           +=  Decimal(ShareOwner)
		Data.append({
						1:u"ចំពោះភាគទុនិក៖ នាយក នាយកចាត់ការ និងសម្ព័ន្ធញាតិ \nFor shareholders, directors, managers and their next of kin",
						2:u'',
						3:u'',
						4:mktmoney.formatNumber(ShareOwner, 2,2),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})

		Data.append({
						1:u"ចំណែកដើមទុនដែលមិនទាន់បានបង់\nUnpaid portion of capital",
						2:u'',
						3:u'',
						4:mktmoney.formatNumber(UnpaidPortCapital, 2, 2),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G21" : Decimal(UnpaidPortCapital)
					})

		Data.append({
						1:u"បុរេប្រទាន ឥណទាន មូលប័ត្រ និងកិច្ចសន្យារបស់ជនពាក់ព័ន្ធ \nAdvances, loans, security and the agreement of the persons concerned as defined above",
						2:u'',
						3:u'',
						4:mktmoney.formatNumber(InsiderTotal, 2, 2),
						'LineType':'LD',
						'Indent':2,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G22" : Decimal(InsiderTotal)
					})

		HoldingOfOwn    = getGLValueForField(Branch, Period, 'HoldingOfOwn', CurrencyDic, **Kargs)
		SubTotalB       += Decimal(HoldingOfOwn)
		Data.append({
						1:u"ការកាន់កាប់ភាគហ៊ុនផ្ទាល់តាមតំលៃចុះបញ្ជី\nHolding of own shares at their book value",
						2:u'',
						3:u'',
						4:u'%s' %HoldingOfOwn,
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G23" : Decimal(HoldingOfOwn)
					})
		AuditedNetProfit    =   getGLValueForField(Branch, Period, 'AccumulatedLoss', CurrencyDic, **Kargs)
		AccumulatedLoss = AuditedNetProfit
		if AuditedNetProfit > 0: AccumulatedLoss = 0
		AccumulatedLoss = abs(AccumulatedLoss)
		SubTotalB       +=  AccumulatedLoss
		Data.append({
						1:u"កាតខាតបង្គរ\nAccumulated losses",
						2:u'',
						3:u'',
						4:mktmoney.formatNumber(AccumulatedLoss, 2, 2),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G24" : Decimal(AccumulatedLoss)
					})
		
		FormationExp    =   getGLValueForField(Branch, Period, 'FormationExp', CurrencyDic, **Kargs)
		SubTotalB       +=  FormationExp
		Data.append({
						1:u"ចំណាយក្នុងការបង្កើត \n Formation expenses",
						2:u'',
						3:u'',
						4:mktmoney.formatNumber(FormationExp,2,2),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G25" : Decimal(FormationExp)
					})
		CurrentYear     =   0
		Losses          =   getGLValueForField(Branch, Period, 'LossDetermined', CurrencyDic, **Kargs)
		if Decimal(Losses) < 0:
			CurrentYear     -=  Decimal(Losses)
			SubTotalB       +=  Decimal(CurrentYear)
		
		Data.append({
						1:u"ការខាតដែលកំណត់តាមគ្រា \nLosses determined on dates",
						2:u'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(float(CurrentYear), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G26" : Decimal(CurrentYear)
					})
		Data.append({
						1:u"សរុបរង B \n Sub-total B",
						2:u'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(SubTotalB, 1, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})


		SubTOtalC   =   Decimal(SubTotalA) - Decimal(SubTotalB)

		Data.append({
						1:u"III. សរុប C៖ មូលនិធិផ្ទាល់សុទ្ធមូលដ្ឋាន = A - B \nIII. Total C: BASE NET WORTH = A - B",
						2:u'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(float(SubTOtalC), 2, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})

		SubTotalD   =   0

		Data.append({
						1:u'IV. Sub-total D: Items to be added',
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})
		RevaluationReserv = getGLValueForField(Branch, Period, 'RevaluationReserv', CurrencyDic, **Kargs)
		SubTotalD   +=   RevaluationReserv

		Data.append({
						1:u"ទុនបំរុងពីការវាយតំលៃឡើងវិញ\nRevaluation Reserves",
						2:u'',
						3:u'',
						4:u'%s' %RevaluationReserv,
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G30" : Decimal(RevaluationReserv)
					})

		Subordinated =   getGLValueForField(Branch, Period, 'Subordinated', CurrencyDic, **Kargs)
		SubTotalD   +=   Subordinated

		Data.append({
						1:u"អនុបំណុល\nSubordinated Debt (up to 100% of base net worth)",
						2:u'',
						3:u'',
						4:u'%s' %Subordinated,
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G31" : Decimal(Subordinated)
					})

		OtherItemsOfSubTotalD    =  getGLValueForField(Branch, Period, 'OtherItemsOfSubTotalD', CurrencyDic, **Kargs)
		SubTotalD               += OtherItemsOfSubTotalD

		Data.append({
						1:u"ខ្ទង់ផ្សេងៗ \nOther Items",
						2:u'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(float(OtherItemsOfSubTotalD), 1, 2)),
						'LineType':'LD',
						'Indent':1,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G32" : Decimal(OtherItemsOfSubTotalD)
					})

		SubTotalD 
		Data.append({
						1:u"សរុបរង D\nSub-total D",
						2:u'',
						3:u'',
						4:u'%s' %SubTotalD,
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		SubTOtalE   =   0

		Data.append({
						1:u"V. សរុបរង E៖ ខ្ទង់ត្រូវដក\nV. Sub-total E: Items to be deducted",
						2:u'',
						3:u'',
						4:u'',
					   'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})
		EquityParticipation = Decimal(getGLValueForField(Branch, Period, 'EquityParticipation', CurrencyDic, **Kargs))
		SubTOtalE           +=   EquityParticipation

		Data.append({
						1:u"ភាគកម្មមូលនិធិផ្ទាល់ក្នុងគ្រឹះស្ថានធនាគារនិងហិរញ្ញវត្ថុនានា\nEquity participation in banking and financial institutions",
						2:u'',
						3:u'',
						4:u'%s' %EquityParticipation,
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G35" : Decimal(EquityParticipation)
					})
		OtherItemOfSubTOtalE = Decimal(getGLValueForField(Branch, Period, 'OtherItemOfSubTOtalE', CurrencyDic, **Kargs))
		SubTOtalE           += OtherItemOfSubTOtalE
		Data.append({
						1:u"ខ្ទង់ផ្សេងៗ\nOther Items",
						2:u'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(float(OtherItemOfSubTOtalE), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"G36" : Decimal(OtherItemOfSubTOtalE)
					})

		Data.append({
						1:u"សរុបរង E\nSub-total E",
						2:u'',
						3:u'',
						4:u'%s' %SubTOtalE,
					   'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		TotalNetWorth   =   Decimal(SubTOtalC) + Decimal(SubTotalD) - Decimal(SubTOtalE)
		
		Data.append({
						1:u"សរុប F៖ សរុបមូលនិធិផ្ទាល់សុទ្ធ = (C + D) - E\nTotal F: TOTAL NET WORTH = (C + D) - E",
						2:u'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(float(TotalNetWorth), 2, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})


# Solvency B

		Data.append({
						1:u"ភាគបែង ៖ សរុបទ្រព្យសកម្មដែលបានថ្លឹងហានិភ័យ\nDENOMINATOR: RISK-WEIGHTED ASSETS",
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})

		Data.append({
						1:u"",
						2:u'<div class="text-center">ចំនួនទឹកប្រាក់\nAmount</div>',
						3:u'<div class="text-center">ការថ្លឹងហានិភ័យ\nRisk Weighting</div>',
						4:u'<div class="text-center">ចំនួនទឺកប្រាក់ក្រោយថ្លឹង\nRisk Weighted Amount</div>',
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})

		TotalWeightedAmt=   Decimal(0)
		Data.append({
						1:u"ការថ្លឹងសូន្យភាគរយ\nZero weighting Asset",
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})
		AmountOfAsset = 0
		CashInHand      =   getGLValueForField(Branch, Period, 'CashInHand', CurrencyDic, **Kargs)
		AmountOfAsset   += Decimal(CashInHand)
		SubTotal        += Decimal(CashInHand)
		RiskWeighting   =   0
		WeightedAmt     =   (CashInHand * RiskWeighting) / 100
		TotalWeightedAmt    +=  Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))

		Data.append({
						1:u"សាច់ប្រាក់\nCash",
						2:u'%s' %(mktmoney.formatNumber(float(CashInHand), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E42" : Decimal(CashInHand)
					})
		GoldInHand      = getGLValueForField(Branch, Period, 'GoldInHand', CurrencyDic, **Kargs)
		AmountOfAsset   += GoldInHand
		SubTotal        += GoldInHand
		RiskWeighting   =   0
		WeightedAmt     =   (GoldInHand * RiskWeighting) / 100
		TotalWeightedAmt    += Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))

		Data.append({
						1:u"មាស\nGold",
						2:u'%s' %(mktmoney.formatNumber(float(GoldInHand), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E43" : Decimal(GoldInHand)
					})
		NBCAccount      =  getGLValueForField(Branch, Period, 'NBCAccount', CurrencyDic, **Kargs)
		AmountOfAsset   +=  Decimal(NBCAccount)
		SubTotal        +=  Decimal(NBCAccount)
		RiskWeighting   =   0
		WeightedAmt     =   (NBCAccount * RiskWeighting) / 100
		TotalWeightedAmt    +=  Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))

		Data.append({
						1:u"ឥណទាយ្យលើធនាគារជាតិនៃកម្ពុជា\nClaims on the NBC",
						2:u'%s' %(mktmoney.formatNumber(float(NBCAccount), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E44" : Decimal(NBCAccount)
					})
		DepositBank     =   getGLValueForField(Branch, Period, 'DepositBank', CurrencyDic, **Kargs)
		AmountOfAsset   +=  DepositBank
		SubTotal        +=  DepositBank
		RiskWeighting   =   0
		WeightedAmt     =   (DepositBank * RiskWeighting) / 100
		TotalWeightedAmt    +=  Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))

		Data.append({
						1:u"ទ្រព្យសកម្មដែលមានវត្ថុបញ្ជាំជាប្រាក់បញ្ញើនៅធនាគារ\nAssets collateralized by deposits lodged with the bank",
						2:u'%s' %(mktmoney.formatNumber(float(DepositBank), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E45" : Decimal(DepositBank)
					})
		GuaranteedAA      =   getGLValueForField(Branch, Period, 'GuaranteedAA', CurrencyDic, **Kargs)
		AmountOfAsset   +=  GuaranteedAA
		SubTotal        +=  GuaranteedAA
		RiskWeighting   =   0
		WeightedAmt     =   (GuaranteedAA * RiskWeighting) / 100
		TotalWeightedAmt    +=  Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))

		Data.append({
						1:u"ឥណទាយ្យលើ ឬធានាដោយស្ថាប័នអធិបតេយ្យដែលមានចំណាត់ថ្នាក់ពី AAA ទៅ AA- ឬចំណាត់ថ្នាក់សមមូល\nClaims on or guaranteed by sovereights rated AAA to AA-",
						2:u'%s' %(mktmoney.formatNumber(float(GuaranteedAA), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E46" : Decimal(GuaranteedAA)
					})
		Data.append({
						1:u"ការថ្លឹង ២០%\n20 percent weighting Asset",
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		GuaranteedA       =   getGLValueForField(Branch, Period, 'GuaranteedA', CurrencyDic, **Kargs)
		AmountOfAsset   +=  GuaranteedA
		SubTotal        +=  GuaranteedA
		RiskWeighting   =   20
		WeightedAmt     =   (GuaranteedA * RiskWeighting) / 100
		TotalWeightedAmt    +=  Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))
		GuaranteedA     = mktmoney.formatNumber(float(GuaranteedA), 1, 2)

		Data.append({
						1:u"ឥណទាយ្យលើ ឬធានាដោយស្ថាប័នអធិបតេយ្យដែលមានចំណាត់ថ្នាក់ពី A+ ទៅ A- ឬចំណាត់ថ្នាក់សមមូល\nClaims on or guaranteed by sovereights rated A+ to A-",
						2:u'%s' %GuaranteedA,
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E48" : Decimal(mktmoney.formatNumber(float(GuaranteedA), 0, 2))
					})

		CorporationAA       =   getGLValueForField(Branch, Period, 'CorporationAA', CurrencyDic, **Kargs)
		AmountOfAsset   +=  CorporationAA
		SubTotal        +=  CorporationAA
		RiskWeighting   =   20
		WeightedAmt     =   (CorporationAA * RiskWeighting) / 100
		TotalWeightedAmt    += Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))

		Data.append({
						1:u"ឥណទាយ្យលើ ឬធានាដោយធនាគារ ឫក្រុមហ៊ុនដែលមានចំណាត់ថ្នាក់ពី AAA ទៅ AA- ឬចំណាត់ថ្នាក់សមមូល\nClaims on or guaranteed by banks or corporations rated AAA+ to AA-",
						2:u'%s' %(mktmoney.formatNumber(float(CorporationAA), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E49" : Decimal(mktmoney.formatNumber(float(CorporationAA), 0, 2))
					})

		Data.append({
						1:u"ការថ្លឹង ៥០%\n50 percent weighting Asset",
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		GuaranteedBB       =   getGLValueForField(Branch, Period, 'GuaranteedBB', CurrencyDic, **Kargs)
		AmountOfAsset   +=  GuaranteedBB
		SubTotal        +=  GuaranteedBB
		RiskWeighting   =   50
		WeightedAmt     =   (GuaranteedBB * RiskWeighting) / 100
		TotalWeightedAmt    +=  Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))
		Data.append({
						1:u"ឥណទាយ្យលើ ឬធានាដោយស្ថាប័នអធិបតេយ្យដែលមានចំណាត់ថ្នាក់ពី BBB+ ទៅ BBB- ឬចំណាត់ថ្នាក់សមមូល\nClaims on or guaranteed by sovereights rated BBB+ to BBB-",
						2:u'%s' %(mktmoney.formatNumber(float(GuaranteedBB), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E51" : Decimal(mktmoney.formatNumber(float(GuaranteedBB), 0, 2))
					})
		CorporationA       =   getGLValueForField(Branch, Period, 'CorporationA', CurrencyDic, **Kargs)
		AmountOfAsset   +=  CorporationA
		SubTotal        +=  CorporationA
		RiskWeighting   =   50
		WeightedAmt     =   (CorporationA * RiskWeighting) / 100
		TotalWeightedAmt    += Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))

		Data.append({
						1:u"ឥណទាយ្យលើ ឬធានាដោយស្ថាប័នអធិបតេយ្យដែលមានចំណាត់ថ្នាក់ពី A+ ទៅ A- ឬចំណាត់ថ្នាក់សមមូល \nClaims on or guaranteed by banks or corporations rated A+ to A-",
						2:u'%s' %(mktmoney.formatNumber(float(CorporationA), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E52" : Decimal(mktmoney.formatNumber(float(CorporationA), 0, 2))
					})
		Data.append({
						1:u"ការថ្លឹង ១០០%\n100 percent weighting Asset",
						2:u'',
						3:u'',
						4:u'',
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_BODY_COLOR,
						'LineFormat':'bold'
					})

		# TotalAsset      =   getGLValueForField(Branch, Period, 'TotalAsset', CurrencyDic, **Kargs)
		LoanParty      =   getGLValueForField(Branch, Period, 'LoanParty', CurrencyDic, **Kargs)
		TotalAsset      = 0
		TotalAssetLine      =   '31'
		BalanceSheet    =   Decimal(mktnbc.getLineValue("Amount%s%s"%("KHR", TotalAssetLine), DataList))
		BalanceSheet1    =   Decimal(mktnbc.getLineValue("Amount%s%s"%("USD", TotalAssetLine), DataList))
		BalanceSheet1 = Decimal(mktmoney.formatNumber(float(BalanceSheet1), 0, 2)) if BalanceSheet1 else 0
		BalanceSheet = Decimal(mktmoney.formatNumber(float(BalanceSheet), 0, 2)) if BalanceSheet else 0
		
		BalanceSheet += BalanceSheet1


		# AllAssetAmt     =   Decimal(TotalAsset) - Decimal(CashInHand) - Decimal(NBCAccount)
		AllAssetAmt     =   Decimal(TotalAsset)
		AmountOfAsset   +=  Decimal(TotalAsset)
		RiskWeighting   =   100
		
		NewAmountOfAsset    = Decimal(str(mktmoney.formatNumber(float(AmountOfAsset), 1, 2)).replace(',',''))
		NewAllAssetAmt      = Decimal(str(mktmoney.formatNumber(float(AllAssetAmt), 1, 2)).replace(',',''))
		NewInsiderTotal     = Decimal(str(mktmoney.formatNumber(float(InsiderTotal), 1, 2)).replace(',',''))

		LoanParty           =  Decimal(str(mktmoney.formatNumber(float(LoanParty), 1, 2)).replace(',',''))
		CashInHand = Decimal(mktmoney.formatNumber(float(CashInHand), 0, 2)) if CashInHand else 0
		NBCAccount = Decimal(mktmoney.formatNumber(float(NBCAccount), 0, 2)) if NBCAccount else 0
		AllOtherAssets = BalanceSheet - (LoanParty + CashInHand + NBCAccount)
		WeightedAmt     =   (AllOtherAssets * RiskWeighting) / 100
		SubTotal        +=  Decimal(AllOtherAssets)
		TotalWeightedAmt += Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))
		Data.append({
						1:u"ទ្រព្យសកម្មដទៃទៀតទាំងអស់\nAll other assets",
						2:u'%s' %(mktmoney.formatNumber(float(AllOtherAssets), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E54" : Decimal(AllOtherAssets)
					})
		OffBalance      =   getGLValueForField(Branch, Period, 'OffBalance', CurrencyDic, **Kargs)
		SubTotal        +=  OffBalance
		RiskWeighting   =   100
		WeightedAmt     =   (OffBalance * RiskWeighting) / 100
		TotalWeightedAmt +=  Decimal(mktmoney.formatNumber(float(WeightedAmt), 0, 2))

		Data.append({
						1:u"ខ្ទង់ក្រៅតារាងតុល្យការទាំងអស់\nAll off-balance sheet items",
						2:u'%s' %(mktmoney.formatNumber(float(OffBalance), 1, 2)),
						3:u'%s %s' %(mktmoney.formatNumber(float(RiskWeighting), 1, 0), "%"),
						4:u'%s' %(mktmoney.formatNumber(float(WeightedAmt), 1, 2)),
						'LineType':'LD',
						'Indent':0,
						'RowBGColor':'',
						'LineFormat':'',
					})
		Excel.update({
						"E55" : Decimal(OffBalance)
					})
		Data.append({
						1:u"សរុប G៖ ទ្រព្យដែលបានថ្លឹងហានិភ័យ\nTotal G: Total Risk-weighted Assets",
						2:u'',
						3:u'',
						4:u'%s' %(mktmoney.formatNumber(float(TotalWeightedAmt), 1, 2)),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})


		if not TotalNetWorth:
			TotalNetWorth = 0
			
		SovencyRatio    =   0 if TotalWeightedAmt == 0 else float(TotalNetWorth) / float(TotalWeightedAmt)
		SovencyRatio    =   round(SovencyRatio, 4)
		SovencyRatio    =   SovencyRatio * 100

		Data.append({
						1:u"អនុបាតសោធនភាព = សរុប F / សរុបG\nSOLVENCY RATIO = Total F / Total G",
						2:u'',
						3:u'',
						4:u'%s %s' %(SovencyRatio, "%"),
						'LineType':'GH',
						'Indent':0,
						'RowBGColor':mktnbc.BG_HEADER_COLOR,
						'LineFormat':'bold'
					})
		
		Result.update({'TableHeader':TableHeader,'ReportHeader':ReportHeader,'Data':Data, 'Excel': Excel})

		CellSyle = {
					'B9':'top*medium,FF000000:bottom*thin,FF000000',
					'C9':'top*medium,FF000000:bottom*thin,FF000000',
					'D9':'top*medium,FF000000:bottom*thin,FF000000',
					'E9':'top*medium,FF000000:bottom*thin,FF000000',
					'F9':'top*medium,FF000000:bottom*thin,FF000000',
					'G9':'top*medium,FF000000:bottom*thin,FF000000:right*medium,FF000000',

					'G10':'right*medium,FF000000',

					'C11':'top*thin,FF000000:bottom*thin,FF000000',
					'D11':'top*thin,FF000000:bottom*thin,FF000000',
					'E11':'top*thin,FF000000:bottom*thin,FF000000',
					'F11':'top*thin,FF000000:bottom*thin,FF000000',

					'C13':'top*thin,FF000000:bottom*thin,FF000000',
					'D13':'top*thin,FF000000:bottom*thin,FF000000',
					'E13':'top*thin,FF000000:bottom*thin,FF000000',
					'F13':'top*thin,FF000000:bottom*thin,FF000000',

					'C15':'top*thin,FF000000:bottom*thin,FF000000',
					'D15':'top*thin,FF000000:bottom*thin,FF000000',
					'E15':'top*thin,FF000000:bottom*thin,FF000000',
					'F15':'top*thin,FF000000:bottom*thin,FF000000',

					'C17':'top*thin,FF000000:bottom*thin,FF000000',
					'D17':'top*thin,FF000000:bottom*thin,FF000000',
					'E17':'top*thin,FF000000:bottom*thin,FF000000',
					'F17':'top*thin,FF000000:bottom*thin,FF000000',

					'B19':'top*thin,FF000000',
					'C19':'top*thin,FF000000:bottom*thin,FF000000',
					'D19':'top*thin,FF000000:bottom*thin,FF000000',
					'E19':'top*thin,FF000000:bottom*thin,FF000000',
					'F19':'top*thin,FF000000:bottom*thin,FF000000',

					'B21':'left*medium,FF000000',
					'D21':'top*thin,FF000000:bottom*thin,FF000000',
					'E21':'top*thin,FF000000:bottom*thin,FF000000',
					'F21':'top*thin,FF000000:bottom*thin,FF000000',

					'C23':'bottom*thin,FF000000',
					'D23':'top*thin,FF000000:bottom*thin,FF000000',
					'E23':'top*thin,FF000000:bottom*thin,FF000000',
					'F23':'top*thin,FF000000:bottom*thin,FF000000',


					'C25':'top*thin,FF000000:bottom*thin,FF000000',
					'D25':'top*thin,FF000000:bottom*thin,FF000000',
					'E25':'top*thin,FF000000:bottom*thin,FF000000',
					'F25':'top*thin,FF000000:bottom*thin,FF000000',

					'B27':'bottom*thin,FF000000',
					'C27':'top*thin,FF000000:bottom*thin,FF000000',
					'D27':'top*thin,FF000000:bottom*thin,FF000000',
					'E27':'top*thin,FF000000:bottom*thin,FF000000',
					'F27':'top*thin,FF000000:bottom*thin,FF000000',

					'B29':'top*thin,FF000000',
					'C29':'top*thin,FF000000:bottom*thin,FF000000',
					'D29':'top*thin,FF000000:bottom*thin,FF000000',
					'E29':'top*thin,FF000000:bottom*thin,FF000000',
					'F29':'top*thin,FF000000:bottom*thin,FF000000',

					'C31':'top*thin,FF000000:bottom*thin,FF000000',
					'D31':'top*thin,FF000000:bottom*thin,FF000000',
					'E31':'top*thin,FF000000:bottom*thin,FF000000',
					'F31':'top*thin,FF000000:bottom*thin,FF000000',

					'B33':'bottom*thin,FF000000',
					'C33':'top*thin,FF000000:bottom*thin,FF000000',
					'D33':'top*thin,FF000000:bottom*thin,FF000000',
					'E33':'top*thin,FF000000:bottom*thin,FF000000',
					'F33':'top*thin,FF000000:bottom*thin,FF000000',
					
					'C35':'top*thin,FF000000:bottom*thin,FF000000',
					'D35':'top*thin,FF000000:bottom*thin,FF000000',
					'E35':'top*thin,FF000000:bottom*thin,FF000000',
					'F35':'top*thin,FF000000:bottom*thin,FF000000',

					'B37':'bottom*thin,FF000000',
					'C37':'top*thin,FF000000:bottom*thin,FF000000',
					'D37':'top*thin,FF000000:bottom*thin,FF000000',
					'E37':'top*thin,FF000000:bottom*thin,FF000000',
					'F37':'top*thin,FF000000:bottom*thin,FF000000',

					'B39':'bottom*thin,FF000000:top*thin,FF000000',
					'C39':'top*thin,FF000000:bottom*thin,FF000000',
					'D39':'top*thin,FF000000:bottom*thin,FF000000',
					'E39':'top*thin,FF000000',
					'F39':'top*thin,FF000000',

					'B41':'top*thin,FF000000',
					'C41':'top*thin,FF000000:bottom*thin,FF000000',
					'D41':'top*thin,FF000000:bottom*thin,FF000000',

					'C43':'top*thin,FF000000:bottom*thin,FF000000',
					'D43':'top*thin,FF000000:bottom*thin,FF000000',

					'C45':'top*thin,FF000000:bottom*thin,FF000000',
					'D45':'top*thin,FF000000:bottom*thin,FF000000',

					'C47':'top*thin,FF000000:bottom*thin,FF000000',
					'D47':'top*thin,FF000000:bottom*thin,FF000000',

					'C49':'top*thin,FF000000:bottom*thin,FF000000',
					'D49':'top*thin,FF000000:bottom*thin,FF000000',

					'C51':'top*thin,FF000000:bottom*thin,FF000000',
					'D51':'top*thin,FF000000:bottom*thin,FF000000',

					'C53':'top*thin,FF000000:bottom*thin,FF000000',
					'D53':'top*thin,FF000000:bottom*thin,FF000000',

					'C55':'top*thin,FF000000:bottom*thin,FF000000',
					'D55':'top*thin,FF000000:bottom*thin,FF000000',

					'B57':'top*thin,FF000000:bottom*medium,FF000000',
					'C57':'top*thin,FF000000:bottom*medium,FF000000',
					'D57':'top*thin,FF000000:bottom*medium,FF000000',
					'E57':'top*thin,FF000000:bottom*medium,FF000000',
					'F57':'top*thin,FF000000:bottom*medium,FF000000',

					}
		if NBCN011==True:
			return SubTOtalC
		return Result, CellSyle

	except Exception, e:
		raise

def getLoanContract():
	ReadAs 			= 1000000
	LoanPartyID 	= mktsetting.getAppSetting('NBCInsiderOtherPartyLoan')
	LoanObj = db.session.query(	MKT_LOAN_CONTRACT.Branch,
								MKT_LOAN_CONTRACT.ID,
								MKT_LOAN_CONTRACT.ContractCustomerID,
								MKT_CUSTOMER.FirstNameEn,
								MKT_CUSTOMER.LastNameEn,
								MKT_CUSTOMER.FirstNameKh,
								MKT_CUSTOMER.LastNameKh,
								MKT_CUSTOMER.Province,
								MKT_CUSTOMER.District,
								MKT_CUSTOMER.Commune,
								MKT_CUSTOMER.Village,
								MKT_LOAN_CONTRACT.LoanProduct,
								MKT_LOAN_PRODUCT.Description.label('LoanProductDescription'),
								MKT_LOAN_CONTRACT.LoanPurpose,
								MKT_LOAN_CONTRACT.Currency,
								(MKT_LOAN_CONTRACT.Disbursed * cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label('Disbursed'),
								MKT_LOAN_CONTRACT.ValueDate,
								MKT_LOAN_CONTRACT.MaturityDate,
								MKT_LOAN_CONTRACT.InterestRate,
								(MKT_LOAN_CONTRACT.OutstandingAmount * cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label("OutstandingAmount"),
								(MKT_LOAN_CONTRACT.ApprovedAmount * cast(MKT_CURRENCY.OtherRate1, Float)/ReadAs).label('ApprovedAmount')
						).\
						join(MKT_CUSTOMER, MKT_CUSTOMER.ID == MKT_LOAN_CONTRACT.ContractCustomerID).\
						join(MKT_LOAN_PRODUCT, MKT_LOAN_PRODUCT.ID==MKT_LOAN_CONTRACT.LoanProduct).\
						join(MKT_CURRENCY, MKT_CURRENCY.ID==MKT_LOAN_CONTRACT.Currency).\
						filter(MKT_LOAN_CONTRACT.LoanProduct==LoanPartyID).\
						filter(MKT_LOAN_CONTRACT.DisbursedStat =='Y').all()
	return LoanObj
