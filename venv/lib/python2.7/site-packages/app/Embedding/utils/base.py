from app.mktcore.imports 	import *
from app.Embedding.embedding 			import *
from app.Embedding.embeddingdetail 		import *
from app.Embedding.models 				import *
import urllib2

class EmbeddedBase:
	def __init__(self,AppName,ID,**kwargs):
		self.EmbeddingObj = ""
		self.EmbeddingDeObj = ""
		# ID for table "MKT_EMBEDDING"
		self.AppName = AppName 
		# ID for table "MKT_EMBEDDING_DE"
		self.ID 	= ID
		self.kwargs = kwargs
		self.url 	= ""
		self.EmbeddedType 	= ""
		self.MainConfig 	= ""
		self.DetailConfig 	= ""
		self.Resource 		= ""

		if self.AppName:
			self.EmbeddingObj 	= 	MKT_EMBEDDING.query.get(self.AppName)
			self.MainConfig 	= self.getConfiguration(self.EmbeddingObj.Configuration) if self.EmbeddingObj else None
			self.Resource 		= self.EmbeddingObj.Resource if self.EmbeddingObj else ""
		if self.ID:
			self.EmbeddingDeObj = 	MKT_EMBEDDING_DE.query.filter(MKT_EMBEDDING_DE.ID==self.ID).\
													 	   filter(MKT_EMBEDDING_DE.EmbeddedApp==self.AppName).first()
			self.DetailConfig	=	self.EmbeddingDeObj.Configuration if self.EmbeddingDeObj else None
			if self.EmbeddingDeObj:
				if self.EmbeddingDeObj.EmbeddedType == 'C':
					self.DetailConfig 	= self.getConfiguration(self.EmbeddingDeObj.Configuration) if self.EmbeddingDeObj else None
			self.EmbeddedType 	= self.EmbeddingDeObj.EmbeddedType if self.EmbeddingDeObj else ""


	def Process(self):
		if self.Authenticate:
			if self.EmbeddedType in ['F','L']:
				self.url = self.DetailConfig

			elif self.EmbeddedType == 'C':
				self.url = self.GenerateUrl()
		return self.url,self.EmbeddedType

	def getConfiguration(self,Configuration,**kwargs):
		Result = {}
		ResultList =[]
		if Configuration:
			Configuration 		= 	str(Configuration).splitlines()
			for row in Configuration:
				Configure= row.strip().split()
				Result.update({Configure[0]:Configure[1]})
		return Result

	def GenerateUrl(self,**kwargs):
		"""override this method 
			return url
		"""
		return self.url


	def Authenticate(self,**kwargs):
		"""Override this method"""
		return True

	def getURLFromFrame(self):
		Process = self.Process()
		url = Process[0]
		if Process[1]== 'F':
			Frame = Process[0].split()
			for row in Frame:
				if 'src' in row:
					Index = row.find('src')
					url = row[Index+5:-1]
		return url

	def checkServiceWeb(self):
		try:
			URL = self.getURLFromFrame()
			CheckUrl = urllib2.urlopen(URL).info()
			return True,""
		except Exception as e:
			return False,e

	






