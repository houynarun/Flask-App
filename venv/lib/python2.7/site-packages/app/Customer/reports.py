from app.mktcore.imports 			import *
from .models 						import *
from app.Branch.models 				import *
import app.tools.mktdate 			as mktdate


@app.route("/Morakot/Report/CustomerByBranch", methods=['GET', 'POST'])
@checkLogOutSession
@checkLogOutTime
def routeCustomerByBranch():

	# Female
	Female = db.session.query(MKT_CUSTOMER.Branch,func.count(MKT_CUSTOMER.Gender).label('Female')).\
			filter(MKT_CUSTOMER.Gender=='Female').\
			group_by(MKT_CUSTOMER.Gender,MKT_CUSTOMER.Branch)
	DicFemale={}
	for item in Female:
		DicFemale.update({item.Branch:item.Female})

	# Male
	Male = db.session.query(MKT_CUSTOMER.Branch,func.count(MKT_CUSTOMER.Gender).label('Male')).\
			filter(MKT_CUSTOMER.Gender=='Male').\
			group_by(MKT_CUSTOMER.Gender,MKT_CUSTOMER.Branch)

	DicMale={}
	for item in Male:
		DicMale.update({item.Branch:item.Male})


	# Other
	Other = db.session.query(MKT_CUSTOMER.Branch,func.count(MKT_CUSTOMER.Gender).label('Other')).\
			filter(MKT_CUSTOMER.Gender=='Other').\
			group_by(MKT_CUSTOMER.Gender,MKT_CUSTOMER.Branch)

	DicOther={}
	for item in Other:
		DicOther.update({item.Branch:item.Other})

	Total = db.session.query(MKT_CUSTOMER.Branch,func.count(MKT_CUSTOMER.Gender).label('Total')).\
			group_by(MKT_CUSTOMER.Branch)

	DicTotal={}
	for item in Total:
		DicTotal.update({item.Branch:item.Total})

	SumMale 	= sum(DicMale.values())
	SumFemale 	= sum(DicFemale.values())
	SumOther 	= sum(DicOther.values())
	SumTotal 	= sum(DicTotal.values())

	Branch = db.session.query(MKT_CUSTOMER.Branch,MKT_BRANCH.Description).\
			join(MKT_BRANCH, MKT_CUSTOMER.Branch == MKT_BRANCH.ID).\
			group_by(MKT_CUSTOMER.Branch,MKT_BRANCH.Description)

	BankDate = mktdate.getBankDate()
	
	return render_template("customer/customerbybranch.html",
							Branch 		= Branch,
							DicFemale 	= DicFemale,
							Male 		= Male,
							DicMale 	= DicMale,
							DicOther 	= DicOther,
							DicTotal 	= DicTotal,
							SumMale 	= SumMale,
							SumFemale 	= SumFemale,
							SumOther 	= SumOther,
							SumTotal 	= SumTotal,
							BankDate 	= BankDate)