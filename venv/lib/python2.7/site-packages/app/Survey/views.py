from app.mktcore.imports 	import *
from flask 				import g,flash
from .survey 			import *
from .questionnaire		import *
from .questionanswer 		import *
from app.mktcore.imports 		import *
import app.tools.mktdb 			as mktdb
import app.tools.mktaudit 		as mktaudit


registerCRUD(admin, '/Survey', 'Survey',FRM_SURVEY, [MKT_SURVEY])
registerCRUD(admin, '/SurveyQuestionnaire', 'SurveyQuestionnaire',FRM_SURVEY_QUESTIONNAIRE, [MKT_SURVEY_QUESTIONNAIRE,MKT_SURVEY_QUESTIONNAIRE_DE])
registerCRUD(admin,'/SurveyQA','SurveyQA',FRM_QUESTION_ANSWER,[MKT_SURVEY_QUESTIONS,MKT_SURVEY_ANSWERS])



@app.route('/Morakot/SurveyDetail/<SurveyID>',methods = ['GET','POST'])
@app.route('/Morakot/SurveyDetail/',methods = ['GET','POST'])
@checkLogOutSession
@checkLogOutTime
def getSurveyDetail(SurveyID = ''):
	ID 	 			= 	request.args.get('ID') if 'ID' in request.args else ''
	QuestionList 	=	[]
	QuestionDic 	=	{}
	if SurveyID != "":
		if SurveyID != "__None":
			QuestionnaireObj 	= 	MKT_SURVEY_QUESTIONNAIRE.query.filter(MKT_SURVEY_QUESTIONNAIRE.ID == SurveyID).first()
			QuestionnaireDeObj	= 	MKT_SURVEY_QUESTIONNAIRE_DE.query.filter(MKT_SURVEY_QUESTIONNAIRE_DE.ID==QuestionnaireObj.ID).\
																		order_by(MKT_SURVEY_QUESTIONNAIRE_DE.QuestionOrder).all()
			AnswerObj 			=  	MKT_SURVEY_ANSWERS
			SurveyDeObj  	    = 	MKT_SURVEY_DE.query.filter(MKT_SURVEY_DE.ID == ID).all()
			if not SurveyDeObj:
				SurveyDeObj  	= 	MKT_SURVEY_DE_HIST.query.filter(MKT_SURVEY_DE_HIST.ID==ID).all()
			SurveyObj 			= 	MKT_SURVEY.query.filter(MKT_SURVEY.ID == ID).first()
			SurveyCurr 			= 	SurveyObj.Curr if SurveyObj else ""
			QuestionID 			= 	[Question.QuestionID for Question in QuestionnaireDeObj]
			for row in QuestionID:
				QuestionObj 	= 	MKT_SURVEY_QUESTIONS.query.filter(MKT_SURVEY_QUESTIONS.ID == row).first()
				QuestionDic	 	= 	{'1':QuestionObj.ID,'2':QuestionObj.Question,'3':QuestionObj.AnswerType}
				QuestionList.append(QuestionDic)
			if SurveyDeObj:
				return render_template('survey/detail.html',
														QuestionObj 	=	QuestionObj,
														AnswerObj		=	AnswerObj,
														QuestionID 		=	QuestionID,
														SurveyDeObj 	=	SurveyDeObj,
														SurveyCurr  	= 	SurveyCurr,
														QuestionList 	=	QuestionList,
														ID 				=	ID
													)
			else:
				return render_template('survey/detail.html',QuestionObj 	=	QuestionObj,
														QuestionnaireDeObj	=	QuestionnaireDeObj,
														AnswerObj		 	=	AnswerObj,
														QuestionID 			=	QuestionID,
														QuestionList 		= 	QuestionList
													)
	return render_template('survey/detail.html',QuestionObj 		=	"",
													AnswerObj 		=	"",
													SurveyDeObj 	=	"",
													QuestionList	=	"")


def getCRU(ID,Question,Answer,AnswerType,Other,Curr,Current):
	SurveyData = {}
	if Current:
		Curr += 1
	SurveyData.update({
			'ID':ID,
			'Question':Question,
			'Answer':Answer,
			'AnswerType':AnswerType,
			'Other':Other,
			'Curr':Curr
		})
	return SurveyData
@app.route('/Morakot/UpdateSurvey/<QuestionID>',methods=['GET','POST'])
@app.route('/Morakot/UpdateSurvey/',methods=['GET','POST'])
@app.route('/Morakot/UpdateSurvey',methods=['GET','POST'])
@checkLogOutSession
@checkLogOutTime
def updateServey(QuestionID=''):
	result = False
	if request.method 	== 'POST':
		Curr 	   		= 	request.form['Curr'] if 'Curr' in request.form else ''
		if QuestionID:
			QuestionList 	= 	eval(QuestionID)
		if Curr:
			ID 			= request.form['Survey']
			Audit 		= mktaudit.getAuditrail()
			SurveyData 	= ""
			QuestionObj = MKT_SURVEY_QUESTIONS.query.filter(MKT_SURVEY_QUESTIONS.ID.in_(QuestionList))
			# CFUID 		= request.form["CFU"]
			SurveyObj   = 	MKT_SURVEY.query.get(ID)
			SurveyDeObj = 	MKT_SURVEY_DE.query.filter(MKT_SURVEY_DE.ID==ID).first()
			Current 	= 	int(SurveyDeObj.Curr)
			"""
				1. move old record to hist
				2. delete old record then update new record, 
			"""
			mktaudit.moveAUTHtoHIST(MKT_SURVEY_DE,MKT_SURVEY_DE_HIST,ID)
			mktaudit.deleteRecord(MKT_SURVEY_DE,[MKT_SURVEY_DE.ID==ID],True)
			
			for row in QuestionObj:
				if row.AnswerType == '1':
					ID 			= request.form['Survey']
					Question 	= row.ID
					try:
						Answer 	= request.form['Answer[%s]'%row.ID] 
					except Exception as e:
						Answer 	= ""
					SurveyData 	= getCRU(ID,Question,Answer[0],row.AnswerType,"",int(Current),Curr)
					mktdb.insertTable(MKT_SURVEY_DE,SurveyData)
				elif row.AnswerType == '2':
					ID 				= request.form['Survey']
					try:
						AnswerList  = request.form.getlist('Answer[%s]'%row.ID) 
					except Exception as e:
						AnswerList = ""
					Question = row.ID
					if AnswerList:
						for Answer in AnswerList:
							SurveyData = getCRU(ID,Question,Answer,row.AnswerType,"",int(Current),Curr)
							mktdb.insertTable(MKT_SURVEY_DE,SurveyData)
					else:
						SurveyData = getCRU(ID,Question,"",row.AnswerType,"",int(SurveyDebj.Curr),Curr)
						mktdb.insertTable(MKT_SURVEY_DE,SurveyData)
				else:
					AnswerData ={}
					ID  	 = request.form['Survey']
					try:
						Answer 	 = request.form['Answer[%s]'%row.ID]
					except Exception as e:
						Answer = ""
					Question 	= row.ID
					SurveyData 	= getCRU(ID,Question,"",row.AnswerType,Answer,int(Current),Curr)
					mktdb.insertTable(MKT_SURVEY_DE,SurveyData)
			db.session.commit()
			
		else:
			SurveyData 	= {}
			if QuestionList:
				QuestionObj = MKT_SURVEY_QUESTIONS.query.filter(MKT_SURVEY_QUESTIONS.ID.in_(QuestionList)).all()
				for row in QuestionObj:
					if row.AnswerType == '1':
						ID 		= request.form['Survey']
						try:
							Answer 	= request.form['Answer[%s]'%row.ID] 
						except Exception as e:
							Answer  = ""
						#Answer 	= request.form['Answer[%s]'%row.ID]
						Question 	= row.ID
						SurveyData 	= getCRU(ID,Question,Answer,row.AnswerType,"",0,Curr)
						mktdb.insertTable(MKT_SURVEY_DE,SurveyData)
					elif row.AnswerType == '2':
						ID 		= request.form['Survey']
						try:
							AnswerList  = request.form.getlist('Answer[%s]'%row.ID) 
						except Exception as e:
							AnswerList = ""
						Question 	= row.ID
						if AnswerList:
							for Answer in AnswerList:
								SurveyData = getCRU(ID,Question,Answer,row.AnswerType,"",0,Curr)
								mktdb.insertTable(MKT_SURVEY_DE,SurveyData)
						else:
							SurveyData = getCRU(ID,Question,"",row.AnswerType,"",0,Curr)
							mktdb.insertTable(MKT_SURVEY_DE,SurveyData)
					else:
						AnswerData 	=	{}
						ID  	 	= 	request.form['Survey']
						try:
							Answer 	= request.form['Answer[%s]'%row.ID]
						except Exception as e:
							Answer 	= ""
						Question 	= row.ID
						SurveyData 	= getCRU(ID,Question,"",row.AnswerType,Answer,0,Curr)
						mktdb.insertTable(MKT_SURVEY_DE,SurveyData)
				#$result=True
		db.session.commit()
	return render_template('survey/detail.html',result=result)

