#!/usr/local/bin/python
# -*- coding: utf-8 -*-

from app.mktcore.wtfimports import *
from decimal import *
from sqlalchemy import or_

from app.Province.models 	import MKT_PROVINCE
from app.District.models 	import MKT_DISTRICT
from app.Commune.models 	import MKT_COMMUNE
from app.Village.models 	import MKT_VILLAGE
from app.VillageII.models 	import MKT_VILLAGE_II
from app.Industry.models	import MKT_INDUSTRY

import app.tools.mkttool		as mkttool

def getProvince():
	return MKT_PROVINCE.query

def getDistrict(Province=None):
	dic = {}
	mapping = {}
	result = MKT_DISTRICT.query if mkttool.isRequestAll() else MKT_DISTRICT.query.filter_by(Province=Province).all()
	for row in  result:
		dic[row.ID] = row.Description
		if mkttool.isRequestAll():
			if row.Province not in mapping:
				mapping[row.Province] = []
			mapping[row.Province].append(row.ID)

	return jsonify(results=dic, mapping=mapping)

def getCommune(District=None):
	dic = {}
	mapping = {}
	result = MKT_COMMUNE.query if mkttool.isRequestAll() else MKT_COMMUNE.query.filter_by(District=District).all()
	for row in  result:
		dic[row.ID] = row.Description
		if mkttool.isRequestAll():
			if row.District not in mapping:
				mapping[row.District] = []
			mapping[row.District].append(row.ID)

	return jsonify(results=dic, mapping=mapping)

def getVillage(Commune=None):
	dic = {}
	mapping = {}
	result = MKT_VILLAGE.query if mkttool.isRequestAll() else MKT_VILLAGE.query.filter_by(Commune=Commune).all()
	for row in  result:
		dic[row.ID] = row.Description
		if mkttool.isRequestAll():
			if row.Commune not in mapping:
				mapping[row.Commune] = []
			mapping[row.Commune].append(row.ID)

	return jsonify(results=dic, mapping=mapping)

def getVillageII(Village=None):
	dic = {}
	mapping = {}
	result = MKT_VILLAGE_II.query if mkttool.isRequestAll() else MKT_VILLAGE_II.query.filter_by(Village=Village).all()
	for row in  result:
		dic[row.ID] = row.Description
		if mkttool.isRequestAll():
			if row.Village not in mapping:
				mapping[row.Village] = []
			mapping[row.Village].append(row.ID)

	return jsonify(results=dic, mapping=mapping)

def getIndustryBySector(SectorID=''):
	dic = {}
	result = MKT_INDUSTRY.query if mkttool.isRequestAll() else MKT_INDUSTRY.query.filter_by(Sector = SectorID).all()
	for row in  result:
		dic[row.ID] = '%s - %s'%(row.ID,row.Description)

	return jsonify(results=dic)


# get to load QuerySelectField
def getLoadDistrict(ProvinceID=None):
	return MKT_DISTRICT.query.filter_by(Province=ProvinceID) # tablename.query

def getLoadCommune(DistrictID=None):
	return MKT_COMMUNE.query.filter_by(District=DistrictID) # tablename.query

def getLoadVillage(CommuneID=None):
	return MKT_VILLAGE.query.filter_by(Commune=CommuneID) # tablename.query

def getLoadVillageII(VillageID=None):
	return MKT_VILLAGE_II.query.filter_by(Village=VillageID) # tablename.query

def getAddress(ProvinceID='',DistrictID='',CommuneID='',VillageID='', HouseNo='',Street='',Locale='en', ShowLabel=False):
	try:
		# Set Default 
		Address 	= ""
		Province 	= ""
		District 	= ""
		Commune 	= ""
		Village 	= ""
		HouseNo 	= HouseNo if HouseNo else ""
		Street 		= Street if Street else ""

		ProvinceObj = MKT_PROVINCE.query.get(ProvinceID if ProvinceID else '')
		DistrictObj = MKT_DISTRICT.query.get(DistrictID if DistrictID else '')
		CommuneObj 	= MKT_COMMUNE.query.get(CommuneID if CommuneID else '')
		VillageObj 	= MKT_VILLAGE.query.get(VillageID if VillageID else '')

		if hasattr(MKT_PROVINCE, 'LocalDescription') and Locale.upper() != 'EN':
			Field = 'LocalDescription'
		else:
			Field = 'Description'

		if ProvinceObj:
			Province = getattr(ProvinceObj,Field)

		if DistrictObj:
			District = getattr(DistrictObj,Field)

		if CommuneObj:
			Commune = getattr(CommuneObj,Field)

		if VillageObj:
			Village = getattr(VillageObj,Field)

		LabelDict = {	'Street':	{'KH':u'ផ្លូវ',			'EN':'St.'},
						'HouseNo':	{'KH':u'ផ្ទះលេខ',		'EN':'No.'},
						'Village':	{'KH':u'ភូមិ',				'EN':'Village'},
						'Commune':	{'KH':u'ឃុំ/សង្កាត់',	'EN':'Commune'},
						'District':	{'KH':u'ស្រុក/ខណ្ឌ',		'EN':'District'},
						'Province':	{'KH':u'ខេត្ត/ក្រុង',		'EN':'Province'}
					}
		if ShowLabel:
			if Locale:
				Locale 	= Locale.upper()
				HouseNo = '%s %s'%(LabelDict.get('HouseNo',{}).get(Locale,""), HouseNo) if HouseNo else ''
				Street 	= '%s %s'%(LabelDict.get('Street',{}).get(Locale,""), Street) if Street else ''
				Village = '%s %s'%(LabelDict.get('Village',{}).get(Locale,""), Village) if Village else ''
				Commune = '%s %s'%(LabelDict.get('Commune',{}).get(Locale,""), Commune) if Commune else ''
				District = '%s %s'%(LabelDict.get('District',{}).get(Locale,""), District) if District else ''
				Province = '%s %s'%(LabelDict.get('Province',{}).get(Locale,""), Province) if Province else ''

		ListAddress = [HouseNo, Street, Village, Commune, District, Province]
		
		# Remove none in the list
		ListAddress = filter(None,ListAddress)
		Address = ", ".join(ListAddress)

		return Address

	except Exception, e:
		raise