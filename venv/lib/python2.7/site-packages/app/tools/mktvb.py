from app.mktcore.wtfimports 	import *
from app.VB.models 				import MKT_VB
from sqlalchemy 				import *

import app.tools.user as mktuser
import app.tools.mkttool as mkttool

def getSearchVB():
	action = request.args.get('action') # by borin
	search = request.args.get('q') if "q" in request.args else ""
	Branch = mktuser.getCurrentBranch()
	NAMES = []
	# filter(MKT_VB.Branch == Branch).\
	# solve issue: For records ID are similar will be wrong showing. 
	if action== 'view':
		query = MKT_VB.query.\
			filter(MKT_VB.ID==search).\
			all()
	elif mkttool.isRequestAll():
		query = MKT_VB.query.all()
	else:
		query = MKT_VB.query.\
				filter(or_(MKT_VB.ID.ilike('%'+search+'%'), MKT_VB.Description.ilike('%'+search+'%'))).\
				filter(MKT_VB.Branch == Branch).\
				all()
			
	for row in query:
		dic = {"id":row.ID, "text":row.ID+" - "+row.Description}
		NAMES.append(dic)

	app.logger.debug(NAMES)
	return jsonify(items = NAMES)