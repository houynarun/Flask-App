from 	systemhealthcheck 			import  * 
from 	app.LoanContract.models 	import MKT_LOAN_CONTRACT
from 	app.Branch.models 			import MKT_BRANCH
from 	app.ConsolBalance.models 	import MKT_CONSOL_BALANCE
from 	app.Currency.models 		import MKT_CURRENCY
from 	app.AssetClass.models 		import MKT_ASSET_CLASS
from 	app.PDParameter.models 		import MKT_PD_PARAM


# import app.tools.mktsetting as mktsetting
import app.tools.mktmoney as mktmoney

import app.tools.mktaccounting as mktaccounting
import app.tools.mktparam 	as mktparam


class ValidateAIRSuspend(SystemHealthCheck):

	def __init__(self):
		self.ItemName 		= 	"ValidateAIRSuspend"
		self.Title 			= 	"Total AIR Suspend"
		self.Status 		= 	"F"
		self.Level 			= 	"Warning"
		self.Code			=	"LOA-W003"
		self.Description	= 	""
		self.ErrorDetail 	= 	{}
		self.Suggestion 	= 	'N'


	@staticmethod
	def runValidate(self):
		# AccSetting = mktsetting.getAccSetting()
		BranchObj = MKT_BRANCH.query.all()
		CurrencyObj = MKT_CURRENCY.query.all()
		PDParamObj = mktparam.getPDParam()
		
		#Get object of loan
		LoanContractObj = db.session.query(MKT_LOAN_CONTRACT).join(MKT_ASSET_CLASS , MKT_LOAN_CONTRACT.AssetClass ==  MKT_ASSET_CLASS.ID).\
															filter(MKT_ASSET_CLASS.IncomeRecog=='N',
																	MKT_LOAN_CONTRACT.OutstandingAmount>0,
																    MKT_LOAN_CONTRACT.DisbursedStat=='Y' )


		TotalError = 0
		# compare value
		for row in BranchObj:
			Message = []
			CurrencyDic 		= 	{}
			BranchError 		= 	0
			for col in CurrencyObj:
				TotalLoanAIRSuspend = 0
				TotalConsolAIRSuspend = 0
				DetailAsseteClass = {}
				AIRSuspendAmount = {}
				GL_KEYS = ""
				LoanContractByBranch 	= 	LoanContractObj.filter( MKT_LOAN_CONTRACT.Branch==row.ID,
																    MKT_LOAN_CONTRACT.Currency==col.ID).all()
				if LoanContractByBranch:
					for LoanContract in LoanContractByBranch:

						GL_KEYS 	= mktaccounting.getConsolKey(PDParamObj.SuspendCrCat, LoanContract.Currency , "", "LC", '')
						CalAIRSuspend = float(LoanContract.AccrInterest)


						GetKey = "Class: %s, More than one year: %s "%(LoanContract.AssetClass,LoanContract.MoreThanOneYear)
						AIRSuspendAmount = DetailAsseteClass.get(GetKey,0)


						DetailAsseteClass.update({
								GetKey: AIRSuspendAmount + CalAIRSuspend

							})
						
						TotalLoanAIRSuspend += CalAIRSuspend

		 			
				ConsoleObj = db.session.query(MKT_CONSOL_BALANCE.ID,(MKT_CONSOL_BALANCE.Balance).label('TotalConsolAIRSuspend')).\
										filter(MKT_CONSOL_BALANCE.ID == GL_KEYS,
											   MKT_CONSOL_BALANCE.Branch == row.ID,
											   MKT_CONSOL_BALANCE.Currency==col.ID).first()


				if ConsoleObj:
					TotalConsolAIRSuspend = ConsoleObj.TotalConsolAIRSuspend


				if str(round(TotalLoanAIRSuspend, 2)) != str(round(TotalConsolAIRSuspend, 2)):

						CurrencyObject = 	mktmoney.getCurrencyObj(col.ID)
						Amount = (float(TotalLoanAIRSuspend)-float(TotalConsolAIRSuspend))
						TotalAmount = "Different Amount from Consol: %s %s" % (mktmoney.toMoney(Amount, CurrencyObject), col.ID)

						for key, value in DetailAsseteClass.iteritems():
							Msg = "%s, Amount: %s %s" % (key, mktmoney.toMoney(float(value), CurrencyObject), col.ID)
							Message.append(Msg)

						BranchError += len(Message)
						ID = ConsoleObj.ID if ConsoleObj else ""
						CurrencyDic.update({
								ID :{
								'Message': Message,
								'Total': len(Message),
								'DiffAmount':TotalAmount
							},
							'Total': BranchError
						})
				Message = []

			if CurrencyDic:
				TotalError += int(CurrencyDic.get('Total', 0))
				self.ErrorDetail.update({
					row.ID: CurrencyDic,
					'Total': TotalError
				})

		return self.ErrorDetail
