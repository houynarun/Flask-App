from systemhealthcheck      import *
from app.PD.models          import MKT_PAST_DUE, MKT_PD_DATE
from app.Branch.models      import MKT_BRANCH
from app.GLBalance.models   import MKT_GL_BALANCE

import app.tools.mktgl as mktgl
import app.tools.mktmoney as mktmoney


class ValidateBalanceSheet(SystemHealthCheck):
	def __init__(self):
		self.ItemName = "ValidateBalanceSheet"
		self.Title = "Balance Sheet"
		self.Status = "F"
		self.Level = "Warning"
		self.Code = "ACG-W001"
		self.Description = ""
		self.ErrorDetail = {}
		self.Suggestion = 'N'

	@staticmethod
	def runValidate(self):
		BankDateObj  = mktdate.getBankDateObj()
		BalanceSheetReportID = "FR002"
		CurrentMonthReportID = "FR001"
		# if mktgl.isMonthEnd(BankDateObj):
		AccSetting          =   mktsetting.getAccSetting()  # Get Acccounting Setting
		TotalAssetLine      =   mktsetting.getAppSetting('TOTAL_ASSETS_LINE') # Get asset line
		TotalLiabilityLine  =   mktsetting.getAppSetting('TOTAL_LIABILITIES_LINE') # Get liability line
		TotalNetIncomeLine  =   mktsetting.getAppSetting('TOTAL_NET_INCOME_LINE')
		Currency 			= 	AccSetting.BaseCurrency
		BranchObj 			= 	MKT_BRANCH.query.all()
		GLObj 				= 	MKT_GL_BALANCE.query
		CurrencyObj 		= 	mktmoney.getCurrencyObj(Currency)

		TotalError = 0
		for row in BranchObj:
			Message = []
			CurrencyDic 		= 	{}
			BranchError 		= 	0
			GLObjByBranch 		= 	GLObj.filter(MKT_GL_BALANCE.Branch == row.ID)
			TotAsset 			= 	decimal.Decimal(mktgl.getReportSubTotal(BalanceSheetReportID, TotalAssetLine, Currency, row.ID, '6', MKT_GL_BALANCE, GLObjByBranch))
			TotLiabityAndEquity = 	decimal.Decimal(mktgl.getReportSubTotal(BalanceSheetReportID, TotalLiabilityLine, Currency, row.ID, '6', MKT_GL_BALANCE, GLObjByBranch))
			# Need to add with current month income
			TotLiabityAndEquity += 	decimal.Decimal(mktgl.getReportSubTotal(CurrentMonthReportID, TotalNetIncomeLine, Currency, row.ID, '0', MKT_GL_BALANCE, GLObjByBranch))

			if str(round(TotAsset, 2))  != str(round(TotLiabityAndEquity, 2)) :
				Amount = (float(TotAsset)-float(TotLiabityAndEquity))
				TotalAmount = mktmoney.toMoney(Amount, CurrencyObj)
				Msg = "Total Assets is not equal to Total Liabilites: %s %s." % (TotalAmount, Currency)
				Message.append(Msg)
				BranchError += len(Message)
				CurrencyDic.update({
					Currency: {
						'Message': Message,
						'Total': len(Message)
					},
					'Total': BranchError
				})

			if CurrencyDic:
				TotalError += int(CurrencyDic.get('Total', 0))
				self.ErrorDetail.update({
					row.ID: CurrencyDic,
					'Total': TotalError
				})

		return self.ErrorDetail
