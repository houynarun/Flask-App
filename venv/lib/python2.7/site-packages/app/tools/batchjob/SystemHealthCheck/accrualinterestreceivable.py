from 	systemhealthcheck 			import  * 
from 	app.LoanContract.models 	import MKT_LOAN_CONTRACT
from 	app.Branch.models 			import MKT_BRANCH
from 	app.ConsolBalance.models 	import MKT_CONSOL_BALANCE
from 	app.Currency.models 		import MKT_CURRENCY
from 	app.AssetClass.models 		import MKT_ASSET_CLASS
from 	app.LoanProduct.models 		import MKT_LOAN_PRODUCT


# import app.tools.mktsetting as mktsetting
import app.tools.mktmoney as mktmoney

import app.tools.mktaccounting as mktaccounting


class ValidateAccrualInterestReceivable(SystemHealthCheck):

	def __init__(self):
		self.ItemName 		= 	"ValidateAccrualInterestReceivable"
		self.Title 			= 	"Total Accrual Interest Receivable"
		self.Status 		= 	"F"
		self.Level 			= 	"Warning"
		self.Code			=	"LOA-W002"
		self.Description	= 	""
		self.ErrorDetail 	= 	{}
		self.Suggestion 	=   'N'


	@staticmethod
	def runValidate(self):
		AccSetting = mktsetting.getAccSetting()
		BranchObj = MKT_BRANCH.query.all()
		CurrencyObj = MKT_CURRENCY.query.all()

		LoanContractObj = db.session.query(
											MKT_LOAN_CONTRACT.Branch,
											MKT_LOAN_CONTRACT.Currency,
											MKT_LOAN_PRODUCT.IntReceivableCate,
											MKT_LOAN_CONTRACT.MoreThanOneYear,
											MKT_LOAN_CONTRACT.AssetClass,
											func.sum(MKT_LOAN_CONTRACT.AccrInterest).label('TotalLoanAIR')).\
									join(MKT_ASSET_CLASS , MKT_LOAN_CONTRACT.AssetClass ==  MKT_ASSET_CLASS.ID).\
									join(MKT_LOAN_PRODUCT , MKT_LOAN_CONTRACT.LoanProduct == MKT_LOAN_PRODUCT.ID)
	
		if AccSetting.GL_KEY1 == "":
			LoanContractObj = db.session.query(
												MKT_LOAN_CONTRACT.Branch,
												MKT_LOAN_CONTRACT.Currency,
												MKT_LOAN_PRODUCT.IntReceivableCate,
												MKT_LOAN_CONTRACT.AssetClass,
												func.sum(MKT_LOAN_CONTRACT.AccrInterest).label('TotalLoanAIR')).\
										join(MKT_ASSET_CLASS , MKT_LOAN_CONTRACT.AssetClass ==  MKT_ASSET_CLASS.ID).\
										join(MKT_LOAN_PRODUCT , MKT_LOAN_CONTRACT.LoanProduct == MKT_LOAN_PRODUCT.ID)
		LoanContractObj = LoanContractObj.filter( 
										   MKT_ASSET_CLASS.IncomeRecog=='Y',
										   MKT_LOAN_CONTRACT.OutstandingAmount>0,
										   MKT_LOAN_CONTRACT.DisbursedStat=='Y' ).\
									order_by(
											MKT_LOAN_CONTRACT.Branch,
											MKT_LOAN_CONTRACT.Currency,
											MKT_LOAN_PRODUCT.IntReceivableCate,
											MKT_LOAN_CONTRACT.MoreThanOneYear if AccSetting.GL_KEY1 else "",
											MKT_LOAN_CONTRACT.AssetClass).\
									group_by(
											MKT_LOAN_CONTRACT.Branch,
											MKT_LOAN_CONTRACT.Currency,
											MKT_LOAN_PRODUCT.IntReceivableCate,
											MKT_LOAN_CONTRACT.MoreThanOneYear if AccSetting.GL_KEY1 else "",
											MKT_LOAN_CONTRACT.AssetClass)


		TotalError = 0
		# compare value
		for row in BranchObj:
			Message = []
			CurrencyDic 		= 	{}
			BranchError 		= 	0
			for col in CurrencyObj:
				LoanContractByBranch 	= 	LoanContractObj.filter(MKT_LOAN_CONTRACT.Branch==row.ID,MKT_LOAN_CONTRACT.Currency==col.ID).all()
				if LoanContractByBranch:
					for LoanContract in LoanContractByBranch:
						# MergeKey  = LoanContract.Category + "." + LoanContract.Currency + "." + LoanContract.AssetClass + "." +\
						#  			LoanContract.MoreThanOneYear + "........"
						LCMoreThanOneYear	= LoanContract.MoreThanOneYear if AccSetting.GL_KEY1 else ""
						GL_KEYS 	= mktaccounting.getConsolKey(LoanContract.IntReceivableCate, LoanContract.Currency , LoanContract.AssetClass, "LC", LCMoreThanOneYear )

					
						ConsoleObj = db.session.query(MKT_CONSOL_BALANCE.ID,(MKT_CONSOL_BALANCE.Balance).label('TotalConsolAIR')).\
												filter(MKT_CONSOL_BALANCE.ID == GL_KEYS,
													   MKT_CONSOL_BALANCE.Branch == row.ID,
													   MKT_CONSOL_BALANCE.Currency==col.ID).first()


						TotalLoanAIR = LoanContract.TotalLoanAIR
						TotalConsolAIR = ConsoleObj.TotalConsolAIR if ConsoleObj else 0


						if str(round(TotalLoanAIR, 2)) != str(round(TotalConsolAIR, 2)):
							CurrencyObject = 	mktmoney.getCurrencyObj(col.ID)
							Amount = (float(TotalLoanAIR)-float(TotalConsolAIR))
							# Check balance between TotalLoanAIR and TotalCosolAIR, if variant is less than 0.05, system healt check will not raise error.
							
							ErrorTreshold = mktsetting.getAppSetting('BALANCE_ERROR_TRESHOLD')

							if not ErrorTreshold:
								ErrorTreshold = 0.05

							if abs(Amount) > float(ErrorTreshold):
								TotalAmount = mktmoney.toMoney(Amount, CurrencyObject)

								Msg = "Category: %s, Class: %s , More than one year: %s, Different Amount from Consol: %s %s" % (LoanContract.IntReceivableCate,LoanContract.AssetClass,\
																			LCMoreThanOneYear, TotalAmount, col.ID)
								Message.append(Msg)

								BranchError += len(Message)
								ID = ConsoleObj.ID if ConsoleObj else ""
								CurrencyDic.update({
									ID :{
										'Message': Message,
										'Total': len(Message)
									},
									'Total': BranchError
								})
						Message = []

			if CurrencyDic:
				TotalError += int(CurrencyDic.get('Total', 0))
				self.ErrorDetail.update({
									row.ID: CurrencyDic,
									'Total': TotalError
								})
		return self.ErrorDetail
