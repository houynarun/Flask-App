from flask 							import render_template,request
from .. import 						app, db
import requests
import app.tools.mktsetting 		as mktsetting
import app.tools.mktnotification 	as mktnotification
import requests
import hashlib
import app.tools.mkttool 			as mkttool

try:
	#python2
	from urllib import urlencode
except ImportError:
	#python3
	from urllib.parse import urlencode

class CLS_SMS(object):	
	Username 		= 	""
	Password 		= 	""
	Url 	 		= 	""
	SMSSender 		= 	""
	COUNTRY_CODE 	= 	"855"
	API_VENDOR 		= 	"1"
	try:
		NotiSetting 	=	mktsetting.getNotificationSetting()
	except Exception, e:
		NotiSetting = ''
	if NotiSetting:
		Username 		= NotiSetting.SMSUserName
		Password 		= NotiSetting.SMSPassword 
		Url 	 		= NotiSetting.SMSURL
		SMSSender 		= NotiSetting.SMSSender
		COUNTRY_CODE 	= NotiSetting.CountryCode		
		API_VENDOR 		= NotiSetting.SMSVendor #1. Mekong Net, #2. Twillio		

	def convertPhoneNumberFormat(self,**kwargs):
		Result 			= ""
		PhoneNumber		= kwargs.get("PhoneNumber")
		COUNTRY_CODE 	= kwargs.get("COUNTRY_CODE",self.COUNTRY_CODE)

		if self.API_VENDOR == "1": #Mekong Net
			#85581771792
			Result = "%s%s" % (COUNTRY_CODE,PhoneNumber[1:])
		if self.API_VENDOR == "2": #Twilio
			#+855081771792
			Result = "+%s%s" % (COUNTRY_CODE,PhoneNumber[1:]) # remove 0

		return Result

	def md5hasher(self,Data):
		md5hash = hashlib.md5()
		md5hash.update(Data)
		return (md5hash.hexdigest())

	def sendSMS(self,**kwargs):		
		try:
			Result 		= 	True, ""
			Body 		= 	kwargs.get("Body")
			To 			= 	kwargs.get("To") #List of Reciepeints
			# print "Vendor",self.API_VENDOR
			#check validate phone number as morakot format
			CheckMobileNumber, Msg = mkttool.isMobile(To)
			if not CheckMobileNumber:
				return False, Msg
				
			if self.API_VENDOR=="1":
				UrlEnpoint 	= self.getMekongSpec(Username = self.Username,
											 Password = self.md5hasher(Data=self.Password),
											 Url= self.Url,
											 Sender=self.SMSSender,
											 To=To,
											 Body= Body)
				Result = requests.request("GET",UrlEnpoint) # retrun integer
				Code   	 	= Result.text[0] 
				if int(Code)==0: # success
					Result = True,Result.text
				else: #Fail
					Result = False,Result.text

			elif self.API_VENDOR=="2":
				from twilio.rest import Client
				#UserName is acc id
				#Password is token
				client 			= Client(self.Username, self.Password)
				# print "self.SMSSender ", self.SMSSender
				# print "To ", To
				To = self.convertPhoneNumberFormat(COUNTRY_CODE=self.COUNTRY_CODE,PhoneNumber=To)
				# print "To ", To
				message 	= 	client.messages.create(body 	= Body,
														from_	= self.SMSSender,
														to  	= To)
				Result = True,"Twillio haven't respone result after send"
			return Result
		except Exception, e:
			print e			
			return False, str(e)

	def getMekongSpec(self,**kwargs):
		Username = kwargs.get("Username")
		Password = kwargs.get("Password")
		Sender   = kwargs.get("Sender") # From
		Body     = kwargs.get("Body") # details info
		To 		 = kwargs.get("To") #phone number
		Url 	 = kwargs.get("Url")+"?"

		Flash    = 0 # 0 or 1
		To 		 = self.convertPhoneNumberFormat(COUNTRY_CODE=self.COUNTRY_CODE,PhoneNumber=To)
		Cd 		 = ""

		DictParam = {
						"username":Username,
						"pass":Password,
						"sender":Sender,
						"cd":Cd,
						"smstext":Body,
						"isflash":Flash,
						"gsm":To
					}
		UrlParam = urlencode(DictParam)
		# UrlParam = "username=%s&pass=%s&cd=%s&sender=%s&smstext=%s&isflash=%s&gsm=%s" % (Username,Password,Cd,Sender,str(Body),Flash,To)
		return Url+UrlParam

SMS = CLS_SMS()