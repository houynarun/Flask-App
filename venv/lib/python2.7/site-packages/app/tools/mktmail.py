from flask 								import render_template
from flask_mail 						import Message,Mail
from .. 								import app, db
import app.tools.mktsetting 			as mktsetting
import app.tools.mktnotification  		as mktnotification
import smtplib


class CLS_MAIL(object):
	MAX_MAIL_RECIPIENTS = int(10) #maximun reciepients per send
	MAIL_SENDER 		= ""

	#mail smtp configuration	
	try:
		NotiSettingObj	= mktsetting.getNotificationSetting()
	except Exception, e:
		NotiSettingObj = ''
	if NotiSettingObj:
		app.config['MAIL_SERVER']   = str(NotiSettingObj.MailServer).strip() 	# do not remove strip()##smtp.gmail.com  for gmail
		app.config['MAIL_PORT']     = str(NotiSettingObj.MailPort).strip()   	# do not remove strip() #465
		app.config['MAIL_USERNAME'] = str(NotiSettingObj.MailUserName).strip() # do not remove strip()
		app.config['MAIL_PASSWORD'] = str(NotiSettingObj.MailPassword).strip() # do not remove strip()
		app.config['MAIL_USE_TLS']  = False
		app.config['MAIL_USE_SSL']  = True
		mail = Mail(app)
		MAIL_SENDER 				= str(NotiSettingObj.MailSender).strip() 
	def getGroupMail(self,**kwargs):
		Result = []
		MAX_MAIL_RECIPIENTS 	= kwargs.get("MAX_MAIL_RECIPIENTS",self.MAX_MAIL_RECIPIENTS)
		LIST_RECIPIENTS 		= kwargs.get("Recipients") #List of Recipients
		LIST = LIST_RECIPIENTS
		while len(LIST[:MAX_MAIL_RECIPIENTS]) > 0:
			Result.append(LIST[:MAX_MAIL_RECIPIENTS])
			LIST = LIST[MAX_MAIL_RECIPIENTS:]
		return Result

	def sendMail(self,**kwargs):
		try:
			with app.app_context():
				Subject 		= kwargs.get("Subject")
				Sender 			= kwargs.get("Sender",self.MAIL_SENDER)
				Recipients 		= kwargs.get("Recipients") # list 
				Body 			= kwargs.get("Body",None)
				Html 			= kwargs.get("Html",None)
				CC 				= kwargs.get("CC",None)
				BCC				= kwargs.get("BCC",None)
				Attachemnts		= kwargs.get("Attachemnts",None)		
				ReplyTo			= kwargs.get("ReplyTo",None)	
				Date			= kwargs.get("Date",None)	
				Charset			= kwargs.get("Charset",None)	
				ExtraHeaders	= kwargs.get("ExtraHeaders",None)			
				MailOptions		= kwargs.get("MailOptions",None)		
				RcptOptions		= kwargs.get("RcptOptions",None)		

				msg = Message(subject=Subject,
							  sender=Sender,
							  recipients=Recipients,
							  body=Body,
							  html=Html,
							  cc=CC,
							  bcc=BCC,
							  attachments=Attachemnts,
							  reply_to=ReplyTo,
							  date=Date,
							  charset=Charset,
							  extra_headers=ExtraHeaders,
							  mail_options=MailOptions,
							  rcpt_options=RcptOptions)

				Result   = self.mail.send(msg)
				return True , "Email successful sent"

		except Exception , e:
			return False, str(e)

MAIL = CLS_MAIL()