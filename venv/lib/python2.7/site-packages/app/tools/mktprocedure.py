
from sqlalchemy 		import *
from app import app,db
from app.Currency.models import *
from sqlalchemy.sql.expression import cast
from datetime 					import datetime, date, timedelta
from app.urlregister import *
import sys
import app.tools.user 					as mktuser
import app.tools.mktdate 				as mktdate
import app.tools.mktaddress 			as mktaddress
import app.tools.mktsetting 			as mktsetting
import app.tools.mktdate 				as mktdate
import app.tools.mktmoney 				as mktmoney
import ast

def getCriteria(Param):
	"""
	- Param is Paramter in store procedure.

	- return Param = ["Branch","Customer ID"]
	"""
	if Param:
		ListCriteria = []
		Param 		 = Param.split('\n')
		for Item in Param:
			if Item:
				Criteria  = Item.split("*")[0]
				ListCriteria.append(Criteria)
		return ListCriteria
	else:
		return []

def getProcedureResult(ProcedureObj,RowFormat,TableHeader):
	"""
	- this functin used to format data
	- param:
		ProcedureObj: is procedure obj
	- return :
		 format : [[],[],...]
	"""
	ListResult = []
	if ProcedureObj:
		for item in ProcedureObj:
			item = ast.literal_eval(str(item))
			Str = "%s"%item
			Str = Str.strip("(") # remove (
			Str = Str.strip(")") # remove )
			Str = Str.replace('"',"")
			List = Str.split(",")
			List = getFomatField(List,RowFormat,TableHeader)

			ListResult.append(List)
	return ListResult
		
	
def getFomatField(List,RowFormat,TableHeader):
	"""
	this function used to format data of field
	- paramter:
		List : single list. ex ["HO","Customer"]
	"""
	Result    = [] 
	Index = 0
	for Col in TableHeader:
		Status = False # this use to check wheather we should append itme to list or not

		FieldValue 	= List[Index]

		for ListFormat in RowFormat:
			
			FieldName = ListFormat[0] # Field that you would like to Format
			FieldType = ListFormat[1] # C Crrency,N Number ,D Date
			
			if Col ==FieldName:
				Status = True
				# loop formated field
				if FieldType=='C':
					 # value that gonna format
					Currency 	= ListFormat[2] # get field currency
					CurrIndex 	= 0 # index to look up currency field
					for Item in TableHeader:
						# loop currency field 
						if Item.strip() ==Currency.strip():

							FieldValue  = FieldValue if FieldValue else 0
							CurrencyObj = MKT_CURRENCY.query.get(List[CurrIndex]) # get currency obj
							Value  		= mktmoney.toMoney(float(FieldValue),CurrencyObj)
							break

						CurrIndex +=1
				elif FieldType =='N':
					# format number
					try:
						# maybe we have other way to cast string number to number but for using ast.literal_eval(0x) is error
						FieldValue = int(FieldValue) if FieldValue else 0
					except Exception as e:
						FieldValue = float(FieldValue) if FieldValue else 0
					DecimalPlace  = 2
					if len(ListFormat)==3:
						# incase user want to format decimal place up
						# when len(ListFormat) == 3 mean that user add format decimal place 
						DecimalPlace  = ListFormat[2]

					Value 		= mktmoney.formatNumber(FieldValue,DecimalPlace=DecimalPlace) # format number here
				else:
					Value = FieldValue

				Result.append(Value)

		if not Status:
			Result.append(FieldValue)

		Index +=1

	return Result
