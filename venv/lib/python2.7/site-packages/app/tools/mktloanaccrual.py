import mktaccounting                as mktaccounting
import mktautoid                    as mktautoid
import mktdate                      as mktdate
from app.Journal.models             import *
from app.DailyBooking.models        import *
from app.ConsolBalance.models       import *

def setLoanAccrualPosting(RecCategory, RecGL, RecCurrency, RecIncome, IntCategory,IntGL,IntCurrency,IntIncome, 
                            Transaction, TranDate, Reference, DateTimeNow, Branch, InterestRate, BaseAmount, UserReference, Description="",EOD=0):
    try:
        
        if float(RecIncome) > 0:
        
            Createdon   = mktdate.getDateTimeNow() 

            for x in [0,1]:
                if x == 1:
                    DrCr        =   'Cr'
                    Amount      =   IntIncome
                    GL_KEYS     =   IntGL
                    Category    =   IntCategory
                    Currency    =   IntCurrency
                else:
                    DrCr        =   'Dr'
                    Amount      =   RecIncome
                    GL_KEYS     =   RecGL
                    Category    =   RecCategory
                    Currency    =   RecCurrency
                
                LCYAmount = mktaccounting.calculateLCY(Currency, Amount)
                insert_AIR_JOURNAL(Category, DrCr, Amount, 'LC', Transaction, TranDate, Reference, 
                                Currency, Branch, GL_KEYS, LCYAmount, DateTimeNow, InterestRate, BaseAmount, UserReference=UserReference, Description=Description)

            
    except Exception as e:
        db.session.rollback()
        raise 

def insert_AIR_JOURNAL( CategoryID ,DebitCredit , Amount, Module, Transaction, TransactionDate ,Reference,
                        Currency="", Branch="", GL_KEYS="", LCYAmount="", DateTimeNow='', InterestRate=0, BaseAmount=0,CustomerID="",Note="",UserReference="",Description=""):
    
    try:

        Description     = ""
        PrevBalance     = 0
        LCYPrevBalance  = 0

        ConsolBal       =   MKT_CONSOL_BALANCE.query.\
                            filter(MKT_CONSOL_BALANCE.ID == GL_KEYS).\
                            filter(MKT_CONSOL_BALANCE.Branch == Branch).\
                            first()
                    
        if ConsolBal:

            PrevBalance     = ConsolBal.Balance # PrevBalance for Beggining Balance on GL Balance Detail
            LCYPrevBalance  = ConsolBal.LCYBalance

        Journal =   MKT_AIR_JOURNAL(
                        Status          =   'AUTH',
                        Curr            =   '0',
                        Inputter        =   'System',
                        Createdon       =   DateTimeNow,
                        Authorizer      =   'System',
                        Authorizeon     =   DateTimeNow,
                        Description     =   Description,
                        CategoryID      =   CategoryID,
                        CustomerID      =   CustomerID,
                        DebitCredit     =   DebitCredit,
                        Amount          =   Amount,
                        PrevBalance     =   PrevBalance,
                        Currency        =   Currency,
                        Module          =   Module,
                        Transaction     =   Transaction,
                        TransactionDate =   TransactionDate,
                        Reference       =   Reference,
                        UserReference   =   UserReference,
                        Branch          =   Branch,
                        LCYAmount       =   LCYAmount,
                        LCYPrevBalance  =   LCYPrevBalance,
                        InterestRate    =   InterestRate,
                        BaseAmount      =   BaseAmount,
                        GL_KEYS         =   GL_KEYS,
                    )

        db.session.add(Journal)

    except Exception as e:
        db.session.rollback()
        raise

def setDailyBooking(LoanDailyAccrLog, Branch, Customer="",Reference="", BaseAmount="", Rate="",NumDay=1, 
                    Currency="", BookedAmount="", Module="",Transaction="", TransactionDate=""):
    try:
        
        if LoanDailyAccrLog == "Y":
                    
            DateTimeNow = mktdate.getDateTimeNow()
            ID = mktautoid.setAutoID("DB", 10, "MKT_DAILY_BOOKING")
            if ID:
                DAILY_BOOKING = MKT_DAILY_BOOKING(

                            Branch          =   Branch,
                            Status          =   'AUTH',
                            Curr            =   '0',
                            Inputter        =   'System',
                            Createdon       =   DateTimeNow,
                            Authorizer      =   'System',
                            Authorizeon     =   DateTimeNow,
                            ID              =   ID,
                            Customer        =   Customer,
                            Reference       =   Reference,
                            BaseAmount      =   BaseAmount,
                            Rate            =   Rate,
                            NumDay          =   NumDay,
                            Currency        =   Currency,
                            BookedAmount    =   BookedAmount,
                            Module          =   Module,
                            Transaction     =   Transaction,
                            TransactionDate =   TransactionDate,                        
                          )

                db.session.add(DAILY_BOOKING)
                return True,'successfully'
            else:
                return False,"Can't find the ID"
    except Exception, e:
        db.session.rollback()
        raise
        return False,'%s'%e